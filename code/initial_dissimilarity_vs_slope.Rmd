---
title: "Initial dissimilarity and trend"
output: 
    github_document: default
---

```{r setup, include=FALSE}
library(data.table) # for handling large datasets
library(ggplot2) # for some plotting
library(glmmTMB) # for beta regression
library(here) # for navigating directories in the repo
if(Sys.info()['nodename'] == 'annotate.sebs.rutgers.edu'){
  library('mgcv', lib.loc = '/usr/lib64/R/library') # when running on Annotate. Need to load 1.8-26, not 1.8-33, for geom_smooth() in ggplot
} else {
  library('mgcv')
}
source(here('code', 'util.R')) # simple utility functions

# tell RStudio to use project root directory as the root for this notebook. Needed since we are storing code in a separate directory.
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file()) 

```

# Load data and set up
```{r}
# biotime community dissimilarity data
bt <- fread('output/turnover_w_covariates.csv.gz') # the timeseries that pass QA/QC. from assemble_turnover_covariates.Rmd
bt[, minduration := min(duration), by = rarefyID]
nrow(bt)

# turnover rate (slope of dissimilarity vs. time)
trends <- fread('output/slope.csv.gz') # linear slopes. from calc_turnover.R

# make frame of initial dissimilarities and turnover rates
initdiss <- bt[duration == minduration, .(Jtu.init = mean(Jtu.sc)), by = .(REALM, rarefyID)] # initial dissimilarities
nrow(initdiss)

# add slope to initdiss
initdiss <- merge(initdiss, trends[measure == 'Jtu' & duration_group == 'All'], by = 'rarefyID')
nrow(initdiss)

# add initdiss back to bt
bt <- merge(bt, initdiss[, .(rarefyID, Jtu.init)])
nrow(bt)

```

## Plot
Turnover rate depends somewhat on number of temporal samples.
```{r}
initdiss[, log10nsamps := log10(nsamps)]
initdiss[, nsamps_class := NA_character_]
initdiss[nsamps == 3, nsamps_class := '3'] # turnover rate isn't meaningful for <3 samples, since need at least 2 dissimilarity values
initdiss[nsamps == 4, nsamps_class := '4']
initdiss[nsamps == 5, nsamps_class := '5']
initdiss[nsamps > 5, nsamps_class := '>5']
initdiss[, nsamps_class := factor(nsamps_class, levels = c('3', '4', '5', '>5'))]


ggplot(initdiss[!is.na(nsamps_class)], aes(Jtu.init, disstrend, color = year2 - year1)) +
    geom_point() +
    geom_smooth() +
  facet_wrap(~nsamps_class, scales = "free_y") +
  scale_color_gradient(trans = 'log10')
  
```

Turnover rate depends on duration of the time series.
```{r}
initdiss[, duration_class := NA_character_]
initdiss[(year2 - year1) == 3, duration_class := '3']
initdiss[(year2 - year1) >= 4 & (year2 - year1) < 6, duration_class := '4-5']
initdiss[(year2 - year1) >=6 & (year2 - year1) < 11, duration_class := '6-10']
initdiss[(year2 - year1) >= 11 & (year2 - year1) < 20, duration_class := '11-20']
initdiss[(year2 - year1) >= 21 & (year2 - year1) < 50, duration_class := '21-50']
initdiss[(year2 - year1) >= 51, duration_class := '>51']
initdiss[, duration_class := factor(duration_class, levels = c('3', '4-5', '6-10', '11-20', '21-50', '>51'))]


ggplot(initdiss[!is.na(duration_class) & nsamps > 2], aes(Jtu.init, disstrend, color = nsamps)) + # need at least 3 samples to get 2 dissimilarities to plot a meaningful slope
    geom_point(alpha = 0.5) +
    geom_smooth() +
  facet_wrap(~duration_class, scales = "free_y") +
  scale_color_gradient(trans = 'log10')
  
```


# Statistical test
Need to first fit a one-stage ME model with beta errors with turnover_vs_temperature_GLMM_fit_Jtu.init.R.
```{r}
if(!exists('modInitAllJtu')) modInitAllJtu <- readRDS(here('temp', 'modInitAllJtu.rds'))
summary(modInitAllJtu)
```


## Predictions from the model
```{r}
newdat <- data.table(expand.grid(duration = 1:10, REALM = c('Marine', 'Terrestrial', 'Freshwater'), Jtu.init = seq(0,1, length.out = 5)))
newdat$STUDY_ID <- 1
newdat$rarefyID <- 1

# Calculate predicted probabilities manually (since predict() is very slow)
m <- model.matrix(~ duration + Jtu.init:duration, newdat)[,]
newdat[, Jtu.sc.linear := fixef(modInitAllJtu)$cond %*% t(m)] # predicted values on linear scale
newdat[, Jtu.sc := plogis(Jtu.sc.linear)] # back to response scale

# convert dissimilarity values into turnover rate (slope)
newdat.slopes <- newdat[, .(disstrend = coef(lm(Jtu.sc ~ duration))[2]), by = Jtu.init]
```

## Plot predictions
The dissimilarity values
```{r}
ggplot(newdat, aes(duration, Jtu.sc, color = Jtu.init, group = Jtu.init)) +
  geom_line()

```


The turnover rates
```{r}
ggplot(newdat.slopes, aes(Jtu.init, disstrend)) +
  geom_point()

```


# Examine Tchange models with Jtu.init
Fit by code/turnover_vs_temperature_GLMM_fit_Jtu.init.R.
## Load models
```{r}
# with Jtu.init for Table 1
if(!exists('modInitAllJtu')) modInitAllJtu <- readRDS(here('temp', 'modInitAllJtu.rds')) # Null
if(!exists('modRealmInitAllJtu')) modRealmInitAllJtu <- readRDS('temp/modRealmInitAllJtu.rds') # Realm. 
if(!exists('modTaxamod2InitAllJtu')) modTaxamod2InitAllJtu <- readRDS('temp/modTaxamod2InitAllJtu.rds') # Taxon. 
if(!exists('modsdTtsignInitAllJtu')) modsdTtsignInitAllJtu <- readRDS(here('temp', 'modsdTtsignInitAllJtu.rds')) # tsign, tempchange_abs.
if(!exists('modsdTRealmtsigninitAllJtu')) modsdTRealmtsigninitAllJtu <- readRDS(here('temp', 'modsdTRealmtsigninitAllJtu.rds')) # tsign:tempchange_abs by realm. 
#if(!exists('modabsLatsdTabsLatRealmtsignInitAllJtu')) modabsLatsdTabsLatRealmtsignInitAllJtu <- readRDS(here('temp', 'modabsLatsdTabsLatRealmtsignInitAllJtu.rds')) # tsign:tempchange_abs:absLat. Not yet included since not fit yet
if(!exists('modrawTsdTTRealmtsigninitAllJtu')) modrawTsdTTRealmtsigninitAllJtu <- readRDS(here('temp','modrawTsdTTRealmtsigninitAllJtu.rds')) # tsign:tempchange_abs:tempave:realm. 

# with Jtu.init for Table S3
#if(!exists('modInitAllHorn')) modInitAllHorn <- readRDS(here('temp', 'modInitAllHorn.rds')) # Null with only duration
if(!exists('modRealmInitAllHorn')) modRealmInitAllHorn <- readRDS('temp/modRealmInitAllHorn.rds') # Realm
if(!exists('modTaxamod2InitAllHorn')) modTaxamod2InitAllHorn <- readRDS('temp/modTaxamod2InitAllHorn.rds') # Taxon
if(!exists('modsdTtsignInitAllHorn')) modsdTtsignInitAllHorn <- readRDS(here('temp', 'modsdTtsignInitAllHorn.rds')) # tsign, tempchange_abs
if(!exists('modsdTRealmtsigninitAllHorn')) modsdTRealmtsigninitAllHorn <- readRDS(here('temp', 'modsdTRealmtsigninitAllHorn.rds')) # tsign:tempchange by realm
#if(!exists('modrawTsdTTRealmtsigninitAllHorn')) modrawTsdTTRealmtsigninitAllHorn <- readRDS(here('temp','modrawTsdTTRealmtsigninitAllHorn.rds')) # adds tsign to tempave:tempchange:realm

# with Jtu.init for Table S4
#if(!exists('modrawTsdTTRealmtsignmicroclimInitAllJtu')) modrawTsdTTRealmtsignmicroclimInitAllJtu <- readRDS('temp/modrawTsdTTRealmtsignmicroclimInitAllJtu.rds') # has microclimates
#if(!exists('modrawTsdTTRealmtsignhumanInitAllJtu')) modrawTsdTTRealmtsignhumanInitAllJtu <- readRDS('temp/modrawTsdTTRealmtsignhumanInitAllJtu.rds') # has human impact. 


# w/out
if(!exists('modsdTRealmtsignAllJtu')) modsdTRealmtsignAllJtu <- readRDS(here('temp', 'modsdTRealmtsignAllJtu.rds')) # Fit by code/turnover_vs_temperature_GLMM_fit_Jtu.R
if(!exists('modrawTsdTTRealmtsignAllJtu')) modrawTsdTTRealmtsignAllJtu <- readRDS(here('temp', 'modrawTsdTTRealmtsignAllJtu.rds')) # Fit by code/turnover_vs_temperature_GLMM_fit_Jtu.R


```

## Summaries
```{r}
if(!exists('sum.Tchange')) sum.Tchange <- summary(modsdTRealmtsigninitAllJtu)
if(!exists('sum.TchangeTave')) sum.TchangeTave <- summary(modrawTsdTTRealmtsigninitAllJtu)

sum.Tchange
sum.TchangeTave
```


## AIC
### Like Table 1 (main Jtu models)
```{r}

aics <- AIC(modInitAllJtu, modRealmInitAllJtu, modTaxamod2InitAllJtu, # simple models w/out tempchange
            modsdTtsignInitAllJtu, modsdTRealmtsigninitAllJtu, # tsign:tempchange_abs w/out or w/ realm
            #modabsLatsdTabsLatRealmtsignInitAllJtu,
            modrawTsdTTRealmtsigninitAllJtu) # add tempave:tempchange_abs
aics$dAIC <- aics$AIC - min(aics$AIC)
aics$dAICnull <- aics$AIC - aics$AIC[rownames(aics)=='modInitAllJtu']
aics

```

### Like Table S3 (Horn)
```{r}
aics <- AIC(
  #modInitAllHorn, 
  modRealmInitAllHorn, modTaxamod2InitAllHorn, # simple models w/out tempchange
  modsdTtsignInitAllHorn, modsdTRealmtsigninitAllHorn#, # tsign:tempchange_abs, also by realm
  #          modrawTsdTTRealmtsignInitAllHorn
) # add tempave:tempchange_abs
aics$dAIC <- aics$AIC - min(aics$AIC)
#aics$dAICnull <- aics$AIC - aics$AIC[rownames(aics)=='modInitAllHorn']
aics

```

### Like Table S4 (covariates)
```{r}
aics <- AIC(modInitAllJtu, modrawTsdTTRealmtsigninitAllJtu, 
            modrawTsdTTRealmtsignmicroclimInitAllJtu,
            modrawTsdTTRealmtsignhumanInitAllJtu) 
aics$dAICTsdTT <- aics$AIC - aics$AIC[rownames(aics)=='modrawTsdTTRealmtsigninitAllJtu']
aics$dAICnull <- aics$AIC - aics$AIC[rownames(aics)=='modInitAllJtu']
aics


```

## Plots: Compare to models without init
## 2D plots
made by pred_modrawXAllJtu.sh
```{r}
# read in slopes
slopessdTRealmtsigninitJtu <- readRDS(here('temp', 'slopes_modsdTRealmtsigninitAllJtu.rds')) # made by pred_modrawXAllJtu.sh/.r
slopesrawTsdTTRealmtsigninitJtu <- readRDS(here('temp', 'slopes_rawTsdTTRealmtsigninit.rds')) # made by pred_modrawXAllJtu.sh/.r

# plot
p1 <- ggplot(slopessdTRealmtsigninitJtu, aes(tempchange, tempave, z = slope)) +
    geom_raster(aes(fill = slope)) +
    labs(x = 'Temperature change (°C/yr)', y = 'Average Temperature (°C)') +
    scale_fill_gradient2(high= "#B2182B", mid = "white", low= "#2166AC", midpoint = 0, name = 'Turnover rate') +
    facet_grid(cols = vars(REALM)) +
    theme(axis.text = element_text(size = 10), 
          axis.title = element_text(size = 12),
          panel.background = element_blank(),
          axis.line = element_line(colour = "black"),
          legend.position = "top",
          legend.margin = margin(c(0, 0.1, -5, 0)),
          legend.justification = c(0.92, 0.9),
          legend.text=element_text(size= 8),
          legend.title=element_text(size= 12),
          legend.title.align = 1)

p2 <- ggplot(slopesrawTsdTTRealmtsigninitJtu, aes(tempchange, tempave, z = slope)) +
    geom_raster(aes(fill = slope)) +
    labs(x = 'Temperature change (°C/yr)', y = 'Average Temperature (°C)') +
    scale_fill_gradient2(high= "#B2182B", mid = "white", low= "#2166AC", midpoint = 0, name = 'Turnover rate') +
    facet_grid(cols = vars(REALM)) +
    theme(axis.text = element_text(size = 10), 
          axis.title = element_text(size = 12),
          panel.background = element_blank(),
          axis.line = element_line(colour = "black"),
          legend.position = "top",
          legend.margin = margin(c(0, 0.1, -5, 0)),
          legend.justification = c(0.92, 0.9),
          legend.text=element_text(size= 8),
          legend.title=element_text(size= 12),
          legend.title.align = 1)

p1
p2
```




### 1D plots
Like Fig. 2 in the draft paper
```{r}

# predicted slopes from the tsign model (no tempave)
slopessdTRealmtsigninitJtu <- readRDS(here('temp', 'slopes_modsdTRealmtsigninitAllJtu.rds')) # made by pred_modrawXAllJtu.sh/.r

# predicted slopes from the tempave interaction model
slopesrawTsdTTRealmtsigninitJtu <- readRDS(here('temp', 'slopes_rawTsdTTRealmtsigninit.rds')) # made by pred_modrawXAllJtu.sh/.r
vals <- slopesrawTsdTTRealmtsigninitJtu[c(which.min(abs(tempave - 0)), which.min(abs(tempave-25))), unique(tempave)] # show 0 and 25degC (+/-2SD from the mean)
slopesrawTsdTTRealmtsigninitJtu <- slopesrawTsdTTRealmtsigninitJtu[tempave %in% vals,]
slopesrawTsdTTRealmtsigninitJtu[, tempave := factor(as.character(round(tempave)), levels = c('0', '25'))] # re-order factor for nicer plotting

# b) plot of change vs. dT
p2 <- ggplot() +
    geom_hline(yintercept = 0, linetype = 'dotted') +
    geom_line(data = slopessdTRealmtsigninitJtu, mapping=aes(tempchange, slope), size=0.5) +
    geom_ribbon(data = slopessdTRealmtsigninitJtu, alpha = 0.2, color = NA, 
                aes(tempchange, slope,
                    ymin=slope - slope.se, 
                    ymax=slope + slope.se)) +
    geom_line(data = slopesrawTsdTTRealmtsigninitJtu, mapping=aes(tempchange, slope, color = tempave, group = tempave), linetype = 'dashed') +
    geom_ribbon(data = slopesrawTsdTTRealmtsigninitJtu, alpha = 0.2, color = NA,
                aes(tempchange, slope, fill = tempave,
                    ymin=slope - slope.se,
                    ymax=slope + slope.se)) +
    scale_color_brewer(palette = 'Dark2') +
    scale_fill_brewer(palette = 'Dark2') +
    facet_grid(cols = vars(REALM), scales = 'free')  +
    labs(tag = 'B)', x = 'Temperature change [°C/year]', y = expression(atop('Turnover rate','['~Delta~'Turnover/year]')), 
         fill = 'Average temperature [°C]', 
         color = 'Average temperature [°C]',
         size = 'Duration [years]') +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
          panel.background = element_blank(), axis.line = element_line(colour = "black"),
          legend.key=element_blank(),
          axis.text=element_text(size=8),
          axis.title=element_text(size=8),
          plot.title=element_text(size=8)) +
    scale_y_continuous(trans = signedsqrttrans, 
                       breaks = c(seq(-1,-0.2, by = 0.2), -0.1, 0, 0.1, seq(0.2, 1, by=0.2))) +
    scale_size(trans='log', range = c(0.8,3), breaks = c(2, 5, 20, 50)) +
    guides(size = guide_legend(override.aes = list(alpha=1))) # set alpha to 1 for points in the legend
    
p2 <- addSmallLegend(p2, pointSize = 0.8, spaceLegend = 0.1, textSize = 6)
p2
```


