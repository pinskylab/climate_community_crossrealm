---
title: "Dissimilarity slope covariate data prep and visualization"
output:
  github_document: default
---
Uses slope of dissimilarity vs. time from calc_turnover.Rmd.

```{r setup}
if(Sys.info()['nodename'] == 'annotate.sebs.rutgers.edu'){
  library('mgcv', lib.loc = '/usr/lib64/R/library') # when running on Annotate. Need to load 1.8-26, not 1.8-33.
} else {
  library('mgcv')
}
library(data.table)
library(ggplot2)
library(beanplot) # for beanplots
library(gridExtra) # to combine ggplots together
library(grid) # to combine ggplots together
require(scales) # for custom axis scales
require(here)


#knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file()) # tell RStudio to use project root directory as the root for this notebook. Needed since we are storing code in a separate directory.

signedsqrt_trans <- function() trans_new('signedsqrt', 
                                         transform = function(x) sign(x)*sqrt(abs(x)), 
                                         inverse = function(x) sign(x)*x^2)
```

# Load data
```{r load data, echo=FALSE}
# biotime community dissimilarity data
btlong <- readRDS(here('temp', 'trendstemp.rds'))


# biotime num individuals and other info
load(here::here('data', 'biotime_blowes', 'bt_malin.Rdata')) # load bt_malin
btinfo <- data.table(bt_malin); rm(bt_malin)
btinfo[, Nave := mean(N), by = rarefyID] # average number of individuals in the timeseries
btinfo <- btinfo[!duplicated(rarefyID), .(rarefyID, Nave)]

# Temperature average, changes, and seasonality
temperature <- fread(here('output', 'temperaturetrend_byrarefyID_by_year1_year2.csv.gz'))

# microclimates
microclim <- fread(here('output', 'microclimates.csv.gz'), drop = 1)

# NPP
npp <- fread(here('output', 'npplandocean.csv.gz'))

# Body size
bs <- fread(here('output', 'mass_byrarefyID.csv.gz'), drop = 1)
bs[, ':='(STUDY_ID = NULL, REALM = NULL, taxa_mod = NULL)] # remove unnecessary columns 

# Mobility
speed <- fread(here('output', 'speed_byrarefyID.csv.gz'), drop = 1)
speed[, ':='(STUDY_ID = NULL, REALM = NULL, taxa_mod = NULL)] # remove unnecessary columns 

# Lifespan
lsp <- fread(here('output', 'lifespan_byrarefyID.csv.gz'))

# CTI
cti <- fread(here('output', 'cti_byrarefyID.csv.gz'))
    
# consumer vs. producer
consfrac <- fread(here('output', 'consfrac_byrarefyID.csv.gz'))

# richness
rich <- fread(here('output', 'richness_by_rarefyID.csv.gz')) # number of species

# endotherm vs. ectotherm
endofrac <- fread(here('output', 'endofrac_byrarefyID.csv.gz')) # endotherm vs. ectotherm classifications

# human impact
human <- fread(here('output', 'humanimpact_by_rarefyID.csv.gz'))

# %veg
veg <- as.data.table(readRDS(here('output', 'vct_by_rarefyID.rds')))
veg[, veg := (`tree cover % (mean)` + 0.5 * `non-tree veg. % (mean)`)/100] # veg index from 0 (all non-veg) to 1 (all tree). Non-tree veg counts as 0.5.
```


## Add covariates to BT data
```{r add covariate data, echo=FALSE}
# add covariates
bt <- merge(btlong, btinfo, all.x = TRUE, by = 'rarefyID')
bt <- merge(bt, temperature, all.x = TRUE, by = c('rarefyID', 'year1', 'year2')) # temperature ave, ave metabolic, change, and seasonality
bt <- merge(bt, microclim[, .(rarefyID, microclim = Temp_sd20km)], all.x = TRUE, by = 'rarefyID') # microclimates
bt <- merge(bt, npp, all.x = TRUE, by = 'rarefyID') # npp
bt <- merge(bt, bs[, .(rarefyID, mass = mass_mean_weight)], all.x = TRUE) # body size mass (g)
bt <- merge(bt, cti[, .(rarefyID, thermal_bias)], all.x = TRUE) # thermal bias (degC)
bt <- merge(bt, rich, all.x = TRUE) # species richness
bt <- merge(bt, endofrac[, .(rarefyID, endofrac)], all.x = TRUE) # endotherm vs. ectotherm
bt <- merge(bt, human[, .(rarefyID, human_bowler = atc)], all.x = TRUE) # human impact
```



## Set up useful variables and transformations
```{r, echo=FALSE}
# set realm order
bt[, REALM := factor(REALM, levels = c('Freshwater', 'Marine', 'Terrestrial'), ordered = FALSE)]

# realm that combines Terrestrial and Freshwater, for interacting with human impact
bt[, REALM2 := REALM]
levels(bt$REALM2) = list(TerrFresh = "Freshwater", TerrFresh = "Terrestrial", Marine = "Marine")

# group Marine invertebrates/plants in with All
bt[, taxa_mod2 := taxa_mod]
bt[taxa_mod == 'Marine invertebrates/plants', taxa_mod2 := 'All']

# calculate duration
bt[, duration := year2 - year1]


# set duration group order
bt[, duration_group := factor(duration_group, levels = c('3', '5', '10', '20', 'All', 'Ally1'), ordered = FALSE)]

#add a comparison id
bt[, compID := paste0(rarefyID, '_', year1, '_', year2)]


#######################
## Transformations

### Log-transform some variables, then center and scale. 
bt[, tempave.sc := scale(tempave)]
bt[, tempave_metab.sc := scale(tempave_metab)]
bt[, seas.sc := scale(seas)]
bt[, microclim.sc := scale(log(microclim))]
bt[, temptrend.sc := scale(temptrend, center = TRUE)]
bt[, temptrend_abs.sc := scale(abs(temptrend), center = TRUE)]
bt[, mass.sc := scale(log(mass))]
bt[, thermal_bias.sc := scale(thermal_bias, center = FALSE)]
bt[, endothermfrac.sc := scale(endofrac)]
bt[, nspp.sc := scale(log(Nspp))]
bt[, npp.sc := scale(log(npp))]
bt[, duration.sc := scale(log(duration))]
bt[, human_bowler.sc := scale(log(human_bowler+1)), by = REALM2] # separate scaling by realm

## save the centering and scaling
scaling <- data.frame(center = t(t(sapply(bt, attr, 'scaled:center'))),
                 scale = t(t(sapply(bt, attr, 'scaled:scale'))))
scaling$var <- rownames(scaling)
scaling <- scaling[!vapply(scaling$center, is.null, TRUE) | !vapply(scaling$scale, is.null, TRUE),]
scaling$center[vapply(scaling$center, is.null, TRUE)] <- NA # turn null to NA
scaling$center <- vapply(scaling$center, paste, collapse = ", ", character(1L)) # flatten list to character. not sure why it's a list.
scaling$scale <- vapply(scaling$scale, paste, collapse = ", ", character(1L))

## save the transformations just entered above
scaling$log <- FALSE # whether variable was log-transformed before scaling
scaling$log[scaling$var %in% c('microclim.sc', 'mass.sc', 'speed.sc', 'lifepsan.sc', 'nspp.sc', 'npp.sc', 'veg.sc', 'duration.sc', 'human_bowler.sc', 'human_footprint.sc')] <- TRUE
scaling$plus <- 0 # whether anything was added to the variable before logtransforming
scaling$plus[scaling$var %in% c('speed.sc', 'veg.sc', 'human_bowler.sc')] <- 1

```


## Write out
Only if file doesn't yet exist
```{r write out, echo=FALSE}
if(!file.exists(here('output', 'slope_w_covariates.csv.gz'))){
  write.csv(bt[,.(STUDY_ID, rarefyID, rarefyID_y, REALM, Biome, taxa_mod, taxa_mod2, year1, year2, duration_group, duration, 
                  disstrend, trendse, measure, 
                  tempave.sc, tempave_metab.sc, seas.sc, 
                  microclim.sc, temptrend, temptrend.sc, temptrend_abs.sc,
                  mass.sc, endothermfrac.sc, nspp.sc, thermal_bias.sc, npp.sc,
                  duration.sc, human_bowler.sc, REALM2)], 
            gzfile(here('output', 'slope_w_covariates.csv.gz')), row.names = FALSE)
  write.csv(scaling, here('output','slope_w_covariates_scaling.csv'), row.names = FALSE)
}

```



# Check variable distributions
## Response variables
```{r summaries response}
bt[measure =='Jbeta' & duration_group == '3', summary(disstrend)]
bt[measure =='Jtu' & duration_group == '3', summary(disstrend)]
bt[measure =='Horn' & duration_group == '3', summary(disstrend)]

bt[measure =='Jbeta' & duration_group == '5', summary(disstrend)]
bt[measure =='Jtu' & duration_group == '5', summary(disstrend)]
bt[measure =='Horn' & duration_group == '5', summary(disstrend)]

bt[measure =='Jbeta' & duration_group == '10', summary(disstrend)]
bt[measure =='Jtu' & duration_group == '10', summary(disstrend)]
bt[measure =='Horn' & duration_group == '10', summary(disstrend)]

bt[measure =='Jbeta' & duration_group == '20', summary(disstrend)]
bt[measure =='Jtu' & duration_group == '20', summary(disstrend)]
bt[measure =='Horn' & duration_group == '20', summary(disstrend)]

bt[measure =='Jbeta' & duration_group == 'All', summary(disstrend)]
bt[measure =='Jtu' & duration_group == 'All', summary(disstrend)]
bt[measure =='Horn' & duration_group == 'All', summary(disstrend)]

```

```{r histograms response, echo = FALSE}
# histograms for 3-year ts
invisible(bt[measure =='Jbeta' & duration_group == '3', hist(disstrend, main = 'Jaccard total 3-year slope', breaks = 80)])
invisible(bt[measure =='Jtu' & duration_group == '3', hist(disstrend, main = 'Jaccard turnover 3-year slope', breaks = 80)])
invisible(bt[measure =='Horn' & duration_group == '3', hist(disstrend, main = 'Morisita-Horn 3-year slope', breaks = 80)])

# histograms for 5-year ts
invisible(bt[measure =='Jbeta' & duration_group == '5', hist(disstrend, main = 'Jaccard total 5-year slope', breaks = 80)])
invisible(bt[measure =='Jtu' & duration_group == '5', hist(disstrend, main = 'Jaccard turnover 5-year slope', breaks = 80)])
invisible(bt[measure =='Horn' & duration_group == '5', hist(disstrend, main = 'Morisita-Horn 5-year slope', breaks = 80)])

# histograms for 10-year ts
invisible(bt[measure =='Jbeta' & duration_group == '10', hist(disstrend, main = 'Jaccard total 10-year slope', breaks = 80)])
invisible(bt[measure =='Jtu' & duration_group == '10', hist(disstrend, main = 'Jaccard turnover 10-year slope', breaks = 80)])
invisible(bt[measure =='Horn' & duration_group == '10', hist(disstrend, main = 'Morisita-Horn 10-year slope', breaks = 80)])

# histograms for 20-year ts
invisible(bt[measure =='Jbeta' & duration_group == '20', hist(disstrend, main = 'Jaccard total 20-year slope', breaks = 80)])
invisible(bt[measure =='Jtu' & duration_group == '20', hist(disstrend, main = 'Jaccard turnover 20-year slope', breaks = 80)])
invisible(bt[measure =='Horn' & duration_group == '20', hist(disstrend, main = 'Morisita-Horn 20-year slope', breaks = 80)])

# histograms for all ts
invisible(bt[measure =='Jbeta' & duration_group == 'All', hist(disstrend, main = 'Jaccard total 20-year slope', breaks = 80)])
invisible(bt[measure =='Jtu' & duration_group == 'All', hist(disstrend, main = 'Jaccard turnover 20-year slope', breaks = 80)])
invisible(bt[measure =='Horn' & duration_group == 'All', hist(disstrend, main = 'Morisita-Horn 20-year slope', breaks = 80)])

```

## Unscaled covariates
```{r histograms unscaled, fig.height = 9, echo=FALSE}
# histograms to examine
cexmain = 0.6
par(mfrow = c(5,4))
invisible(bt[, hist(year1, main = 'Start year', cex.main = cexmain)])
invisible(bt[, hist(duration, main = 'Duration (years)', cex.main = cexmain)])
invisible(bt[, hist(mass, main = 'Mass (g)', cex.main = cexmain)])
invisible(bt[, hist(tempave_metab, main = 'Metabolic temperature (°C)', cex.main = cexmain)])
invisible(bt[, hist(endofrac, main = 'Endotherms (fraction)', cex.main = cexmain)])
invisible(bt[, hist(tempave, main = 'Environmental temperature (°C)', cex.main = cexmain)])
invisible(bt[, hist(temptrend, main = 'Temperature trend (°C/yr)', cex.main = cexmain)]) # all the raw data
invisible(bt[, hist(seas, main = 'Seasonality (°C)', cex.main = cexmain)])
invisible(bt[, hist(microclim, main = 'Microclimates (°C)', cex.main = cexmain)])
invisible(bt[, hist(Nspp, main = 'Species richness', cex.main = cexmain)])
invisible(bt[, hist(thermal_bias, main = 'Thermal bias (°C)', cex.main = cexmain)])
invisible(bt[, hist(npp, main = 'Net primary productivity', cex.main = cexmain)])
invisible(bt[, hist(human_bowler, main = 'Human impact score (Bowler)', cex.main = cexmain)])

```

## Scaled covariates
```{r histograms scaled, fig.height = 9, echo=FALSE}
# histograms to examine
cexmain = 0.6
par(mfrow = c(5,4))
invisible(bt[, hist(tempave.sc, main = 'Environmental temperature (°C)', cex.main = cexmain)])
invisible(bt[, hist(tempave_metab.sc, main = 'Metabolic temperature (°C)', cex.main = cexmain)])
invisible(bt[, hist(seas.sc, main = 'Seasonality (°C)', cex.main = cexmain)])
invisible(bt[, hist(microclim.sc, main = 'log Microclimates (°C)', cex.main = cexmain)])
invisible(bt[, hist(temptrend.sc, main = 'Temperature trend (°C/yr)', cex.main = cexmain)])
invisible(bt[, hist(temptrend_abs.sc, main = 'abs(Temperature trend) (°C/yr)', cex.main = cexmain)])
invisible(bt[, hist(mass.sc, main = 'log Mass (g)', cex.main = cexmain)])
invisible(bt[, hist(endothermfrac.sc, main = 'Endotherms (fraction)', cex.main = cexmain)])
invisible(bt[, hist(nspp.sc, main = 'log Species richness', cex.main = cexmain)])
invisible(bt[, hist(thermal_bias.sc, main = 'Thermal bias (°C)', cex.main = cexmain)])
invisible(bt[, hist(npp.sc, main = 'log Net primary productivity', cex.main = cexmain)])
invisible(bt[, hist(human_bowler.sc, main = 'log Human impact score (Bowler)', cex.main = cexmain)])

```


# Response variable SE
```{r response SE, fig.width=9, fig.height=9}
ggplot(bt, aes(disstrend, trendse)) + geom_point() + facet_wrap(vars(duration_group, measure), scales = 'free', ncol = 3)
```

# Check correlations among variables 
Pearson's r is in the lower triangle
```{r pairs, fig.height=10, fig.width=10, echo=FALSE}
panel.cor <- function(x, y, digits = 2, prefix = "", cex.cor, ...)
{
    usr <- par("usr"); on.exit(par(usr))
    par(usr = c(0, 1, 0, 1))
    r <- cor(x, y, use = 'pairwise.complete.obs')
    txt <- format(c(r, 0.123456789), digits = digits)[1]
    txt <- paste0(prefix, txt)
    if(missing(cex.cor)) cex.cor <- 0.8/strwidth(txt)
    text(0.5, 0.5, txt) #, cex = cex.cor * r)
}
pairs(formula = ~ tempave.sc + tempave_metab.sc + seas.sc + microclim.sc + temptrend.sc + temptrend_abs.sc + mass.sc + endothermfrac.sc + nspp.sc + thermal_bias.sc + npp.sc + human_bowler.sc, data = bt[measure == 'Jtu' & duration_group == 'All'], gap = 1/10, cex = 0.2, col = '#00000022', lower.panel = panel.cor)

```


# Compare covariates across realms
```{r compare across realms, fig.height=12, fig.width=9, echo=FALSE}
i <- bt[, !duplicated(rarefyID) & duration_group == 'All']; sum(i)
par(mfrow=c(5,3))
beanplot(rarefyID_y ~ REALM, data = bt[i,], what = c(1,1,1,1), col = c("#CAB2D6", "#33A02C", "#B2DF8A"), border = "#CAB2D6", ylab = 'Latitude (degN)', ll = 0.05)
beanplot(tempave ~ REALM, data = bt[i,], what = c(1,1,1,1), col = c("#CAB2D6", "#33A02C", "#B2DF8A"), border = "#CAB2D6", ylab = 'Temperature (degC)', ll = 0.05)
beanplot(tempave_metab ~ REALM, data = bt[i,], what = c(1,1,1,1), col = c("#CAB2D6", "#33A02C", "#B2DF8A"), border = "#CAB2D6", ylab = 'Metabolic Temperature (degC)', ll = 0.05, bw = 'nrd0') # nrd0 bandwidth to calculation gap
beanplot(seas ~ REALM, data = bt[i,], what = c(1,1,1,1), col = c("#CAB2D6", "#33A02C", "#B2DF8A"), border = "#CAB2D6", ylab = 'Seasonality (degC)', ll = 0.05)
beanplot(microclim ~ REALM, data = bt[i,], what = c(1,1,1,1), col = c("#CAB2D6", "#33A02C", "#B2DF8A"), border = "#CAB2D6", ylab = 'Microclimates (degC)', ll = 0.05)
beanplot(temptrend ~ REALM, data = bt[i,], what = c(1,1,1,1), col = c("#CAB2D6", "#33A02C", "#B2DF8A"), border = "#CAB2D6", ylab = 'Temperature change (degC)', ll = 0.05)
beanplot(mass ~ REALM, data = bt[i,], what = c(1,1,1,1), col = c("#CAB2D6", "#33A02C", "#B2DF8A"), border = "#CAB2D6", ylab = 'Mass (g)', ll = 0.05, log = 'y')
beanplot(Nspp ~ REALM, data = bt[i,], what = c(1,1,1,1), col = c("#CAB2D6", "#33A02C", "#B2DF8A"), border = "#CAB2D6", ylab = 'Number of species', ll = 0.05, log = 'y')
beanplot(thermal_bias ~ REALM, data = bt[i & !is.na(thermal_bias),], what = c(1,1,1,1), col = c("#CAB2D6", "#33A02C", "#B2DF8A"), border = "#CAB2D6", ylab = 'Thermal bias (degC)', ll = 0.05)
beanplot(npp ~ REALM, data = bt[i,], what = c(1,1,1,1), col = c("#CAB2D6", "#33A02C", "#B2DF8A"), border = "#CAB2D6", ylab = 'NPP', ll = 0.05)

```

- Marine are in generally warmer locations (seawater doesn't freeze)
- Marine have much lower seasonality.
- Marine and freshwater have some very small masses (plankton), but much of dataset is similar to terrestrial.
- Marine has a lot of slow, crawling organisms, but land has plants. Land also has birds (fast).



# Plot dissimilarity vs. explanatory variables

Lines are ggplot smoother fits

## Jtu
### Realm
```{r, echo=FALSE, warning = FALSE, message = FALSE}
ggplot(bt[measure == 'Jtu'], aes(REALM, disstrend)) +
  geom_boxplot(na.rm = TRUE) + 
  labs(x = 'Realm', y = 'Jaccard turnover slope') +
  facet_wrap(vars(duration_group), scales = 'free')
```

### Temperature trend
```{r, echo=FALSE, warning = FALSE, message = FALSE}
ggplot(bt[measure == 'Jtu'], aes(temptrend, disstrend)) +
  geom_point(aes(color = REALM), size = 0.2, alpha = 0.5, na.rm = TRUE) + 
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = "cs"), na.rm = TRUE, color = 'black') +
  scale_color_brewer(palette="Set1") + 
  labs(x = 'Temperature trend (°C/yr)', y = 'Jaccard turnover slope') +
  facet_wrap(vars(duration_group), scales = 'free')
```

### abs(Temperature trend)
```{r, echo=FALSE, warning = FALSE, message = FALSE}
ggplot(bt[measure == 'Jtu'], aes(abs(temptrend), disstrend)) +
  geom_point(aes(color = REALM), size = 0.2, alpha = 0.5, na.rm = TRUE) + 
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = "cs"), na.rm = TRUE, color = 'black') +
  scale_color_brewer(palette="Set1") + 
  labs(x = 'abs(Temperature trend) (°C/yr)', y = 'Jaccard turnover slope') +
  facet_wrap(vars(duration_group), scales = 'free')
```

### Temperature
```{r, echo=FALSE, warning = FALSE, message = FALSE}
ggplot(bt[measure == 'Jtu'], aes(tempave, disstrend)) +
  geom_point(aes(color = REALM), size = 0.2, alpha = 0.5, na.rm = TRUE) + 
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = "cs"), na.rm = TRUE, color = 'black') +
  scale_color_brewer(palette="Set1") + 
  labs(x = 'Temperature (°C)', y = 'Jaccard turnover slope') +
  facet_wrap(vars(duration_group), scales = 'free')

```

### Metabolic temperature
```{r, echo=FALSE, warning = FALSE, message = FALSE}
ggplot(bt[measure == 'Jtu'], aes(tempave_metab, disstrend)) +
  geom_point(aes(color = REALM), size = 0.2, alpha = 0.5, na.rm = TRUE) + 
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = "cs"), na.rm = TRUE, color = 'black') +
  scale_color_brewer(palette="Set1") + 
  labs(x = 'Metabolic temperature (°C)', y = 'Jaccard turnover slope') +
  facet_wrap(vars(duration_group), scales = 'free')

```

### Seasonality
```{r, echo=FALSE, warning = FALSE, message = FALSE}
ggplot(bt[measure == 'Jtu'], aes(seas, disstrend)) +
  geom_point(aes(color = REALM), size = 0.2, alpha = 0.5, na.rm = TRUE) + 
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = "cs"), na.rm = TRUE, color = 'black') +
  scale_color_brewer(palette="Set1") + 
  labs(x = 'Seasonality (°C)', y = 'Jaccard turnover slope') +
  facet_wrap(vars(duration_group), scales = 'free')

```

### Microclimates
```{r, echo=FALSE, warning = FALSE, message = FALSE}
ggplot(bt[measure == 'Jtu'], aes(microclim, disstrend)) +
  geom_point(aes(color = REALM), size = 0.2, alpha = 0.5, na.rm = TRUE) + 
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = "cs"), na.rm = TRUE, color = 'black') +
  scale_color_brewer(palette="Set1") + 
  scale_x_log10() +
  labs(x = 'Microclimate availability (°C)', y = 'Jaccard turnover slope') +
  facet_wrap(vars(duration_group), scales = 'free')

```

### Mass
```{r, echo=FALSE, warning = FALSE, message = FALSE}
ggplot(bt[measure == 'Jtu'], aes(mass, disstrend)) +
  geom_point(aes(color = REALM), size = 0.2, alpha = 0.5, na.rm = TRUE) + 
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = "cs"), na.rm = TRUE, color = 'black') +
  scale_color_brewer(palette="Set1") + 
  scale_x_log10() +
  labs(x = 'Mass (g))', y = 'Jaccard turnover slope') +
  facet_wrap(vars(duration_group), scales = 'free')

```

### Endotherms
```{r, echo=FALSE, warning = FALSE, message = FALSE}
ggplot(bt[measure == 'Jtu'], aes(endofrac, disstrend)) +
  geom_point(aes(color = REALM), size = 0.2, alpha = 0.5, na.rm = TRUE) + 
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = "cs", k = 3), na.rm = TRUE, color = 'black') +
  scale_color_brewer(palette="Set1") + 
  labs(x = 'Fraction endotherms', y = 'Jaccard turnover slope') +
  facet_wrap(vars(duration_group), scales = 'free')

```

### Richness
```{r, echo=FALSE, warning = FALSE, message = FALSE}
ggplot(bt[measure == 'Jtu'], aes(Nspp, disstrend)) +
  geom_point(aes(color = REALM), size = 0.2, alpha = 0.5, na.rm = TRUE) + 
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = "cs"), na.rm = TRUE, color = 'black') +
  scale_color_brewer(palette="Set1") + 
  scale_x_log10() +
  labs(x = 'Number of species', y = 'Jaccard turnover slope') +
  facet_wrap(vars(duration_group), scales = 'free')

```

### Thermal bias
```{r, echo=FALSE, warning = FALSE, message = FALSE}
ggplot(bt[measure == 'Jtu'], aes(thermal_bias, disstrend)) +
  geom_point(aes(color = REALM), size = 0.2, alpha = 0.5, na.rm = TRUE) + 
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = "cs"), na.rm = TRUE, color = 'black') +
  scale_color_brewer(palette="Set1") + 
  labs(x = 'Thermal bias (°C)', y = 'Jaccard turnover slope') +
  facet_wrap(vars(duration_group), scales = 'free')

```

### NPP
```{r, echo=FALSE, warning = FALSE, message = FALSE}
ggplot(bt[measure == 'Jtu'], aes(npp, disstrend)) +
  geom_point(aes(color = REALM), size = 0.2, alpha = 0.5, na.rm = TRUE) + 
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = "cs"), na.rm = TRUE, color = 'black') +
  scale_color_brewer(palette="Set1") + 
  scale_x_log10() +
  labs(x = 'Net primary productivity (mg C / m2 / day)', y = 'Jaccard turnover slope') +
  facet_wrap(vars(duration_group), scales = 'free')

```

### Human
```{r, echo=FALSE, warning = FALSE, message = FALSE}
ggplot(bt[measure == 'Jtu'], aes(human_bowler, disstrend, color = REALM)) +
  geom_point(size = 0.2, alpha = 0.5, na.rm = TRUE) + 
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = "cs", k = 5), na.rm = TRUE) +
  scale_color_brewer(palette="Set1") + 
  labs(x = 'Bowler human impact score', y = 'Jaccard turnover slope') +
  facet_wrap(vars(duration_group), scales = 'free')
```





## Jbeta (total)
### Realm
```{r, echo=FALSE, warning = FALSE, message = FALSE}
ggplot(bt[measure == 'Jbeta'], aes(REALM, disstrend)) +
  geom_boxplot(na.rm = TRUE) + 
  labs(x = 'Realm', y = 'Jaccard total slope') +
  facet_wrap(vars(duration_group), scales = 'free')
```

### Temperature trend
```{r, echo=FALSE, warning = FALSE, message = FALSE}
ggplot(bt[measure == 'Jbeta'], aes(temptrend, disstrend)) +
  geom_point(aes(color = REALM), size = 0.2, alpha = 0.5, na.rm = TRUE) + 
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = "cs"), na.rm = TRUE, color = 'black') +
  scale_color_brewer(palette="Set1") + 
  labs(x = 'Temperature trend (°C/yr)', y = 'Jaccard total slope') +
  facet_wrap(vars(duration_group), scales = 'free')

```

### abs(Temperature trend)
```{r, echo=FALSE, warning = FALSE, message = FALSE}
ggplot(bt[measure == 'Jbeta'], aes(abs(temptrend), disstrend)) +
  geom_point(aes(color = REALM), size = 0.2, alpha = 0.5, na.rm = TRUE) + 
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = "cs"), na.rm = TRUE, color = 'black') +
  scale_color_brewer(palette="Set1") + 
  labs(x = 'abs(Temperature trend) (°C/yr)', y = 'Jaccard total slope') +
  facet_wrap(vars(duration_group), scales = 'free')

```

### Temperature
```{r, echo=FALSE, warning = FALSE, message = FALSE}
ggplot(bt[measure == 'Jbeta'], aes(tempave, disstrend)) +
  geom_point(aes(color = REALM), size = 0.2, alpha = 0.5, na.rm = TRUE) + 
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = "cs"), na.rm = TRUE, color = 'black') +
  scale_color_brewer(palette="Set1") + 
  labs(x = 'Temperature (°C)', y = 'Jaccard total slope') +
  facet_wrap(vars(duration_group), scales = 'free')

```

### Metabolic temperature
```{r, echo=FALSE, warning = FALSE, message = FALSE}
ggplot(bt[measure == 'Jbeta'], aes(tempave_metab, disstrend)) +
  geom_point(aes(color = REALM), size = 0.2, alpha = 0.5, na.rm = TRUE) + 
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = "cs"), na.rm = TRUE, color = 'black') +
  scale_color_brewer(palette="Set1") + 
  labs(x = 'Metabolic temperature (°C)', y = 'Jaccard total slope') +
  facet_wrap(vars(duration_group), scales = 'free')

```

### Seasonality
```{r, echo=FALSE, warning = FALSE, message = FALSE}
ggplot(bt[measure == 'Jbeta'], aes(seas, disstrend)) +
  geom_point(aes(color = REALM), size = 0.2, alpha = 0.5, na.rm = TRUE) + 
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = "cs"), na.rm = TRUE, color = 'black') +
  scale_color_brewer(palette="Set1") + 
  labs(x = 'Seasonality (°C)', y = 'Jaccard total slope') +
  facet_wrap(vars(duration_group), scales = 'free')

```

### Microclimate
```{r, echo=FALSE, warning = FALSE, message = FALSE}
ggplot(bt[measure == 'Jbeta'], aes(microclim, disstrend)) +
  geom_point(aes(color = REALM), size = 0.2, alpha = 0.5, na.rm = TRUE) + 
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = "cs"), na.rm = TRUE, color = 'black') +
  scale_color_brewer(palette="Set1") + 
  scale_x_log10() +
  labs(x = 'Microclimate availability (°C)', y = 'Jaccard total slope') +
  facet_wrap(vars(duration_group), scales = 'free')

```

### Mass
```{r, echo=FALSE, warning = FALSE, message = FALSE}
ggplot(bt[measure == 'Jbeta'], aes(mass, disstrend)) +
  geom_point(aes(color = REALM), size = 0.2, alpha = 0.5, na.rm = TRUE) + 
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = "cs"), na.rm = TRUE, color = 'black') +
  scale_color_brewer(palette="Set1") + 
  scale_x_log10() +
  labs(x = 'Mass (g))', y = 'Jaccard total slope') +
  facet_wrap(vars(duration_group), scales = 'free')

```

### Endotherms
```{r, echo=FALSE, warning = FALSE, message = FALSE}
ggplot(bt[measure == 'Jbeta'], aes(endofrac, disstrend)) +
  geom_point(aes(color = REALM), size = 0.2, alpha = 0.5, na.rm = TRUE) + 
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = "cs", k = 3), na.rm = TRUE, color = 'black') +
  scale_color_brewer(palette="Set1") + 
  labs(x = 'Fraction endotherms', y = 'Jaccard total slope') +
  facet_wrap(vars(duration_group), scales = 'free')

```

### Richness
```{r, echo=FALSE, warning = FALSE, message = FALSE}
ggplot(bt[measure == 'Jbeta'], aes(Nspp, disstrend)) +
  geom_point(aes(color = REALM), size = 0.2, alpha = 0.5, na.rm = TRUE) + 
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = "cs"), na.rm = TRUE, color = 'black') +
  scale_color_brewer(palette="Set1") + 
  scale_x_log10() +
  labs(x = 'Number of species', y = 'Jaccard total slope') +
  facet_wrap(vars(duration_group), scales = 'free')

```

### Thermal bias
```{r, echo=FALSE, warning = FALSE, message = FALSE}
ggplot(bt[measure == 'Jbeta'], aes(thermal_bias, disstrend)) +
  geom_point(aes(color = REALM), size = 0.2, alpha = 0.5, na.rm = TRUE) + 
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = "cs"), na.rm = TRUE, color = 'black') +
  scale_color_brewer(palette="Set1") + 
  labs(x = 'Thermal bias (°C)', y = 'Jaccard total slope') +
  facet_wrap(vars(duration_group), scales = 'free')

```

### NPP
```{r, echo=FALSE, warning = FALSE, message = FALSE}
ggplot(bt[measure == 'Jbeta'], aes(npp, disstrend)) +
  geom_point(aes(color = REALM), size = 0.2, alpha = 0.5, na.rm = TRUE) + 
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = "cs"), na.rm = TRUE, color = 'black') +
  scale_color_brewer(palette="Set1") + 
  scale_x_log10() +
  labs(x = 'Net primary productivity (mg C / m2 / day)', y = 'Jaccard total slope') +
  facet_wrap(vars(duration_group), scales = 'free')

```

### Human
```{r, echo=FALSE, warning = FALSE, message = FALSE}
ggplot(bt[measure == 'Jbeta'], aes(human_bowler, disstrend, color = REALM)) +
  geom_point(size = 0.2, alpha = 0.5, na.rm = TRUE) + 
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = "cs", k = 5), na.rm = TRUE) +
  scale_color_brewer(palette="Set1") + 
  labs(x = 'Bowler human impact score', y = 'Jaccard total slope') +
  facet_wrap(vars(duration_group), scales = 'free')
```


## Horn
### Realm
```{r, echo=FALSE, warning = FALSE, message = FALSE}
ggplot(bt[measure == 'Horn'], aes(REALM, disstrend)) +
  geom_boxplot(na.rm = TRUE) + 
  labs(x = 'Realm', y = 'Horn slope') +
  facet_wrap(vars(duration_group), scales = 'free')

```

### Temperature trend
```{r, echo=FALSE, warning = FALSE, message = FALSE}
ggplot(bt[measure == 'Horn'], aes(temptrend, disstrend)) +
  geom_point(aes(color = REALM), size = 0.2, alpha = 0.5, na.rm = TRUE) + 
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = "cs"), na.rm = TRUE, color = 'black') +
  scale_color_brewer(palette="Set1") + 
  labs(x = 'Temperature trend (°C/yr)', y = 'Horn slope') +
  facet_wrap(vars(duration_group), scales = 'free')

```

### abs(Temperature trend)
```{r, echo=FALSE, warning = FALSE, message = FALSE}
ggplot(bt[measure == 'Horn'], aes(abs(temptrend), disstrend)) +
  geom_point(aes(color = REALM), size = 0.2, alpha = 0.5, na.rm = TRUE) + 
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = "cs"), na.rm = TRUE, color = 'black') +
  scale_color_brewer(palette="Set1") + 
  labs(x = 'abs(Temperature trend) (°C/yr)', y = 'Horn slope') +
  facet_wrap(vars(duration_group), scales = 'free')

```

### Temperature
```{r, echo=FALSE, warning = FALSE, message = FALSE}
ggplot(bt[measure == 'Horn'], aes(tempave, disstrend)) +
  geom_point(aes(color = REALM), size = 0.2, alpha = 0.5, na.rm = TRUE) + 
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = "cs"), na.rm = TRUE, color = 'black') +
  scale_color_brewer(palette="Set1") + 
  labs(x = 'Temperature (°C)', y = 'Horn slope') +
  facet_wrap(vars(duration_group), scales = 'free')

```

### Metabolic temperature
```{r, echo=FALSE, warning = FALSE, message = FALSE}
ggplot(bt[measure == 'Horn'], aes(tempave_metab, disstrend)) +
  geom_point(aes(color = REALM), size = 0.2, alpha = 0.5, na.rm = TRUE) + 
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = "cs"), na.rm = TRUE, color = 'black') +
  scale_color_brewer(palette="Set1") + 
  labs(x = 'Metabolic temperature (°C)', y = 'Horn slope') +
  facet_wrap(vars(duration_group), scales = 'free')

```

### Seasonality
```{r, echo=FALSE, warning = FALSE, message = FALSE}
ggplot(bt[measure == 'Horn'], aes(seas, disstrend)) +
  geom_point(aes(color = REALM), size = 0.2, alpha = 0.5, na.rm = TRUE) + 
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = "cs"), na.rm = TRUE, color = 'black') +
  scale_color_brewer(palette="Set1") + 
  labs(x = 'Seasonality (°C)', y = 'Horn slope') +
  facet_wrap(vars(duration_group), scales = 'free')

```

### Microclimates
```{r, echo=FALSE, warning = FALSE, message = FALSE}
ggplot(bt[measure == 'Horn'], aes(microclim, disstrend)) +
  geom_point(aes(color = REALM), size = 0.2, alpha = 0.5, na.rm = TRUE) + 
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = "cs"), na.rm = TRUE, color = 'black') +
  scale_color_brewer(palette="Set1") + 
  scale_x_log10() +
  labs(x = 'Microclimate availability (°C)', y = 'Horn slope') +
  facet_wrap(vars(duration_group), scales = 'free')

```

### Mass
```{r, echo=FALSE, warning = FALSE, message = FALSE}
ggplot(bt[measure == 'Horn'], aes(mass, disstrend)) +
  geom_point(aes(color = REALM), size = 0.2, alpha = 0.5, na.rm = TRUE) + 
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = "cs"), na.rm = TRUE, color = 'black') +
  scale_color_brewer(palette="Set1") + 
  scale_x_log10() +
  labs(x = 'Mass (g))', y = 'Horn slope') +
  facet_wrap(vars(duration_group), scales = 'free')

```

### Endotherms
```{r, echo=FALSE, warning = FALSE, message = FALSE}
ggplot(bt[measure == 'Horn'], aes(endofrac, disstrend)) +
  geom_point(aes(color = REALM), size = 0.2, alpha = 0.5, na.rm = TRUE) + 
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = "cs", k = 3), na.rm = TRUE, color = 'black') +
  scale_color_brewer(palette="Set1") + 
  labs(x = 'Fraction endotherms', y = 'Horn slope') +
  facet_wrap(vars(duration_group), scales = 'free')

```

### Richness
```{r, echo=FALSE, warning = FALSE, message = FALSE}
ggplot(bt[measure == 'Horn'], aes(Nspp, disstrend)) +
  geom_point(aes(color = REALM), size = 0.2, alpha = 0.5, na.rm = TRUE) + 
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = "cs"), na.rm = TRUE, color = 'black') +
  scale_color_brewer(palette="Set1") + 
  scale_x_log10() +
  labs(x = 'Number of species', y = 'Horn slope') +
  facet_wrap(vars(duration_group), scales = 'free')

```

### Thermal bias
```{r, echo=FALSE, warning = FALSE, message = FALSE}
ggplot(bt[measure == 'Horn'], aes(thermal_bias, disstrend)) +
  geom_point(aes(color = REALM), size = 0.2, alpha = 0.5, na.rm = TRUE) + 
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = "cs"), na.rm = TRUE, color = 'black') +
  scale_color_brewer(palette="Set1") + 
  labs(x = 'Thermal bias (°C)', y = 'Horn slope') +
  facet_wrap(vars(duration_group), scales = 'free')

```

### NPP
```{r, echo=FALSE, warning = FALSE, message = FALSE}
ggplot(bt[measure == 'Horn'], aes(npp, disstrend)) +
  geom_point(aes(color = REALM), size = 0.2, alpha = 0.5, na.rm = TRUE) + 
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = "cs"), na.rm = TRUE, color = 'black') +
  scale_color_brewer(palette="Set1") + 
  scale_x_log10() +
  labs(x = 'Net primary productivity (mg C / m2 / day)', y = 'Horn slope') +
  facet_wrap(vars(duration_group), scales = 'free')

```

### Human
```{r, echo=FALSE, warning = FALSE, message = FALSE}
ggplot(bt[measure == 'Horn'], aes(human_bowler, disstrend, color = REALM)) +
  geom_point(size = 0.2, alpha = 0.5, na.rm = TRUE) + 
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = "cs", k = 5), na.rm = TRUE) +
  scale_color_brewer(palette="Set1") + 
  labs(x = 'Bowler human impact score', y = 'Horn slope') +
  facet_wrap(vars(duration_group), scales = 'free')
```

