---
title: "Pairwise dissimilarity covariate data prep and visualization"
output:
  github_document: default
---
Trims based on data quality, separates the data points to use for 3/5/10/20 year comparisons, and adds covariate data.

```{r setup}
library('mgcv', lib.loc = '/usr/lib64/R/library') # when running on Annotate. Need to load 1.8-26, not 1.8-33.
library(data.table)
library(ggplot2)
library(beanplot) # for beanplots
library(gridExtra) # to combine ggplots together
library(grid) # to combine ggplots together
require(scales) # for custom axis scales
require(here)

```

# Load data
```{r load data}
# biotime taxa category and other info
load(here::here('data', 'biotime_blowes', 'bt_malin.Rdata')) # load bt_malin
btinfo <- data.table(bt_malin); rm(bt_malin)
btinfo[, Nave := mean(N), by = rarefyID] # average number of individuals in the timeseries
btinfo <- btinfo[!duplicated(rarefyID), .(rarefyID, rarefyID_x, rarefyID_y, Biome, taxa_mod, Nave, REALM, STUDY_ID)]

# biotime community dissimilarity data
load(here::here('data', 'biotime_blowes', 'all_pairs_beta.Rdata')) # load rarefied_beta_medians
bt <- data.table(rarefied_beta_medians); rm(rarefied_beta_medians)
bt[, year1 := as.numeric(year1)] # not sure why it gets read in as character
bt[, year2 := as.numeric(year2)]
bt[, Horn := 1- Hornsim] # convert similarity to dissimilarity
bt[, Hornsim := NULL]
bt <- merge(bt, btinfo) # add lat/lon and realm

# Temperature average, changes, and seasonality
temperature <- fread(here('output', 'temperature_byrarefyID.csv.gz'))

# microclimates
microclim <- fread(here('output', 'microclimates.csv.gz'), drop = 1)

# NPP
npp <- fread(here('output', 'npplandocean.csv.gz'))

# Body size
bs <- fread(here('output', 'mass_byrarefyID.csv.gz'), drop = 1)
bs[, ':='(STUDY_ID = NULL, REALM = NULL, taxa_mod = NULL)] # remove unnecessary columns 

# Mobility
speed <- fread(here('output', 'speed_byrarefyID.csv.gz'), drop = 1)
speed[, ':='(STUDY_ID = NULL, REALM = NULL, taxa_mod = NULL)] # remove unnecessary columns 

# Lifespan
lsp <- fread(here('output', 'lifespan_byrarefyID.csv.gz'))

# CTI
cti <- fread(here('output', 'cti_byrarefyID.csv.gz'))
    
# consumer vs. producer
consfrac <- fread(here('output', 'consfrac_byrarefyID.csv.gz'))

# richness
rich <- fread(here('output', 'richness_by_rarefyID.csv.gz')) # number of species

# endotherm vs. ectotherm
endofrac <- fread(here('output', 'endofrac_byrarefyID.csv.gz')) # endotherm vs. ectotherm classifications

# human impact
human <- fread(here('output', 'humanimpact_by_rarefyID.csv.gz'))

# %veg
veg <- as.data.table(readRDS(here('output', 'vct_by_rarefyID.rds')))
veg[, veg := (`tree cover % (mean)` + 0.5 * `non-tree veg. % (mean)`)/100] # veg index from 0 (all non-veg) to 1 (all tree). Non-tree veg counts as 0.5.
```


## Add covariates to BT data
```{r add covariate data}
# add covariates
bt <- merge(bt, temperature, all.x = TRUE, by = c('rarefyID', 'year1', 'year2')) # temperature ave, ave metabolic, change, and seasonality
bt <- merge(bt, microclim[, .(rarefyID, microclim = Temp_sd20km)], all.x = TRUE, by = 'rarefyID') # microclimates
bt <- merge(bt, npp, all.x = TRUE, by = 'rarefyID') # npp
bt <- merge(bt, bs[, .(rarefyID, mass_mean_weight, mass_sd_weight)], all.x = TRUE) # body size mass (g)
bt <- merge(bt, speed[, .(rarefyID, speed_mean_weight, speed_sd_weight)], all.x = TRUE) # speed (km/hr)
bt <- merge(bt, lsp[, .(rarefyID, lifespan_mean_weight, lifespan_sd_weight)], all.x = TRUE) # lifespan (yr)
bt <- merge(bt, cti[, .(rarefyID, thermal_bias)], all.x = TRUE) # thermal bias (degC)
bt <- merge(bt, consfrac[, .(rarefyID, consfrac)], all.x = TRUE) # fraction consumers
bt <- merge(bt, rich, all.x = TRUE) # species richness
bt <- merge(bt, endofrac[, .(rarefyID, endofrac)], all.x = TRUE) # endotherm vs. ectotherm
bt <- merge(bt, human[, .(rarefyID, human_bowler = atc, human_venter = hfp, human_halpern = himp)], all.x = TRUE) # human impact
bt <- merge(bt, veg[, .(rarefyID, veg = veg)], all.x = TRUE) # vegetation index
bt[REALM == 'Marine', veg := 0] # veg index is 0 at sea
```



## Trim data
```{r}
cat('original number of rows'); norig <- nrow(bt); norig
# trim out timeseries with too few species
cat('rows with <5 spp'); bt[Nspp < 5 | is.na(Nspp), .N]
bt <- bt[Nspp >= 5, ]
  
# or few individuals
cat('rows with <10 indivs'); bt[Nave < 10, .N]
bt <- bt[Nave >= 10 | is.na(Nave), ]


cat('rows left'); nrow(bt)
cat('fraction kept'); nrow(bt)/norig
cat('number of studies'); bt[, length(unique(STUDY_ID))]
cat('number of timeseries'); bt[, length(unique(rarefyID))]

```

## Choose datasets of the same duration

### Function to choose the data to use within each timeseries
Find the most recent set of consecutive years of duration numyrs
```{r}
# function takes columns of bt. returns a vector of T/F for whether to include a row.
flagbyduration <- function(year1, year2, numyrs){
  yrs <- sort(unique(c(year1, year2)))
  dy <- diff(yrs) # find intervals between years
  rl <- rle(dy) # run length encoding
  end = cumsum(rl$lengths) # find ends of runs of the same year interval
  start = c(1, head(end, -1) + 1) # find starts of runs
  rlkeep <- which(rl$lengths >= numyrs & rl$values == 1) # find runs with desired length and 1 year intervals
  if(length(rlkeep)>0){
    rlkeep <- max(rlkeep) # find the latest run that meets our criteria
    start <- start[rlkeep] # start of this run
    end <- end[rlkeep] # end of this run
    dykeep <- rep(FALSE, length(dy)) # year intervals to keep
    dykeep[start:end] <- TRUE
    yrs2 <- yrs[c(dykeep, FALSE) | c(FALSE, dykeep)] # keep years involved in at least one interval to keep
    maxyr <- max(yrs2)
    yrs3 <- yrs2[yrs2 > maxyr - numyrs] # only use last numyrs years
    
    flag <- year1 %in% yrs3 & year2 %in% yrs3
    return(flag)
  } else{ # didn't find any suitable sequences of years
    flag <- rep(FALSE, length(year1))
    return(flag)
  }

}
```


### Divide into datasets of the same duration
```{r}
# flag rows that fit each study duration
bt[, keep3 := flagbyduration(year1, year2, 3), by = .(rarefyID)]
bt[, keep5 := flagbyduration(year1, year2, 5), by = .(rarefyID)]
bt[, keep10 := flagbyduration(year1, year2, 10), by = .(rarefyID)]
bt[, keep20 := flagbyduration(year1, year2, 20), by = .(rarefyID)]

# divide into separate datasets
bt3 <- bt[keep3 == TRUE,]
bt5 <- bt[keep5 == TRUE,]
bt10 <- bt[keep10 == TRUE,]
bt20 <- bt[keep20 == TRUE,]
```

### Choose the appropriate temperature value for each study and duration
Average temperature for the full duration. Thiel-Sen temperature slope.
```{r}
picklongest <- function(year1, year2, y){
  dy <- year2 - year1
  keep <- which.max(dy)
  return(y[keep])
}

bt3[, tempave := picklongest(year1, year2, tempave), by = rarefyID]
bt3[, tempave_metab := picklongest(year1, year2, tempave_metab), by = rarefyID]
bt3[, tempchange := median(tempchange/(year2 - year1)), by = rarefyID] # Thiel-Sen estimator of the slope: median of all pairwise differences

bt5[, tempave := picklongest(year1, year2, tempave), by = rarefyID]
bt5[, tempave_metab := picklongest(year1, year2, tempave_metab), by = rarefyID]
bt5[, tempchange := median(tempchange/(year2 - year1)), by = rarefyID] # Thiel-Sen estimator of the slope: median of all pairwise differences

bt10[, tempave := picklongest(year1, year2, tempave), by = rarefyID]
bt10[, tempave_metab := picklongest(year1, year2, tempave_metab), by = rarefyID]
bt10[, tempchange := median(tempchange/(year2 - year1)), by = rarefyID] # Thiel-Sen estimator of the slope: median of all pairwise differences

bt20[, tempave := picklongest(year1, year2, tempave), by = rarefyID]
bt20[, tempave_metab := picklongest(year1, year2, tempave_metab), by = rarefyID]
bt20[, tempchange := median(tempchange/(year2 - year1)), by = rarefyID] # Thiel-Sen estimator of the slope: median of all pairwise differences

```

## Set up useful variables and transformations
```{r}
# set realm order
bt3[, REALM := factor(REALM, levels = c('Freshwater', 'Marine', 'Terrestrial'), ordered = FALSE)]
bt5[, REALM := factor(REALM, levels = c('Freshwater', 'Marine', 'Terrestrial'), ordered = FALSE)]
bt10[, REALM := factor(REALM, levels = c('Freshwater', 'Marine', 'Terrestrial'), ordered = FALSE)]
bt20[, REALM := factor(REALM, levels = c('Freshwater', 'Marine', 'Terrestrial'), ordered = FALSE)]

# realm that combines Terrestrial and Freshwater, for interacting with human impact
bt3[, REALM2 := REALM]
levels(bt3$REALM2) = list(TerrFresh = "Freshwater", TerrFresh = "Terrestrial", Marine = "Marine")

bt5[, REALM2 := REALM]
levels(bt5$REALM2) = list(TerrFresh = "Freshwater", TerrFresh = "Terrestrial", Marine = "Marine")

bt10[, REALM2 := REALM]
levels(bt10$REALM2) = list(TerrFresh = "Freshwater", TerrFresh = "Terrestrial", Marine = "Marine")

bt20[, REALM2 := REALM]
levels(bt20$REALM2) = list(TerrFresh = "Freshwater", TerrFresh = "Terrestrial", Marine = "Marine")

# duration
bt3[, duration := year2 - year1]
bt5[, duration := year2 - year1]
bt10[, duration := year2 - year1]
bt20[, duration := year2 - year1]

# group Marine invertebrates/plants in with All
bt3[, taxa_mod2 := taxa_mod]
bt3[taxa_mod == 'Marine invertebrates/plants', taxa_mod2 := 'All']

bt5[, taxa_mod2 := taxa_mod]
bt5[taxa_mod == 'Marine invertebrates/plants', taxa_mod2 := 'All']

bt10[, taxa_mod2 := taxa_mod]
bt10[taxa_mod == 'Marine invertebrates/plants', taxa_mod2 := 'All']

bt20[, taxa_mod2 := taxa_mod]
bt20[taxa_mod == 'Marine invertebrates/plants', taxa_mod2 := 'All']

#######################
## Transformations

### Adjust response away from 0-1
# transformation for 2 categories. Eq. 1 in Douma & Weedon 2019 MEE
transform01 <- function(x) (x * (length(x) - 1) + 0.5) / (length(x))

bt3[, ':='(Jtu.sc = transform01(Jtu), Jbeta.sc = transform01(Jbeta), Horn.sc = transform01(Horn))]
bt5[, ':='(Jtu.sc = transform01(Jtu), Jbeta.sc = transform01(Jbeta), Horn.sc = transform01(Horn))]
bt10[, ':='(Jtu.sc = transform01(Jtu), Jbeta.sc = transform01(Jbeta), Horn.sc = transform01(Horn))]
bt20[, ':='(Jtu.sc = transform01(Jtu), Jbeta.sc = transform01(Jbeta), Horn.sc = transform01(Horn))]


### Log-transform some variables, then center and scale. 
bt3[, ':='(tempave.sc = scale(tempave),
           tempave_metab.sc = scale(tempave_metab),
           seas.sc = scale(seas),
           microclim.sc = scale(log(microclim)),
           tempchange.sc = scale(tempchange, center = TRUE), # do not center
           tempchange_abs.sc = scale(abs(tempchange), center = TRUE), # do not center, so that 0 is still 0 temperature change
           mass.sc = scale(log(mass_mean_weight)),
           speed.sc = scale(log(speed_mean_weight+1)),
           lifespan.sc = scale(log(lifespan_mean_weight)),
           consumerfrac.sc = scale(consfrac),
           endothermfrac.sc = scale(endofrac),
           nspp.sc = scale(log(Nspp)),
           thermal_bias.sc = scale(thermal_bias),
           npp.sc = scale(log(npp)),
           veg.sc = scale(log(veg+1)),
           duration.sc = scale(duration),
           durationlog.sc = scale(log(duration)))]
bt3[, human_bowler.sc := scale(log(human_bowler+1)), by = REALM2] # separate scaling by realm
bt3[REALM2 == 'TerrFresh', human_footprint.sc := scale(log(human_venter+1))]
bt3[REALM2 == 'Marine', human_footprint.sc := scale(log(human_halpern))]

bt5[, ':='(tempave.sc = scale(tempave),
           tempave_metab.sc = scale(tempave_metab),
           seas.sc = scale(seas),
           microclim.sc = scale(log(microclim)),
           tempchange.sc = scale(tempchange, center = TRUE), # do not center
           tempchange_abs.sc = scale(abs(tempchange), center = TRUE), # do not center, so that 0 is still 0 temperature change
           mass.sc = scale(log(mass_mean_weight)),
           speed.sc = scale(log(speed_mean_weight+1)),
           lifespan.sc = scale(log(lifespan_mean_weight)),
           consumerfrac.sc = scale(consfrac),
           endothermfrac.sc = scale(endofrac),
           nspp.sc = scale(log(Nspp)),
           thermal_bias.sc = scale(thermal_bias),
           npp.sc = scale(log(npp)),
           veg.sc = scale(log(veg+1)),
           duration.sc = scale(duration),
           durationlog.sc = scale(log(duration)))]
bt5[, human_bowler.sc := scale(log(human_bowler+1)), by = REALM2] # separate scaling by realm
bt5[REALM2 == 'TerrFresh', human_footprint.sc := scale(log(human_venter+1))]
bt5[REALM2 == 'Marine', human_footprint.sc := scale(log(human_halpern))]

bt10[, ':='(tempave.sc = scale(tempave),
           tempave_metab.sc = scale(tempave_metab),
           seas.sc = scale(seas),
           microclim.sc = scale(log(microclim)),
           tempchange.sc = scale(tempchange, center = TRUE), # do not center
           tempchange_abs.sc = scale(abs(tempchange), center = TRUE), # do not center, so that 0 is still 0 temperature change
           mass.sc = scale(log(mass_mean_weight)),
           speed.sc = scale(log(speed_mean_weight+1)),
           lifespan.sc = scale(log(lifespan_mean_weight)),
           consumerfrac.sc = scale(consfrac),
           endothermfrac.sc = scale(endofrac),
           nspp.sc = scale(log(Nspp)),
           thermal_bias.sc = scale(thermal_bias),
           npp.sc = scale(log(npp)),
           veg.sc = scale(log(veg+1)),
           duration.sc = scale(duration),
           durationlog.sc = scale(log(duration)))]
bt10[, human_bowler.sc := scale(log(human_bowler+1)), by = REALM2] # separate scaling by realm
bt10[REALM2 == 'TerrFresh', human_footprint.sc := scale(log(human_venter+1))]
bt10[REALM2 == 'Marine', human_footprint.sc := scale(log(human_halpern))]

bt20[, ':='(tempave.sc = scale(tempave),
           tempave_metab.sc = scale(tempave_metab),
           seas.sc = scale(seas),
           microclim.sc = scale(log(microclim)),
           tempchange.sc = scale(tempchange, center = TRUE), # do not center
           tempchange_abs.sc = scale(abs(tempchange), center = TRUE), # do not center, so that 0 is still 0 temperature change
           mass.sc = scale(log(mass_mean_weight)),
           speed.sc = scale(log(speed_mean_weight+1)),
           lifespan.sc = scale(log(lifespan_mean_weight)),
           consumerfrac.sc = scale(consfrac),
           endothermfrac.sc = scale(endofrac),
           nspp.sc = scale(log(Nspp)),
           thermal_bias.sc = scale(thermal_bias),
           npp.sc = scale(log(npp)),
           veg.sc = scale(log(veg+1)),
           duration.sc = scale(duration),
           durationlog.sc = scale(log(duration)))]
bt20[, human_bowler.sc := scale(log(human_bowler+1)), by = REALM2] # separate scaling by realm
bt20[REALM2 == 'TerrFresh', human_footprint.sc := scale(log(human_venter+1))]
bt20[REALM2 == 'Marine', human_footprint.sc := scale(log(human_halpern))]


## save the centering and scaling
scaling3 <- data.frame(center = t(t(sapply(bt3, attr, 'scaled:center'))),
                 scale = t(t(sapply(bt3, attr, 'scaled:scale'))))
scaling3$var <- rownames(scaling3)
scaling3 <- scaling3[!vapply(scaling3$center, is.null, TRUE) | !vapply(scaling3$scale, is.null, TRUE),]
scaling3$center[vapply(scaling3$center, is.null, TRUE)] <- NA # turn null to NA
scaling3$center <- vapply(scaling3$center, paste, collapse = ", ", character(1L)) # flatten list to character. not sure why it's a list.
scaling3$scale <- vapply(scaling3$scale, paste, collapse = ", ", character(1L))

scaling5 <- data.frame(center = t(t(sapply(bt3, attr, 'scaled:center'))),
                 scale = t(t(sapply(bt3, attr, 'scaled:scale'))))
scaling5$var <- rownames(scaling5)
scaling5 <- scaling5[!vapply(scaling5$center, is.null, TRUE) | !vapply(scaling5$scale, is.null, TRUE),]
scaling5$center[vapply(scaling5$center, is.null, TRUE)] <- NA # turn null to NA
scaling5$center <- vapply(scaling5$center, paste, collapse = ", ", character(1L)) # flatten list to character. not sure why it's a list.
scaling5$scale <- vapply(scaling5$scale, paste, collapse = ", ", character(1L))

scaling10 <- data.frame(center = t(t(sapply(bt3, attr, 'scaled:center'))),
                 scale = t(t(sapply(bt3, attr, 'scaled:scale'))))
scaling10$var <- rownames(scaling10)
scaling10 <- scaling10[!vapply(scaling10$center, is.null, TRUE) | !vapply(scaling10$scale, is.null, TRUE),]
scaling10$center[vapply(scaling10$center, is.null, TRUE)] <- NA # turn null to NA
scaling10$center <- vapply(scaling10$center, paste, collapse = ", ", character(1L)) # flatten list to character. not sure why it's a list.
scaling10$scale <- vapply(scaling10$scale, paste, collapse = ", ", character(1L))

scaling20 <- data.frame(center = t(t(sapply(bt3, attr, 'scaled:center'))),
                 scale = t(t(sapply(bt3, attr, 'scaled:scale'))))
scaling20$var <- rownames(scaling20)
scaling20 <- scaling20[!vapply(scaling20$center, is.null, TRUE) | !vapply(scaling20$scale, is.null, TRUE),]
scaling20$center[vapply(scaling20$center, is.null, TRUE)] <- NA # turn null to NA
scaling20$center <- vapply(scaling20$center, paste, collapse = ", ", character(1L)) # flatten list to character. not sure why it's a list.
scaling20$scale <- vapply(scaling20$scale, paste, collapse = ", ", character(1L))

## save the transformations just entered above
scaling3$log <- FALSE # whether variable was log-transformed before scaling
scaling3$log[scaling3$var %in% c('microclim.sc', 'mass.sc', 'speed.sc', 'lifepsan.sc', 'nspp.sc', 'npp.sc', 'veg.sc', 'duration.sc', 'durationlog.sc', 'human_bowler.sc', 'human_footprint.sc')] <- TRUE
scaling3$plus <- 0 # whether anything was added to the variable before logtransforming
scaling3$plus[scaling3$var %in% c('speed.sc', 'veg.sc', 'human_bowler.sc')] <- 1

scaling5$log <- FALSE # whether variable was log-transformed before scaling
scaling5$log[scaling5$var %in% c('microclim.sc', 'mass.sc', 'speed.sc', 'lifepsan.sc', 'nspp.sc', 'npp.sc', 'veg.sc', 'duration.sc', 'durationlog.sc', 'human_bowler.sc', 'human_footprint.sc')] <- TRUE
scaling5$plus <- 0 # whether anything was added to the variable before logtransforming
scaling5$plus[scaling5$var %in% c('speed.sc', 'veg.sc', 'human_bowler.sc')] <- 1

scaling10$log <- FALSE # whether variable was log-transformed before scaling
scaling10$log[scaling10$var %in% c('microclim.sc', 'mass.sc', 'speed.sc', 'lifepsan.sc', 'nspp.sc', 'npp.sc', 'veg.sc', 'duration.sc', 'durationlog.sc', 'human_bowler.sc', 'human_footprint.sc')] <- TRUE
scaling10$plus <- 0 # whether anything was added to the variable before logtransforming
scaling10$plus[scaling10$var %in% c('speed.sc', 'veg.sc', 'human_bowler.sc')] <- 1

scaling20$log <- FALSE # whether variable was log-transformed before scaling
scaling20$log[scaling20$var %in% c('microclim.sc', 'mass.sc', 'speed.sc', 'lifepsan.sc', 'nspp.sc', 'npp.sc', 'veg.sc', 'duration.sc', 'durationlog.sc', 'human_bowler.sc', 'human_footprint.sc')] <- TRUE
scaling20$plus <- 0 # whether anything was added to the variable before logtransforming
scaling20$plus[scaling20$var %in% c('speed.sc', 'veg.sc', 'human_bowler.sc')] <- 1

```

## Dataset sizes
```{r}
bt3[, .N]
bt5[, .N]
bt10[, .N]
bt20[, .N]

bt3[, length(unique(STUDY_ID)), by = REALM]
bt5[, length(unique(STUDY_ID)), by = REALM]
bt10[, length(unique(STUDY_ID)), by = REALM]
bt20[, length(unique(STUDY_ID)), by = REALM]

bt3[, length(unique(rarefyID)), by = REALM]
bt5[, length(unique(rarefyID)), by = REALM]
bt10[, length(unique(rarefyID)), by = REALM]
bt20[, length(unique(rarefyID)), by = REALM]
```


## Write out
Only if file doesn't yet exist
```{r write out}
if(!file.exists(here('output', 'turnover_w_covariates3.csv.gz'))){
  write.csv(bt3[,.(STUDY_ID, rarefyID, REALM, Biome, taxa_mod, taxa_mod2, year1, year2, duration, Jtu.sc, Jbeta.sc, Horn.sc, 
                  tempave.sc, tempave_metab.sc, seas.sc, 
                  microclim.sc, tempchange, tempchange.sc, tempchange_abs.sc,
                  mass.sc, speed.sc, lifespan.sc, consumerfrac.sc, endothermfrac.sc, nspp.sc, thermal_bias.sc, npp.sc, veg.sc,
                  duration.sc, durationlog.sc, human_bowler.sc, REALM2)], 
            gzfile(here('output', 'turnover_w_covariates3.csv.gz')), row.names = FALSE)
  write.csv(scaling3, here('output','turnover_w_covariates_scaling3.csv'), row.names = FALSE)
}

if(!file.exists(here('output', 'turnover_w_covariates5.csv.gz'))){
  write.csv(bt5[,.(STUDY_ID, rarefyID, REALM, Biome, taxa_mod, taxa_mod2, year1, year2, duration, Jtu.sc, Jbeta.sc, Horn.sc, 
                  tempave.sc, tempave_metab.sc, seas.sc, 
                  microclim.sc, tempchange, tempchange.sc, tempchange_abs.sc,
                  mass.sc, speed.sc, lifespan.sc, consumerfrac.sc, endothermfrac.sc, nspp.sc, thermal_bias.sc, npp.sc, veg.sc,
                  duration.sc, durationlog.sc, human_bowler.sc, REALM2)], 
            gzfile(here('output', 'turnover_w_covariates5.csv.gz')), row.names = FALSE)
  write.csv(scaling5, here('output','turnover_w_covariates_scaling5.csv'), row.names = FALSE)
}

if(!file.exists(here('output', 'turnover_w_covariates10.csv.gz'))){
  write.csv(bt10[,.(STUDY_ID, rarefyID, REALM, Biome, taxa_mod, taxa_mod2, year1, year2, duration, Jtu.sc, Jbeta.sc, Horn.sc, 
                  tempave.sc, tempave_metab.sc, seas.sc, 
                  microclim.sc, tempchange, tempchange.sc, tempchange_abs.sc,
                  mass.sc, speed.sc, lifespan.sc, consumerfrac.sc, endothermfrac.sc, nspp.sc, thermal_bias.sc, npp.sc, veg.sc,
                  duration.sc, durationlog.sc, human_bowler.sc, REALM2)], 
            gzfile(here('output', 'turnover_w_covariates10.csv.gz')), row.names = FALSE)
  write.csv(scaling10, here('output','turnover_w_covariates_scaling10.csv'), row.names = FALSE)
}

if(!file.exists(here('output', 'turnover_w_covariates20.csv.gz'))){
  write.csv(bt20[,.(STUDY_ID, rarefyID, REALM, Biome, taxa_mod, taxa_mod2, year1, year2, duration, Jtu.sc, Jbeta.sc, Horn.sc, 
                  tempave.sc, tempave_metab.sc, seas.sc, 
                  microclim.sc, tempchange, tempchange.sc, tempchange_abs.sc,
                  mass.sc, speed.sc, lifespan.sc, consumerfrac.sc, endothermfrac.sc, nspp.sc, thermal_bias.sc, npp.sc, veg.sc,
                  duration.sc, durationlog.sc, human_bowler.sc, REALM2)], 
            gzfile(here('output', 'turnover_w_covariates20.csv.gz')), row.names = FALSE)
  write.csv(scaling20, here('output','turnover_w_covariates_scaling20.csv'), row.names = FALSE)
}

```



# A bit more prep for visualizing covariate distributions
## Make a data.table summarized by rarefyID
```{r summarize by rarefyID}
# function for returning the slope of a regression and catching errors related to NAs
lmNAcoef <- function(y, x){
  if(sum(!is.na(y)) > 1){ # if enough data points to calculate a slope
    b <- coef(lm(y ~ x))[2]
    return(b)
  } else {
    return(NA_real_)
  }
}
btave3 <- bt3[, .(Jtuslope = lmNAcoef(Jtu, duration), Jbetaslope = lmNAcoef(Jbeta, duration), Hornslope = lmNAcoef(Horn, duration), 
                  minyrBT = min(year1), maxyrBT = max(year2), nyrBT = length(Jtu) + 1,
                  REALM = unique(REALM), REALM2 = unique(REALM2), rarefyID_y = mean(rarefyID_y),
                  tempchange = mean(tempchange), tempave = mean(tempave),
                  tempave_metab = mean(tempave_metab), seas = mean(seas), microclim = mean(microclim),
                  mass_mean_weight = mean(mass_mean_weight), speed_mean_weight = mean(speed_mean_weight),
                  lifespan_mean_weight = mean(lifespan_mean_weight), consfrac = mean(consfrac),
                  endofrac = mean(endofrac), Nspp = mean(Nspp), thermal_bias = mean(thermal_bias),
                  npp = mean(npp), veg = mean(veg), human_bowler = mean(human_bowler),
                  human_venter = mean(human_venter), human_halpern = mean(human_halpern),
                  tempave.sc = mean(tempave.sc), tempave_metab.sc = mean(tempave_metab.sc), 
                  tempchange.sc = mean(tempchange.sc), tempchange_abs.sc = mean(tempchange_abs.sc),
                  seas.sc = mean(seas.sc), microclim.sc = mean(microclim.sc),
                  mass.sc = mean(mass.sc), speed.sc = mean(speed.sc), lifespan.sc = mean(lifespan.sc),
                  consumerfrac.sc = mean(consumerfrac.sc), endothermfrac.sc = mean(endothermfrac.sc),
                  nspp.sc = mean(nspp.sc), thermal_bias.sc = mean(thermal_bias.sc),
                  npp.sc = mean(npp.sc), veg.sc = mean(veg.sc), human_bowler.sc = mean(human_bowler.sc),
                  human_footprint.sc = mean(human_footprint.sc)),
              by = rarefyID]

btave5 <- bt5[, .(Jtuslope = lmNAcoef(Jtu, duration), Jbetaslope = lmNAcoef(Jbeta, duration), Hornslope = lmNAcoef(Horn, duration), 
                  minyrBT = min(year1), maxyrBT = max(year2), nyrBT = length(Jtu) + 1,
                  REALM = unique(REALM), REALM2 = unique(REALM2), rarefyID_y = mean(rarefyID_y),
                  tempchange = mean(tempchange), tempave = mean(tempave),
                  tempave_metab = mean(tempave_metab), seas = mean(seas), microclim = mean(microclim),
                  mass_mean_weight = mean(mass_mean_weight), speed_mean_weight = mean(speed_mean_weight),
                  lifespan_mean_weight = mean(lifespan_mean_weight), consfrac = mean(consfrac),
                  endofrac = mean(endofrac), Nspp = mean(Nspp), thermal_bias = mean(thermal_bias),
                  npp = mean(npp), veg = mean(veg), human_bowler = mean(human_bowler),
                  human_venter = mean(human_venter), human_halpern = mean(human_halpern),
                  tempave.sc = mean(tempave.sc), tempave_metab.sc = mean(tempave_metab.sc), 
                  tempchange.sc = mean(tempchange.sc), tempchange_abs.sc = mean(tempchange_abs.sc),
                  seas.sc = mean(seas.sc), microclim.sc = mean(microclim.sc),
                  mass.sc = mean(mass.sc), speed.sc = mean(speed.sc), lifespan.sc = mean(lifespan.sc),
                  consumerfrac.sc = mean(consumerfrac.sc), endothermfrac.sc = mean(endothermfrac.sc),
                  nspp.sc = mean(nspp.sc), thermal_bias.sc = mean(thermal_bias.sc),
                  npp.sc = mean(npp.sc), veg.sc = mean(veg.sc), human_bowler.sc = mean(human_bowler.sc),
                  human_footprint.sc = mean(human_footprint.sc)),
              by = rarefyID]

btave10 <- bt10[, .(Jtuslope = lmNAcoef(Jtu, duration), Jbetaslope = lmNAcoef(Jbeta, duration), Hornslope = lmNAcoef(Horn, duration), 
                    minyrBT = min(year1), maxyrBT = max(year2), nyrBT = length(Jtu) + 1,
                    REALM = unique(REALM), REALM2 = unique(REALM2), rarefyID_y = mean(rarefyID_y),
                    tempchange = mean(tempchange), tempave = mean(tempave),
                    tempave_metab = mean(tempave_metab), seas = mean(seas), microclim = mean(microclim),
                    mass_mean_weight = mean(mass_mean_weight), speed_mean_weight = mean(speed_mean_weight),
                    lifespan_mean_weight = mean(lifespan_mean_weight), consfrac = mean(consfrac),
                    endofrac = mean(endofrac), Nspp = mean(Nspp), thermal_bias = mean(thermal_bias),
                    npp = mean(npp), veg = mean(veg), human_bowler = mean(human_bowler),
                    human_venter = mean(human_venter), human_halpern = mean(human_halpern),
                    tempave.sc = mean(tempave.sc), tempave_metab.sc = mean(tempave_metab.sc), 
                    tempchange.sc = mean(tempchange.sc), tempchange_abs.sc = mean(tempchange_abs.sc),
                    seas.sc = mean(seas.sc), microclim.sc = mean(microclim.sc),
                    mass.sc = mean(mass.sc), speed.sc = mean(speed.sc), lifespan.sc = mean(lifespan.sc),
                    consumerfrac.sc = mean(consumerfrac.sc), endothermfrac.sc = mean(endothermfrac.sc),
                    nspp.sc = mean(nspp.sc), thermal_bias.sc = mean(thermal_bias.sc),
                    npp.sc = mean(npp.sc), veg.sc = mean(veg.sc), human_bowler.sc = mean(human_bowler.sc),
                    human_footprint.sc = mean(human_footprint.sc)),
                by = rarefyID]

btave20 <- bt20[, .(Jtuslope = lmNAcoef(Jtu, duration), Jbetaslope = lmNAcoef(Jbeta, duration), Hornslope = lmNAcoef(Horn, duration), 
                    minyrBT = min(year1), maxyrBT = max(year2), nyrBT = length(Jtu) + 1,
                    REALM = unique(REALM), REALM2 = unique(REALM2), rarefyID_y = mean(rarefyID_y),
                    tempchange = mean(tempchange), tempave = mean(tempave),
                    tempave_metab = mean(tempave_metab), seas = mean(seas), microclim = mean(microclim),
                    mass_mean_weight = mean(mass_mean_weight), speed_mean_weight = mean(speed_mean_weight),
                    lifespan_mean_weight = mean(lifespan_mean_weight), consfrac = mean(consfrac),
                    endofrac = mean(endofrac), Nspp = mean(Nspp), thermal_bias = mean(thermal_bias),
                    npp = mean(npp), veg = mean(veg), human_bowler = mean(human_bowler),
                    human_venter = mean(human_venter), human_halpern = mean(human_halpern),
                    tempave.sc = mean(tempave.sc), tempave_metab.sc = mean(tempave_metab.sc), 
                    tempchange.sc = mean(tempchange.sc), tempchange_abs.sc = mean(tempchange_abs.sc),
                    seas.sc = mean(seas.sc), microclim.sc = mean(microclim.sc),
                    mass.sc = mean(mass.sc), speed.sc = mean(speed.sc), lifespan.sc = mean(lifespan.sc),
                    consumerfrac.sc = mean(consumerfrac.sc), endothermfrac.sc = mean(endothermfrac.sc),
                    nspp.sc = mean(nspp.sc), thermal_bias.sc = mean(thermal_bias.sc),
                    npp.sc = mean(npp.sc), veg.sc = mean(veg.sc), human_bowler.sc = mean(human_bowler.sc),
                    human_footprint.sc = mean(human_footprint.sc)),
                by = rarefyID]
```



# Check variable distributions
## Response variables
```{r histograms response}
bt3[, summary(Jbeta)]
bt3[, summary(Jtu)]
bt3[, summary(Horn)]

# fraction 0 or 1
bt3[, sum(Jbeta == 0)/.N]
bt3[, sum(Jtu == 0)/.N]
bt3[!is.na(Horn), sum(Horn == 0)/.N]

bt3[, sum(Jbeta == 1)/.N]
bt3[, sum(Jtu == 1)/.N]
bt3[!is.na(Horn), sum(Horn == 1)/.N]

# histograms
invisible(bt3[, hist(Jbeta, main = 'Jaccard total 3 yr', breaks = 80)])
invisible(bt3[, hist(Jtu, main = 'Jaccard turnover 3 yr', breaks = 80)])
invisible(bt3[, hist(Horn, main = 'Morisita-Horn 3 yr', breaks = 80)])

invisible(bt5[, hist(Jbeta, main = 'Jaccard total 5 yr', breaks = 80)])
invisible(bt5[, hist(Jtu, main = 'Jaccard turnover 5 yr', breaks = 80)])
invisible(bt5[, hist(Horn, main = 'Morisita-Horn 5 yr', breaks = 80)])

invisible(bt10[, hist(Jbeta, main = 'Jaccard total 10 yr', breaks = 80)])
invisible(bt10[, hist(Jtu, main = 'Jaccard turnover 10 yr', breaks = 80)])
invisible(bt10[, hist(Horn, main = 'Morisita-Horn 10 yr', breaks = 80)])

invisible(bt20[, hist(Jbeta, main = 'Jaccard total 20 yr', breaks = 80)])
invisible(bt20[, hist(Jtu, main = 'Jaccard turnover 20 yr', breaks = 80)])
invisible(bt20[, hist(Horn, main = 'Morisita-Horn 20 yr', breaks = 80)])

```

## Unscaled covariates
```{r histograms unscaled, fig.height = 9}
# histograms to examine
cexmain = 0.6
par(mfrow = c(5,4))
invisible(btave3[, hist(minyrBT, main = 'Start year', cex.main = cexmain)])
invisible(btave3[, hist(maxyrBT - minyrBT, main = 'Duration (years)', cex.main = cexmain)])
invisible(btave3[, hist(nyrBT, main = 'Number of sampled years', cex.main = cexmain)])
invisible(btave3[, hist(mass_mean_weight, main = 'Mass (g)', cex.main = cexmain)])
invisible(btave3[, hist(speed_mean_weight, main = 'Speed (km/hr)', cex.main = cexmain)])
invisible(btave3[, hist(lifespan_mean_weight, main = 'Lifespan (yr)', cex.main = cexmain)])
invisible(btave3[, hist(tempave_metab, main = 'Metabolic temperature (°C)', cex.main = cexmain)])
invisible(btave3[, hist(consfrac, main = 'Consumers (fraction)', cex.main = cexmain)])
invisible(btave3[, hist(endofrac, main = 'Endotherms (fraction)', cex.main = cexmain)])
invisible(btave3[, hist(tempave, main = 'Environmental temperature (°C)', cex.main = cexmain)])
invisible(btave3[, hist(tempchange, main = 'Temperature trend (°C/yr)', cex.main = cexmain)]) # all the raw data
invisible(btave3[, hist(seas, main = 'Seasonality (°C)', cex.main = cexmain)])
invisible(btave3[, hist(microclim, main = 'Microclimates (°C)', cex.main = cexmain)])
invisible(btave3[, hist(Nspp, main = 'Species richness', cex.main = cexmain)])
invisible(btave3[, hist(thermal_bias, main = 'Thermal bias (°C)', cex.main = cexmain)])
invisible(btave3[, hist(npp, main = 'Net primary productivity', cex.main = cexmain)])
invisible(btave3[, hist(veg, main = 'Vegetation index', cex.main = cexmain)])
invisible(btave3[, hist(human_bowler, main = 'Human impact score (Bowler)', cex.main = cexmain)])
invisible(btave3[, hist(human_venter, main = 'Human impact score (Venter)', cex.main = cexmain)])
invisible(btave3[, hist(human_halpern, main = 'Human impact score (Halpern)', cex.main = cexmain)])

```

## Scaled covariates
```{r histograms scaled, fig.height = 9}
# histograms to examine
cexmain = 0.6
par(mfrow = c(5,4))
invisible(btave3[, hist(tempave.sc, main = 'Environmental temperature (°C)', cex.main = cexmain)])
invisible(btave3[, hist(tempave_metab.sc, main = 'Metabolic temperature (°C)', cex.main = cexmain)])
invisible(btave3[, hist(seas.sc, main = 'Seasonality (°C)', cex.main = cexmain)])
invisible(btave3[, hist(microclim.sc, main = 'log Microclimates (°C)', cex.main = cexmain)])
invisible(btave3[, hist(tempchange.sc, main = 'Temperature trend (°C/yr)', cex.main = cexmain)])
invisible(btave3[, hist(tempchange_abs.sc, main = 'abs(Temperature trend) (°C/yr)', cex.main = cexmain)])
invisible(btave3[, hist(mass.sc, main = 'log Mass (g)', cex.main = cexmain)])
invisible(btave3[, hist(speed.sc, main = 'log Speed (km/hr)', cex.main = cexmain)])
invisible(btave3[, hist(lifespan.sc, main = 'log Lifespan (yr)', cex.main = cexmain)])
invisible(btave3[, hist(consumerfrac.sc, main = 'Consumers (fraction)', cex.main = cexmain)])
invisible(btave3[, hist(endothermfrac.sc, main = 'Endotherms (fraction)', cex.main = cexmain)])
invisible(btave3[, hist(nspp.sc, main = 'log Species richness', cex.main = cexmain)])
invisible(btave3[, hist(thermal_bias.sc, main = 'Thermal bias (°C)', cex.main = cexmain)])
invisible(btave3[, hist(npp.sc, main = 'log Net primary productivity', cex.main = cexmain)])
invisible(btave3[, hist(veg.sc, main = 'log Vegetation index', cex.main = cexmain)])
invisible(btave3[, hist(human_bowler.sc, main = 'log Human impact score (Bowler)', cex.main = cexmain)])
invisible(btave3[, hist(human_footprint.sc, main = 'log Human impact score (Venter & Halpern)', cex.main = cexmain)])

```



# Check correlations among variables 
Pearson's r is in the lower triangle
```{r pairs, fig.height=10, fig.width=10}
panel.cor <- function(x, y, digits = 2, prefix = "", cex.cor, ...)
{
    usr <- par("usr"); on.exit(par(usr))
    par(usr = c(0, 1, 0, 1))
    r <- cor(x, y, use = 'pairwise.complete.obs')
    txt <- format(c(r, 0.123456789), digits = digits)[1]
    txt <- paste0(prefix, txt)
    if(missing(cex.cor)) cex.cor <- 0.8/strwidth(txt)
    text(0.5, 0.5, txt) #, cex = cex.cor * r)
}
pairs(formula = ~ tempave.sc + tempave_metab.sc + seas.sc + microclim.sc + tempchange.sc + tempchange_abs.sc + mass.sc + speed.sc + lifespan.sc + consumerfrac.sc + endothermfrac.sc + nspp.sc + thermal_bias.sc + npp.sc + veg.sc + human_bowler.sc + human_footprint.sc, data = btave3, gap = 1/10, cex = 0.2, col = '#00000022', lower.panel = panel.cor)

pairs(formula = ~ tempave.sc + tempave_metab.sc + seas.sc + microclim.sc + tempchange.sc + tempchange_abs.sc + mass.sc + speed.sc + lifespan.sc + consumerfrac.sc + endothermfrac.sc + nspp.sc + thermal_bias.sc + npp.sc + veg.sc + human_bowler.sc + human_footprint.sc, data = btave20, gap = 1/10, cex = 0.2, col = '#00000022', lower.panel = panel.cor)

```

- Mass and lifespan look tightly correlated, but r only 0.56...?
- Tempave_metab and lifespan don't look tightly correlated, but r= -0.81 
- Tempave_metab and speed don't look tightly correlated, but r= -0.83 
- Lifespan and speed don't look tightly correlated, but r = 0.73

# Compare covariates across realms
```{r compare across realms, fig.height=12, fig.width=9}
par(mfrow=c(5,3))
beanplot(rarefyID_y ~ REALM, data = btave3, what = c(1,1,1,1), col = c("#CAB2D6", "#33A02C", "#B2DF8A"), border = "#CAB2D6", ylab = 'Latitude (degN)', ll = 0.05)
beanplot(tempave ~ REALM, data = btave3, what = c(1,1,1,1), col = c("#CAB2D6", "#33A02C", "#B2DF8A"), border = "#CAB2D6", ylab = 'Temperature (degC)', ll = 0.05)
beanplot(tempave_metab ~ REALM, data = btave3, what = c(1,1,1,1), col = c("#CAB2D6", "#33A02C", "#B2DF8A"), border = "#CAB2D6", ylab = 'Metabolic Temperature (degC)', ll = 0.05, bw = 'nrd0') # nrd0 bandwidth to calculation gap
beanplot(seas ~ REALM, data = btave3, what = c(1,1,1,1), col = c("#CAB2D6", "#33A02C", "#B2DF8A"), border = "#CAB2D6", ylab = 'Seasonality (degC)', ll = 0.05)
beanplot(microclim ~ REALM, data = btave3, what = c(1,1,1,1), col = c("#CAB2D6", "#33A02C", "#B2DF8A"), border = "#CAB2D6", ylab = 'Microclimates (degC)', ll = 0.05)
beanplot(tempchange ~ REALM, data = btave3, what = c(1,1,1,1), col = c("#CAB2D6", "#33A02C", "#B2DF8A"), border = "#CAB2D6", ylab = 'Temperature change (degC)', ll = 0.05)
beanplot(mass_mean_weight ~ REALM, data = btave3, what = c(1,1,1,1), col = c("#CAB2D6", "#33A02C", "#B2DF8A"), border = "#CAB2D6", ylab = 'Mass (g)', ll = 0.05, log = 'y')
beanplot(speed_mean_weight +1 ~ REALM, data = btave3, what = c(1,1,1,1), col = c("#CAB2D6", "#33A02C", "#B2DF8A"), border = "#CAB2D6", ylab = 'Speed (km/hr)', ll = 0.05, log = 'y')
beanplot(lifespan_mean_weight ~ REALM, data = btave3, what = c(1,1,1,1), col = c("#CAB2D6", "#33A02C", "#B2DF8A"), border = "#CAB2D6", ylab = 'Lifespan (yr)', ll = 0.05, log = 'y')
#beanplot(consfrac ~ REALM, data = btave3, what = c(1,1,1,1), col = c("#CAB2D6", "#33A02C", "#B2DF8A"), border = "#CAB2D6", ylab = 'Consumers (fraction)', ll = 0.05, log = '') # too sparse
#beanplot(endofrac ~ REALM, data = btave3, what = c(1,1,1,1), col = c("#CAB2D6", "#33A02C", "#B2DF8A"), border = "#CAB2D6", ylab = 'Endotherms (fraction)', ll = 0.05, log = '') # too sparse
beanplot(Nspp ~ REALM, data = btave3, what = c(1,1,1,1), col = c("#CAB2D6", "#33A02C", "#B2DF8A"), border = "#CAB2D6", ylab = 'Number of species', ll = 0.05, log = 'y')
beanplot(thermal_bias ~ REALM, data = btave3[!is.na(thermal_bias),], what = c(1,1,1,1), col = c("#CAB2D6", "#33A02C", "#B2DF8A"), border = "#CAB2D6", ylab = 'Thermal bias (degC)', ll = 0.05)
beanplot(npp ~ REALM, data = btave3, what = c(1,1,1,1), col = c("#CAB2D6", "#33A02C", "#B2DF8A"), border = "#CAB2D6", ylab = 'NPP', ll = 0.05)
beanplot(veg ~ REALM, data = btave3[REALM !='Marine',], what = c(1,1,1,1), col = c("#CAB2D6", "#33A02C", "#B2DF8A"), border = "#CAB2D6", ylab = 'veg', ll = 0.05)

```

- Marine are in generally warmer locations (seawater doesn't freeze)
- Marine have much lower seasonality.
- Marine and freshwater have some very small masses (plankton), but much of dataset is similar to terrestrial.
- Marine has a lot of slow, crawling organisms, but land has plants. Land also has birds (fast).

# Frequency of time differences
```{r plot time differences}
invisible(bt3[, hist(year2 - year1, breaks = seq(0.5, 20.5, by = 1))])
invisible(bt5[, hist(year2 - year1, breaks = seq(0.5, 20.5, by = 1))])
invisible(bt10[, hist(year2 - year1, breaks = seq(0.5, 20.5, by = 1))])
invisible(bt20[, hist(year2 - year1, breaks = seq(0.5, 20.5, by = 1))])
```

# Plot dissimilarity vs. time
## Jaccard turnover
```{r plot diss vs time, echo=FALSE, fig.height = 3, fig.width = 11}
p1 <- ggplot(bt3, aes(duration, Jtu, color = REALM)) +
  geom_point(size = 0.2, alpha = 0.5, na.rm = TRUE) + 
  scale_color_brewer(palette="Set1") + 
  labs(x = 'Years', y = 'Jaccard turnover')

p2 <- ggplot(bt5, aes(duration, Jtu, color = REALM)) +
  geom_point(size = 0.2, alpha = 0.5, na.rm = TRUE) + 
  geom_smooth(method = 'gam', formula = y ~ s(x, k = 3), na.rm = TRUE) +
  scale_color_brewer(palette="Set1") + 
  labs(x = 'Years', y = 'Jaccard turnover')

p3 <- ggplot(bt10, aes(duration, Jtu, color = REALM)) +
  geom_point(size = 0.2, alpha = 0.5, na.rm = TRUE) + 
  geom_smooth(method = 'gam', formula = y ~ s(x, k = 5), na.rm = TRUE) +
  scale_color_brewer(palette="Set1") + 
  labs(x = 'Years', y = 'Jaccard turnover')

p4 <- ggplot(bt20, aes(duration, Jtu, color = REALM)) +
  geom_point(size = 0.2, alpha = 0.5, na.rm = TRUE) + 
  geom_smooth(method = 'gam', formula = y ~ s(x, k = 5), na.rm = TRUE) +
  scale_color_brewer(palette="Set1") + 
  labs(x = 'Years', y = 'Jaccard turnover')

grid.arrange(p1, p2, p3, p4, ncol = 2)
```

# Plot slope vs. explanatory variables
## Each variable individually
Lines are ggplot smoother fits
Just Jtu for now, slope within rarefyID for btave3
```{r plot diss v explanatory vars, echo=FALSE, warning = FALSE, message = FALSE, fig.height = 16, fig.width = 9}
p1 <- ggplot(btave3, aes(REALM, Jtuslope)) +
  geom_boxplot(na.rm = TRUE) + 
  labs(x = 'Realm', y = 'Jaccard slope')

p2 <- ggplot(btave3, aes(tempave, Jtuslope)) +
  geom_point(aes(color = REALM), size = 0.2, alpha = 0.5, na.rm = TRUE) + 
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = "cs"), na.rm = TRUE, color = 'black') +
  scale_color_brewer(palette="Set1") + 
  labs(x = 'Temperature (°C)', y = 'Jaccard slope')

p3 <- ggplot(btave3, aes(tempave_metab, Jtuslope)) +
  geom_point(aes(color = REALM), size = 0.2, alpha = 0.5, na.rm = TRUE) + 
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = "cs"), na.rm = TRUE, color = 'black') +
  scale_color_brewer(palette="Set1") + 
  labs(x = 'Metabolic temperature (°C)', y = 'Jaccard slope')

p4 <- ggplot(btave3, aes(seas, Jtuslope)) +
  geom_point(aes(color = REALM), size = 0.2, alpha = 0.5, na.rm = TRUE) + 
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = "cs"), na.rm = TRUE, color = 'black') +
  scale_color_brewer(palette="Set1") + 
  labs(x = 'Seasonality (°C)', y = 'Jaccard slope')

p5 <- ggplot(btave3, aes(microclim, Jtuslope)) +
  geom_point(aes(color = REALM), size = 0.2, alpha = 0.5, na.rm = TRUE) + 
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = "cs"), na.rm = TRUE, color = 'black') +
  scale_color_brewer(palette="Set1") + 
  scale_x_log10() +
  labs(x = 'Microclimate availability (°C)', y = 'Jaccard slope')

p6 <- ggplot(btave3, aes(mass_mean_weight, Jtuslope)) +
  geom_point(aes(color = REALM), size = 0.2, alpha = 0.5, na.rm = TRUE) + 
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = "cs"), na.rm = TRUE, color = 'black') +
  scale_color_brewer(palette="Set1") + 
  scale_x_log10() +
  labs(x = 'Mass (g))', y = 'Jaccard slope')

p7 <- ggplot(btave3, aes(speed_mean_weight+1, Jtuslope)) +
  geom_point(aes(color = REALM), size = 0.2, alpha = 0.5, na.rm = TRUE) + 
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = "cs"), na.rm = TRUE, color = 'black') +
  scale_color_brewer(palette="Set1") + 
  scale_x_log10() +
  labs(x = 'Speed (km / hr))', y = 'Jaccard slope')

p8 <- ggplot(btave3, aes(lifespan_mean_weight, Jtuslope)) +
  geom_point(aes(color = REALM), size = 0.2, alpha = 0.5, na.rm = TRUE) + 
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = "cs"), na.rm = TRUE, color = 'black') +
  scale_color_brewer(palette="Set1") + 
  scale_x_log10() +
  labs(x = 'Lifespan (yr))', y = 'Jaccard slope')

p9 <- ggplot(btave3, aes(consfrac, Jtuslope)) +
  geom_point(aes(color = REALM), size = 0.2, alpha = 0.5, na.rm = TRUE) + 
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = "cs", k = 3), na.rm = TRUE, color = 'black') +
  scale_color_brewer(palette="Set1") + 
  labs(x = 'Fraction consumers', y = 'Jaccard slope')

p10 <- ggplot(btave3, aes(endofrac, Jtuslope)) +
  geom_point(aes(color = REALM), size = 0.2, alpha = 0.5, na.rm = TRUE) + 
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = "cs", k = 3), na.rm = TRUE, color = 'black') +
  scale_color_brewer(palette="Set1") + 
  labs(x = 'Fraction endotherms', y = 'Jaccard slope')

p11 <- ggplot(btave3, aes(Nspp, Jtuslope)) +
  geom_point(aes(color = REALM), size = 0.2, alpha = 0.5, na.rm = TRUE) + 
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = "cs"), na.rm = TRUE, color = 'black') +
  scale_color_brewer(palette="Set1") + 
  scale_x_log10() +
  labs(x = 'Number of species', y = 'Jaccard slope')

p12 <- ggplot(btave3, aes(thermal_bias, Jtuslope)) +
  geom_point(aes(color = REALM), size = 0.2, alpha = 0.5, na.rm = TRUE) + 
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = "cs"), na.rm = TRUE, color = 'black') +
  scale_color_brewer(palette="Set1") + 
  labs(x = 'Thermal bias (°C)', y = 'Jaccard slope')

p13 <- ggplot(btave3, aes(npp, Jtuslope)) +
  geom_point(aes(color = REALM), size = 0.2, alpha = 0.5, na.rm = TRUE) + 
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = "cs"), na.rm = TRUE, color = 'black') +
  scale_color_brewer(palette="Set1") + 
  scale_x_log10() +
  labs(x = 'Net primary productivity (mg C / m2 / day)', y = 'Jaccard slope')

p14 <- ggplot(btave3, aes(veg, Jtuslope, color = REALM)) +
  geom_point(size = 0.2, alpha = 0.5, na.rm = TRUE) + 
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = "cs", k = 5), na.rm = TRUE) +
  scale_color_brewer(palette="Set1") + 
  labs(x = 'Vegetation score', y = 'Jaccard slope')

p15 <- ggplot(btave3, aes(human_bowler, Jtuslope, color = REALM)) +
  geom_point(size = 0.2, alpha = 0.5, na.rm = TRUE) + 
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = "cs", k = 5), na.rm = TRUE) +
  scale_color_brewer(palette="Set1") + 
  labs(x = 'Bowler human impact score', y = 'Jaccard slope')

p16 <- ggplot(btave3, aes(human_venter, Jtuslope, color = REALM)) +
  geom_point(size = 0.2, alpha = 0.5, na.rm = TRUE) + 
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = "cs", k = 5), na.rm = TRUE) +
  scale_color_brewer(palette="Set1") + 
  labs(x = 'scaled Human impact score (Venter)', y = 'Jaccard slope')

p17 <- ggplot(btave3, aes(human_halpern, Jtuslope, color = REALM)) +
  geom_point(size = 0.2, alpha = 0.5, na.rm = TRUE) + 
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = "cs", k = 5), na.rm = TRUE) +
  scale_color_brewer(palette="Set1") + 
  labs(x = 'scaled Human impact score (Halpern)', y = 'Jaccard slope')


grid.arrange(p1, p2, p3, p4, p5, p6, p7, p8, p9, p10, p11, p12, p13, p14, p15, p16, p17, ncol = 2)
```

- Strong trends with temperature change, but trends are pretty symmetric around no trend in temperature, which implies warming or cooling drives similar degree of community turnover.
- Some indication of less turnover for larger organisms (mass)
- Higher turnover on land with higher seasonality?
- More turnover for shorter-lived organisms?
- No really clear differences among realms.




