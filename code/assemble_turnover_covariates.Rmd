---
title: "Turnover covariate data prep"
output: 
    html_notebook: default
    #html_document: default
    #github_document: default # latter for displaying on github
---

```{r setup}
library(data.table)
library(ggplot2)

knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file()) # tell RStudio to use project root directory as the root for this notebook. Needed since we are storing code in a separate directory.
```

### Load data
```{r load data}
# BioTime
load('data/biotime_blowes/bt_malin.Rdata')
bt <- data.table(bt_malin); rm(bt_malin)

# Temperature average, trends, and seasonality
temperature <- fread('output/temperature_byrarefyID.csv.gz')

# microclimates
microclim <- fread('output/microclimates.csv.gz', drop = 1)

# NPP
npp <- fread('output/npplandocean.csv.gz')

# Body size
bs <- fread('output/mass_byrarefyid.csv.gz', drop = 1)
bs[, ':='(STUDY_ID = NULL, REALM = NULL, taxa_mod = NULL)] # remove unnecessary columns 

# Mobility
speed <- fread('output/speed_byrarefyID.csv.gz', drop = 1)
speed[, ':='(STUDY_ID = NULL, REALM = NULL, taxa_mod = NULL)] # remove unnecessary columns 

# Lifespan
lsp <- fread('output/lifespan_byrarefyID.csv.gz')

# CTI
cti <- fread('output/cti_byrarefyID.csv.gz')
    
# consumer vs. producer
cons <- fread('output/metab_feed_byspecies.csv.gz')
consfrac <- cons[, .(consfrac = sum(feeding == 'consumer')/.N), by = rarefyID] # fraction of species in each study that are consumers
```

### Plot a turnover example
```{r plot turnover}
bt[, .(n = .N), by = rarefyID][n > 50,]

ggplot(bt[rarefyID == '339_1085477'], aes(YEAR, Jtu_base)) +
    geom_point() +
    geom_smooth(method = 'lm') +
    xlab('Year') + ylab('Jaccard dissimilarity')
```

### Assemble dataset of beta diversity trends (temporal turnover) and covariates
```{r assemble trends}
# calculate temporal turnover
calctrend <- function(y, YEAR, nm = 'y'){ # function to calc trends
    mod <- lm(y ~ YEAR)
    out <- list(y = coef(mod)[2], # coef for the slope
         y_se = sqrt(diag(vcov(mod)))[2]) # SE
    names(out) <- c(nm, paste0(nm, '_se'))
    return(out)
}

setkey(bt, STUDY_ID, rarefyID, YEAR)
trends <- bt[, calctrend(Jtu_base, YEAR, 'Jtutrend'), 
    by = .(REALM, Biome, taxa_mod, STUDY_ID, rarefyID, rarefyID_x, rarefyID_y)] # calculate trend in Jaccard turnover from first year, plus SEs
trends2 <- bt[, calctrend(Jbeta_base, YEAR, 'Jbetatrend'), 
    by = .(rarefyID)] # calculate trend in total Jaccard' beta diversity's from first year, 
trends3 <- bt[, calctrend(1-Horn_base, YEAR, 'Horntrend'), 
    by = .(rarefyID)] # calculate trend in Horn-Morisita from first year. Convert to dissimilarity.
trends4 <- bt[, .(Strend = coef(lm(I(log(S)) ~ YEAR))[2]), by = .(rarefyID)] # trend in log(S)
nyrBT <-  bt[, .(nyrBT = length(YEAR)), by = .(rarefyID)] # number of years in time-series

trends <- merge(trends, trends2) # merge in total J and Horn-Morisita
trends <- merge(trends, trends3)
trends <- merge(trends, trends4)
trends <- merge(trends, nyrBT)
rm(trends2, trends3, trends4, nyrBT)
```

```{r add covariate data}
# add covariates
trends <- merge(trends, temperature[, .(rarefyID, tempave, tempave_metab, temptrend, seas)], all.x = TRUE, by = 'rarefyID') # temperature ave, ave metabolic, trend, and seasonality
trends <- merge(trends, microclim[, .(rarefyID, microclim = Temp_sd20km)], all.x = TRUE, by = 'rarefyID') # microclimates
trends <- merge(trends, npp, all.x = TRUE, by = 'rarefyID') # npp
trends <- merge(trends, bs[, .(rarefyID, mass_mean, mass_geomean, mass_sd, mass_geosd)], all.x = TRUE) # body size mass (g)
trends <- merge(trends, speed[, .(rarefyID, speed_mean, speed_geomean, speed_sd, speed_geosd)], all.x = TRUE) # speed (km/hr)
trends <- merge(trends, lsp[, .(rarefyID, lifespan_mean, lifespan_geomean, lifespan_sd, lifespan_geosd)], all.x = TRUE) # lifespan (yr)
trends <- merge(trends, cti[, .(rarefyID, thermal_bias)], all.x = TRUE) # thermal bias (degC)
trends <- merge(trends, consfrac, all.x = TRUE) # fraction consumers
```

Do some basic checks
```{r basic checks}
# basic checks
trends
trends[, .(minJtu = min(Jtutrend), maxJtu = max(Jtutrend), minJbe = min(Jbetatrend), maxJbe = max(Jbetatrend), 
           minHo = min(Horntrend, na.rm = TRUE), maxHo = max(Horntrend, na.rm = TRUE), minS = min(Strend), maxS = max(Strend)), by = REALM]
trends[, .(nJtu = sum(Jtutrend < 0), nS = sum(Strend < 0)), by = REALM] # why are some turnover trends < 0?
trends[, .(nJ = sum(Jtutrend > 0), nS = sum(Strend > 0)), by = REALM]
```

Turnover calculations are correlated, though less so for Horn
```{r basic pairwise graphs of turnover metrics}
# are turnover calculations correlated?
ggplot(trends, aes(Jbetatrend, Jtutrend)) +
    geom_point() +
    geom_smooth()

ggplot(trends, aes(Jbetatrend, Horntrend)) +
    geom_point() +
    geom_smooth()

```


### Write out
```{r write out}
write.csv(trends, gzfile('output/turnover_w_covariates.csv.gz'), row.names = FALSE)
```

