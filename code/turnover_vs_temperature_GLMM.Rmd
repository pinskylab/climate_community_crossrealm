---
title: 'Community dissimilarity through time using beta models: Evaluate and plot models'
output: 
    github_document: default

---
# Prep
First run turnover_vs_temperature_GLMM_fit.R to fit the models.
```{r setup, echo=FALSE}
library(data.table) # for handling large datasets
library(ggplot2) # for some plotting
library(glmmTMB) # for ME models
library(lme4) # for plotting random effects dotplot
library(bbmle) # for AICtab
library(gridExtra) # to combine ggplots together
library(grid) # to combine ggplots together
library(RColorBrewer)
library(scales) # for defining custom scales in ggplot
library(DHARMa) # for model diagnostics
library(here) # for relative paths
library(performance) # for r2 calculations

options(width=500) # turn off most text wrapping

signedsqrt = function(x) sign(x)*sqrt(abs(x))
signedsq = function(x) sign(x) * x^2
signedsqrttrans <- trans_new(name = 'signedsqrt', transform = signedsqrt, inverse = signedsq)


# tell RStudio to use project root directory as the root for this notebook. Needed since we are storing code in a separate directory.
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file()) 

# Turnover and covariates assembled by turnover_vs_temperature_prep.Rmd
trends3 <- fread(here('output', 'turnover_w_covariates3.csv.gz'))
trends5 <- fread(here('output', 'turnover_w_covariates5.csv.gz'))
trends10 <- fread(here('output', 'turnover_w_covariates10.csv.gz'))
trends20 <- fread(here('output', 'turnover_w_covariates20.csv.gz'))

```


# Summary stats
## Examine how many data points are available
### Just turnover and non-zero tempchange
#### 3-years
```{r sample size all}
cat('Overall # dissimilarities: ', nrow(trends3), '\n')
cat('# studies: ', trends3[, length(unique(STUDY_ID))], '\n')
cat('# timeseries: ', trends3[, length(unique(rarefyID))], '\n')
trends3[!duplicated(rarefyID), table(REALM)]
trends3[!duplicated(rarefyID), table(taxa_mod)]
trends3[!duplicated(rarefyID), table(taxa_mod, REALM)]
```
#### 5-years
```{r sample size all}
cat('Overall # dissimilarities: ', nrow(trends5), '\n')
cat('# studies: ', trends5[, length(unique(STUDY_ID))], '\n')
cat('# timeseries: ', trends5[, length(unique(rarefyID))], '\n')
trends5[!duplicated(rarefyID), table(REALM)]
trends5[!duplicated(rarefyID), table(taxa_mod)]
trends5[!duplicated(rarefyID), table(taxa_mod, REALM)]
```

#### 10-years
```{r sample size all}
cat('Overall # dissimilarities: ', nrow(trends10), '\n')
cat('# studies: ', trends10[, length(unique(STUDY_ID))], '\n')
cat('# timeseries: ', trends10[, length(unique(rarefyID))], '\n')
trends10[!duplicated(rarefyID), table(REALM)]
trends10[!duplicated(rarefyID), table(taxa_mod)]
trends10[!duplicated(rarefyID), table(taxa_mod, REALM)]
```

#### 20-years
```{r sample size all}
cat('Overall # dissimilarities: ', nrow(trends20), '\n')
cat('# studies: ', trends20[, length(unique(STUDY_ID))], '\n')
cat('# timeseries: ', trends20[, length(unique(rarefyID))], '\n')
trends20[!duplicated(rarefyID), table(REALM)]
trends20[!duplicated(rarefyID), table(taxa_mod)]
trends20[!duplicated(rarefyID), table(taxa_mod, REALM)]
```

### With all covariates
Use Bowler for human impact
#### 3-year
```{r sample size Jtu covariates}
# the cases we can compare
apply(trends3[, .(Jtu.sc, REALM, tempave_metab.sc, seas.sc, microclim.sc, tempchange.sc, mass.sc, speed.sc, consumerfrac.sc, endothermfrac.sc, nspp.sc, thermal_bias.sc, npp.sc, veg.sc, human_bowler.sc)], MARGIN = 2, FUN = function(x) sum(!is.na(x)))
i <- trends3[, complete.cases(Jtu.sc, tempave_metab.sc, seas.sc, microclim.sc, tempchange.sc, mass.sc, speed.sc, consumerfrac.sc, nspp.sc, thermal_bias.sc, npp.sc, veg.sc, human_bowler.sc)]
cat('Overall # dissimilarities: ', sum(i), '\n')
cat('# studies: ', trends3[i, length(unique(STUDY_ID))], '\n')
cat('# timeseries: ', trends3[i, length(unique(rarefyID))], '\n')
trends3[i & !duplicated(rarefyID), table(REALM)]
trends3[i & !duplicated(rarefyID), table(taxa_mod)]
trends3[i & !duplicated(rarefyID), table(taxa_mod, REALM)]
```

# Models
## Choose the variance structure
Try combinations of

- beta errors
- variance scaled to Nspp or to Nspp + REALM
- random intercept for taxa_mod2, STUDY_ID, rarefyID
- random slopes for duration

Did not try random intercept for compID (for overdispersion), since had trouble converging.
Use a full set of fixed effects and choose the RE with lowest AIC.
Many of the 3- and 5-year models with random slopes had singular convergence issues.

### 3-years
Best is beta errors, durationlog.sc, intercepts for STUDY_ID and rarefyID, variance scaled to nspp + realm.
Models with slopes didn't converge.
We haven't dealt with potential testing on the boundary issues here. Note that a number of models with random slopes did not converge.
```{r choose variance structure, echo=FALSE}
# comment out the ones that didn't converge (see log files from fitting)
mods3 <- vector('list', length = 17)
i = 1
if(file.exists(here('temp', 'modRFgauss3.rds'))){ mods3[[i]] <- readRDS(here('temp', 'modRFgauss3.rds')); names(mods3)[i] <- 'modRFgauss3'; i = i+1}
if(file.exists(here('temp', 'modRFbeta3.rds'))){ mods3[[i]] <- readRDS(here('temp', 'modRFbeta3.rds')); names(mods3)[i] <- 'modRFbeta3'; i = i+1}
if(file.exists(here('temp', 'modRFrID3.rds'))){ mods3[[i]] <- readRDS(here('temp', 'modRFrID3.rds')); names(mods3)[i] <- 'modRFrID3'; i = i+1}
if(file.exists(here('temp', 'modRF2lev3.rds'))){ mods3[[i]] <- readRDS(here('temp', 'modRF2lev3.rds')); names(mods3)[i] <- 'modRF2lev3'; i = i+1}
if(file.exists(here('temp', 'modRFnestedRE3.rds'))){ mods3[[i]] <- readRDS(here('temp', 'modRFnestedRE3.rds')); names(mods3)[i] <- 'modRFnestedRE3'; i = i+1}
#if(file.exists(here('temp', 'modRFslopeRE3.rds'))){ mods3[[i]] <- readRDS(here('temp', 'modRFslopeRE3.rds')); names(mods3)[i] <- 'modRFslopeRE3'; i = i+1}
# if(file.exists(here('temp', 'modRFslopeRE2lev3.rds'))){ mods3[[i]] <- readRDS(here('temp', 'modRFslopeRE2lev3.rds')); names(mods3)[i] <- 'modRFslopeRE2lev3'; i = i+1}
if(file.exists(here('temp', 'modRFdisp3.rds'))){ mods3[[i]] <- readRDS(here('temp', 'modRFdisp3.rds')); names(mods3)[i] <- 'modRFdisp3'; i = i+1}
if(file.exists(here('temp', 'modRF2levdisp3.rds'))){ mods3[[i]] <- readRDS(here('temp', 'modRF2levdisp3.rds')); names(mods3)[i] <- 'modRF2levdisp3'; i = i+1}
# if(file.exists(here('temp', 'modRFslopeRE2levdisp3.rds'))){ mods3[[i]] <- readRDS(here('temp', 'modRFslopeRE2levdisp3.rds')); names(mods3)[i] <- 'modRFslopeRE2levdisp3'; i = i+1}
#if(file.exists(here('temp', 'modRFslopeREdisp3.rds'))){ mods3[[i]] <- readRDS(here('temp', 'modRFslopeREdisp3.rds')); names(mods3)[i] <- 'modRFslopeREdisp3'; i = i+1}
if(file.exists(here('temp', 'modRF2levdisprealm3.rds'))){ mods3[[i]] <- readRDS(here('temp', 'modRF2levdisprealm3.rds')); names(mods3)[i] <- 'modRF2levdisprealm3'; i = i+1}
# if(file.exists(here('temp', 'modRFslopeRE2levdisprealm3.rds'))){ mods3[[i]] <- readRDS(here('temp', 'modRFslopeRE2levdisprealm3.rds')); names(mods3)[i] <- 'modRFslopeRE2levdisprealm3'; i = i+1}

# with log duration
if(file.exists(here('temp', 'modRFdurlog2levdisp3.rds'))){ mods3[[i]] <- readRDS(here('temp', 'modRFdurlog2levdisp3.rds')); names(mods3)[i] <- 'modRFdurlog2levdisp3'; i = i+1}
# if(file.exists(here('temp', 'modRFdurlogslopeRE2levdisp3.rds'))){ mods3[[i]] <- readRDS(here('temp', 'modRFdurlogslopeRE2levdisp3.rds')); names(mods3)[i] <- 'modRFdurlogslopeRE2levdisp3'; i = i+1} # convergence error
# if(file.exists(here('temp', 'modRFdurlogslopeREdisp3.rds'))){ mods3[[i]] <- readRDS(here('temp', 'modRFdurlogslopeREdisp3.rds')); names(mods3)[i] <- 'modRFdurlogslopeREdisp3'; i = i+1} # convergence error
if(file.exists(here('temp', 'modRFdurlog2levdisprealm3.rds'))){ mods3[[i]] <- readRDS(here('temp', 'modRFdurlog2levdisprealm3.rds')); names(mods3)[i] <- 'modRFdurlog2levdisprealm3'; i = i+1}
# if(file.exists(here('temp', 'modRFdurlogslopeRE2levdisprealm3.rds'))){ mods3[[i]] <- readRDS(here('temp', 'modRFdurlogslopeRE2levdisprealm3.rds')); names(mods3)[i] <- 'modRFdurlogslopeRE2levdisprealm3'; i = i+1} # convergence error


modes <- sapply(X = mods3, FUN = mode)
aics <- sapply(X = mods3[modes == 'list'], FUN = AIC)
aics - min(aics)
```

### 5-years
Best is beta errors, duration.sc, slope & intercepts for STUDY_ID and rarefyID, variance scaled to nspp + realm.
We haven't dealt with potential testing on the boundary issues here. Note that a number of models with random slopes did not converge.
```{r choose variance structure, echo=FALSE}
mods5 <- vector('list', length = 12)
i = 1
if(file.exists(here('temp', 'modRFgauss5.rds'))){ mods5[[i]] <- readRDS(here('temp', 'modRFgauss5.rds')); names(mods5)[i] <- 'modRFgauss5'; i = i+1}
if(file.exists(here('temp', 'modRFbeta5.rds'))){ mods5[[i]] <- readRDS(here('temp', 'modRFbeta5.rds')); names(mods5)[i] <- 'modRFbeta5'; i = i+1}
if(file.exists(here('temp', 'modRFrID5.rds'))){ mods5[[i]] <- readRDS(here('temp', 'modRFrID5.rds')); names(mods5)[i] <- 'modRFrID5'; i = i+1}
if(file.exists(here('temp', 'modRF2lev5.rds'))){ mods5[[i]] <- readRDS(here('temp', 'modRF2lev5.rds')); names(mods5)[i] <- 'modRF2lev5'; i = i+1}
if(file.exists(here('temp', 'modRFnestedRE5.rds'))){ mods5[[i]] <- readRDS(here('temp', 'modRFnestedRE5.rds')); names(mods5)[i] <- 'modRFnestedRE5'; i = i+1}
#if(file.exists(here('temp', 'modRFslopeRE5.rds'))){ mods5[[i]] <- readRDS(here('temp', 'modRFslopeRE5.rds')); names(mods5)[i] <- 'modRFslopeRE5'; i = i+1}
if(file.exists(here('temp', 'modRFslopeRE2lev5.rds'))){ mods5[[i]] <- readRDS(here('temp', 'modRFslopeRE2lev5.rds')); names(mods5)[i] <- 'modRFslopeRE2lev5'; i = i+1}
if(file.exists(here('temp', 'modRFdisp5.rds'))){ mods5[[i]] <- readRDS(here('temp', 'modRFdisp5.rds')); names(mods5)[i] <- 'modRFdisp5'; i = i+1}
if(file.exists(here('temp', 'modRF2levdisp5.rds'))){ mods5[[i]] <- readRDS(here('temp', 'modRF2levdisp5.rds')); names(mods5)[i] <- 'modRF2levdisp5'; i = i+1}
if(file.exists(here('temp', 'modRFslopeRE2levdisp5.rds'))){ mods5[[i]] <- readRDS(here('temp', 'modRFslopeRE2levdisp5.rds')); names(mods5)[i] <- 'modRFslopeRE2levdisp5'; i = i+1}
#if(file.exists(here('temp', 'modRFslopeREdisp5.rds'))){ mods5[[i]] <- readRDS(here('temp', 'modRFslopeREdisp5.rds')); names(mods5)[i] <- 'modRFslopeREdisp5'; i = i+1}
if(file.exists(here('temp', 'modRF2levdisprealm5.rds'))){ mods5[[i]] <- readRDS(here('temp', 'modRF2levdisprealm5.rds')); names(mods5)[i] <- 'modRF2levdisprealm5'; i = i+1}
if(file.exists(here('temp', 'modRFslopeRE2levdisprealm5.rds'))){ mods5[[i]] <- readRDS(here('temp', 'modRFslopeRE2levdisprealm5.rds')); names(mods5)[i] <- 'modRFslopeRE2levdisprealm5'; i = i+1}

# with log duration
if(file.exists(here('temp', 'modRFdurlog2levdisp5.rds'))){ mods5[[i]] <- readRDS(here('temp', 'modRFdurlog2levdisp5.rds')); names(mods5)[i] <- 'modRFdurlog2levdisp5'; i = i+1}
# if(file.exists(here('temp', 'modRFdurlogslopeRE2levdisp5.rds'))){ mods5[[i]] <- readRDS(here('temp', 'modRFdurlogslopeRE2levdisp5.rds')); names(mods5)[i] <- 'modRFdurlogslopeRE2levdisp5'; i = i+1} # convergence error
# if(file.exists(here('temp', 'modRFdurlogslopeREdisp5.rds'))){ mods5[[i]] <- readRDS(here('temp', 'modRFdurlogslopeREdisp5.rds')); names(mods5)[i] <- 'modRFdurlogslopeREdisp5'; i = i+1} # convergence error
if(file.exists(here('temp', 'modRFdurlog2levdisprealm5.rds'))){ mods5[[i]] <- readRDS(here('temp', 'modRFdurlog2levdisprealm5.rds')); names(mods5)[i] <- 'modRFdurlog2levdisprealm5'; i = i+1}
# if(file.exists(here('temp', 'modRFdurlogslopeRE2levdisprealm5.rds'))){ mods5[[i]] <- readRDS(here('temp', 'modRFdurlogslopeRE2levdisprealm5.rds')); names(mods5)[i] <- 'modRFdurlogslopeRE2levdisprealm5'; i = i+1} # convergence error

modes <- sapply(X = mods5, FUN = mode)
aics <- sapply(X = mods5[modes == 'list'], FUN = AIC)
aics - min(aics)
```

### 10-years
This chooses beta errors, random slopes (duration.sc) & intercepts for STUDY_ID and rarefyID, and variance scaled to nspp + realm.
We haven't dealt with potential testing on the boundary issues here.
```{r choose variance structure, echo=FALSE}
mods10 <- vector('list', length = 17)
i = 1
if(file.exists(here('temp', 'modRFgauss10.rds'))){ mods10[[i]] <- readRDS(here('temp', 'modRFgauss10.rds')); names(mods10)[i] <- 'modRFgauss10'; i = i+1}
if(file.exists(here('temp', 'modRFbeta10.rds'))){ mods10[[i]] <- readRDS(here('temp', 'modRFbeta10.rds')); names(mods10)[i] <- 'modRFbeta10'; i = i+1}
if(file.exists(here('temp', 'modRFrID10.rds'))){ mods10[[i]] <- readRDS(here('temp', 'modRFrID10.rds')); names(mods10)[i] <- 'modRFrID10'; i = i+1}
if(file.exists(here('temp', 'modRF2lev10.rds'))){ mods10[[i]] <- readRDS(here('temp', 'modRF2lev10.rds')); names(mods10)[i] <- 'modRF2lev10'; i = i+1}
if(file.exists(here('temp', 'modRFnestedRE10.rds'))){ mods10[[i]] <- readRDS(here('temp', 'modRFnestedRE10.rds')); names(mods10)[i] <- 'modRFnestedRE10'; i = i+1}
if(file.exists(here('temp', 'modRFslopeRE10.rds'))){ mods10[[i]] <- readRDS(here('temp', 'modRFslopeRE10.rds')); names(mods10)[i] <- 'modRFslopeRE10'; i = i+1}
if(file.exists(here('temp', 'modRFslopeRE2lev10.rds'))){ mods10[[i]] <- readRDS(here('temp', 'modRFslopeRE2lev10.rds')); names(mods10)[i] <- 'modRFslopeRE2lev10'; i = i+1}
if(file.exists(here('temp', 'modRFdisp10.rds'))){ mods10[[i]] <- readRDS(here('temp', 'modRFdisp10.rds')); names(mods10)[i] <- 'modRFdisp10'; i = i+1}
if(file.exists(here('temp', 'modRF2levdisp10.rds'))){ mods10[[i]] <- readRDS(here('temp', 'modRF2levdisp10.rds')); names(mods10)[i] <- 'modRF2levdisp10'; i = i+1}
if(file.exists(here('temp', 'modRFslopeRE2levdisp10.rds'))){ mods10[[i]] <- readRDS(here('temp', 'modRFslopeRE2levdisp10.rds')); names(mods10)[i] <- 'modRFslopeRE2levdisp10'; i = i+1}
if(file.exists(here('temp', 'modRFslopeREdisp10.rds'))){ mods10[[i]] <- readRDS(here('temp', 'modRFslopeREdisp10.rds')); names(mods10)[i] <- 'modRFslopeREdisp10'; i = i+1}
if(file.exists(here('temp', 'modRF2levdisprealm10.rds'))){ mods10[[i]] <- readRDS(here('temp', 'modRF2levdisprealm10.rds')); names(mods10)[i] <- 'modRF2levdisprealm10'; i = i+1}
if(file.exists(here('temp', 'modRFslopeRE2levdisprealm10.rds'))){ mods10[[i]] <- readRDS(here('temp', 'modRFslopeRE2levdisprealm10.rds')); names(mods10)[i] <- 'modRFslopeRE2levdisprealm10'; i = i+1}

# with log duration
if(file.exists(here('temp', 'modRFdurlog2levdisp10.rds'))){ mods10[[i]] <- readRDS(here('temp', 'modRFdurlog2levdisp10.rds')); names(mods10)[i] <- 'modRFdurlog2levdisp10'; i = i+1}
if(file.exists(here('temp', 'modRFdurlogslopeRE2levdisp10.rds'))){ mods10[[i]] <- readRDS(here('temp', 'modRFdurlogslopeRE2levdisp10.rds')); names(mods10)[i] <- 'modRFdurlogslopeRE2levdisp10'; i = i+1}
# if(file.exists(here('temp', 'modRFdurlogslopeREdisp10.rds'))){ mods10[[i]] <- readRDS(here('temp', 'modRFdurlogslopeREdisp10.rds')); names(mods10)[i] <- 'modRFdurlogslopeREdisp10'; i = i+1} # convergence error
if(file.exists(here('temp', 'modRFdurlog2levdisprealm10.rds'))){ mods10[[i]] <- readRDS(here('temp', 'modRFdurlog2levdisprealm10.rds')); names(mods10)[i] <- 'modRFdurlog2levdisprealm10'; i = i+1}
if(file.exists(here('temp', 'modRFdurlogslopeRE2levdisprealm10.rds'))){ mods10[[i]] <- readRDS(here('temp', 'modRFdurlogslopeRE2levdisprealm10.rds')); names(mods10)[i] <- 'modRFdurlogslopeRE2levdisprealm10'; i = i+1}

modes <- sapply(X = mods10, FUN = mode)
aics <- sapply(X = mods10[modes == 'list'], FUN = AIC)
aics - min(aics)
```

### 20-years
This chooses beta errors, random slopes (duration.sc) & intercepts for STUDY_ID and rarefyID, and variance scaled to nspp + realm.
We haven't dealt with potential testing on the boundary issues here.
```{r choose variance structure, echo=FALSE}
mods20 <- vector('list', length = 17)
i = 1
if(file.exists(here('temp', 'modRFgauss20.rds'))){ mods20[[i]] <- readRDS(here('temp', 'modRFgauss20.rds')); names(mods20)[i] <- 'modRFgauss20'; i = i+1}
if(file.exists(here('temp', 'modRFbeta20.rds'))){ mods20[[i]] <- readRDS(here('temp', 'modRFbeta20.rds')); names(mods20)[i] <- 'modRFbeta20'; i = i+1}
if(file.exists(here('temp', 'modRFrID20.rds'))){ mods20[[i]] <- readRDS(here('temp', 'modRFrID20.rds')); names(mods20)[i] <- 'modRFrID20'; i = i+1}
if(file.exists(here('temp', 'modRF2lev20.rds'))){ mods20[[i]] <- readRDS(here('temp', 'modRF2lev20.rds')); names(mods20)[i] <- 'modRF2lev20'; i = i+1}
if(file.exists(here('temp', 'modRFnestedRE20.rds'))){ mods20[[i]] <- readRDS(here('temp', 'modRFnestedRE20.rds')); names(mods20)[i] <- 'modRFnestedRE20'; i = i+1}
if(file.exists(here('temp', 'modRFslopeRE20.rds'))){ mods20[[i]] <- readRDS(here('temp', 'modRFslopeRE20.rds')); names(mods20)[i] <- 'modRFslopeRE20'; i = i+1}
if(file.exists(here('temp', 'modRFslopeRE2lev20.rds'))){ mods20[[i]] <- readRDS(here('temp', 'modRFslopeRE2lev20.rds')); names(mods20)[i] <- 'modRFslopeRE2lev20'; i = i+1}
if(file.exists(here('temp', 'modRFdisp20.rds'))){ mods20[[i]] <- readRDS(here('temp', 'modRFdisp20.rds')); names(mods20)[i] <- 'modRFdisp20'; i = i+1}
if(file.exists(here('temp', 'modRF2levdisp20.rds'))){ mods20[[i]] <- readRDS(here('temp', 'modRF2levdisp20.rds')); names(mods20)[i] <- 'modRF2levdisp20'; i = i+1}
if(file.exists(here('temp', 'modRFslopeRE2levdisp20.rds'))){ mods20[[i]] <- readRDS(here('temp', 'modRFslopeRE2levdisp20.rds')); names(mods20)[i] <- 'modRFslopeRE2levdisp20'; i = i+1}
# if(file.exists(here('temp', 'modRFslopeREdisp20.rds'))){ mods20[[i]] <- readRDS(here('temp', 'modRFslopeREdisp20.rds')); names(mods20)[i] <- 'modRFslopeREdisp20'; i = i+1}
if(file.exists(here('temp', 'modRF2levdisprealm20.rds'))){ mods20[[i]] <- readRDS(here('temp', 'modRF2levdisprealm20.rds')); names(mods20)[i] <- 'modRF2levdisprealm20'; i = i+1}
if(file.exists(here('temp', 'modRFslopeRE2levdisprealm20.rds'))){ mods20[[i]] <- readRDS(here('temp', 'modRFslopeRE2levdisprealm20.rds')); names(mods20)[i] <- 'modRFslopeRE2levdisprealm20'; i = i+1}

# with log duration
if(file.exists(here('temp', 'modRFdurlog2levdisp20.rds'))){ mods20[[i]] <- readRDS(here('temp', 'modRFdurlog2levdisp20.rds')); names(mods20)[i] <- 'modRFdurlog2levdisp20'; i = i+1}
if(file.exists(here('temp', 'modRFdurlogslopeRE2levdisp20.rds'))){ mods20[[i]] <- readRDS(here('temp', 'modRFdurlogslopeRE2levdisp20.rds')); names(mods20)[i] <- 'modRFdurlogslopeRE2levdisp20'; i = i+1}
# if(file.exists(here('temp', 'modRFdurlogslopeREdisp20.rds'))){ mods20[[i]] <- readRDS(here('temp', 'modRFdurlogslopeREdisp20.rds')); names(mods20)[i] <- 'modRFdurlogslopeREdisp20'; i = i+1} # convergence error
if(file.exists(here('temp', 'modRFdurlog2levdisprealm20.rds'))){ mods20[[i]] <- readRDS(here('temp', 'modRFdurlog2levdisprealm20.rds')); names(mods20)[i] <- 'modRFdurlog2levdisprealm20'; i = i+1}
if(file.exists(here('temp', 'modRFdurlogslopeRE2levdisprealm20.rds'))){ mods20[[i]] <- readRDS(here('temp', 'modRFdurlogslopeRE2levdisprealm20.rds')); names(mods20)[i] <- 'modRFdurlogslopeRE2levdisprealm20'; i = i+1}

modes <- sapply(X = mods20, FUN = mode)
aics <- sapply(X = mods20[modes == 'list'], FUN = AIC)
aics - min(aics)
```

### Summary of the chosen model
#### 3 years
```{r, echo=FALSE}
summary(mods3[[which(names(mods3)=='modRF2levdisprealm3')]])
```

#### 5 years
```{r, echo=FALSE}
summary(mods5[[which(names(mods5)=='modRFslopeRE2levdisprealm5')]])
```

#### 10 years
```{r, echo=FALSE}
summary(mods10[[which(names(mods10)=='modRFslopeRE2levdisprealm10')]])
```

#### 20 years
```{r, echo=FALSE}
summary(mods20[[which(names(mods20)=='modRFslopeRE2levdisprealm20')]])
```

### Plot random effects
No clear discontinuities. Looks ok.
```{r, echo=FALSE}
lme4:::dotplot.ranef.mer(ranef(mods10[[which(names(mods10)=='modRFslopeRE2levdisprealm10')]])$cond)
```

### DHARMa model evaluation
```{r, echo=FALSE, eval=FALSE}
## run the top part by hand if needed. takes ~3 hrs
if(FALSE) {
  i10 <- trends10[, complete.cases(Jtu.sc, tempchange_abs.sc, REALM, tempave_metab.sc, duration.sc, mass.sc, 
                                   endothermfrac.sc, microclim.sc, npp.sc, human_bowler.sc, nspp.sc)]

  res_RFslopeRE2levdisprealm10 <- simulateResiduals(mods10[[which(names(mods10)=='modRFslopeRE2levdisprealm10')]], n = 250)
  
  saveRDS(res_RFslopeRE2levdisprealm10, file = 'temp/res_RFslopeRE2levdisprealm10.rds')
} else {
  if(file.exists('temp/res_RFslopeRE2levdisprealm10.rds')) res_RFslopeRE2levdisprealm10 <- readRDS('temp/res_res_RFslopeRE2levdisprealm10.rds')
  i10 <- trends10[, complete.cases(Jtu.sc, tempchange_abs.sc, REALM, tempave_metab.sc, duration.sc, mass.sc, 
                                   endothermfrac.sc, microclim.sc, npp.sc, human_bowler.sc, nspp.sc)]
}
```

#### Plot residuals for model fit to all data
There are many outliers and signs of underdispersion, but this is probably ok.
```{r, echo=FALSE, eval=FALSE}
if(exists('res_RFslopeRE2levdisprealm10')){
  plot(res_RFslopeRE2levdisprealm10)
  plotResiduals(res_RFslopeRE2levdisprealm10, form=trends10$tempchange_abs.sc[i10], xlab = 'tempchange_abs.sc', main = '')
  plotResiduals(res_RFslopeRE2levdisprealm10, form=trends10$REALM[i10], xlab = 'REALM', main = '')
  plotResiduals(res_RFslopeRE2levdisprealm10, trends10$tempave_metab.sc[i10], xlab = 'tempave_metab.sc', main = '')
  plotResiduals(res_RFslopeRE2levdisprealm10, trends10$duration.sc[i10], xlab = 'duration.sc', main = '')
  plotResiduals(res_RFslopeRE2levdisprealm10, trends10$mass.sc[i10], xlab = 'mass.sc', main = '')
  plotResiduals(res_RFslopeRE2levdisprealm10, trends10$endothermfrac.sc[i10], xlab = 'endothermfrac.sc', main = '')
  plotResiduals(res_RFslopeRE2levdisprealm10, trends10$microclim.sc[i10], xlab = 'microclim.sc', main = '')
  plotResiduals(res_RFslopeRE2levdisprealm10, trends10$npp.sc[i10], xlab = 'npp.sc', main = '')
  plotResiduals(res_RFslopeRE2levdisprealm10, form=trends10$human_bowler.sc[i10], xlab = 'human_bowler.sc', main = '')
}
```


#### Overdispersion
There is underdispersion.
```{r, echo=FALSE, eval=FALSE}
testDispersion(res_RFslopeRE2levdisprealm10)

```

#### Near-zero-inflation
(Zero values have been transformed to slightly >0, so can't test zero-inflation directly)

Near-zero values are not inflated.
```{r, eval=FALSE}
countNearZero <- function(x) sum(x < 0.0001)
testGeneric(res_RFslopeRE2levdisprealm10, summary = countNearZero, alternative = 'greater')

```

#### Near-one-inflation
Near-one values are not inflated.
```{r, eval=FALSE}
countNearOne <- function(x) sum(x > 0.9999)
testGeneric(res_RFslopeRE2levdisprealm10, summary = countNearOne, alternative = 'greater')

```


## Temperature, temperature slope & duration models
### Load the models
```{r temperature, temp slope and duration, eval=FALSE, echo=FALSE}
# all years
# modTdT3 <- readRDS('temp/modTdT3.rds')
modTdT5 <- readRDS('temp/modTdT5.rds')
modTdT10 <- readRDS('temp/modTdT10.rds')
modTdT20 <- readRDS('temp/modTdT20.rds')
```

### Summary
```{r summary of TD mods, eval=FALSE, echo=FALSE}
summary(modTdT5)
summary(modTdT10)
summary(modTdT20)
```



### Plot the coefficients
Not used
```{r modTD coefs, eval=FALSE, echo=FALSE}

coefs1 <- summary(modTDJtu)$coefficients$cond
coefs2 <- summary(modTDJbeta)$coefficients$cond
coefs3 <- summary(modTDHorn)$coefficients$cond

varstoplot <- unique(c(rownames(coefs1), rownames(coefs2), rownames(coefs3)))
varstoplot <- varstoplot[which(!grepl('Intercept', varstoplot) | grepl(':', varstoplot))] # vars to plot

rows1_1 <- which(rownames(coefs1) %in% varstoplot) # rows in coefs
rows1_2 <- which(rownames(coefs2) %in% varstoplot)
rows1_3 <- which(rownames(coefs3) %in% varstoplot)
xlims <- range(c(coefs1[rows1_1,1] - 1.96*coefs1[rows1_1,2], coefs1[rows1_1,1] + 1.96*coefs1[rows1_1,2], 
                  coefs2[rows1_2,1] - 1.96*coefs2[rows1_2,2], coefs2[rows1_2,1] + 1.96*coefs2[rows1_2,2], 
                  coefs3[rows1_3,1] - 1.96*coefs3[rows1_3,2], coefs3[rows1_3,1] + 1.96*coefs3[rows1_3,2]))

cols <- brewer.pal(3, 'Dark2') # for Jtu, Jbeta and Horn models
pchs <- c(16, 16, 16)
offs <- c(0.1, 0, -0.1) # offset vertically for each model

par(las = 1, mai = c(0.5, 4, 0.1, 0.1))

plot(0,0, col = 'white', xlim = xlims, ylim = c(0.9,length(varstoplot)+0.1), yaxt='n', xlab = '', ylab ='')
axis(2, at = length(varstoplot):1, labels = varstoplot, cex.axis = 0.7)
abline(v = 0, col = 'grey', lty = 2)
abline(h = 1:length(varstoplot), col = 'grey', lty = 3)
for(i in 1:length(varstoplot)){
  if(varstoplot[i] %in% rownames(coefs1)){
    x = coefs1[rownames(coefs1) == varstoplot[i], 1] # the coef in col 1
    se = coefs1[rownames(coefs1) == varstoplot[i], 2] # the SE in col 2
    points(x, length(varstoplot) + 1 - i + offs[1], pch = pchs[1], col = cols[1])
    lines(x = c(x-1.96*se, x+1.96*se), y = c(length(varstoplot) + 1 - i + offs[1], length(varstoplot) + 1 - i + offs[1]), col = cols[1])
  }
  if(varstoplot[i] %in% rownames(coefs2)){
    x = coefs2[rownames(coefs2) == varstoplot[i], 1]
    se = coefs2[rownames(coefs2) == varstoplot[i], 2]
    points(x, length(varstoplot) + 1 - i + offs[2], pch = pchs[2], col = cols[2])
    lines(x = c(x-1.96*se, x+1.96*se), y = c(length(varstoplot) + 1 - i + offs[2], length(varstoplot) + 1 - i + offs[2]), col = cols[2])
  }
  if(varstoplot[i] %in% rownames(coefs3)){
    x = coefs3[rownames(coefs3) == varstoplot[i], 1]
    se = coefs3[rownames(coefs3) == varstoplot[i], 2]
    points(x, length(varstoplot) + 1 - i + offs[3], pch = pchs[3], col = cols[3])
    lines(x = c(x-1.96*se, x+1.96*se), y = c(length(varstoplot) + 1 - i + offs[3], length(varstoplot) + 1 - i + offs[3]), col = cols[3])
  }
}
legend('bottomright', col = cols, pch = 16, lwd = 1, legend = c('Jtu', 'Jbeta', 'Horn'), cex = 0.5)
```
abs(tempchange) is in degC

duration is in years

### Plot the response
Not used
```{r plot TD response, eval=FALSE, echo=FALSE}
if(!file.exists('temp/modTDJtu_preds.rds')) {
  newdat <- expand.grid(duration = c(1, 50), tempchange = seq(0.01, 5, length.out = 5), 
                      taxa_mod2 = NA, STUDY_ID = NA, rarefyID = NA,
                      Nspp = 60) # no REs, ave number of species
  scaling <- fread('output/turnover_w_covariates_scaling.csv')
  cent <- scaling$center[scaling$var == 'tempchange_abs.sc'] # centering
  scl <- scaling$scale[scaling$var == 'tempchange_abs.sc'] # scaling factor for tempchange
  newdat$tempchange_abs.sc <- (abs(newdat$tempchange)-cent)/scl
  cent <- scaling$center[scaling$var == 'nspp.sc'] # centering
  scl <- scaling$scale[scaling$var == 'nspp.sc'] # scaling factor for tempchange
  newdat$nspp.sc <- (log(newdat$Nspp) - cent)/scl
  Jtu <- predict(modTDJtu, newdata = newdat, se.fit = TRUE, re.form = NA, type = 'response')
  newdat$durationfac <- as.factor(newdat$duration)
  newdat$Jtu <- Jtu$fit
  newdat$Jtu.se <- Jtu$se.fit
  
  saveRDS(newdat, file = 'temp/modTDJtu_preds.rds')
} else {
  newdat <- readRDS('temp/modTDJtu_preds.rds')
}

ggplot(newdat, aes(tempchange, Jtu, color = durationfac, group = durationfac)) +
  geom_line() +
  geom_ribbon(aes(ymin=Jtu - 1.96*Jtu.se, ymax=Jtu + 1.96*Jtu.se), alpha = 0.1, linetype = 'blank')
```

## Temperature*temperature slope & duration models
### Load the models
```{r temperature by temp slope and duration, eval=FALSE, echo=FALSE}
# modTdT3 <- readRDS('temp/modTdT3.rds')
modTdTT5 <- readRDS('temp/modTdTT5.rds')
modTdTT10 <- readRDS('temp/modTdTT10.rds')
modTdTT20 <- readRDS('temp/modTdTT20.rds')

modTdTT5Horn <- readRDS('temp/modTdTT5Horn.rds')
modTdTT10Horn <- readRDS('temp/modTdTT10Horn.rds')
modTdTT20Horn <- readRDS('temp/modTdTT20Horn.rds')
```

### Plot the response
#### Set up and write to file
Only run this once.
```{r, eval=FALSE, echo=FALSE}
scaling5 <- fread('output/turnover_w_covariates_scaling5.csv') # the scalings
scaling10 <- fread('output/turnover_w_covariates_scaling10.csv') # the scalings
scaling20 <- fread('output/turnover_w_covariates_scaling20.csv') # the scalings

# find a study in all 3 datasets to use as the random effect
# ranef(modTdT20Horn))

# set up the variables to plot
vars <- data.frame(vars = c('tempchange_abs', 'tempave_metab'),
                   min =      c(0,    -10), 
                   max =      c(0.7,    40),
                   len =      c(100,  100),
                   discrete = c(F,    F),
                   stringsAsFactors = FALSE)
basetab5 <- data.table(expand.grid(start = 1:4, end = 2:5, nspp.sc = 0, REALM = 'Terrestrial', STUDY_ID = 195L, rarefyID = '195_289043', tempchange_abs.sc = 0, tempave_metab.sc = 0)) # the base case
basetab5[, duration := end - start]
if(scaling5[var == 'duration.sc', log]) basetab5[, duration.sc := (log(duration) - scaling5[var == 'duration.sc', center])/scaling5[var == 'duration.sc', scale]]
if(!scaling5[var == 'duration.sc', log]) basetab5[, duration.sc := (duration - scaling5[var == 'duration.sc', center])/scaling5[var == 'duration.sc', scale]]
basetab5 <- basetab5[duration > 0, ]

basetab10 <- data.table(expand.grid(start = 1:9, end = 2:10, nspp.sc = 0, REALM = 'Terrestrial', STUDY_ID = 195L, rarefyID = '195_289043', tempchange_abs.sc = 0, tempave_metab.sc = 0)) # the base case
basetab10[, duration := end - start]
if(scaling10[var == 'duration.sc', log]) basetab10[, duration.sc := (log(duration) - scaling10[var == 'duration.sc', center])/scaling10[var == 'duration.sc', scale]]
if(!scaling10[var == 'duration.sc', log]) basetab10[, duration.sc := (duration - scaling10[var == 'duration.sc', center])/scaling10[var == 'duration.sc', scale]]
basetab10 <- basetab10[duration > 0, ]

basetab20 <- data.table(expand.grid(start = 1:19, end = 2:20, nspp.sc = 0, REALM = 'Terrestrial', STUDY_ID = 195L, rarefyID = '195_289043', tempchange_abs.sc = 0, tempave_metab.sc = 0)) # the base case
basetab20[, duration := end - start]
if(scaling20[var == 'duration.sc', log]) basetab20[, duration.sc := (log(duration) - scaling20[var == 'duration.sc', center])/scaling20[var == 'duration.sc', scale]]
if(!scaling20[var == 'duration.sc', log]) basetab20[, duration.sc := (duration - scaling20[var == 'duration.sc', center])/scaling20[var == 'duration.sc', scale]]
basetab20 <- basetab20[duration > 0, ]

# make the data frames for each interaction to plot                
for(j in 1:nrow(vars)){
    # set up the main effects
    if(scaling5[var == paste0(vars$vars[j], '.sc'), log]){
        thisdat <- data.frame(new = 10^seq(log10(vars$min[j]), log10(vars$max[j]), length.out = vars$len[j]),
                              var = vars$vars[j], stringsAsFactors = FALSE)
    } 
    if(!scaling5[var == paste0(vars$vars[j], '.sc'), log]){
        thisdat <- data.frame(new = seq(vars$min[j], vars$max[j], length.out = vars$len[j]),
                              var = vars$vars[j], stringsAsFactors = FALSE)
    }
    names(thisdat) <- c(vars$vars[j], 'var')
    
    # scale the variable
    cent <- scaling5[var == paste0(vars$vars[j], '.sc'), center]
    scl <- scaling5[var == paste0(vars$vars[j], '.sc'), scale]
    lg <- scaling5[var == paste0(vars$vars[j], '.sc'), log]
    plus <- scaling5[var == paste0(vars$vars[j], '.sc'), plus]
    if(is.null(cent)) cent <- 0
    if(!is.null(cent) & !is.null(scl)){
        if(lg) thisdat[[paste0(vars$var[j], '.sc')]] <- (log(thisdat[[vars$vars[j]]] + plus) - cent)/scl
        if(!lg) thisdat[[paste0(vars$var[j], '.sc')]] <- (thisdat[[vars$var[j]]] - cent)/scl
    }
    
    # merge with the rest of the columns
    expand.grid.df <- function(...) Reduce(function(...) merge(..., by=NULL), list(...)) # https://stackoverflow.com/questions/11693599/alternative-to-expand-grid-for-data-frames
    colnamestouse <- setdiff(colnames(basetab5), paste0(vars$vars[j], '.sc'))
    thisdat5 <- expand.grid.df(thisdat, basetab5[, ..colnamestouse])
    thisdat10 <- expand.grid.df(thisdat, basetab10[, ..colnamestouse])
    thisdat20 <- expand.grid.df(thisdat, basetab20[, ..colnamestouse])
    
    # merge with the previous iterations
    if(j == 1){
      newdat5 <- thisdat5
      newdat10 <- thisdat10
      newdat20 <- thisdat20
    }
    if(j > 1){
        colstoadd <- setdiff(colnames(thisdat5), colnames(newdat5))
        for(toadd in colstoadd){
            newdat5[[toadd]] <- NA
            newdat10[[toadd]] <- NA
            newdat20[[toadd]] <- NA
        }
        
        colstoadd2 <- setdiff(colnames(newdat5), colnames(thisdat5))
        for(toadd in colstoadd2){
            thisdat5[[toadd]] <- NA
            thisdat10[[toadd]] <- NA
            thisdat20[[toadd]] <- NA
        }
        
        newdat5 <- rbind(newdat5, thisdat5)
        newdat10 <- rbind(newdat10, thisdat10)
        newdat20 <- rbind(newdat20, thisdat20)
    } 
}

# predict (takes a few minutes on Annotate)
logit <- function(p) return(log(p/(1-p)))
invlogit <- function(x) return(1/(1+exp(-x)))

coefs5 <- (summary(modTdTT5Horn)$coefficients) # get the model coefficients
coefs10 <- (summary(modTdTT10Horn)$coefficients)
coefs20 <- (summary(modTdTT20Horn)$coefficients)

newdat5$Horn.sc <- predict(modTdTT5Horn, newdat = newdat5, type = 'response', se.fit = FALSE, re.form = NA) # make the predictions
newdat10$Horn.sc <- predict(modTdTT10Horn, newdat = newdat10, type = 'response', se.fit = FALSE, re.form = NA)
newdat20$Horn.sc <- predict(modTdTT20Horn, newdat = newdat20, type = 'response', se.fit = FALSE, re.form = NA)

newdat5$Horn.sc.dTu <- invlogit(logit(newdat5$Horn.sc) + 
                                  newdat5$tempchange_abs.sc * newdat5$duration.sc *
                                  coefs5$cond[3,2]) # upper bound on tempchange coef
newdat5$Horn.sc.dTl <- invlogit(logit(newdat5$Horn.sc) - 
                                  newdat5$tempchange_abs.sc * newdat5$duration.sc *
                                  coefs5$cond[3,2]) # lower bound on tempchange coef
newdat5$Horn.sc.Tu <- invlogit(logit(newdat5$Horn.sc) + 
                                 newdat5$tempave_metab.sc * newdat5$duration.sc *
                                 coefs5$cond[4,2]) # upper bound on tempchange coef
newdat5$Horn.sc.Tl <- invlogit(logit(newdat5$Horn.sc) - 
                                 newdat5$tempave_metab.sc * newdat5$duration.sc *
                                 coefs5$cond[4,2]) # lower bound on tempchange coef

newdat10$Horn.sc.dTu <- invlogit(logit(newdat10$Horn.sc) + 
                                  newdat10$tempchange_abs.sc * newdat10$duration.sc *
                                  coefs10$cond[3,2]) # upper bound on tempchange coef
newdat10$Horn.sc.dTl <- invlogit(logit(newdat10$Horn.sc) - 
                                  newdat10$tempchange_abs.sc * newdat10$duration.sc *
                                  coefs10$cond[3,2]) # lower bound on tempchange coef
newdat10$Horn.sc.Tu <- invlogit(logit(newdat10$Horn.sc) + 
                                 newdat10$tempave_metab.sc * newdat10$duration.sc *
                                 coefs10$cond[4,2]) # upper bound on tempchange coef
newdat10$Horn.sc.Tl <- invlogit(logit(newdat10$Horn.sc) - 
                                 newdat10$tempave_metab.sc * newdat10$duration.sc *
                                 coefs10$cond[4,2]) # lower bound on tempchange coef

newdat20$Horn.sc.dTu <- invlogit(logit(newdat20$Horn.sc) + 
                                  newdat20$tempchange_abs.sc * newdat20$duration.sc *
                                  coefs20$cond[3,2]) # upper bound on tempchange coef
newdat20$Horn.sc.dTl <- invlogit(logit(newdat20$Horn.sc) - 
                                  newdat20$tempchange_abs.sc * newdat20$duration.sc *
                                  coefs20$cond[3,2]) # lower bound on tempchange coef
newdat20$Horn.sc.Tu <- invlogit(logit(newdat20$Horn.sc) + 
                                 newdat20$tempave_metab.sc * newdat20$duration.sc *
                                 coefs20$cond[4,2]) # upper bound on tempchange coef
newdat20$Horn.sc.Tl <- invlogit(logit(newdat20$Horn.sc) - 
                                 newdat20$tempave_metab.sc * newdat20$duration.sc *
                                 coefs20$cond[4,2]) # lower bound on tempchange coef


# write out
write.csv(newdat5, 'temp/modTdTT5_preds.csv', row.names = FALSE)
write.csv(newdat10, 'temp/modTdTT10_preds.csv', row.names = FALSE)
write.csv(newdat20, 'temp/modTdTT20_preds.csv', row.names = FALSE)

```

#### Plot
```{r}
# load predictions
newdat5 <- fread('temp/modTdTT5_preds.csv')
newdat10 <- fread('temp/modTdTT10_preds.csv')
newdat20 <- fread('temp/modTdTT20_preds.csv')

# calc duration slope per temp:tempchange level
slope <- function(duration, Horn.sc){
  mod <- lm(Horn.sc ~ duration)
  return(coef(mod)[2])
}
slope5 <- newdat5[, .(Hornslope = slope(duration, Horn.sc), 
                      HornslopedTu = slope(duration, Horn.sc.dTu),
                      HornslopedTl = slope(duration, Horn.sc.dTl), 
                      HornslopeTu = slope(duration, Horn.sc.Tu),
                      HornslopeTl = slope(duration, Horn.sc.Tl)), 
                  by = .(tempchange_abs, tempave_metab)]
slope10 <- newdat10[, .(Hornslope = slope(duration, Horn.sc), 
                      HornslopedTu = slope(duration, Horn.sc.dTu),
                      HornslopedTl = slope(duration, Horn.sc.dTl), 
                      HornslopeTu = slope(duration, Horn.sc.Tu),
                      HornslopeTl = slope(duration, Horn.sc.Tl)), 
                  by = .(tempchange_abs, tempave_metab)]
slope20 <- newdat20[, .(Hornslope = slope(duration, Horn.sc), 
                      HornslopedTu = slope(duration, Horn.sc.dTu),
                      HornslopedTl = slope(duration, Horn.sc.dTl), 
                      HornslopeTu = slope(duration, Horn.sc.Tu),
                      HornslopeTl = slope(duration, Horn.sc.Tl)), 
                  by = .(tempchange_abs, tempave_metab)]

p1 <- ggplot(slope5, aes(x=tempchange_abs, y=Hornslope, ymin=HornslopedTu, ymax=HornslopedTl)) +
  geom_line() + 
  geom_ribbon(alpha=0.2)
  
p2 <- ggplot(slope5, aes(x=tempave_metab, y=Hornslope, ymin=HornslopeTu, ymax=HornslopeTl)) +
  geom_line() +
  geom_ribbon(alpha=0.2)

grid.arrange(p1, p2, ncol = 2)
```

## Temperature+REALM : duration models
### Load the models
```{r, eval=FALSE, echo=FALSE}
modTRealm5Jtu <- readRDS('temp/modTRealm5Jtu.rds')
modTRealm5Horn <- readRDS('temp/modTRealm5Horn.rds')
```

### Plot the response
#### Set up and write to file
Only run this once.
```{r, eval=FALSE, echo=FALSE}
scaling5 <- fread('output/turnover_w_covariates_scaling5.csv') # the scalings

# find a study in all 3 datasets to use as the random effect
# ranef(modTdTTRealm5Horn))

# set up the variables to plot
vars <- data.frame(vars = c('tempave_metab'),
                   min =      c(-10), 
                   max =      c(40),
                   len =      c(100),
                   discrete = c(F),
                   stringsAsFactors = FALSE)
basetab5 <- data.table(expand.grid(start = 1:4, end = 2:5, nspp.sc = 0, REALM = c('Terrestrial', 'Freshwater', 'Marine'), STUDY_ID = 195L, rarefyID = '195_289043', tempchange_abs.sc = 0, tempave_metab.sc = 0)) # the base case
basetab5[, duration := end - start]
if(scaling5[var == 'duration.sc', log]) basetab5[, duration.sc := (log(duration) - scaling5[var == 'duration.sc', center])/scaling5[var == 'duration.sc', scale]]
if(!scaling5[var == 'duration.sc', log]) basetab5[, duration.sc := (duration - scaling5[var == 'duration.sc', center])/scaling5[var == 'duration.sc', scale]]
basetab5 <- basetab5[duration > 0, ]

# make the data frames for each interaction to plot                
for(j in 1:nrow(vars)){
    # set up the main effects
    if(scaling5[var == paste0(vars$vars[j], '.sc'), log]){
        thisdat <- data.frame(new = 10^seq(log10(vars$min[j]), log10(vars$max[j]), length.out = vars$len[j]),
                              var = vars$vars[j], stringsAsFactors = FALSE)
    } 
    if(!scaling5[var == paste0(vars$vars[j], '.sc'), log]){
        thisdat <- data.frame(new = seq(vars$min[j], vars$max[j], length.out = vars$len[j]),
                              var = vars$vars[j], stringsAsFactors = FALSE)
    }
    names(thisdat) <- c(vars$vars[j], 'var')
    
    # scale the variable
    cent <- scaling5[var == paste0(vars$vars[j], '.sc'), center]
    scl <- scaling5[var == paste0(vars$vars[j], '.sc'), scale]
    lg <- scaling5[var == paste0(vars$vars[j], '.sc'), log]
    plus <- scaling5[var == paste0(vars$vars[j], '.sc'), plus]
    if(is.null(cent)) cent <- 0
    if(!is.null(cent) & !is.null(scl)){
        if(lg) thisdat[[paste0(vars$var[j], '.sc')]] <- (log(thisdat[[vars$vars[j]]] + plus) - cent)/scl
        if(!lg) thisdat[[paste0(vars$var[j], '.sc')]] <- (thisdat[[vars$var[j]]] - cent)/scl
    }
    
    # merge with the rest of the columns
    expand.grid.df <- function(...) Reduce(function(...) merge(..., by=NULL), list(...)) # https://stackoverflow.com/questions/11693599/alternative-to-expand-grid-for-data-frames
    colnamestouse <- setdiff(colnames(basetab5), paste0(vars$vars[j], '.sc'))
    thisdat5 <- expand.grid.df(thisdat, basetab5[, ..colnamestouse])
    
    # merge with the previous iterations
    if(j == 1){
      newdat5 <- thisdat5
    }
    if(j > 1){
        colstoadd <- setdiff(colnames(thisdat5), colnames(newdat5))
        for(toadd in colstoadd){
            newdat5[[toadd]] <- NA
        }
        
        colstoadd2 <- setdiff(colnames(newdat5), colnames(thisdat5))
        for(toadd in colstoadd2){
            thisdat5[[toadd]] <- NA
        }
        
        newdat5 <- rbind(newdat5, thisdat5)
    } 
}
newdat5 <- as.data.table(newdat5)

# predict (takes a few minutes on Annotate)
logit <- function(p) return(log(p/(1-p)))
invlogit <- function(x) return(1/(1+exp(-x)))

coefs5Jtu <- summary(modTdTRealm5Jtu)$coefficients$cond # get the model coefficients and SE
terms5Jtu <- rownames(coefs5Jtu)

newdat5[, Jtu.sc := predict(modTdTRealm5Jtu, newdat = newdat5, type = 'response', 
                            se.fit = FALSE, re.form = NA)] # make the predictions

newdat5[, Jtu.sc.Tu := invlogit(logit(Jtu.sc) + 
                                 tempave_metab.sc * duration.sc *
                                 coefs5Jtu[terms5Jtu == 'duration.sc:tempave_metab.sc',2])] # upper bound on T coef
newdat5[, Jtu.sc.Tl := invlogit(logit(Jtu.sc) - 
                                 tempave_metab.sc * duration.sc *
                                 coefs5Jtu[terms5Jtu == 'duration.sc:tempave_metab.sc',2])]

## Horn
coefs5Horn <- summary(modTdTRealm5Horn)$coefficients$cond # get the model coefficients and SE
terms5Horn <- rownames(coefs5Horn)

newdat5[, Horn.sc := predict(modTdTRealm5Horn, newdat = newdat5, type = 'response', 
                             se.fit = FALSE, re.form = NA)] # make the predictions

newdat5[, Horn.sc.Tu := invlogit(logit(Horn.sc) + 
                                 tempave_metab.sc * duration.sc *
                                 coefs5Horn[terms5Horn == 'duration.sc:tempave_metab.sc',2])] # upper bound on T coef
newdat5[, Horn.sc.Tl := invlogit(logit(Horn.sc) - 
                                 tempave_metab.sc * duration.sc *
                                 coefs5Horn[terms5Horn == 'duration.sc:tempave_metab.sc',2])]


# write out
write.csv(newdat5, 'temp/modTRealm5_preds.csv', row.names = FALSE)

```

#### Plot
```{r}
# load predictions
newdat5 <- fread('temp/modTRealm5_preds.csv')

# calc duration slope per temp:tempchange level
slope <- function(duration, diss){
  mod <- lm(diss ~ duration)
  return(coef(mod)[2])
}
slope5 <- newdat5[, .(Jtuslope = slope(duration, Jtu.sc), 
                      JtuslopeTu = slope(duration, Jtu.sc.Tu),
                      JtuslopeTl = slope(duration, Jtu.sc.Tl),
                      Hornslope = slope(duration, Horn.sc), 
                      HornslopeTu = slope(duration, Horn.sc.Tu),
                      HornslopeTl = slope(duration, Horn.sc.Tl)), 
                  by = .(tempave_metab)]

p1 <- ggplot(slope5, aes(x=tempave_metab, y=Jtuslope, ymin=JtuslopeTu, ymax=JtuslopeTl)) +
  geom_line() +
  geom_ribbon(alpha=0.2)

p2 <- ggplot(slope5, aes(x=tempave_metab, y=Hornslope, ymin=HornslopeTu, ymax=HornslopeTl)) +
  geom_line() +
  geom_ribbon(alpha=0.2)

grid.arrange(p1, p2, ncol = 2)
```

## Temperature+temperature slope+REALM : duration models
### Load the models
```{r, eval=FALSE, echo=FALSE}
modTdTRealm5Jtu <- readRDS('temp/modTdTRealm5Jtu.rds')
modTdTRealm5Horn <- readRDS('temp/modTdTRealm5Horn.rds')
```

### Plot the response
#### Set up and write to file
Only run this once.
```{r, eval=FALSE, echo=FALSE}
scaling5 <- fread('output/turnover_w_covariates_scaling5.csv') # the scalings

# find a study in all 3 datasets to use as the random effect
# ranef(modTdTTRealm5Horn))

# set up the variables to plot
vars <- data.frame(vars = c('tempchange_abs', 'tempave_metab'),
                   min =      c(0,    -10), 
                   max =      c(0.7,    40),
                   len =      c(100,  100),
                   discrete = c(F,    F),
                   stringsAsFactors = FALSE)
basetab5 <- data.table(expand.grid(start = 1:4, end = 2:5, nspp.sc = 0, REALM = c('Terrestrial', 'Freshwater', 'Marine'), STUDY_ID = 195L, rarefyID = '195_289043', tempchange_abs.sc = 0, tempave_metab.sc = 0)) # the base case
basetab5[, duration := end - start]
if(scaling5[var == 'duration.sc', log]) basetab5[, duration.sc := (log(duration) - scaling5[var == 'duration.sc', center])/scaling5[var == 'duration.sc', scale]]
if(!scaling5[var == 'duration.sc', log]) basetab5[, duration.sc := (duration - scaling5[var == 'duration.sc', center])/scaling5[var == 'duration.sc', scale]]
basetab5 <- basetab5[duration > 0, ]

# make the data frames for each interaction to plot                
for(j in 1:nrow(vars)){
    # set up the main effects
    if(scaling5[var == paste0(vars$vars[j], '.sc'), log]){
        thisdat <- data.frame(new = 10^seq(log10(vars$min[j]), log10(vars$max[j]), length.out = vars$len[j]),
                              var = vars$vars[j], stringsAsFactors = FALSE)
    } 
    if(!scaling5[var == paste0(vars$vars[j], '.sc'), log]){
        thisdat <- data.frame(new = seq(vars$min[j], vars$max[j], length.out = vars$len[j]),
                              var = vars$vars[j], stringsAsFactors = FALSE)
    }
    names(thisdat) <- c(vars$vars[j], 'var')
    
    # scale the variable
    cent <- scaling5[var == paste0(vars$vars[j], '.sc'), center]
    scl <- scaling5[var == paste0(vars$vars[j], '.sc'), scale]
    lg <- scaling5[var == paste0(vars$vars[j], '.sc'), log]
    plus <- scaling5[var == paste0(vars$vars[j], '.sc'), plus]
    if(is.null(cent)) cent <- 0
    if(!is.null(cent) & !is.null(scl)){
        if(lg) thisdat[[paste0(vars$var[j], '.sc')]] <- (log(thisdat[[vars$vars[j]]] + plus) - cent)/scl
        if(!lg) thisdat[[paste0(vars$var[j], '.sc')]] <- (thisdat[[vars$var[j]]] - cent)/scl
    }
    
    # merge with the rest of the columns
    expand.grid.df <- function(...) Reduce(function(...) merge(..., by=NULL), list(...)) # https://stackoverflow.com/questions/11693599/alternative-to-expand-grid-for-data-frames
    colnamestouse <- setdiff(colnames(basetab5), paste0(vars$vars[j], '.sc'))
    thisdat5 <- expand.grid.df(thisdat, basetab5[, ..colnamestouse])
    
    # merge with the previous iterations
    if(j == 1){
      newdat5 <- thisdat5
    }
    if(j > 1){
        colstoadd <- setdiff(colnames(thisdat5), colnames(newdat5))
        for(toadd in colstoadd){
            newdat5[[toadd]] <- NA
        }
        
        colstoadd2 <- setdiff(colnames(newdat5), colnames(thisdat5))
        for(toadd in colstoadd2){
            thisdat5[[toadd]] <- NA
        }
        
        newdat5 <- rbind(newdat5, thisdat5)
    } 
}
newdat5 <- as.data.table(newdat5)

# predict (takes a few minutes on Annotate)
logit <- function(p) return(log(p/(1-p)))
invlogit <- function(x) return(1/(1+exp(-x)))

coefs5Jtu <- summary(modTdTRealm5Jtu)$coefficients$cond # get the model coefficients and SE
terms5Jtu <- rownames(coefs5Jtu)

newdat5[, Jtu.sc := predict(modTdTRealm5Jtu, newdat = newdat5, type = 'response', 
                            se.fit = FALSE, re.form = NA)] # make the predictions

newdat5[, Jtu.sc.dTu := invlogit(logit(Jtu.sc) + 
                                      tempchange_abs.sc * duration.sc *
                                      coefs5Jtu[terms5Jtu == 
                                                  'duration.sc:tempchange_abs.sc',2])] # upper bound on dT coef
newdat5[, Jtu.sc.dTl := invlogit(logit(Jtu.sc) - 
                                  tempchange_abs.sc * duration.sc *
                                  coefs5Jtu[terms5Jtu == 'duration.sc:tempchange_abs.sc',2])] # lower bound

newdat5[, Jtu.sc.Tu := invlogit(logit(Jtu.sc) + 
                                 tempave_metab.sc * duration.sc *
                                 coefs5Jtu[terms5Jtu == 'duration.sc:tempave_metab.sc',2])] # upper bound on T coef
newdat5[, Jtu.sc.Tl := invlogit(logit(Jtu.sc) - 
                                 tempave_metab.sc * duration.sc *
                                 coefs5Jtu[terms5Jtu == 'duration.sc:tempave_metab.sc',2])]

## Horn
coefs5Horn <- summary(modTdTRealm5Horn)$coefficients$cond # get the model coefficients and SE
terms5Horn <- rownames(coefs5Horn)

newdat5[, Horn.sc := predict(modTdTRealm5Horn, newdat = newdat5, type = 'response', 
                             se.fit = FALSE, re.form = NA)] # make the predictions

newdat5[, Horn.sc.dTu := invlogit(logit(Horn.sc) + 
                                      tempchange_abs.sc * duration.sc *
                                      coefs5Horn[terms5Horn == 
                                                  'duration.sc:tempchange_abs.sc',2])] # upper bound on dT coef
newdat5[, Horn.sc.dTl := invlogit(logit(Horn.sc) - 
                                  tempchange_abs.sc * duration.sc *
                                  coefs5Horn[terms5Horn == 'duration.sc:tempchange_abs.sc',2])] # lower bound

newdat5[, Horn.sc.Tu := invlogit(logit(Horn.sc) + 
                                 tempave_metab.sc * duration.sc *
                                 coefs5Horn[terms5Horn == 'duration.sc:tempave_metab.sc',2])] # upper bound on T coef
newdat5[, Horn.sc.Tl := invlogit(logit(Horn.sc) - 
                                 tempave_metab.sc * duration.sc *
                                 coefs5Horn[terms5Horn == 'duration.sc:tempave_metab.sc',2])]


# write out
write.csv(newdat5, 'temp/modTdTRealm5_preds.csv', row.names = FALSE)

```

#### Plot
```{r}
# load predictions
newdat5 <- fread('temp/modTdTRealm5_preds.csv')

# calc duration slope per temp:tempchange level
slope <- function(duration, diss){
  mod <- lm(diss ~ duration)
  return(coef(mod)[2])
}
slope5 <- newdat5[, .(Jtuslope = slope(duration, Jtu.sc), 
                      JtuslopedTu = slope(duration, Jtu.sc.dTu),
                      JtuslopedTl = slope(duration, Jtu.sc.dTl), 
                      JtuslopeTu = slope(duration, Jtu.sc.Tu),
                      JtuslopeTl = slope(duration, Jtu.sc.Tl),
                      Hornslope = slope(duration, Horn.sc), 
                      HornslopedTu = slope(duration, Horn.sc.dTu),
                      HornslopedTl = slope(duration, Horn.sc.dTl), 
                      HornslopeTu = slope(duration, Horn.sc.Tu),
                      HornslopeTl = slope(duration, Horn.sc.Tl)), 
                  by = .(tempchange_abs, tempave_metab)]

p1 <- ggplot(slope5, aes(x=tempchange_abs, y=Jtuslope, ymin=JtuslopedTu, ymax=JtuslopedTl)) +
  geom_line() + 
  geom_ribbon(alpha=0.2)
  
p2 <- ggplot(slope5, aes(x=tempave_metab, y=Jtuslope, ymin=JtuslopeTu, ymax=JtuslopeTl)) +
  geom_line() +
  geom_ribbon(alpha=0.2)

p3 <- ggplot(slope5, aes(x=tempchange_abs, y=Hornslope, ymin=HornslopedTu, ymax=HornslopedTl)) +
  geom_line() + 
  geom_ribbon(alpha=0.2)
  
p4 <- ggplot(slope5, aes(x=tempave_metab, y=Hornslope, ymin=HornslopeTu, ymax=HornslopeTl)) +
  geom_line() +
  geom_ribbon(alpha=0.2)

grid.arrange(p1, p2, p3, p4, ncol = 2)
```

## Compare models

### Load the models
```{r, echo=FALSE}
modnames <- c('modNull', 'modRealm', 'modT', 'moddT', 'modmass', 'modnpp', 'modseas', 'modmicroclim', 'modhuman', 'modTdT', 'modTRealm', 'modTmass', 'modTnpp', 'modTseas', 'modTmicroclim', 'modThuman', 'moddTRealm', 'moddTtsign', 'moddTmass', 'moddTnpp', 'moddTseas', 'moddTmicroclim', 'moddThuman', 'modTdTRealm', 'modTdTtsign', 'modTdTmass', 'modTdTnpp', 'modTdTseas', 'modTdTmicroclim', 'modTdThuman', 'modTdTT', 'modTxRealm', 'modTxmass', 'modTxnpp', 'modTxseas', 'modTxmicroclim', 'modTxhuman', 'moddTxRealm', 'moddTxmass', 'moddTxnpp', 'moddTxseas', 'moddTxmicroclim', 'moddTxhuman')

# 5 yrs Jtu
mods5Jtu <- vector('list', length = length(modnames))
names(mods5Jtu) <- paste0(modnames, '5Jtu')
for(i in 1:length(mods5Jtu)){
  if(file.exists(here('temp', paste0(names(mods5Jtu)[i], '.rds')))){ 
    mods5Jtu[[i]] <- readRDS(here('temp', paste0(names(mods5Jtu)[i], '.rds')))
  }
}

# 5 yrs Jne

# 5 yrs Horn
mods5Horn <- vector('list', length = length(modnames))
names(mods5Horn) <- paste0(modnames, '5Horn')
for(i in 1:length(mods5Horn)){
  if(file.exists(here('temp', paste0(names(mods5Horn)[i], '.rds')))){ 
    mods5Horn[[i]] <- readRDS(here('temp', paste0(names(mods5Horn)[i], '.rds')))
  }
}

# # 10 yrs Jtu
# mods10Jtu <- vector('list', length = length(modnames))
# names(mods10Jtu) <- paste0(modnames, '10Jtu')
# for(i in 1:length(mods10Jtu)){
#   if(file.exists(here('temp', paste0(names(mods10Jtu)[i], '.rds')))){ 
#     mods10Jtu[[i]] <- readRDS(here('temp', paste0(names(mods10Jtu)[i], '.rds')))
#   }
# }
# 
# # 10 yrs Jne
# 
# 
# # 10 yrs Horn
# mods10Horn <- vector('list', length = length(modnames))
# names(mods10Horn) <- paste0(modnames, '10Horn')
# for(i in 1:length(mods10Horn)){
#   if(file.exists(here('temp', paste0(names(mods10Horn)[i], '.rds')))){ 
#     mods10Horn[[i]] <- readRDS(here('temp', paste0(names(mods10Horn)[i], '.rds')))
#   }
# }
# # 20 yrs Jtu
# mods20Jtu <- vector('list', length = length(modnames))
# names(mods20Jtu) <- paste0(modnames, '20Jtu')
# for(i in 1:length(mods20Jtu)){
#   if(file.exists(here('temp', paste0(names(mods20Jtu)[i], '.rds')))){ 
#     mods20Jtu[[i]] <- readRDS(here('temp', paste0(names(mods20Jtu)[i], '.rds')))
#   }
# }
# 
# # 20 yrs Horn
# mods20Horn <- vector('list', length = length(modnames))
# names(mods20Horn) <- paste0(modnames, '20Horn')
# for(i in 1:length(mods20Horn)){
#   if(file.exists(here('temp', paste0(names(mods20Horn)[i], '.rds')))){ 
#     mods20Horn[[i]] <- readRDS(here('temp', paste0(names(mods20Horn)[i], '.rds')))
#   }
# }
```

### AIC
#### Jtu
##### 5 years
```{r, echo=FALSE}
checkconv <- function(x){
  if(is.null(x)){
    return(-1)
  } else {
    return(x$fit$convergence)
  }
}
nobs <- sapply(mods5Jtu, FUN = function(x) x$modelInfo$nobs)
nulls <- sapply(X = mods5Jtu, FUN = is.null)
conv <- sapply(mods5Jtu, FUN = checkconv)
good <- !nulls & conv == 0
if(sum(nulls) >0){
  print(paste0('Did not fit: ', paste0(names(mods5Jtu)[nulls], collapse = ', ')))
}
if(sum(conv==0) != length(conv)){
  print(paste0('Did not converge: ', paste0(names(mods5Jtu)[conv > 0], collapse = ', ')))
}
if(!all(unlist(nobs[good]) == nobs[good][1])) print('NOT ALL THE SAME! AIC is meaningless')
aics <- sapply(X = mods5Jtu[good], FUN = AIC)
daics <- data.frame(num=1:length(aics), daic=aics - min(aics))
daics[daics[,2] < 10 | grepl('Null', rownames(daics)), ] # print null and dAIC<4
```

##### 10 years
```{r, echo=FALSE}
nobs <- sapply(mods10Jtu, FUN = function(x) x$modelInfo$nobs)
modes <- sapply(X = mods10Jtu, FUN = mode)
conv <- sapply(mods10Jtu, FUN = function(x) return(x$fit$convergence))
good <- modes == 'list' & conv == 0
if(!all(unlist(nobs[good]) == nobs[good][1])) print('NOT ALL THE SAME! AIC is meaningless')
if(sum(conv==0) != length(conv)){
  print(paste0('Did not converge: ', paste0(names(mods10Jtu)[conv != 0], collapse = ', ')))
}
if(!all(unlist(nobs[good]) == nobs[good][1])) print('NOT ALL THE SAME! AIC is meaningless')
aics <- sapply(X = mods10Jtu[good], FUN = AIC)
cbind(1:length(aics), aics - min(aics))
```

##### 20 years
```{r, echo=FALSE}
nobs <- sapply(mods20Jtu, FUN = function(x) x$modelInfo$nobs)
modes <- sapply(X = mods20Jtu, FUN = mode)
conv <- sapply(mods20Jtu, FUN = function(x) return(x$fit$convergence))
good <- modes == 'list' & conv == 0
if(!all(unlist(nobs[good]) == nobs[good][1])) print('NOT ALL THE SAME! AIC is meaningless')
if(sum(conv==0) != length(conv)){
  print(paste0('Did not converge: ', paste0(names(mods20Jtu)[conv != 0], collapse = ', ')))
}
if(!all(unlist(nobs[good]) == nobs[good][1])) print('NOT ALL THE SAME! AIC is meaningless')
aics <- sapply(X = mods20Jtu[good], FUN = AIC)
cbind(1:length(aics), aics - min(aics))
```

#### Horn
##### 5 years
```{r, echo=FALSE}
checkconv <- function(x){
  if(is.null(x)){
    return(-1)
  } else {
    return(x$fit$convergence)
  }
}
nobs <- sapply(mods5Horn, FUN = function(x) x$modelInfo$nobs)
nulls <- sapply(X = mods5Horn, FUN = is.null)
conv <- sapply(mods5Horn, FUN = checkconv)
good <- !nulls & conv == 0
if(sum(nulls) >0){
  print(paste0('Did not fit: ', paste0(names(mods5Horn)[nulls], collapse = ', ')))
}
if(sum(conv==0) != length(conv)){
  print(paste0('Did not converge: ', paste0(names(mods5Horn)[conv > 0], collapse = ', ')))
}
if(!all(unlist(nobs[good]) == nobs[good][1])) print('NOT ALL THE SAME! AIC is meaningless')
aics <- sapply(X = mods5Horn[good], FUN = AIC)
daics <- data.frame(num=1:length(aics), daic=aics - min(aics))
daics[daics[,2] < 5 | grepl('Null', rownames(daics)), ] # print null and dAIC<4
```

##### 10 years
```{r, echo=FALSE}
nobs <- sapply(mods10Horn, FUN = function(x) x$modelInfo$nobs)
modes <- sapply(X = mods10Horn, FUN = mode)
conv <- sapply(mods10Horn, FUN = function(x) return(x$fit$convergence))
good <- modes == 'list' & conv == 0
if(!all(unlist(nobs[good]) == nobs[good][1])) print('NOT ALL THE SAME! AIC is meaningless')
if(sum(conv==0) != length(conv)){
  print(paste0('Did not converge: ', paste0(names(mods10Horn)[conv != 0], collapse = ', ')))
}
if(!all(unlist(nobs[good]) == nobs[good][1])) print('NOT ALL THE SAME! AIC is meaningless')
aics <- sapply(X = mods10Horn[good], FUN = AIC)
t(t(aics - min(aics)))
```

##### 20 years
```{r, echo=FALSE}
nobs <- sapply(mods20Horn, FUN = function(x) x$modelInfo$nobs)
modes <- sapply(X = mods20Horn, FUN = mode)
conv <- sapply(mods20Horn, FUN = function(x) return(x$fit$convergence))
good <- modes == 'list' & conv == 0
if(!all(unlist(nobs[good]) == nobs[good][1])) print('NOT ALL THE SAME! AIC is meaningless')
if(sum(conv==0) != length(conv)){
  print(paste0('Did not converge: ', paste0(names(mods20Horn)[conv != 0], collapse = ', ')))
}
if(!all(unlist(nobs[good]) == nobs[good][1])) print('NOT ALL THE SAME! AIC is meaningless')
aics <- sapply(X = mods20Horn[good], FUN = AIC)
t(t(aics - min(aics)))
```


## Full models w/ duration interactions
### Load the models
```{r durint, echo=FALSE}
if(file.exists('temp/modDurIntTdTSeMiNPNspMaHu5yrJtu.rds')){
  modDurInt5yrJtu <- readRDS('temp/modDurIntTdTSeMiNPNspMaHu5yrJtu.rds')
  # needed because model fit with trends[i,]
  trends[, maxyr := max(c(year1, year2)), by = rarefyID]
  rowkeep <- trends[, complete.cases(Jtu.sc, tempchange_abs.sc, REALM, tempave_metab.sc, duration.sc,
                                     seas.sc, microclim.sc, npp.sc, mass.sc, human_bowler.sc, nspp.sc) &
                      year1 > maxyr - 5 &
                      year2 > maxyr - 5] # trim to complete cases in the last 5 years
  rkeep <- trends[rowkeep, .(nyrs = length(unique(c(year1, year2)))), by = rarefyID][nyrs == 5, rarefyID] # find timeseries with exactly 5 years
  i <- trends[, rowkeep & rarefyID %in% rkeep]
  
  trends[i, tempchangeTS_abs := abs(median(tempchange/duration)), by = rarefyID] # Thiel-Sen estimator of the abs(slope): median of all pairwise differences
}
```

### Summary
```{r summary durint, echo=FALSE}
if(exists('modDurInt5yrJut')) summary(modDurInt5yrJtu)
```

### DHARMa model evaluation
#### Simulate residuals
```{r, echo=FALSE}
## run the if(FALSE) part by hand if needed (e.g., the first time)
if(FALSE) {
  res_DurInt5yrJtu <- simulateResiduals(modDurInt5yrJtu, n = 250)
  
  saveRDS(res_DurInt5yrJtu, file = 'temp/res_DurInt5yrJtu.rds')
} else {
  if(file.exists(here('temp', 'res_DurInt5yrJtu.rds'))) res_DurInt5yrJtu <- readRDS(here('temp', 'res_DurInt5yrJtu.rds'))
}
```

#### Plot residuals
```{r, echo=FALSE}
if(exists('res_DurInt5yrJtu')){
  plot(res_DurInt5yrJtu)
  plotResiduals(res_DurInt5yrJtu, trends$duration.sc[i], xlab = 'duration.sc', main = '')
  plotResiduals(res_DurInt5yrJtu, form=trends$REALM[i], xlab = 'REALM', main = '')
  plotResiduals(res_DurInt5yrJtu, form=trends$tempchangeTS_abs[i], xlab = 'tempchangeTS_abs', main = '')
  plotResiduals(res_DurInt5yrJtu, trends$tempave_metab.sc[i], xlab = 'tempave_metab.sc', main = '')
  plotResiduals(res_DurInt5yrJtu, trends$seas.sc[i], xlab = 'seas.sc', main = '')
  plotResiduals(res_DurInt5yrJtu, trends$microclim.sc[i], xlab = 'microclim.sc', main = '')
  plotResiduals(res_DurInt5yrJtu, trends$npp.sc[i], xlab = 'npp.sc', main = '')
  plotResiduals(res_DurInt5yrJtu, trends$nspp.sc[i], xlab = 'nspp.sc', main = '')
  plotResiduals(res_DurInt5yrJtu, trends$mass.sc[i], xlab = 'mass.sc', main = '')
  plotResiduals(res_DurInt5yrJtu, form=trends$human_bowler.sc[i], xlab = 'human_bowler.sc', main = '')
}
```


#### Overdispersion
```{r, echo=FALSE}
if(exists('res_DurInt5yrJtu')){
  testDispersion(res_DurInt5yrJtu)
}

```

#### Near-zero-inflation
Zero values have been transformed to slightly >0, so can't test zero-inflation directly
```{r, echo=FALSE,}
countNearZero <- function(x) sum(x < 0.0001)

if(exists('res_DurInt5yrJtu')){
  testGeneric(res_DurInt5yrJtu, summary = countNearZero, alternative = 'greater')
}

```

#### Near-one-inflation
```{r, echo=FALSE, eval=FALSE}
countNearOne <- function(x) sum(x > 0.9999)

if(exists('res_DurInt5yrJtu')){
  testGeneric(res_DurInt5yrJtu, summary = countNearOne, alternative = 'greater')
}
```

### Interactions
#### Set up and write to file
Only run this once
```{r, eval = FALSE, echo=FALSE}
scaling <- fread(here('output', 'turnover_w_covariates_scaling.csv')) # the scalings

# set up the interactions to plot. min and max on a raw scale.
ints <- data.frame(vars = c('tempchangeTS_abs', 'tempave_metab', 'seas', 'microclim', 
                            'npp', 'nspp', 'mass',
                            'human_bowler', 'human_bowler'),
                   min =      c(0,   -10, 0,   0.1,   0.5,  1,    1,   0,   0), 
                   max =      c(1,   40,  15,  6,   5000, 1000, 1e8, 10,  10),
                   len =      c(100, 100, 100, 100, 100,  100,  100, 100, 100),
                   discrete = c(F,   F,   F,   F,   F,    F,    F,   F,   F),
                   REALM = c(rep('Terrestrial', 8), 'Marine'),
                   REALM2 = c(rep('TerrFresh', 8), 'Marine'),
                   stringsAsFactors = FALSE)
baseall <- trends[, .(type = 'all', 
                      tempchangeTS_abs = mean(tempchangeTS_abs, na.rm=TRUE), 
                      tempave_metab.sc = mean(tempave_metab.sc, na.rm=TRUE), 
                      seas.sc = mean(seas.sc, na.rm=TRUE), 
                      microclim.sc = mean(microclim.sc, na.rm=TRUE), 
                      npp.sc = mean(npp.sc, na.rm=TRUE), 
                      nspp.sc = mean(nspp.sc, na.rm=TRUE),
                      mass.sc = mean(mass.sc, na.rm=TRUE), 
                      human_bowler.sc = mean(human_bowler.sc, na.rm=TRUE))]
baseterr <- trends[REALM == 'Terrestrial', 
                   .(type = 'Terrestrial', 
                     tempchangeTS_abs = mean(tempchangeTS_abs, na.rm=TRUE), 
                     tempave_metab.sc = mean(tempave_metab.sc, na.rm=TRUE), 
                     seas.sc = mean(seas.sc, na.rm=TRUE), 
                     microclim.sc = mean(microclim.sc, na.rm=TRUE), 
                     npp.sc = mean(npp.sc, na.rm=TRUE), 
                     nspp.sc = baseall$nspp.sc, # keep this the same across all
                     mass.sc = mean(mass.sc, na.rm=TRUE), 
                     human_bowler.sc = mean(human_bowler.sc, na.rm=TRUE))]
basemar <- trends[REALM == 'Marine', 
                  .(type = 'Marine',
                    tempchangeTS_abs = mean(tempchangeTS_abs, na.rm=TRUE), 
                    tempave_metab.sc = mean(tempave_metab.sc, na.rm=TRUE), 
                    seas.sc = mean(seas.sc, na.rm=TRUE), 
                    microclim.sc = mean(microclim.sc, na.rm=TRUE), 
                    npp.sc = mean(npp.sc, na.rm=TRUE), 
                    nspp.sc = baseall$nspp.sc,
                    mass.sc = mean(mass.sc, na.rm=TRUE), 
                    human_bowler.sc = mean(human_bowler.sc, na.rm=TRUE))]
basetab <- rbind(baseall, baseterr, basemar)
basetab[, ':='(STUDY_ID = trends[i, STUDY_ID][1], rarefyID = trends[i, rarefyID][1])] # pick the first RE level in the dataframe

# make the data frames for each interaction to plot                
for(j in 1:nrow(ints)){
  # set up a grid of temperature trends and the interacting variable
  if(ints$vars[j] == 'tempchangeTS_abs'){ # this one isn't in scaling, since made anew for each model based on duration
    intvars <- list(duration = seq(1, 5, length.out = 100), 
                    new = seq(ints$min[j], ints$max[j], length.out = ints$len[j]),
                    var = ints$vars[j])
  } else {
    log <- scaling$log[scaling$var == paste0(ints$vars[j], '.sc')]
    plus <- scaling$plus[scaling$var == paste0(ints$vars[j], '.sc')]
    if(log) intvars <- list(duration = seq(1, 5, length.out = 100), 
                                    new = exp(seq(log(ints$min[j]+plus), log(ints$max[j]+plus), length.out = ints$len[j])),
                                    var = ints$vars[j])
    if(!log) intvars <- list(duration = seq(1, 5, length.out = 100), 
                                     new = seq(ints$min[j], ints$max[j], length.out = ints$len[j]),
                                     var = ints$vars[j])
  }
  names(intvars) <- c('duration', ints$vars[j], 'var')
  thisdat <- expand.grid(intvars)
  
  # scale the interacting variable
  if(ints$vars[j] != 'tempchangeTS_abs'){ # this one isn't in scaling, since made anew for each model based on duration0
    cent <- scaling$center[scaling$var == paste0(ints$vars[j], '.sc')]
    scl <- scaling$scale[scaling$var == paste0(ints$vars[j], '.sc')]
    log <- scaling$log[scaling$var == paste0(ints$vars[j], '.sc')]
    plus <- scaling$plus[scaling$var == paste0(ints$vars[j], '.sc')]
    if(log) thisdat[[paste0(ints$var[j], '.sc')]] <- (log(thisdat[[ints$vars[j]]] + plus) - cent)/scl
    if(!log) thisdat[[paste0(ints$var[j], '.sc')]] <- (thisdat[[ints$var[j]]] - cent)/scl
  }
  
  # merge with the rest of the columns
  # use realm-specific averages for human impacts
  colnamestouse <- setdiff(colnames(basetab), c(ints$var[j], paste0(ints$var[j], '.sc')))
  if(ints$vars[j] != 'human_bowler'){
    thisdat <- cbind(thisdat, basetab[type == 'all', ..colnamestouse])
  }
  if(ints$vars[j] == 'human_bowler' & ints$REALM[j] == 'Terrestrial'){
    thisdat <- cbind(thisdat, basetab[type == 'Terrestrial', ..colnamestouse])
  }
  if(ints$vars[j] == 'human_bowler' & ints$REALM[j] == 'Marine'){
    thisdat <- cbind(thisdat, basetab[type == 'Marine', ..colnamestouse])
  }
  
  # add realm
  thisdat$REALM <- ints$REALM[j]
  thisdat$REALM2 <- ints$REALM2[j]
  
  # add plotting information
  if(ints$vars[j] != 'tempchangeTS_abs'){
    thisdat$log <- scaling$log[scaling$var == paste0(ints$vars[j], '.sc')]
  } else {
    thisdat$log <- FALSE
  }
  thisdat$discrete <- ints$discrete[j]
  
  # merge with the previous iterations
  if(j == 1) newdat <- thisdat
  if(j > 1){
    colstoadd <- setdiff(colnames(thisdat), colnames(newdat))
    for(toadd in colstoadd){
      newdat[[toadd]] <- NA
    }
    
    colstoadd2 <- setdiff(colnames(newdat), colnames(thisdat))
    for(toadd in colstoadd2){
      thisdat[[toadd]] <- NA
    }
    
    newdat <- rbind(newdat, thisdat)
  } 
}

# character so that new levels can be added
newdat$REALM <- as.character(newdat$REALM)
newdat$REALM2 <- as.character(newdat$REALM2)
newdat$var <- as.character(newdat$var)

# add extra rows so that all factor levels are represented (for predict.lme to work, not sure about predict.glmmTMB)
newdat <- rbind(newdat[1:6, ], newdat)
newdat$REALM[1:6] <- c('Marine', 'Marine', 'Freshwater', 'Freshwater', 'Terrestrial', 'Terrestrial')
newdat$REALM2[1:6] <- c('Marine', 'Marine', 'TerrFresh', 'TerrFresh', 'TerrFresh', 'TerrFresh')
newdat$tempchange[1:6] <- c(-0.2, 0.2, -0.2, 0.2, -0.2, 0.2)
newdat$var[1:6] <- 'test'

# scale the duration
cent <- scaling$center[scaling$var == 'duration.sc']
scl <- scaling$scale[scaling$var == 'duration.sc']
newdat$duration.sc <- (log(newdat$duration)-cent)/scl

# write out
write.csv(newdat, 'temp/newdata_interactions_DurInt.csv', row.names = FALSE)

```

Now go run on the command line
```
nohup code/turnover_vs_temperature_GLMM_pred.R temp/modDurIntTdTSeMiNPNspMaHu5yrJtu.rds temp/newdata_interactions_DurInt.csv temp/modDurIntTdTSeMiNPNspMaHu5yrJtu_preds_interactions.rds >logs/turnover_vs_temperature_GLMMmodDurIntTdTSeMiNPNspMaHu5yrJtu_pred_interactions.Rout &
```

#### Load and plot
```{r, fig.width = 9, fig.height = 8, echo=FALSE}
newdatint <- readRDS(here('temp', 'modDurIntTdTSeMiNPNspMaHu5yrJtu_preds_interactions.rds'))
newdatint[, REALM := factor(REALM, levels = c('Freshwater', 'Terrestrial', 'Marine'))] # set factor order
newdatint[, REALM2 := factor(REALM2, levels = c('TerrFresh', 'Marine'))] # set factor order

ylims = c(0.2, 0.65)

# prep the plots
ints <- unique(newdatint[ ,.(var, REALM2, log, discrete)])
ints <- ints[ints$var != 'test', ] # remove the extra rows
intplots <- vector('list', nrow(ints))
for(j in 1:length(intplots)){
  subs <- newdatint$var == ints$var[j]
  xvar <- 'duration'
  title <- ints$var[j]
  if(ints$var[j] %in% c('human_bowler')){
    subs <- newdatint$var == ints$var[j] & newdatint$tempchange > 0 & newdatint$REALM2 == ints$REALM2[j]
    title <- paste0('human:', ints$REALM2[j])
  } 
  
  thisplot <- ggplot(newdatint[subs, ], 
                     aes_string(x = xvar, y = 'pred', 
                                group = ints$var[j], 
                                color = ints$var[j])) +
    geom_line() +
    #coord_cartesian(ylim = ylims) +
    theme(legend.title = element_text(size = 8), 
          legend.text = element_text(size = 6),
          legend.key.width = unit(0.1, 'inch')) +
    labs(title = title)
  if(ints$log[j] & !ints$discrete[j]){
    intplots[[j]] <- thisplot + scale_color_distiller(palette = "YlGnBu", trans = 'log')
  }
  if(!ints$log[j] & !ints$discrete[j]){
    intplots[[j]] <- thisplot + scale_color_distiller(palette = "YlGnBu", trans = 'identity')
  }
  if(ints$discrete[j]){
    intplots[[j]] <- thisplot + scale_color_brewer(palette = "Dark2")
  }
}

grid.arrange(grobs = intplots, ncol = 3)

```
