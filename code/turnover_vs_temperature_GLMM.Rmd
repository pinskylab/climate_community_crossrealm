---
title: 'Community dissimilarity through time using beta models: Evaluate and plot models'
output: 
    github_document:
        toc: true
        toc_depth: 3

---
# Prep
First run turnover_vs_temperature_GLMM_fit.R to fit the models.
```{r setup, echo=FALSE}
library(data.table) # for handling large datasets
library(ggplot2) # for some plotting
library(glmmTMB) # for ME models
library(lme4) # for plotting random effects dotplot
library(bbmle) # for AICtab
library(gridExtra) # to combine ggplots together
library(grid) # to combine ggplots together
library(RColorBrewer)
library(scales) # for defining custom scales in ggplot
library(DHARMa) # for model diagnostics
library(here) # for relative paths
library(performance) # for r2 calculations
library(lavaan) # for SEM models of slopes

options(width=500) # turn off most text wrapping

signedsqrt = function(x) sign(x)*sqrt(abs(x))
signedsq = function(x) sign(x) * x^2
signedsqrttrans <- trans_new(name = 'signedsqrt', transform = signedsqrt, inverse = signedsq)
scaleme <- function(x, nm){
  if(!(nm %in% scalingall[,var])) stop('nm not found in scalingall')
  if(scalingall[var==nm, log]){
    x.sc <- (log(x + scalingall[var==nm, plus]) - scalingall[var == nm, center]) / scalingall[var == nm, scale]  
  } else {
    x.sc <- (x  + scalingall[var==nm, plus] - scalingall[var == nm, center]) / scalingall[var == nm, scale]
  }
  return(x.sc)
}

unscaleme <- function(x.sc, nm){
  if(!(nm %in% scalingall[,var])) stop('nm not found in scalingall')
  if(scalingall[var==nm, log]){
    x <- exp(x.sc * scalingall[var == nm, scale] + scalingall[var == nm, center]) - scalingall[var==nm, plus]
  } else {
    x <- x.sc * scalingall[var == nm, scale] + scalingall[var == nm, center] - scalingall[var==nm, plus]
  }
  return(x)
}

# tell RStudio to use project root directory as the root for this notebook. Needed since we are storing code in a separate directory.
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file()) 

# Turnover and covariates assembled by turnover_vs_temperature_prep.Rmd
trendsall <- fread(here('output', 'turnover_w_covariates.csv.gz'))

# And the scaling factors
scalingall <- fread(here('output', 'turnover_w_covariates_scaling.csv'))


```


# Summary stats
## Examine how many data points are available
### Just turnover and non-zero tempchange
```{r sample size all}
cat('Overall # dissimilarities: ', nrow(trendsall), '\n')
cat('# studies: ', trendsall[, length(unique(STUDY_ID))], '\n')
cat('# timeseries: ', trendsall[, length(unique(rarefyID))], '\n')
trendsall[!duplicated(rarefyID), table(REALM)]
trendsall[!duplicated(rarefyID), table(taxa_mod)]
trendsall[!duplicated(rarefyID), table(taxa_mod, REALM)]
```

### With all covariates
Use Bowler for human impact
```{r sample size Jtu covariates}
# the cases we can compare
apply(trendsall[, .(Jtu.sc, REALM, tempave_metab.sc, seas.sc, microclim.sc, tempchange.sc, mass.sc, speed.sc, consumerfrac.sc, endothermfrac.sc, nspp.sc, thermal_bias.sc, npp.sc, veg.sc, human_bowler.sc)], MARGIN = 2, FUN = function(x) sum(!is.na(x)))
i <- trendsall[, complete.cases(Jtu.sc, tempave_metab.sc, seas.sc, microclim.sc, tempchange.sc, mass.sc, speed.sc, consumerfrac.sc, nspp.sc, thermal_bias.sc, npp.sc, veg.sc, human_bowler.sc)]
cat('Overall # dissimilarities: ', sum(i), '\n')
cat('# studies: ', trendsall[i, length(unique(STUDY_ID))], '\n')
cat('# timeseries: ', trendsall[i, length(unique(rarefyID))], '\n')
trendsall[i & !duplicated(rarefyID), table(REALM)]
trendsall[i & !duplicated(rarefyID), table(taxa_mod)]
trendsall[i & !duplicated(rarefyID), table(taxa_mod, REALM)]
```

# Models
## Choose the variance structure
Try combinations of

- beta errors
- variance scaled to Nspp or to Nspp + REALM
- random intercept for taxa_mod2, STUDY_ID, rarefyID
- random slopes for duration

Did not try random intercept for compID (for overdispersion), since had trouble converging.
Use a full set of fixed effects and choose the RE with lowest AIC.
Many of the 3- and 5-year models with random slopes had singular convergence issues.

### 10-years
This chooses beta errors, random slopes (duration.sc) & intercepts for STUDY_ID and rarefyID, and variance scaled to nspp + realm.
We haven't dealt with potential testing on the boundary issues here.
```{r choose variance structure, echo=FALSE}
mods10 <- vector('list', length = 17)
i = 1
if(file.exists(here('temp', 'modRFgauss10.rds'))){ mods10[[i]] <- readRDS(here('temp', 'modRFgauss10.rds')); names(mods10)[i] <- 'modRFgauss10'; i = i+1}
if(file.exists(here('temp', 'modRFbeta10.rds'))){ mods10[[i]] <- readRDS(here('temp', 'modRFbeta10.rds')); names(mods10)[i] <- 'modRFbeta10'; i = i+1}
if(file.exists(here('temp', 'modRFrID10.rds'))){ mods10[[i]] <- readRDS(here('temp', 'modRFrID10.rds')); names(mods10)[i] <- 'modRFrID10'; i = i+1}
if(file.exists(here('temp', 'modRF2lev10.rds'))){ mods10[[i]] <- readRDS(here('temp', 'modRF2lev10.rds')); names(mods10)[i] <- 'modRF2lev10'; i = i+1}
if(file.exists(here('temp', 'modRFnestedRE10.rds'))){ mods10[[i]] <- readRDS(here('temp', 'modRFnestedRE10.rds')); names(mods10)[i] <- 'modRFnestedRE10'; i = i+1}
if(file.exists(here('temp', 'modRFslopeRE10.rds'))){ mods10[[i]] <- readRDS(here('temp', 'modRFslopeRE10.rds')); names(mods10)[i] <- 'modRFslopeRE10'; i = i+1}
if(file.exists(here('temp', 'modRFslopeRE2lev10.rds'))){ mods10[[i]] <- readRDS(here('temp', 'modRFslopeRE2lev10.rds')); names(mods10)[i] <- 'modRFslopeRE2lev10'; i = i+1}
if(file.exists(here('temp', 'modRFdisp10.rds'))){ mods10[[i]] <- readRDS(here('temp', 'modRFdisp10.rds')); names(mods10)[i] <- 'modRFdisp10'; i = i+1}
if(file.exists(here('temp', 'modRF2levdisp10.rds'))){ mods10[[i]] <- readRDS(here('temp', 'modRF2levdisp10.rds')); names(mods10)[i] <- 'modRF2levdisp10'; i = i+1}
if(file.exists(here('temp', 'modRFslopeRE2levdisp10.rds'))){ mods10[[i]] <- readRDS(here('temp', 'modRFslopeRE2levdisp10.rds')); names(mods10)[i] <- 'modRFslopeRE2levdisp10'; i = i+1}
if(file.exists(here('temp', 'modRFslopeREdisp10.rds'))){ mods10[[i]] <- readRDS(here('temp', 'modRFslopeREdisp10.rds')); names(mods10)[i] <- 'modRFslopeREdisp10'; i = i+1}
if(file.exists(here('temp', 'modRF2levdisprealm10.rds'))){ mods10[[i]] <- readRDS(here('temp', 'modRF2levdisprealm10.rds')); names(mods10)[i] <- 'modRF2levdisprealm10'; i = i+1}
if(file.exists(here('temp', 'modRFslopeRE2levdisprealm10.rds'))){ mods10[[i]] <- readRDS(here('temp', 'modRFslopeRE2levdisprealm10.rds')); names(mods10)[i] <- 'modRFslopeRE2levdisprealm10'; i = i+1}

# with log duration
if(file.exists(here('temp', 'modRFdurlog2levdisp10.rds'))){ mods10[[i]] <- readRDS(here('temp', 'modRFdurlog2levdisp10.rds')); names(mods10)[i] <- 'modRFdurlog2levdisp10'; i = i+1}
if(file.exists(here('temp', 'modRFdurlogslopeRE2levdisp10.rds'))){ mods10[[i]] <- readRDS(here('temp', 'modRFdurlogslopeRE2levdisp10.rds')); names(mods10)[i] <- 'modRFdurlogslopeRE2levdisp10'; i = i+1}
# if(file.exists(here('temp', 'modRFdurlogslopeREdisp10.rds'))){ mods10[[i]] <- readRDS(here('temp', 'modRFdurlogslopeREdisp10.rds')); names(mods10)[i] <- 'modRFdurlogslopeREdisp10'; i = i+1} # convergence error
if(file.exists(here('temp', 'modRFdurlog2levdisprealm10.rds'))){ mods10[[i]] <- readRDS(here('temp', 'modRFdurlog2levdisprealm10.rds')); names(mods10)[i] <- 'modRFdurlog2levdisprealm10'; i = i+1}
if(file.exists(here('temp', 'modRFdurlogslopeRE2levdisprealm10.rds'))){ mods10[[i]] <- readRDS(here('temp', 'modRFdurlogslopeRE2levdisprealm10.rds')); names(mods10)[i] <- 'modRFdurlogslopeRE2levdisprealm10'; i = i+1}

modes <- sapply(X = mods10, FUN = mode)
aics <- sapply(X = mods10[modes == 'list'], FUN = AIC)
aics - min(aics)
```


### Summary of the chosen model

```{r, echo=FALSE}
summary(mods10[[which(names(mods10)=='modRFslopeRE2levdisprealm10')]])
```


### Plot random effects
No clear discontinuities. Looks ok.
```{r, echo=FALSE}
lme4:::dotplot.ranef.mer(ranef(mods10[[which(names(mods10)=='modRFslopeRE2levdisprealm10')]])$cond)
```

### DHARMa model evaluation
```{r, echo=FALSE, eval=FALSE}
## run the top part by hand if needed. takes ~3 hrs
if(FALSE) {
  i10 <- trends10[, complete.cases(Jtu.sc, tempchange_abs.sc, REALM, tempave_metab.sc, duration.sc, mass.sc, 
                                   endothermfrac.sc, microclim.sc, npp.sc, human_bowler.sc, nspp.sc)]

  res_RFslopeRE2levdisprealm10 <- simulateResiduals(mods10[[which(names(mods10)=='modRFslopeRE2levdisprealm10')]], n = 250)
  
  saveRDS(res_RFslopeRE2levdisprealm10, file = 'temp/res_RFslopeRE2levdisprealm10.rds')
} else {
  if(file.exists('temp/res_RFslopeRE2levdisprealm10.rds')) res_RFslopeRE2levdisprealm10 <- readRDS('temp/res_res_RFslopeRE2levdisprealm10.rds')
  i10 <- trends10[, complete.cases(Jtu.sc, tempchange_abs.sc, REALM, tempave_metab.sc, duration.sc, mass.sc, 
                                   endothermfrac.sc, microclim.sc, npp.sc, human_bowler.sc, nspp.sc)]
}
```

#### Plot residuals for model fit to all data
There are many outliers and signs of underdispersion, but this is probably ok.
```{r, echo=FALSE, eval=FALSE}
if(exists('res_RFslopeRE2levdisprealm10')){
  plot(res_RFslopeRE2levdisprealm10)
  plotResiduals(res_RFslopeRE2levdisprealm10, form=trends10$tempchange_abs.sc[i10], xlab = 'tempchange_abs.sc', main = '')
  plotResiduals(res_RFslopeRE2levdisprealm10, form=trends10$REALM[i10], xlab = 'REALM', main = '')
  plotResiduals(res_RFslopeRE2levdisprealm10, trends10$tempave_metab.sc[i10], xlab = 'tempave_metab.sc', main = '')
  plotResiduals(res_RFslopeRE2levdisprealm10, trends10$duration.sc[i10], xlab = 'duration.sc', main = '')
  plotResiduals(res_RFslopeRE2levdisprealm10, trends10$mass.sc[i10], xlab = 'mass.sc', main = '')
  plotResiduals(res_RFslopeRE2levdisprealm10, trends10$endothermfrac.sc[i10], xlab = 'endothermfrac.sc', main = '')
  plotResiduals(res_RFslopeRE2levdisprealm10, trends10$microclim.sc[i10], xlab = 'microclim.sc', main = '')
  plotResiduals(res_RFslopeRE2levdisprealm10, trends10$npp.sc[i10], xlab = 'npp.sc', main = '')
  plotResiduals(res_RFslopeRE2levdisprealm10, form=trends10$human_bowler.sc[i10], xlab = 'human_bowler.sc', main = '')
}
```


#### Overdispersion
There is underdispersion.
```{r, echo=FALSE, eval=FALSE}
testDispersion(res_RFslopeRE2levdisprealm10)

```

#### Near-zero-inflation
(Zero values have been transformed to slightly >0, so can't test zero-inflation directly)

Near-zero values are not inflated.
```{r, eval=FALSE}
countNearZero <- function(x) sum(x < 0.0001)
testGeneric(res_RFslopeRE2levdisprealm10, summary = countNearZero, alternative = 'greater')

```

#### Near-one-inflation
Near-one values are not inflated.
```{r, eval=FALSE}
countNearOne <- function(x) sum(x > 0.9999)
testGeneric(res_RFslopeRE2levdisprealm10, summary = countNearOne, alternative = 'greater')

```

## Realm x duration
Compare very basic models w/ and w/out realm as an explanatory factor for differences in turnover (proportion species/yr)
```{r}
modAllJtu <- readRDS('temp/modAllJtu.rds')
modRealmAllJtu <- readRDS('temp/modRealmAllJtu.rds')
```

A model with REALM is worse than a model without (just looking at average slopes, no other covariates)
```{r}
aics <- AIC(modAllJtu, modRealmAllJtu)
aics$dAIC <- aics$AIC - min(aics$AIC)
aics
```

## Temperature slope x REALM x duration
Compare with against null. Compare tempchange vs. tempchange_abs
```{r}
modAllJtu <- readRDS(here('temp', 'modAllJtu.rds'))
moddTRealmAllJtu <- readRDS(here('temp', 'moddTRealmAllJtu.rds')) # uses tempchange
modsdTRealmAllJtu <- readRDS(here('temp', 'modsdTRealmAllJtu.rds')) # uses tempchange
```


### AIC
Clearly chooses tempchange rather than null. Also chooses tempchange over tempchange_abs.
```{r}
# compare dT models against null
aics <- AIC(modAllJtu, moddTRealmAllJtu, modsdTRealmAllJtu)
aics$dAIC <- aics$AIC - min(aics$AIC)
aics
```

### Coefficients
```{r}
summary(moddTRealmAllJtu)
```


## Temperature x temperature slope x REALM x duration
```{r}
# simple
modAllJtu <- readRDS(here('temp', 'modAllJtu.rds')) # just duration
modRealmAllJtu <- readRDS(here('temp', 'modRealmAllJtu.rds')) # realm
moddTAllJtu <- readRDS(here('temp', 'moddTAllJtu.rds')) # tempchange
modsdTAllJtu <- readRDS(here('temp', 'modsdTAllJtu.rds')) # tempchange_abs
moddTRealmAllJtu <- readRDS(here('temp', 'moddTRealmAllJtu.rds')) # tempchange and realm
modsdTRealmAllJtu <- readRDS(here('temp', 'modsdTRealmAllJtu.rds')) # tempchange_abs and realm


# TdTTRealm; versions of duration, scaled duration, and tempchange vs. _abs
modTdTTRealmAllJtu <- readRDS(here('temp', 'modTdTTRealmAllJtu.rds')) # uses duration and tempchange
modTdTTRealmDurscAllJtu <- readRDS(here('temp', 'modTdTTRealmDurscAllJtu.rds')) # uses duration.sc and tempchange
modTsdTTRealmAllJtu <- readRDS(here('temp', 'modTsdTTRealmAllJtu.rds')) # uses duration and abs(tempchange)
modTsdTTRealmDurscAllJtu <- readRDS(here('temp', 'modTsdTTRealmDurscAllJtu.rds')) # uses duration.sc and abs(tempchange)

# environmental temperature
modrawTdTTAllJtu <- readRDS(here('temp', 'modrawTdTTAllJtu.rds')) # tempave and tempchange
modrawTsdTTAllJtu <- readRDS(here('temp', 'modrawTsdTTAllJtu.rds')) # tempave and tempchange_abs
modrawTdTTRealmAllJtu <- readRDS(here('temp', 'modrawTdTTRealmAllJtu.rds')) # tempave and tempchange and realm
modrawTsdTTRealmAllJtu <- readRDS(here('temp', 'modrawTsdTTRealmAllJtu.rds')) # tempave and tempchange_abs and realm
modrawsdTtsignAllJtu <- readRDS(here('temp', 'modrawsdTtsignAllJtu.rds')) # tsign, tempchange_abs
modrawsdTRealmtsignAllJtu <- readRDS(here('temp', 'modrawsdTRealmtsignAllJtu.rds')) # tsign, tempchange_abs, realm
modrawTsdTTtsignAllJtu <- readRDS(here('temp', 'modrawTsdTTtsignAllJtu.rds')) # tempave, tempchange_abs, tsign
modrawTsdTTRealmtsignAllJtu <- readRDS(here('temp', 'modrawTsdTTRealmtsignAllJtu.rds')) # tempave, tempchange_abs, realm, tsign
```

### AIC
#### Check whether duration should be scaled
Clearly chooses un-scaled duration and abs(tempchange).
```{r}
aics <- AIC(modAllJtu, modTdTTRealmAllJtu, modTdTTRealmDurscAllJtu, modTsdTTRealmAllJtu, modTsdTTRealmDurscAllJtu, modRealmAllJtu, moddTRealmAllJtu)
aics$dAIC <- aics$AIC - min(aics$AIC)
aics
```
#### Metabolic temperature vs. environmental temperature
Prefers environmental over metabolic temperature.
```{r}
aics2 <- AIC(modAllJtu, modTsdTTRealmAllJtu, modrawTsdTTRealmAllJtu)
aics2$dAIC <- aics2$AIC - min(aics2$AIC)
aics2
```

#### Compare among environmental temperature models
```{r, rows.print=15}
aics3 <- AIC(modAllJtu, modRealmAllJtu, moddTAllJtu, modsdTAllJtu, # one var
             moddTRealmAllJtu, modsdTRealmAllJtu,  # two vars with realm
             modrawTdTTAllJtu, modrawTsdTTAllJtu, # two vars w/out realm
             modrawTdTTRealmAllJtu, modrawTsdTTRealmAllJtu, # three vars with realm
             modrawsdTtsignAllJtu, modrawsdTRealmtsignAllJtu, 
             modrawTsdTTtsignAllJtu, modrawTsdTTRealmtsignAllJtu) # tsign
aics3$dAIC <- aics3$AIC - min(aics3$AIC)
aics3
```

### Metabolic temperature
#### Make/load the tempchange_abs and tempchange predictions
Uses output from pred_GLMMmodTsdTTRealmAllJtu.R (abs) and pred_GLMMmodTdTTRealmAllJtu.R (not abs).
```{r, echo = FALSE}
if(file.exists(here('temp', 'slopes_TdTTRealm.rds'))){
  slopesTdTT <- readRDS(here('temp', 'slopes_TdTTRealm.rds'))
  print('Loaded TdTTRealm predictions from file')
} else {
  print('Making predictions from pred_GLMMmodTdTTRealmAllJtu.R output')
  
  newdat <- readRDS(here('temp', 'preds_TdTTRealm.rds')) # this also has slope.se
  
  # calculate slopes and SE of the slope using latent variables (since predictions have SE)
  mods <- newdat[, .(mod = list(lavaan(paste0('fithat ~ duration\nfithat =~ 1*Jtu.sc\nJtu.sc ~~ ', mean(Jtu.sc.se), '*Jtu.sc'), data.frame(Jtu.sc, duration)))), by = .(tempave_metab, tempchange, REALM)] # takes ~30 min
  slopesTdTT <- mods[, parameterEstimates(mod[[1]]), by = .(tempave_metab, tempchange, REALM)][lhs == 'fithat' & op == '~' & rhs == 'duration', .(tempave_metab, tempchange, REALM, slope = est, slope.se = se)] # extract the coefficients
  
  
  saveRDS(slopesTdTT, file = here('temp', 'slopes_TdTTRealm.rds'))
}

if(file.exists(here('temp', 'slopes_TsdTTRealm.rds'))){
  slopes <- readRDS(here('temp', 'slopes_TsdTTRealm.rds'))
  print('Loaded TsdTTRealm predictions from file')
} else {
  print('Making predictions from pred_GLMMmodTsdTTRealmAllJtu.R output')
  
  newdat <- readRDS(here('temp', 'preds_TsdTTRealm.rds')) # this also has slope.se
  
  # calculate slopes and SE of the slope using latent variables (since predictions have SE)
  mods <- newdat[, .(mod = list(lavaan(paste0('fithat ~ duration\nfithat =~ 1*Jtu.sc\nJtu.sc ~~ ', mean(Jtu.sc.se), '*Jtu.sc'), data.frame(Jtu.sc, duration)))), by = .(tempave_metab, tempchange_abs, REALM)] # takes ~30 min
  slopes <- mods[, parameterEstimates(mod[[1]]), by = .(tempave_metab, tempchange_abs, REALM)][lhs == 'fithat' & op == '~' & rhs == 'duration', .(tempave_metab, tempchange_abs, REALM, slope = est, slope.se = se)] # extract the coefficients
  
  
  saveRDS(slopes, file = here('temp', 'slopes_TsdTTRealm.rds'))
}
```

#### Tempchange plots
##### Interaction
```{r, echo = FALSE}
p1 <- ggplot(slopesTdTT[REALM=='Marine'], aes(tempchange, tempave_metab, z = slope)) +
    geom_raster(aes(fill = slope)) +
    labs(x = 'Temperature change (degC per year)', y = 'Metabolic temperature (degC)', title = 'Marine') +
    scale_fill_gradient2(high= "#B2182B", mid = "white", low= "#2166AC", midpoint = 0) +
    theme(axis.text = element_text(size = 12), 
          axis.title = element_text(size = 14),
          panel.background = element_blank(),
          axis.line = element_line(colour = "black"),
          legend.position = "top",
          legend.margin = margin(c(0, 0.1, -20, 0)),
          legend.justification = c(0.92, 0.9),
          legend.text=element_text(size= 12),
          legend.title=element_text(size= 18),
          legend.title.align = 1)
p2 <- ggplot(slopesTdTT[REALM=='Terrestrial'], aes(tempchange, tempave_metab, z = slope)) +
    geom_raster(aes(fill = slope)) +
    labs(x = 'Temperature change (degC per year)', y = 'Metabolic temperature (degC)', title = 'Terrestrial') +
    scale_fill_gradient2(high= "#B2182B", mid = "white", low= "#2166AC", midpoint = 0) +
    theme(axis.text = element_text(size = 12), 
          axis.title = element_text(size = 14),
          panel.background = element_blank(),
          axis.line = element_line(colour = "black"),
          legend.position = "top",
          legend.margin = margin(c(0, 0.1, -20, 0)),
          legend.justification = c(0.92, 0.9),
          legend.text=element_text(size= 12),
          legend.title=element_text(size= 18),
          legend.title.align = 1)
p3 <- ggplot(slopesTdTT[REALM=='Freshwater'], aes(tempchange, tempave_metab, z = slope)) +
    geom_raster(aes(fill = slope)) +
    labs(x = 'Temperature change (degC per year)', y = 'Metabolic temperature (degC)', title = 'Freshwater') +
    scale_fill_gradient2(high= "#B2182B", mid = "white", low= "#2166AC", midpoint = 0) +
    theme(axis.text = element_text(size = 12), 
          axis.title = element_text(size = 14),
          panel.background = element_blank(),
          axis.line = element_line(colour = "black"),
          legend.position = "top",
          legend.margin = margin(c(0, 0.1, -20, 0)),
          legend.justification = c(0.92, 0.9),
          legend.text=element_text(size= 12),
          legend.title=element_text(size= 18),
          legend.title.align = 1)

p1
p2
p3
```

##### Confidence bounds
CIs are from a SEM fit to the trends.
```{r, fig.height=8}
ggplot(slopesTdTT[round(tempave_metab,1) %in% c(10.1, 30.2),], aes(tempchange, slope, color = factor(round(tempave_metab)), group = tempave_metab)) +
    geom_line() +
    geom_pointrange(aes(ymin=slope-1.96*slope.se, ymax=slope+1.96*slope.se), alpha = 0.25) + 
    facet_grid(cols = vars(REALM))  +
    labs(x = 'dT [degC/yr]') +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
          panel.background = element_blank(), axis.line = element_line(colour = "black"),
          legend.key=element_blank(),
          axis.text=element_text(size=8),
          axis.title=element_text(size=8),
          plot.title=element_text(size=8))  

```

#### tempchange_abs plots
##### Interaction
```{r, echo = FALSE}
p1 <- ggplot(slopes[REALM=='Marine'], aes(tempchange_abs, tempave_metab, z = slope)) +
    geom_raster(aes(fill = slope)) +
    labs(x = 'Temperature change (degC per year)', y = 'Metabolic temperature (degC)', title = 'Marine') +
    scale_fill_gradient2(high= "#B2182B", mid = "white", low= "#2166AC", midpoint = 0) +
    theme(axis.text = element_text(size = 12), 
          axis.title = element_text(size = 14),
          panel.background = element_blank(),
          axis.line = element_line(colour = "black"),
          legend.position = "top",
          legend.margin = margin(c(0, 0.1, -20, 0)),
          legend.justification = c(0.92, 0.9),
          legend.text=element_text(size= 12),
          legend.title=element_text(size= 18),
          legend.title.align = 1)
p2 <- ggplot(slopes[REALM=='Terrestrial'], aes(tempchange_abs, tempave_metab, z = slope)) +
    geom_raster(aes(fill = slope)) +
    labs(x = 'Temperature change (degC per year)', y = 'Metabolic temperature (degC)', title = 'Terrestrial') +
    scale_fill_gradient2(high= "#B2182B", mid = "white", low= "#2166AC", midpoint = 0) +
    theme(axis.text = element_text(size = 12), 
          axis.title = element_text(size = 14),
          panel.background = element_blank(),
          axis.line = element_line(colour = "black"),
          legend.position = "top",
          legend.margin = margin(c(0, 0.1, -20, 0)),
          legend.justification = c(0.92, 0.9),
          legend.text=element_text(size= 12),
          legend.title=element_text(size= 18),
          legend.title.align = 1)
p3 <- ggplot(slopes[REALM=='Freshwater'], aes(tempchange_abs, tempave_metab, z = slope)) +
    geom_raster(aes(fill = slope)) +
    labs(x = 'Temperature change (degC per year)', y = 'Metabolic temperature (degC)', title = 'Freshwater') +
    scale_fill_gradient2(high= "#B2182B", mid = "white", low= "#2166AC", midpoint = 0) +
    theme(axis.text = element_text(size = 12), 
          axis.title = element_text(size = 14),
          panel.background = element_blank(),
          axis.line = element_line(colour = "black"),
          legend.position = "top",
          legend.margin = margin(c(0, 0.1, -20, 0)),
          legend.justification = c(0.92, 0.9),
          legend.text=element_text(size= 12),
          legend.title=element_text(size= 18),
          legend.title.align = 1)

p1
p2
p3
```

##### Confidence bounds
CIs are from a SEM fit to the trends.
```{r, fig.height=8}
ggplot(slopes[round(tempave_metab,1) %in% c(10.1, 30.2),], aes(tempchange_abs, slope, color = factor(round(tempave_metab)), group = tempave_metab)) +
    geom_line() +
    geom_pointrange(aes(ymin=slope-1.96*slope.se, ymax=slope+1.96*slope.se), alpha = 0.25) + 
    facet_grid(cols = vars(REALM))  +
    labs(x = '|dT|') +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
          panel.background = element_blank(), axis.line = element_line(colour = "black"),
          legend.key=element_blank(),
          axis.text=element_text(size=8),
          axis.title=element_text(size=8),
          plot.title=element_text(size=8))  

```

#### Are endotherms common at high tempave_metab on land?
Endotherms are very common at higher temperatures on land.
```{r, echo = FALSE}
trendsall[!is.na(tempave_metab.sc) & !duplicated(rarefyID), .(mean = round(mean(unscaleme(endothermfrac.sc, 'endothermfrac.sc')),2), sd = signif(sd(unscaleme(endothermfrac.sc, 'endothermfrac.sc')),2)), by = .(REALM, tempG20 = unscaleme(tempave_metab.sc, 'tempave_metab.sc') > 20 )][order(REALM, tempG20)]
```

#### Which species are common in each quadrant?
FALSE is less than 20degC, TRUE is greater than.
```{r}
trendsall[!is.na(tempave_metab.sc) & !duplicated(rarefyID), table(taxa_mod2, REALM, unscaleme(tempave_metab.sc, 'tempave_metab.sc') > 20)]
trendsall[!is.na(tempave_metab.sc) & !duplicated(rarefyID), round(prop.table(table(taxa_mod2, unscaleme(tempave_metab.sc, 'tempave_metab.sc') > 20, REALM), margin = c(2,3)),2)]

```

#### Tsign effects
```{r}
fixef(modTsdTTRealmtsignAllJtu)

```
##### Make or load temperature sign effect
Not yet updated to new method with lavaan.
```{r, echo = FALSE}
if(file.exists(here('temp', 'slopes_tsign.rds'))){
  slopestsign <- readRDS(here('temp', 'slopes_tsign.rds'))
  print('Loaded tsign predictions from file')
} else {
  print('Making tsign predictions from scratch')
  
  # set up prediction frame
  newdattsign <- data.table(expand.grid(tempave_metab.sc = seq(-1.6, 1.5, length.out = 100), tempchange = seq(-0.8, 0.8, length.out = 100), duration = seq(1, 10, length.out=10), REALM = c('Marine', 'Terrestrial', 'Freshwater')))
  newdattsign$STUDY_ID <- 1
  newdattsign$rarefyID <- 1
  newdattsign[, tempave_metab := tempave_metab.sc * scalingall[var == 'tempave_metab.sc', scale] + scalingall[var == 'tempave_metab.sc', center]]
  newdattsign[, tempchange_abs.sc := (abs(tempchange) - scalingall[var == 'tempchange_abs.sc', center])/scalingall[var == 'tempchange_abs.sc', scale]]
  newdattsign[, tsign := sign(tempchange)]
  newdattsign[tsign == 0, tsign := 1]
  # predict
  newdattsign$Jtu.sc <- predict(modTsdTTRealmtsignAllJtu, newdata = newdattsign, se.fit = FALSE, re.form = NA, allow.new.levels=TRUE, type = 'response') # takes >1 hr if se.fit=TRUE
  
  # calculate slopes
  slopestsign <- newdattsign[, .(slope = coef(lm(Jtu.sc ~ duration))[2]), by = .(tempave_metab, tempchange, tsign, REALM)]
  
  saveRDS(slopestsign, file = here('temp', 'slopes_tsign.rds'))
}
```

##### Plot tsign effects
Overall, the effects of warming and cooling at nearly equivalent.  
More biodiversity change with warming in the ocean, consistent with the temperature effect (more change at higher temperatures).  
More biodiversity change with cooling on land, consistent with the temperature effect (more change at lower tempeartures).  
```{r, echo = FALSE}
# plot
p1 <- ggplot(slopestsign[REALM=='Marine'], aes(tempchange, tempave_metab, z = slope)) +
  geom_raster(aes(fill = slope)) +
  labs(x = 'Temperature change (degC per year)', y = 'Metabolic temperature (degC)', title = 'Marine') +
  scale_fill_gradient2(high= "#B2182B", mid = "white", low= "#2166AC", midpoint = 0, name = 'Jtu slope') +
  theme(axis.text = element_text(size = 12), 
        axis.title = element_text(size = 14),
        panel.background = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.position = "top",
        legend.margin = margin(c(0, 0.1, -20, 0)),
        legend.justification = c(0.92, 0.9),
        legend.text=element_text(size= 12),
        legend.title=element_text(size= 18),
        legend.title.align = 1)
p2 <- ggplot(slopestsign[REALM=='Terrestrial'], aes(tempchange, tempave_metab, z = slope)) +
  geom_raster(aes(fill = slope)) +
  labs(x = 'Temperature change (degC per year)', y = 'Metabolic temperature (degC)', title = 'Terrestrial') +
  scale_fill_gradient2(high= "#B2182B", mid = "white", low= "#2166AC", midpoint = 0, name = 'Jtu slope') +
  theme(axis.text = element_text(size = 12), 
        axis.title = element_text(size = 14),
        panel.background = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.position = "top",
        legend.margin = margin(c(0, 0.1, -20, 0)),
        legend.justification = c(0.92, 0.9),
        legend.text=element_text(size= 12),
        legend.title=element_text(size= 18),
        legend.title.align = 1)
p3 <- ggplot(slopestsign[REALM=='Freshwater'], aes(tempchange, tempave_metab, z = slope)) +
  geom_raster(aes(fill = slope)) +
  labs(x = 'Temperature change (degC per year)', y = 'Metabolic temperature (degC)', title = 'Freshwater') +
  scale_fill_gradient2(high= "#B2182B", mid = "white", low= "#2166AC", midpoint = 0, name = 'Jtu slope') +
  theme(axis.text = element_text(size = 12), 
        axis.title = element_text(size = 14),
        panel.background = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.position = "top",
        legend.margin = margin(c(0, 0.1, -20, 0)),
        legend.justification = c(0.92, 0.9),
        legend.text=element_text(size= 12),
        legend.title=element_text(size= 18),
        legend.title.align = 1)

p1
p2
p3
```

##### Difference in slopes
These plots subtract the cooling slopes from the warming slopes.  
Plots need to be improved, I think because pixel spacing isn't even. Getting strange patterns near 0 temperature change.
```{r, echo = FALSE}
#difference in slopes
slopesM <- slopestsign[REALM=='Marine',]
slopesT <- slopestsign[REALM=='Terrestrial',]
slopesF <- slopestsign[REALM=='Freshwater',]

slopesMdiff <- slopesM[tsign== -1, .(tempave_metab, tempchange_abs = round(abs(tempchange),7), slope_cooling = slope)]
slopesMdiff <- merge(slopesMdiff, slopesM[tsign == 1, .(tempave_metab, tempchange_abs = round(abs(tempchange),7), slope_warming = slope)]) # round to allow merging
slopesMdiff[, slope := slope_warming - slope_cooling]

slopesTdiff <- slopesT[tsign== -1, .(tempave_metab, tempchange_abs = round(abs(tempchange),7), slope_cooling = slope)]
slopesTdiff <- merge(slopesTdiff, slopesT[tsign == 1, .(tempave_metab, tempchange_abs = round(abs(tempchange),7), slope_warming = slope)]) # round to allow merging
slopesTdiff[, slope := slope_warming - slope_cooling]

slopesFdiff <- slopesF[tsign== -1, .(tempave_metab, tempchange_abs = round(abs(tempchange),7), slope_cooling = slope)]
slopesFdiff <- merge(slopesFdiff, slopesF[tsign == 1, .(tempave_metab, tempchange_abs = round(abs(tempchange),7), slope_warming = slope)]) # round to allow merging
slopesFdiff[, slope := slope_warming - slope_cooling]

p1 <- ggplot(slopesMdiff, aes(tempchange_abs, tempave_metab, z = slope)) +
  geom_raster(aes(fill = slope)) +
  labs(x = 'Temperature change magnitude (degC per year)', y = 'Long-term metabolic temperature (degC)', title = 'Marine') +
  scale_fill_gradient2(high= "#B2182B", mid = "white", low= "#2166AC", midpoint = 0, name = 'Difference in Jtu slope (warming - cooling)') +
  theme(axis.text = element_text(size = 12), 
        axis.title = element_text(size = 14),
        panel.background = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.position = "top",
        legend.margin = margin(c(0, 0.1, -20, 0)),
        legend.justification = c(0.92, 0.9),
        legend.text=element_text(size= 12),
        legend.title=element_text(size= 18),
        legend.title.align = 1)
p2 <- ggplot(slopesTdiff, aes(tempchange_abs, tempave_metab, z = slope)) +
  geom_raster(aes(fill = slope)) +
  labs(x = 'Temperature change magnitude (degC per year)', y = 'Long-term metabolic temperature (degC)', title = 'Terrestrial') +
  scale_fill_gradient2(high= "#B2182B", mid = "white", low= "#2166AC", midpoint = 0, name = 'Difference in Jtu slope (warming - cooling)') +
  theme(axis.text = element_text(size = 12), 
        axis.title = element_text(size = 14),
        panel.background = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.position = "top",
        legend.margin = margin(c(0, 0.1, -20, 0)),
        legend.justification = c(0.92, 0.9),
        legend.text=element_text(size= 12),
        legend.title=element_text(size= 18),
        legend.title.align = 1)
p3 <- ggplot(slopesFdiff, aes(tempchange_abs, tempave_metab, z = slope)) +
  geom_raster(aes(fill = slope)) +
  labs(x = 'Temperature change magnitude (degC per year)', y = 'Long-term metabolic temperature (degC)', title = 'Freshwater') +
  scale_fill_gradient2(high= "#B2182B", mid = "white", low= "#2166AC", midpoint = 0, name = 'Difference in Jtu slope (warming - cooling)') +
  theme(axis.text = element_text(size = 12), 
        axis.title = element_text(size = 14),
        panel.background = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.position = "top",
        legend.margin = margin(c(0, 0.1, -20, 0)),
        legend.justification = c(0.92, 0.9),
        legend.text=element_text(size= 12),
        legend.title=element_text(size= 18),
        legend.title.align = 1)
p1
p2
p3
```

### Environmental temperature
#### Make/load predictions
Uses output from pred_GLMMmodrawTsdTTRealmAllJtu.R (abs), pred_GLMMmodrawTdTTRealmAllJtu.R (not abs), and pred_GLMMmodrawTsdTTRealmtsignAllJtu.R (tsign)
```{r, echo = FALSE}
# using tempchange_abs
if(file.exists(here('temp', 'slopes_rawTsdTTRealm.rds'))){
  slopesrawTsdTT <- readRDS(here('temp', 'slopes_rawTsdTTRealm.rds'))
  print('Loaded tempchange_abs predictions from file')
} else {
  print('Making predictions from pred_GLMMmodrawTsdTTRealmAllJtu.R output')
  
  newdat <- readRDS(here('temp', 'preds_rawTsdTTRealm.rds')) # this also has slope.se
  
  # calculate slopes and SE of the slope using latent variables (since predictions have SE)
  mods <- newdat[, .(mod = list(lavaan(paste0('fithat ~ duration\nfithat =~ 1*Jtu.sc\nJtu.sc ~~ ', mean(Jtu.sc.se), '*Jtu.sc'), data.frame(Jtu.sc, duration)))), by = .(tempave, tempchange_abs, REALM)] # takes ~30 min
  slopesrawTsdTT <- mods[, parameterEstimates(mod[[1]]), by = .(tempave, tempchange_abs, REALM)][lhs == 'fithat' & op == '~' & rhs == 'duration', .(tempave, tempchange_abs, REALM, slope = est, slope.se = se)] # extract the coefficients
  
  saveRDS(slopesrawTsdTT, file = here('temp', 'slopes_rawTsdTTRealm.rds'))
}

# using tempchange
if(file.exists(here('temp', 'slopes_rawTdTTRealm.rds'))){
  slopesrawTdTT <- readRDS(here('temp', 'slopes_rawTdTTRealm.rds'))
  print('Loaded tempchange predictions from file')
} else {
  print('Making predictions from pred_GLMMmodrawTdTTRealmAllJtu.R output')
  
  newdat <- readRDS(here('temp', 'preds_rawTdTTRealm.rds')) # this also has slope.se
  
  # calculate slopes and SE of the slope using latent variables (since predictions have SE)
  mods <- newdat[, .(mod = list(lavaan(paste0('fithat ~ duration\nfithat =~ 1*Jtu.sc\nJtu.sc ~~ ', mean(Jtu.sc.se), '*Jtu.sc'), data.frame(Jtu.sc, duration)))), by = .(tempave, tempchange, REALM)] # takes ~30 min
  slopesrawTdTT <- mods[, parameterEstimates(mod[[1]]), by = .(tempave, tempchange, REALM)][lhs == 'fithat' & op == '~' & rhs == 'duration', .(tempave, tempchange, REALM, slope = est, slope.se = se)] # extract the coefficients
  
  saveRDS(slopesrawTdTT, file = here('temp', 'slopes_rawTdTTRealm.rds'))
}

# using tsign
if(file.exists(here('temp', 'slopes_interactions2.rds'))){
  slopestsign <- readRDS(here('temp', 'slopes_rawRealmtsign.rds'))
  print('Loaded tsign predictions from file')

} else {
  print('No tsign effects. Need to run pred_GLMMmodrawTsdTTRealmtsignAllJtu.R')
  
}

```

#### Tempchange plots
##### Interaction
```{r, echo = FALSE}
p1 <- ggplot(slopesrawTdTT[REALM=='Marine'], aes(tempchange, tempave, z = slope)) +
    geom_raster(aes(fill = slope)) +
    labs(x = 'Temperature change (degC per year)', y = 'Environmental temperature (degC)', title = 'Marine') +
    scale_fill_gradient2(high= "#B2182B", mid = "white", low= "#2166AC", midpoint = 0) +
    theme(axis.text = element_text(size = 12), 
          axis.title = element_text(size = 14),
          panel.background = element_blank(),
          axis.line = element_line(colour = "black"),
          legend.position = "top",
          legend.margin = margin(c(0, 0.1, -20, 0)),
          legend.justification = c(0.92, 0.9),
          legend.text=element_text(size= 12),
          legend.title=element_text(size= 18),
          legend.title.align = 1)
p2 <- ggplot(slopesrawTdTT[REALM=='Terrestrial'], aes(tempchange, tempave, z = slope)) +
    geom_raster(aes(fill = slope)) +
    labs(x = 'Temperature change (degC per year)', y = 'Environmental temperature (degC)', title = 'Terrestrial') +
    scale_fill_gradient2(high= "#B2182B", mid = "white", low= "#2166AC", midpoint = 0) +
    theme(axis.text = element_text(size = 12), 
          axis.title = element_text(size = 14),
          panel.background = element_blank(),
          axis.line = element_line(colour = "black"),
          legend.position = "top",
          legend.margin = margin(c(0, 0.1, -20, 0)),
          legend.justification = c(0.92, 0.9),
          legend.text=element_text(size= 12),
          legend.title=element_text(size= 18),
          legend.title.align = 1)
p3 <- ggplot(slopesrawTdTT[REALM=='Freshwater'], aes(tempchange, tempave, z = slope)) +
    geom_raster(aes(fill = slope)) +
    labs(x = 'Temperature change (degC per year)', y = 'Environmental temperature (degC)', title = 'Freshwater') +
    scale_fill_gradient2(high= "#B2182B", mid = "white", low= "#2166AC", midpoint = 0) +
    theme(axis.text = element_text(size = 12), 
          axis.title = element_text(size = 14),
          panel.background = element_blank(),
          axis.line = element_line(colour = "black"),
          legend.position = "top",
          legend.margin = margin(c(0, 0.1, -20, 0)),
          legend.justification = c(0.92, 0.9),
          legend.text=element_text(size= 12),
          legend.title=element_text(size= 18),
          legend.title.align = 1)

p1
p2
p3
```

##### Confidence bounds
CIs are from a SEM fit to the trends.
```{r, fig.height=8}
vals <- slopesrawTdTT[c(which.min(abs(tempave - 10)), which.min(abs(tempave-25))), unique(tempave)] # show 10 and 25degC
ggplot(slopesrawTdTT[tempave %in% vals,], 
       aes(tempchange, slope, color = factor(round(tempave)), group = tempave)) +
    geom_line() +
    geom_pointrange(aes(ymin=slope-1.96*slope.se, ymax=slope+1.96*slope.se), alpha = 0.25) + 
    facet_grid(cols = vars(REALM))  +
    labs(x = 'dT [degC/yr]') +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
          panel.background = element_blank(), axis.line = element_line(colour = "black"),
          legend.key=element_blank(),
          axis.text=element_text(size=8),
          axis.title=element_text(size=8),
          plot.title=element_text(size=8))  

```

#### tempchange_abs plots
##### Interaction
```{r, echo = FALSE}
p1 <- ggplot(slopesrawTsdTT[REALM=='Marine'], aes(tempchange_abs, tempave, z = slope)) +
    geom_raster(aes(fill = slope)) +
    labs(x = 'Temperature change (degC per year)', y = 'Environmental temperature (degC)', title = 'Marine') +
    scale_fill_gradient2(high= "#B2182B", mid = "white", low= "#2166AC", midpoint = 0) +
    theme(axis.text = element_text(size = 12), 
          axis.title = element_text(size = 14),
          panel.background = element_blank(),
          axis.line = element_line(colour = "black"),
          legend.position = "top",
          legend.margin = margin(c(0, 0.1, -20, 0)),
          legend.justification = c(0.92, 0.9),
          legend.text=element_text(size= 12),
          legend.title=element_text(size= 18),
          legend.title.align = 1)
p2 <- ggplot(slopesrawTsdTT[REALM=='Terrestrial'], aes(tempchange_abs, tempave, z = slope)) +
    geom_raster(aes(fill = slope)) +
    labs(x = 'Temperature change (degC per year)', y = 'Environmental temperature (degC)', title = 'Terrestrial') +
    scale_fill_gradient2(high= "#B2182B", mid = "white", low= "#2166AC", midpoint = 0) +
    theme(axis.text = element_text(size = 12), 
          axis.title = element_text(size = 14),
          panel.background = element_blank(),
          axis.line = element_line(colour = "black"),
          legend.position = "top",
          legend.margin = margin(c(0, 0.1, -20, 0)),
          legend.justification = c(0.92, 0.9),
          legend.text=element_text(size= 12),
          legend.title=element_text(size= 18),
          legend.title.align = 1)
p3 <- ggplot(slopesrawTsdTT[REALM=='Freshwater'], aes(tempchange_abs, tempave, z = slope)) +
    geom_raster(aes(fill = slope)) +
    labs(x = 'Temperature change (degC per year)', y = 'Environmental temperature (degC)', title = 'Freshwater') +
    scale_fill_gradient2(high= "#B2182B", mid = "white", low= "#2166AC", midpoint = 0) +
    theme(axis.text = element_text(size = 12), 
          axis.title = element_text(size = 14),
          panel.background = element_blank(),
          axis.line = element_line(colour = "black"),
          legend.position = "top",
          legend.margin = margin(c(0, 0.1, -20, 0)),
          legend.justification = c(0.92, 0.9),
          legend.text=element_text(size= 12),
          legend.title=element_text(size= 18),
          legend.title.align = 1)

p1
p2
p3
```
##### Confidence bounds
CIs are from a SEM fit to the trends.
```{r, fig.height=8}
vals <- slopesrawTsdTT[c(which.min(abs(tempave - 10)), which.min(abs(tempave-25))), unique(tempave)] # show 10 and 25degC
ggplot(slopesrawTsdTT[tempave %in% vals,], 
       aes(tempchange_abs, slope, color = factor(round(tempave)), group = tempave)) +
    geom_line() +
    geom_pointrange(aes(ymin=slope-1.96*slope.se, ymax=slope+1.96*slope.se), alpha = 0.25) + 
    facet_grid(cols = vars(REALM))  +
    labs(x = '|dT|') +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
          panel.background = element_blank(), axis.line = element_line(colour = "black"),
          legend.key=element_blank(),
          axis.text=element_text(size=8),
          axis.title=element_text(size=8),
          plot.title=element_text(size=8))  

```

#### tsign effects
```{r}
fixef(modTsdTTRealmtsignAllJtu)

```

##### Interaction
###### Across realms
modrawTsdTTtsignAllJtu model that doesn't have realm
```{r, echo = FALSE}
# plot
p1 <- ggplot(slopestsign, aes(tempchange, tempave, z = slope_tsign)) +
  geom_raster(aes(fill = slope_tsign)) +
  labs(x = 'Temperature change (degC per year)', y = 'Temperature (degC)', title = 'All realms') +
  scale_fill_gradient2(high= "#B2182B", mid = "white", low= "#2166AC", midpoint = 0, name = 'Jtu slope') +
  theme(axis.text = element_text(size = 12), 
        axis.title = element_text(size = 14),
        panel.background = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.position = "top",
        legend.margin = margin(c(0, 0.1, -20, 0)),
        legend.justification = c(0.92, 0.9),
        legend.text=element_text(size= 12),
        legend.title=element_text(size= 18),
        legend.title.align = 1)

p1
```

###### By realm
modrawTsdTTRealmtsignAllJtu model
```{r, echo = FALSE}
# plot
p1 <- ggplot(slopestsign[REALM=='Marine'], aes(tempchange, tempave, z = slope_realmtsign)) +
  geom_raster(aes(fill = slope_realmtsign)) +
  labs(x = 'Temperature change (degC per year)', y = 'Temperature (degC)', title = 'Marine') +
  scale_fill_gradient2(high= "#B2182B", mid = "white", low= "#2166AC", midpoint = 0, name = 'Jtu slope') +
  theme(axis.text = element_text(size = 12), 
        axis.title = element_text(size = 14),
        panel.background = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.position = "top",
        legend.margin = margin(c(0, 0.1, -20, 0)),
        legend.justification = c(0.92, 0.9),
        legend.text=element_text(size= 12),
        legend.title=element_text(size= 18),
        legend.title.align = 1)
p2 <- ggplot(slopestsign[REALM=='Terrestrial'], aes(tempchange, tempave, z = slope_realmtsign)) +
  geom_raster(aes(fill = slope_realmtsign)) +
  labs(x = 'Temperature change (degC per year)', y = 'Temperature (degC)', title = 'Terrestrial') +
  scale_fill_gradient2(high= "#B2182B", mid = "white", low= "#2166AC", midpoint = 0, name = 'Jtu slope') +
  theme(axis.text = element_text(size = 12), 
        axis.title = element_text(size = 14),
        panel.background = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.position = "top",
        legend.margin = margin(c(0, 0.1, -20, 0)),
        legend.justification = c(0.92, 0.9),
        legend.text=element_text(size= 12),
        legend.title=element_text(size= 18),
        legend.title.align = 1)
p3 <- ggplot(slopestsign[REALM=='Freshwater'], aes(tempchange, tempave, z = slope_realmtsign)) +
  geom_raster(aes(fill = slope_realmtsign)) +
  labs(x = 'Temperature change (degC per year)', y = 'Temperature (degC)', title = 'Freshwater') +
  scale_fill_gradient2(high= "#B2182B", mid = "white", low= "#2166AC", midpoint = 0, name = 'Jtu slope') +
  theme(axis.text = element_text(size = 12), 
        axis.title = element_text(size = 14),
        panel.background = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.position = "top",
        legend.margin = margin(c(0, 0.1, -20, 0)),
        legend.justification = c(0.92, 0.9),
        legend.text=element_text(size= 12),
        legend.title=element_text(size= 18),
        legend.title.align = 1)

p1
p2
p3
```

##### Confidence bounds
###### Across realms
CIs are from a SEM fit to the trends.
```{r, fig.height=8}
vals <- slopestsign[c(which.min(abs(tempave - 10)), which.min(abs(tempave-25))), unique(tempave)] # show 10 and 25degC
ggplot(slopestsign[tempave %in% vals,], 
       aes(tempchange, slope_tsign, color = factor(round(tempave)), group = tempave)) +
    geom_hline(yintercept = 0, linetype = 'dashed') +
    geom_line() +
    geom_pointrange(aes(ymin=slope_tsign-1.96*slope_tsign.se, ymax=slope_tsign+1.96*slope_tsign.se), alpha = 0.25) + 
    labs(x = 'dT [degC/yr]') +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
          panel.background = element_blank(), axis.line = element_line(colour = "black"),
          legend.key=element_blank(),
          axis.text=element_text(size=8),
          axis.title=element_text(size=8),
          plot.title=element_text(size=8))  

```

###### By realm
CIs are from a SEM fit to the trends.
```{r, fig.height=8}
vals <- slopestsign[c(which.min(abs(tempave - 10)), which.min(abs(tempave-25))), unique(tempave)] # show 10 and 25degC
ggplot(slopestsign[tempave %in% vals,], 
       aes(tempchange, slope_realmtsign, color = factor(round(tempave)), group = tempave)) +
    geom_line() +
    geom_pointrange(aes(ymin=slope_realmtsign-1.96*slope_realmtsign.se, ymax=slope_realmtsign+1.96*slope_realmtsign.se), alpha = 0.25) + 
    facet_grid(cols = vars(REALM))  +
    labs(x = 'dT [degC/yr]') +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
          panel.background = element_blank(), axis.line = element_line(colour = "black"),
          legend.key=element_blank(),
          axis.text=element_text(size=8),
          axis.title=element_text(size=8),
          plot.title=element_text(size=8))  

```


#### Are endotherms common at high tempave on land?
tempG20 means temperature > 20degC. Endotherms are common at all environmental temperatures on land, not just high temperatures.
```{r, echo = FALSE}
trendsall[!is.na(tempave.sc) & !duplicated(rarefyID), .(mean = round(mean(unscaleme(endothermfrac.sc, 'endothermfrac.sc')),2), sd = signif(sd(unscaleme(endothermfrac.sc, 'endothermfrac.sc')),2)), by = .(REALM, tempG20 = unscaleme(tempave.sc, 'tempave.sc') > 20 )][order(REALM, tempG20),]
```

#### Which species are common in each quadrant?
FALSE is less than 20degC, TRUE is greater than.
```{r}
trendsall[!is.na(tempave.sc) & !duplicated(rarefyID), table(taxa_mod2, unscaleme(tempave.sc, 'tempave.sc') > 20, REALM)]
trendsall[!is.na(tempave.sc) & !duplicated(rarefyID), round(prop.table(table(taxa_mod2, unscaleme(tempave.sc, 'tempave.sc') > 20, REALM), margin = c(2,3)),2)]
```


## Latitude or temperature?
Compare temperature vs. latitude in an interaction with abs(tempchange). Not very useful until we fit abs(latitude) model so that effects are mirrored at each pole.
```{r}
modTsdTTRealmAllJtu <- readRDS(here('temp', 'modTsdTTRealmAllJtu.rds')) # uses temperature
modrawTsdTTRealmAllJtu <- readRDS(here('temp', 'modrawTsdTTRealmAllJtu.rds')) # uses environmental temperature
modLatsdTTRealmAllJtu <- readRDS(here('temp', 'modLatsdTTRealmAllJtu.rds')) # uses latitude
```

### AIC
Clearly chooses environmental temperature.
```{r}
aics <- AIC(modTsdTTRealmAllJtu, modLatsdTTRealmAllJtu, modrawTsdTTRealmAllJtu)
aics$dAIC <- aics$AIC - min(aics$AIC)
aics
```


## Covariate x Temperature x temperature slope x REALM x duration
### Metabolic temperature models
```{r, echo = FALSE}
modTsdTTRealmtsignAllJtu <- readRDS('temp/modTsdTTRealmtsignAllJtu.rds') # has temperature change sign
modTsdTTRealmnppAllJtu <- readRDS('temp/modTsdTTRealmnppAllJtu.rds') # has npp
modTsdTTRealmseasAllJtu <- readRDS('temp/modTsdTTRealmseasAllJtu.rds') # has seasonality
modTsdTTRealmmicroclimAllJtu <- readRDS('temp/modTsdTTRealmmicroclimAllJtu.rds') # has microclimates
modTsdTTRealmhumanAllJtu <- readRDS('temp/modTsdTTRealmhumanAllJtu.rds') # has human impact
#modTsdTTRealmmassAllJtu <- readRDS('temp/modTsdTTRealmmassAllJtu.rds') # has mass
```


#### AIC among covariate models
All covariate models are preferred over the baseline model.  
Microclimates and mass are the preferred covariates.
```{r}
aics <- AIC(modTsdTTRealmAllJtu, modTsdTTRealmtsignAllJtu, modTsdTTRealmnppAllJtu, 
            modTsdTTRealmseasAllJtu, modTsdTTRealmmicroclimAllJtu,
            modTsdTTRealmhumanAllJtu, modTsdTTRealmmassAllJtu)
aics$dAIC <- aics$AIC - min(aics$AIC)
aics
```

#### Microclimate summary
```{r}
fixef(modTsdTTRealmmicroclimAllJtu)

```

##### Make or load the microclimate interaction
Better to rewrite this to use slopes_interactions2.rds
```{r, echo = FALSE}
if(file.exists(here('temp', 'slopes_microclim1.rds'))){
  slopes1 <- readRDS(here('temp', 'slopes_microclim1.rds'))
  print('Loaded microclim predictions from file')
} else {
  print('Making microclim predictions from scratch')
  
  # set up prediction frame
newdat1 <- data.table(expand.grid(tempave_metab.sc = seq(-1.6, 1.5, length.out = 100), tempchange_abs = seq(0, 0.8, length.out = 100), duration = 1:10, REALM = c('Marine', 'Terrestrial'), microclim.sc = c(-2, 2)))
newdat1$STUDY_ID <- 1
newdat1$rarefyID <- 1
newdat1[, tempave_metab := tempave_metab.sc * scalingall[var == 'tempave_metab.sc', scale] + scalingall[var == 'tempave_metab.sc', center]]
newdat1[, tempchange_abs.sc := (tempchange_abs - scalingall[var == 'tempchange_abs.sc', center]) / scalingall[var == 'tempchange_abs.sc', scale]]

# predict
newdat1$Jtu.sc.microclim <- predict(modTsdTTRealmmicroclimAllJtu, newdata = newdat1, se.fit = FALSE, re.form = NA, allow.new.levels=TRUE, type = 'response')

# calculate slopes
slopes1 <- newdat1[, .(slope_microclim = coef(lm(Jtu.sc.microclim ~ duration))[2]), by = .(tempave_metab, tempchange_abs, microclim.sc, REALM)]

  saveRDS(slopes1, file = here('temp', 'slopes_microclim1.rds'))

}
```


##### Plot the temperature interaction by realm for the microclimate model
Microclimates affect the overall magnitude of change, but not the relationship between change and temperature.
```{r, echo = FALSE}
# plot
p1 <- ggplot(slopes1, aes(tempchange_abs, tempave_metab, z = slope_microclim)) +
  geom_raster(aes(fill = slope_microclim)) +
  labs(x = 'Temperature change (degC per year)', y = 'Long-term metabolic temperature (degC)', title = 'Few (left) or many (right) microclimates') +
  scale_fill_gradient2(high= "#B2182B", mid = "white", low= "#2166AC", midpoint = 0) +
  facet_grid(row = vars(REALM), col = vars(microclim.sc)) +
  theme(axis.text = element_text(size = 12), 
        axis.title = element_text(size = 14),
        panel.background = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.position = "top",
        legend.margin = margin(c(0, 0.1, -20, 0)),
        legend.justification = c(0.92, 0.9),
        legend.text=element_text(size= 12),
        legend.title=element_text(size= 18),
        legend.title.align = 1)

p1
```

#### Seasonality summary

##### Make or load the seasonality interaction
Better to replace with slopes_interactions2.rds
```{r, echo = FALSE}
if(file.exists(here('temp', 'slopes_seas1.rds'))){
  slopes1 <- readRDS(here('temp', 'slopes_seas1.rds'))
  print('Loaded seas predictions from file')
} else {
  print('Making seas predictions from scratch')
  
  # set up prediction frame
newdat1 <- data.table(expand.grid(tempave_metab.sc = seq(-1.6, 1.5, length.out = 100), tempchange_abs = seq(0, 0.8, length.out = 100), duration = 1:10, REALM = c('Marine', 'Terrestrial'), seas.sc = c(-2, 2)))
newdat1$STUDY_ID <- 1
newdat1$rarefyID <- 1
newdat1[, tempave_metab := tempave_metab.sc * scalingall[var == 'tempave_metab.sc', scale] + scalingall[var == 'tempave_metab.sc', center]]
newdat1[, tempchange_abs.sc := (tempchange_abs - scalingall[var == 'tempchange_abs.sc', center]) / scalingall[var == 'tempchange_abs.sc', scale]]

# predict
newdat1$Jtu.sc.seas <- predict(modTsdTTRealmseasAllJtu, newdata = newdat1, se.fit = FALSE, re.form = NA, allow.new.levels=TRUE, type = 'response')

# calculate slopes
slopes1 <- newdat1[, .(slope_seas = coef(lm(Jtu.sc.seas ~ duration))[2]), by = .(tempave_metab, tempchange_abs, seas.sc, REALM)]

  saveRDS(slopes1, file = here('temp', 'slopes_seas1.rds'))

}
```


##### Plot the temperature interaction by realm for the seasonality model
Seasonality affects the overall magnitude of change, but not the relationship between change and temperature.
```{r, echo = FALSE}
# plot
p1 <- ggplot(slopes1, aes(tempchange_abs, tempave_metab, z = slope_seas)) +
  geom_raster(aes(fill = slope_seas)) +
  labs(x = 'Temperature change (degC per year)', y = 'Metabolic temperature (degC)', title = 'Low (left) or high (right) seasonality') +
  scale_fill_gradient2(high= "#B2182B", mid = "white", low= "#2166AC", midpoint = 0) +
  facet_grid(row = vars(REALM), col = vars(seas.sc)) +
  theme(axis.text = element_text(size = 12), 
        axis.title = element_text(size = 14),
        panel.background = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.position = "top",
        legend.margin = margin(c(0, 0.1, -20, 0)),
        legend.justification = c(0.92, 0.9),
        legend.text=element_text(size= 12),
        legend.title=element_text(size= 18),
        legend.title.align = 1)

p1
```
#### Mass summary

##### Make or load the mass interaction
```{r, echo = FALSE}
if(file.exists(here('temp', 'slopes_mass1.rds'))){
  slopes1 <- readRDS(here('temp', 'slopes_mass1.rds'))
  print('Loaded mass predictions from file')
} else {
  print('Making mass predictions from scratch')
  
  # set up prediction frame
newdat1 <- data.table(expand.grid(tempave_metab.sc = seq(-1.6, 1.5, length.out = 100), tempchange_abs = seq(0, 0.8, length.out = 100), duration = 1:10, REALM = c('Marine', 'Terrestrial'), mass.sc = c(-2, 2)))
newdat1$STUDY_ID <- 1
newdat1$rarefyID <- 1
newdat1[, tempave_metab := tempave_metab.sc * scalingall[var == 'tempave_metab.sc', scale] + scalingall[var == 'tempave_metab.sc', center]]
newdat1[, tempchange_abs.sc := (tempchange_abs - scalingall[var == 'tempchange_abs.sc', center]) / scalingall[var == 'tempchange_abs.sc', scale]]

# predict
newdat1$Jtu.sc.mass <- predict(modTsdTTRealmmassAllJtu, newdata = newdat1, se.fit = FALSE, re.form = NA, allow.new.levels=TRUE, type = 'response')

# calculate slopes
slopes1 <- newdat1[, .(slope_mass = coef(lm(Jtu.sc.mass ~ duration))[2]), by = .(tempave_metab, tempchange_abs, mass.sc, REALM)]

  saveRDS(slopes1, file = here('temp', 'slopes_mass1.rds'))

}
```


##### Plot the temperature interaction by realm for the mass model
Mass affect the overall magnitude of change, but not the relationship between change and temperature.
```{r, echo = FALSE}
# plot
p1 <- ggplot(slopes1, aes(tempchange_abs, tempave_metab, z = slope_mass)) +
  geom_raster(aes(fill = slope_mass)) +
  labs(x = 'Temperature change (degC per year)', y = 'Metabolic temperature (degC)', title = 'Low (left) or high (right) mass') +
  scale_fill_gradient2(high= "#B2182B", mid = "white", low= "#2166AC", midpoint = 0) +
  facet_grid(row = vars(REALM), col = vars(mass.sc)) +
  theme(axis.text = element_text(size = 12), 
        axis.title = element_text(size = 14),
        panel.background = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.position = "top",
        legend.margin = margin(c(0, 0.1, -20, 0)),
        legend.justification = c(0.92, 0.9),
        legend.text=element_text(size= 12),
        legend.title=element_text(size= 18),
        legend.title.align = 1)

p1
```
#### Interactions as lines
##### Load the interaction effects
```{r, echo = FALSE}

if(file.exists(here('temp', 'slopes_interactions2.rds'))){
  slopes2 <- readRDS(here('temp', 'slopes_interactions2.rds'))
  print('Loaded interaction predictions from file')

} else {
  print('Need to run pred_GLMMmodTsdTTRealmCovariate.R')
  
}

```

##### Plot the interactions (raw)
More response to changing temperatures with
- less microclimate availability: thermal refugia are absent
- more seasonality: may indicate that phenological shifts are common and easier
- more human impacts on land: suggests cumulative effects of humans
- higher NPP (or less response with low NPP) in the ocean
- smaller body size in cold marine environments

Error bars are 95% CIs
```{r, echo = FALSE}
# plot
p1 <- ggplot(slopes2, aes(tempchange_abs, slope_microclim, color = microclim, group = microclim)) +
    geom_line() +
    geom_pointrange(aes(ymin=slope_microclim-1.96*slope_microclim.se, ymax=slope_microclim+1.96*slope_microclim.se), alpha = 0.25) + 
    facet_grid(cols = vars(REALM), rows = vars(tempave_metab), labeller = label_both)
p2 <- ggplot(slopes2, aes(tempchange_abs, slope_npp, color = npp, group = npp)) +
    geom_line() +
    geom_pointrange(aes(ymin=slope_npp-1.96*slope_npp.se, ymax=slope_npp+1.96*slope_npp.se), alpha = 0.25) + 
    facet_grid(cols = vars(REALM), rows = vars(tempave_metab), labeller = label_both)
p3 <- ggplot(slopes2, aes(tempchange_abs, slope_seas, color = seas, group = seas)) +
    geom_line() +
    geom_pointrange(aes(ymin=slope_seas-1.96*slope_seas.se, ymax=slope_seas+1.96*slope_seas.se), alpha = 0.25) + 
    facet_grid(cols = vars(REALM), rows = vars(tempave_metab))
p4 <- ggplot(slopes2, aes(tempchange_abs, slope_human, color = human_bowler, group = human_bowler)) +
    geom_line() +
    geom_pointrange(aes(ymin=slope_human-1.96*slope_human.se, ymax=slope_human+1.96*slope_human.se), alpha = 0.25) + 
    facet_grid(cols = vars(REALM), rows = vars(tempave_metab), labeller = label_both)
p5 <- ggplot(slopes2, aes(tempchange_abs, slope_mass, color = mass, group = mass)) +
    geom_line() +
    geom_pointrange(aes(ymin=slope_mass-1.96*slope_mass.se, ymax=slope_mass+1.96*slope_mass.se), alpha = 0.25) + 
    facet_grid(cols = vars(REALM), rows = vars(tempave_metab), labeller = label_both)

p1
p2
p3
p4
p5
```


### Environmental temperature models
```{r, echo = FALSE}
# simple to more complex models
modRealmAllJtu <- readRDS(here('temp', 'modRealmAllJtu.rds')) # only realm
moddTRealmAllJtu <- readRDS(here('temp', 'moddTRealmAllJtu.rds')) # tempchange and realm
modrawTdTTRealmAllJtu <- readRDS(here('temp', 'modrawTdTTRealmAllJtu.rds')) # uses environmental temperature, tempchange, realm
modrawTsdTTRealmAllJtu <- readRDS(here('temp', 'modrawTsdTTRealmAllJtu.rds')) # uses environmental temperature, tempchange_abs, realm
modrawTsdTTtsignAllJtu <- readRDS(here('temp', 'modrawTsdTTtsignAllJtu.rds')) # tempave, tempchange_abs, tsign
modrawTsdTTRealmtsignAllJtu <- readRDS(here('temp', 'modrawTsdTTRealmtsignAllJtu.rds')) # tempave, tempchange_abs, realm, tsign


# covariate models w/out covariate:tempave:tempchange_abs
modrawTsdTTRealmnppsdTAllJtu <- readRDS(here('temp', 'modrawTsdTTRealmnppsdTAllJtu.rds')) # has npp
modrawTsdTTRealmseassdTAllJtu <- readRDS(here('temp', 'modrawTsdTTRealmseassdTAllJtu.rds')) # has seasonality
modrawTsdTTRealmmicroclimsdTAllJtu <- readRDS(here('temp', 'modrawTsdTTRealmmicroclimsdTAllJtu.rds')) # has microclimates
modrawTsdTTRealmhumansdTAllJtu <- readRDS(here('temp', 'modrawTsdTTRealmhumansdTAllJtu.rds')) # has human impact

# covariate models w/ covariate:tempave:tempchange_abs
modrawTsdTTRealmnppAllJtu <- readRDS(here('temp', 'modrawTsdTTRealmnppAllJtu.rds')) # has npp
modrawTsdTTRealmseasAllJtu <- readRDS(here('temp', 'modrawTsdTTRealmseasAllJtu.rds')) # has seasonality
modrawTsdTTRealmmicroclimAllJtu <- readRDS(here('temp', 'modrawTsdTTRealmmicroclimAllJtu.rds')) # has microclimates
modrawTsdTTRealmhumanAllJtu <- readRDS(here('temp', 'modrawTsdTTRealmhumanAllJtu.rds')) # has human impact


```

#### AIC
##### Compare simple covariate models
```{r, rows.print=15}
aics <- AIC(modRealmAllJtu, moddTRealmAllJtu, 
            modrawTdTTRealmAllJtu, modrawTsdTTRealmAllJtu,
            modrawTsdTTtsignAllJtu, modrawTsdTTRealmtsignAllJtu,
            modrawTsdTTRealmnppsdTAllJtu, modrawTsdTTRealmseassdTAllJtu, # w/out cov:T:sdT
            modrawTsdTTRealmmicroclimsdTAllJtu, modrawTsdTTRealmhumansdTAllJtu)
aics$dAIC <- aics$AIC - min(aics$AIC)
aics

```
##### Compare simple to complex covariate models 
```{r, rows.print=15}
aics <- AIC(modrawTsdTTtsignAllJtu, modrawTsdTTRealmtsignAllJtu,
            modrawTsdTTRealmnppsdTAllJtu, modrawTsdTTRealmseassdTAllJtu, # w/out cov:T:sdT
            modrawTsdTTRealmmicroclimsdTAllJtu, modrawTsdTTRealmhumansdTAllJtu,
            modrawTsdTTRealmnppAllJtu, modrawTsdTTRealmseasAllJtu, # w/ cov:T:sdT
            modrawTsdTTRealmmicroclimAllJtu, modrawTsdTTRealmhumanAllJtu)
aics$dAIC <- aics$AIC - min(aics$AIC)
aics

```

#### Interactions as lines
##### Load the interaction effects
```{r, echo = FALSE}

if(file.exists(here('temp', 'slopes_rawinteractions2.rds'))){
  slopesraw2 <- readRDS(here('temp', 'slopes_rawinteractions2.rds'))
  print('Loaded interaction predictions from file')

} else {
  print('Need to run pred_GLMMmodrawTsdTTRealmCovariate.R')
  
}

```

##### Plot the interactions (raw)
More response to changing temperatures with...

Error bars are 95% CIs
```{r echo=FALSE, fig.height=15, fig.width=6}
# plot
p1 <- ggplot(slopesraw2, aes(tempchange_abs, slope_microclim, color = microclim, group = microclim)) +
    geom_line() +
    geom_pointrange(aes(ymin=slope_microclim-1.96*slope_microclim.se, ymax=slope_microclim+1.96*slope_microclim.se), alpha = 0.25) + 
    facet_grid(cols = vars(REALM), rows = vars(tempave), labeller = label_both)
p2 <- ggplot(slopesraw2, aes(tempchange_abs, slope_npp, color = npp, group = npp)) +
    geom_line() +
    geom_pointrange(aes(ymin=slope_npp-1.96*slope_npp.se, ymax=slope_npp+1.96*slope_npp.se), alpha = 0.25) + 
    facet_grid(cols = vars(REALM), rows = vars(tempave), labeller = label_both)
p3 <- ggplot(slopesraw2, aes(tempchange_abs, slope_seas, color = seas, group = seas)) +
    geom_line() +
    geom_pointrange(aes(ymin=slope_seas-1.96*slope_seas.se, ymax=slope_seas+1.96*slope_seas.se), alpha = 0.25) + 
    facet_grid(cols = vars(REALM), rows = vars(tempave))
p4 <- ggplot(slopesraw2, aes(tempchange_abs, slope_human, color = human_bowler, group = human_bowler)) +
    geom_line() +
    geom_pointrange(aes(ymin=slope_human-1.96*slope_human.se, ymax=slope_human+1.96*slope_human.se), alpha = 0.25) + 
    facet_grid(cols = vars(REALM), rows = vars(tempave), labeller = label_both)

p1
p2
p3
p4
```

## Thermal bias test
Does the thermal bias of a community explain the propensity to change when temperature changes? 

### Use the metabolic temperature
Model with thermal bias is selected
```{r, echo = FALSE}
modTsdTTRealmAllJtu_thermal_biasdata <- readRDS(here('temp','modTsdTTRealmAllJtu_thermal_biasdata_test.rds')) # no thermal bias, but using the thermal bias dataset
modTsdTTRealmtsignAllJtu_thermal_biasdata <- readRDS(here('temp', 'modTsdTTRealmtsignAllJtu_thermal_biasdata_test.rds')) # adding only tsign
modTsdTTRealmthermal_biasAllJtu_thermal_biasdata <- readRDS(here('temp','modTsdTTRealmthermal_biasAllJtu_thermal_biasdata_test.rds')) # adds thermal bias:tempave_metab:tempchange_abs

aics <- AIC(modTsdTTRealmAllJtu_thermal_biasdata, modTsdTTRealmtsignAllJtu_thermal_biasdata, modTsdTTRealmthermal_biasAllJtu_thermal_biasdata)
aics$dAIC <- aics$AIC - min(aics$AIC)
aics
```

### Use the environmental temperature (rawT)
Model with only tsign is selected
```{r, echo = FALSE}
modrawTsdTTRealmAllJtu_thermal_biasdata <- readRDS(here('temp','modrawTsdTTRealmAllJtu_thermal_biasdata.rds')) # no thermal bias, but using the thermal bias dataset
modrawTsdTTRealmtsignAllJtu_thermal_biasdata <- readRDS(here('temp', 'modrawTsdTTRealmtsignAllJtu_thermal_biasdata.rds')) # adding only tsign
modrawTsdTTRealmthermal_biassdTAllJtu_thermal_biasdata <- readRDS(here('temp','modrawTsdTTRealmthermal_biassdTAllJtu_thermal_biasdata.rds')) # adds thermal bias:tempchange_abs:tsign
modrawTsdTTRealmthermal_biasAllJtu_thermal_biasdata <- readRDS(here('temp','modrawTsdTTRealmthermal_biasAllJtu_thermal_biasdata.rds')) # adds thermal bias:tempave

aics <- AIC(modrawTsdTTRealmAllJtu_thermal_biasdata, modrawTsdTTRealmtsignAllJtu_thermal_biasdata, modrawTsdTTRealmthermal_biassdTAllJtu_thermal_biasdata,  modrawTsdTTRealmthermal_biasAllJtu_thermal_biasdata)
aics$dAIC <- aics$AIC - min(aics$AIC)
aics
```

#### Thermal bias coefs
Model that doesn't have a thermal_bias:tempave interaction.
```{r, echo = FALSE}
fixef(modrawTsdTTRealmthermal_biassdTAllJtu_thermal_biasdata)
```

#### Make or load thermal bias effect
```{r, echo = FALSE}
if(file.exists(here('temp', 'slopes_thermal_bias.rds'))){
  slopesTB <- readRDS(here('temp', 'slopes_thermal_bias.rds'))
  print('Loaded thermal bias predictions from file')
} else {
  print('Making thermal bias predictions from scratch')
  
  # set up prediction frame
  newdatTB <- data.table(expand.grid(tempave_metab.sc = seq(-1.6, 1.5, length.out = 100), tempchange_abs = seq(0, 0.8, length.out = 100), duration = seq(1, 10, length.out=10), REALM = c('Marine', 'Terrestrial', 'Freshwater'), thermal_bias.sc = c(-2, 2)))

  newdatTB$STUDY_ID <- 1
  newdatTB$rarefyID <- 1
  newdatTB[, tempave_metab := unscaleme(tempave_metab.sc, 'tempave_metab.sc')]
  newdatTB[, tempchange_abs.sc := scaleme(tempchange_abs, 'tempchange_abs.sc')]
  newdatTB[, thermal_bias := unscaleme(thermal_bias.sc, 'thermal_bias.sc')]
 
  # predict
  newdatTB$Jtu.sc <- predict(modTsdTTRealmthermal_biasAllJtu_thermal_biasdata, newdata = newdatTB, se.fit = FALSE, re.form = NA, allow.new.levels=TRUE, type = 'response')
  
  # calculate slopes
  slopesTB <- newdatTB[, .(slope = coef(lm(Jtu.sc ~ duration))[2]), by = .(tempave_metab, tempchange_abs, thermal_bias, REALM)]
  
  saveRDS(slopesTB, file = here('temp', 'slopes_thermal_bias.rds'))
}
```



#### Plot thermal bias effects
Thermal bias is the Community Temperature Index minus the environmental temperature. Positive means that the species are adapted to warmer conditions than they are experiencing (and presumably are more tolerant of warming but less tolerant of cooling). 
```{r, echo = FALSE, fig.height=8}
# plot
p1 <- ggplot(slopesTB, aes(tempchange_abs, tempave_metab, z = slope)) +
  geom_raster(aes(fill = slope)) +
  labs(x = 'Temperature change (degC per year)', y = 'Long-term metabolic temperature (degC)', title = 'Negative (left) or positive (right) thermal bias') +
  scale_fill_gradient2(high= "#B2182B", mid = "white", low= "#2166AC", midpoint = 0) +
  facet_grid(row = vars(REALM), col = vars(thermal_bias)) +
  theme(axis.text = element_text(size = 12), 
        axis.title = element_text(size = 14),
        panel.background = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.position = "top",
        legend.margin = margin(c(0, 0.1, -20, 0)),
        legend.justification = c(0.92, 0.9),
        legend.text=element_text(size= 12),
        legend.title=element_text(size= 18),
        legend.title.align = 1)

p1
```


## Taxon test
Models with taxon effects interacted with temperature change all returned singular fits (NAs for SEs). Using simplest model here.
```{r, echo = FALSE}
modTaxamod2AllJtu <- readRDS(here('temp', 'modTaxamod2AllJtu.rds')) # has taxa_mod2

# previous models
modAllJtu <- readRDS(here('temp', 'modAllJtu.rds')) # only duration
modRealmAllJtu <- readRDS(here('temp', 'modRealmAllJtu.rds')) # only realm

```

#### AIC
```{r}
aics <- AIC(modAllJtu, modRealmAllJtu, modTaxamod2AllJtu)
aics$dAIC <- aics$AIC - min(aics$AIC, na.rm=TRUE)
aics

```


#### Summary
```{r}
summary(modrawTsdTTRealmTaxamod2FEAllJtu)
```



