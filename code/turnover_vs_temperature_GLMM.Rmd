---
title: 'Temperature change and the community response to temperature change across realms'
subtitle: '(using beta models)'
subtitle: 'Evaluate and plot models'
output: 
    github_document: default

---
# Prep
First run turnover_vs_temperature_GLMM_fit.R to fit the models.
```{r setup}
library(data.table) # for handling large datasets
library(ggplot2) # for some plotting
library(glmmTMB) # for ME models
library(bbmle) # for AICtab
library(gridExtra) # to combine ggplots together
library(grid) # to combine ggplots together
library(RColorBrewer)
library(scales) # for defining custom scales in ggplot
library(DHARMa) # for model diagnostics
library(here) # for relative paths

options(width=500) # turn off most text wrapping

signedsqrt = function(x) sign(x)*sqrt(abs(x))
signedsq = function(x) sign(x) * x^2
signedsqrttrans <- trans_new(name = 'signedsqrt', transform = signedsqrt, inverse = signedsq)


# tell RStudio to use project root directory as the root for this notebook. Needed since we are storing code in a separate directory.
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file()) 

# Turnover and covariates assembled by turnover_vs_temperature_prep.Rmd
trends <- fread(here('output', 'turnover_w_covariates.csv.gz'))

```


# Summary stats
## Examine how many data points are available
### Just turnover and non-zero tempchange
```{r sample size all}
cat('Overall # dissimilarities: ', nrow(trends), '\n')
cat('# studies: ', trends[, length(unique(STUDY_ID))], '\n')
cat('# timeseries: ', trends[, length(unique(rarefyID))], '\n')
trends[!duplicated(rarefyID), table(REALM)]
trends[!duplicated(rarefyID), table(taxa_mod)]
trends[!duplicated(rarefyID), table(taxa_mod, REALM)]
```

### With all covariates
Use Bowler for human impact
```{r sample size Jtu covariates}
# the cases we can compare
apply(trends[, .(Jtu, REALM, tempave_metab.sc, seas.sc, microclim.sc, tempchange.sc, mass.sc, speed.sc, consumerfrac.sc, endothermfrac.sc, nspp.sc, thermal_bias.sc, npp.sc, veg.sc, human_bowler.sc)], MARGIN = 2, FUN = function(x) sum(!is.na(x)))
i <- trends[, complete.cases(Jtu, tempave_metab.sc, seas.sc, microclim.sc, tempchange.sc, mass.sc, speed.sc, consumerfrac.sc, nspp.sc, thermal_bias.sc, npp.sc, veg.sc, human_bowler.sc)]
cat('Overall # dissimilarities: ', sum(i), '\n')
cat('# studies: ', trends[i, length(unique(STUDY_ID))], '\n')
cat('# timeseries: ', trends[i, length(unique(rarefyID))], '\n')
trends[i & !duplicated(rarefyID), table(REALM)]
trends[i & !duplicated(rarefyID), table(taxa_mod)]
trends[i & !duplicated(rarefyID), table(taxa_mod, REALM)]
```

# Models
## Choose the variance structure
Try combinations of

- beta errors
- variance scaled to Nspp
- random intercept for taxa_mod2, STUDY_ID, rarefyID
- random slopes (abs temperature trend)
- random intercept for compID (for overdispersion)?

And choose the one with lowest AIC
```{r choose variance structure}

if(file.exists('temp/modRFgauss.rds')) modRFgauss <- readRDS('temp/modRFgauss.rds')
if(file.exists('temp/modRFbeta.rds')) modRFbeta <- readRDS('temp/modRFbeta.rds')
if(file.exists('temp/modRFrID.rds')) modRFrID <- readRDS('temp/modRFrID.rds')
if(file.exists('temp/modRF2lev.rds')) modRF2lev <- readRDS('temp/modRF2lev.rds')
if(file.exists('temp/modRFnestedRE.rds')) modRFnestedRE <- readRDS('temp/modRFnestedRE.rds')
#if(file.exists('temp/modRFslopeRE.rds')) modRFslopeRE <- readRDS('temp/modRFslopeRE.rds') # too complex to fit
if(file.exists('temp/modRFdisp.rds')) modRFdisp <- readRDS('temp/modRFdisp.rds')
if(file.exists('temp/modRFdisp2lev.rds')) modRFdisp2lev <- readRDS('temp/modRFdisp2lev.rds')
if(file.exists('temp/modRFdisp2levOnlyint.rds')) modRFdisp2levOnlyint <- readRDS('temp/modRFdisp2levOnlyint.rds')
if(file.exists('temp/modRFdurslope2lev.rds')) modRFdurslope2lev <- readRDS('temp/modRFdurslope2lev.rds')
if(file.exists('temp/modRFdurslope2levdisp.rds')) modRFdurslope2levdisp <- readRDS('temp/modRFdurslope2levdisp.rds')


AICtab(modRFgauss, modRFbeta, modRFrID, modRF2lev, modRFnestedRE, modRFdisp, modRFdisp2lev, modRFdisp2levOnlyint,
       modRFdurslope2lev, modRFdurslope2levdisp)
```
Chooses beta errors, random slopes (tempchange_abs.sc) & intercepts for STUDY_ID and rarefyID, and variance scaled to nspp.
We haven't dealt with potential testing on the boundary issues here yet.


## Temperature-only models
### Load the models
```{r temperature only}
# all years
modonlyTchangeJtu <- readRDS('temp/modonlyTchangeJtu.rds')
modonlyTchangeJbeta <- readRDS('temp/modonlyTchangeJbeta.rds')
modonlyTchangeHorn <- readRDS('temp/modonlyTchangeHorn.rds')

# 1 year
modonlyTchange1yrJtu <- readRDS('temp/modonlyTchange1yrJtu.rds')
modonlyTchange1yrJbeta <- readRDS('temp/modonlyTchange1yrJbeta.rds')
modonlyTchange1yrHorn <- readRDS('temp/modonlyTchange1yrHorn.rds')

# 10 year
modonlyTchange10yrJtu <- readRDS('temp/modonlyTchange10yrJtu.rds')
modonlyTchange10yrJbeta <- readRDS('temp/modonlyTchange10yrJbeta.rds')
modonlyTchange10yrHorn <- readRDS('temp/modonlyTchange10yrHorn.rds')

```

### Summary (all years)
```{r summary onlyTchange}
summary(modonlyTchangeJtu)
summary(modonlyTchangeJbeta)
summary(modonlyTchangeHorn)
```

### Summary (1 year)
```{r summary onlyTchange1yr}
summary(modonlyTchange1yrJtu)
summary(modonlyTchange1yrJbeta)
summary(modonlyTchange1yrHorn)
```
### Summary (10 year)
```{r summary onlyTchange10yr}
summary(modonlyTchange10yrJtu)
summary(modonlyTchange10yrJbeta)
summary(modonlyTchange10yrHorn)
```
### Plot the temp-only coefficients
```{r modonlyT coefs}
# make table of coefficients
coefs1 <- as.data.frame(summary(modonlyTchangeJtu)$coefficients$cond)
coefs2 <- as.data.frame(summary(modonlyTchangeJbeta)$coefficients$cond)
coefs3 <- as.data.frame(summary(modonlyTchangeHorn)$coefficients$cond)
coefs4 <- as.data.frame(summary(modonlyTchange1yrJtu)$coefficients$cond)
coefs5 <- as.data.frame(summary(modonlyTchange1yrJbeta)$coefficients$cond)
coefs6 <- as.data.frame(summary(modonlyTchange1yrHorn)$coefficients$cond)
coefs7 <- as.data.frame(summary(modonlyTchange10yrJtu)$coefficients$cond)
coefs8 <- as.data.frame(summary(modonlyTchange10yrJbeta)$coefficients$cond)
coefs9 <- as.data.frame(summary(modonlyTchange10yrHorn)$coefficients$cond)
coefs1$response <- coefs4$response <- coefs7$response <- 'Jtu'
coefs2$response <- coefs5$response <- coefs8$response <- 'Jbeta'
coefs3$response <- coefs6$response <- coefs9$response <- 'Horn'
coefs1$fit <- coefs2$fit <- coefs3$fit <- 'all'
coefs4$fit <- coefs5$fit <- coefs6$fit <- '1yr'
coefs7$fit <- coefs8$fit <- coefs9$fit <- '10yr'
rows1 <- which(grepl('tempchange', rownames(coefs1))) # extract temperature effect
cols <- c('Estimate', 'Std. Error', 'response', 'fit')
allcoefs <- rbind(coefs1[rows1, cols], coefs2[rows1, cols], coefs3[rows1, cols],
                  coefs4[rows1, cols], coefs5[rows1, cols], coefs6[rows1, cols],
                  coefs7[rows1, cols], coefs8[rows1, cols], coefs9[rows1, cols])

allcoefs$lCI <- allcoefs$Estimate - 1.96 * allcoefs$`Std. Error` # lower confidence interval
allcoefs$uCI <- allcoefs$Estimate + 1.96 * allcoefs$`Std. Error`
allcoefs$y <- c(3, 2, 1) + rep(c(0, -0.1, -0.2), c(3, 3, 3)) # y-values
allcoefs$group <- paste0(allcoefs$response, allcoefs$fit)

pd <- position_dodge(width = 0.5)
ggplot(allcoefs, aes(x = response, y = Estimate, color = fit, group = group)) +
  geom_point(position = pd) + 
  geom_errorbar(aes(ymin=lCI, ymax=uCI), width=.1, position = pd) +
  labs(y = 'Dissimilarity per |Â°C change|') #+ 
  #coord_cartesian(ylim = c(-0.01, 0.05))
```
CIs are 1.96*SE

## Temperature&duration models
### Load the models
```{r temperature and duration}
# all years
modTDJtu <- readRDS('temp/modTDJtu.rds')
modTDJbeta <- readRDS('temp/modTDJbeta.rds')
modTDHorn <- readRDS('temp/modTDHorn.rds')
```

### Summary
```{r summary of TD mods}
summary(modTDJtu)
summary(modTDJbeta)
summary(modTDHorn)
```



### Plot the coefficients
```{r modTD coefs}

coefs1 <- summary(modTDJtu)$coefficients$cond
coefs2 <- summary(modTDJbeta)$coefficients$cond
coefs3 <- summary(modTDHorn)$coefficients$cond

varstoplot <- unique(c(rownames(coefs1), rownames(coefs2), rownames(coefs3)))
varstoplot <- varstoplot[which(!grepl('Intercept', varstoplot) | grepl(':', varstoplot))] # vars to plot

rows1_1 <- which(rownames(coefs1) %in% varstoplot) # rows in coefs
rows1_2 <- which(rownames(coefs2) %in% varstoplot)
rows1_3 <- which(rownames(coefs3) %in% varstoplot)
xlims <- range(c(coefs1[rows1_1,1] - 1.96*coefs1[rows1_1,2], coefs1[rows1_1,1] + 1.96*coefs1[rows1_1,2], 
                  coefs2[rows1_2,1] - 1.96*coefs2[rows1_2,2], coefs2[rows1_2,1] + 1.96*coefs2[rows1_2,2], 
                  coefs3[rows1_3,1] - 1.96*coefs3[rows1_3,2], coefs3[rows1_3,1] + 1.96*coefs3[rows1_3,2]))

cols <- brewer.pal(3, 'Dark2') # for Jtu, Jbeta and Horn models
pchs <- c(16, 16, 16)
offs <- c(0.1, 0, -0.1) # offset vertically for each model

par(las = 1, mai = c(0.5, 4, 0.1, 0.1))

plot(0,0, col = 'white', xlim = xlims, ylim = c(0.9,length(varstoplot)+0.1), yaxt='n', xlab = '', ylab ='')
axis(2, at = length(varstoplot):1, labels = varstoplot, cex.axis = 0.7)
abline(v = 0, col = 'grey', lty = 2)
abline(h = 1:length(varstoplot), col = 'grey', lty = 3)
for(i in 1:length(varstoplot)){
  if(varstoplot[i] %in% rownames(coefs1)){
    x = coefs1[rownames(coefs1) == varstoplot[i], 1] # the coef in col 1
    se = coefs1[rownames(coefs1) == varstoplot[i], 2] # the SE in col 2
    points(x, length(varstoplot) + 1 - i + offs[1], pch = pchs[1], col = cols[1])
    lines(x = c(x-1.96*se, x+1.96*se), y = c(length(varstoplot) + 1 - i + offs[1], length(varstoplot) + 1 - i + offs[1]), col = cols[1])
  }
  if(varstoplot[i] %in% rownames(coefs2)){
    x = coefs2[rownames(coefs2) == varstoplot[i], 1]
    se = coefs2[rownames(coefs2) == varstoplot[i], 2]
    points(x, length(varstoplot) + 1 - i + offs[2], pch = pchs[2], col = cols[2])
    lines(x = c(x-1.96*se, x+1.96*se), y = c(length(varstoplot) + 1 - i + offs[2], length(varstoplot) + 1 - i + offs[2]), col = cols[2])
  }
  if(varstoplot[i] %in% rownames(coefs3)){
    x = coefs3[rownames(coefs3) == varstoplot[i], 1]
    se = coefs3[rownames(coefs3) == varstoplot[i], 2]
    points(x, length(varstoplot) + 1 - i + offs[3], pch = pchs[3], col = cols[3])
    lines(x = c(x-1.96*se, x+1.96*se), y = c(length(varstoplot) + 1 - i + offs[3], length(varstoplot) + 1 - i + offs[3]), col = cols[3])
  }
}
legend('bottomright', col = cols, pch = 16, lwd = 1, legend = c('Jtu', 'Jbeta', 'Horn'), cex = 0.5)
```
abs(tempchange) is in degC
duration is in years

### Plot the response
```{r plot TD response}
if(!file.exists('temp/modTDJtu_preds.rds')) {
  newdat <- expand.grid(duration = c(1, 50), tempchange = seq(0.01, 5, length.out = 5), 
                      taxa_mod2 = NA, STUDY_ID = NA, rarefyID = NA,
                      Nspp = 60) # no REs, ave number of species
  scaling <- fread('output/turnover_w_covariates_scaling.csv')
  cent <- scaling$center[scaling$var == 'tempchange_abs.sc'] # centering
  scl <- scaling$scale[scaling$var == 'tempchange_abs.sc'] # scaling factor for tempchange
  newdat$tempchange_abs.sc <- (abs(newdat$tempchange)-cent)/scl
  cent <- scaling$center[scaling$var == 'nspp.sc'] # centering
  scl <- scaling$scale[scaling$var == 'nspp.sc'] # scaling factor for tempchange
  newdat$nspp.sc <- (log(newdat$Nspp) - cent)/scl
  Jtu <- predict(modTDJtu, newdata = newdat, se.fit = TRUE, re.form = NA, type = 'response')
  newdat$durationfac <- as.factor(newdat$duration)
  newdat$Jtu <- Jtu$fit
  newdat$Jtu.se <- Jtu$se.fit
  
  saveRDS(newdat, file = 'temp/modTDJtu_preds.rds')
} else {
  newdat <- readRDS('temp/modTDJtu_preds.rds')
}

ggplot(newdat, aes(tempchange, Jtu, color = durationfac, group = durationfac)) +
  geom_line() +
  geom_ribbon(aes(ymin=Jtu - 1.96*Jtu.se, ymax=Jtu + 1.96*Jtu.se), alpha = 0.1, linetype = 'blank')
```

## Temperature and duration by REALM
### Load the models
```{r temperature duration realm}
# all years
if(file.exists('temp/modTDrealmJtu.rds')) modTDrealmJtu <- readRDS('temp/modTDrealmJtu.rds')
if(file.exists('temp/modTDrealmJbeta.rds')) modTDrealmJbeta <- readRDS('temp/modTDrealmJbeta.rds')
if(file.exists('temp/modTDrealmHorn.rds')) modTDrealmHorn <- readRDS('temp/modTDrealmHorn.rds')

# 1 year
if(file.exists('temp/modTDrealm1yrJtu.rds')) modTDrealm1yrJtu <- readRDS('temp/modTDrealm1yrJtu.rds')
if(file.exists('temp/modTDrealm1yrJbeta.rds')) modTDrealm1yrJbeta <- readRDS('temp/modTDrealm1yrJbeta.rds')
if(file.exists('temp/modTDrealm1yrHorn.rds')) modTDrealm1yrHorn <- readRDS('temp/modTDrealm1yrHorn.rds')

# 10 year
if(file.exists('temp/modTDrealm10yrJtu.rds')) modTDrealm10yrJtu <- readRDS('temp/modTDrealm10yrJtu.rds')
if(file.exists('temp/modTDrealm10yrJbeta.rds')) modTDrealm10yrJbeta <- readRDS('temp/modTDrealm10yrJbeta.rds')
if(file.exists('temp/modTDrealm10yrHorn.rds')) modTDrealm10yrHorn <- readRDS('temp/modTDrealm10yrHorn.rds')

```

### Summary
```{r summary of TDrealm mods}
summary(modTDrealmJtu)
summary(modTDrealmJbeta)
summary(modTDrealmHorn)
```

### Summary (1 yr)
```{r summary of TDrealm1yr mods}
summary(modTDrealm1yrJtu)
summary(modTDrealm1yrJbeta)
summary(modTDrealm1yrHorn)
```

### Summary (10 yr)
```{r summary of TDrealm10yr mods}
summary(modTDrealm10yrJtu)
summary(modTDrealm10yrJbeta)
summary(modTDrealm10yrHorn)
```

### Plot the temp coefficients from TD realm models
```{r modTD realm coefs}

coefs1 <- summary(modTDrealmJtu)$coefficients$cond
coefs2 <- summary(modTDrealmJbeta)$coefficients$cond
coefs3 <- summary(modTDrealmHorn)$coefficients$cond

varstoplot <- unique(c(rownames(coefs1), rownames(coefs2), rownames(coefs3)))
varstoplot <- varstoplot[which(!grepl('Intercept', varstoplot) | grepl(':', varstoplot))] # vars to plot

rows1_1 <- which(rownames(coefs1) %in% varstoplot) # rows in coefs
rows1_2 <- which(rownames(coefs2) %in% varstoplot)
rows1_3 <- which(rownames(coefs3) %in% varstoplot)
xlims <- range(c(coefs1[rows1_1,1] - 1.96*coefs1[rows1_1,2], coefs1[rows1_1,1] + 1.96*coefs1[rows1_1,2], 
                  coefs2[rows1_2,1] - 1.96*coefs2[rows1_2,2], coefs2[rows1_2,1] + 1.96*coefs2[rows1_2,2], 
                  coefs3[rows1_3,1] - 1.96*coefs3[rows1_3,2], coefs3[rows1_3,1] + 1.96*coefs3[rows1_3,2]))

cols <- brewer.pal(3, 'Dark2') # for Jtu, Jbeta and Horn models
pchs <- c(16, 16, 16)
offs <- c(0.1, 0, -0.1) # offset vertically for each model

par(las = 1, mai = c(0.5, 4, 0.1, 0.1))

plot(0,0, col = 'white', xlim = xlims, ylim = c(1,length(varstoplot)), yaxt='n', xlab = '', ylab ='')
axis(2, at = length(varstoplot):1, labels = varstoplot, cex.axis = 0.7)
abline(v = 0, col = 'grey', lty = 2)
abline(h = 1:length(varstoplot), col = 'grey', lty = 3)
for(i in 1:length(varstoplot)){
  if(varstoplot[i] %in% rownames(coefs1)){
    x = coefs1[rownames(coefs1) == varstoplot[i], 1]
    se = coefs1[rownames(coefs1) == varstoplot[i], 2]
    points(x, length(varstoplot) + 1 - i + offs[1], pch = pchs[1], col = cols[1])
    lines(x = c(x-1.96*se, x+1.96*se), y = c(length(varstoplot) + 1 - i + offs[1], length(varstoplot) + 1 - i + offs[1]), col = cols[1])
  }
  if(varstoplot[i] %in% rownames(coefs2)){
    x = coefs2[rownames(coefs2) == varstoplot[i], 1]
    se = coefs2[rownames(coefs2) == varstoplot[i], 2]
    points(x, length(varstoplot) + 1 - i + offs[2], pch = pchs[2], col = cols[2])
    lines(x = c(x-1.96*se, x+1.96*se), y = c(length(varstoplot) + 1 - i + offs[2], length(varstoplot) + 1 - i + offs[2]), col = cols[2])
  }
  if(varstoplot[i] %in% rownames(coefs3)){
    x = coefs3[rownames(coefs3) == varstoplot[i], 1]
    se = coefs3[rownames(coefs3) == varstoplot[i], 2]
    points(x, length(varstoplot) + 1 - i + offs[3], pch = pchs[3], col = cols[3])
    lines(x = c(x-1.96*se, x+1.96*se), y = c(length(varstoplot) + 1 - i + offs[3], length(varstoplot) + 1 - i + offs[3]), col = cols[3])
  }
}
legend('topleft', col = cols, pch = 16, lwd = 1, legend = c('Jtu', 'Jbeta', 'Horn'), cex = 0.5)
```

## Full models
### Load the models
```{r full}
# all years
if(file.exists('temp/modFullendo.rds')) modFullendo <- readRDS('temp/modFullendo.rds')
if(file.exists('temp/modFullmass.rds')) modFullmass <- readRDS('temp/modFullmass.rds')

if(file.exists('temp/modFullMaEnMiNPHuJtu.rds')) modFullMaEnMiNPHuJtu <- readRDS('temp/modFullMaEnMiNPHuJtu.rds') # mass, endoecto, microclimate, NPP, humans
if(file.exists('temp/modFullMaEnMiNPHu1yrJtu.rds')) modFullMaEnMiNPHu1yrJtu <- readRDS('temp/modFullMaEnMiNPHu1yrJtu.rds')
if(file.exists('temp/modFullMaEnMiNPHu10yrJtu.rds')) modFullMaEnMiNPHu10yrJtu <- readRDS('temp/modFullMaEnMiNPHu10yrJtu.rds')

```

### Summary
#### endo and mass models
```{r summary endo and mass}
summary(modFullendo)
summary(modFullmass)
```

#### Mass, endo, microclimate, NPP, humans
All
```{r summary MaEnMiNPHu}
summary(modFullMaEnMiNPHuJtu)
```

1 yr
```{r summary MaEnMiNPHu1}
summary(modFullMaEnMiNPHu1yrJtu)
```

10 yr
```{r summary MaEnMiNPHu10}
summary(modFullMaEnMiNPHu10yrJtu)
```

### DHARMa simulate residuals
#### Mass, endo, microclimate, NPP, humans
##### Simulate residuals
```{r dharma maenminphu}
if(!file.exists('temp/res_MaEnMiNPHuJtu.rds')) {
  i <- trends[, complete.cases(Jtu.sc, tempchange_abs.sc, REALM, tempave_metab.sc, duration.sc, mass.sc, endothermfrac.sc,
                               microclim.sc, npp.sc, human_bowler.sc, nspp.sc)] # needed because model fit with trends[i,]

  res_MaEnMiNPHuJtu <- simulateResiduals(modFullMaEnMiNPHuJtu, n = 250)
  
  saveRDS(res_MaEnMiNPHuJtu, file = 'temp/res_MaEnMiNPHuJtu.rds')
} else {
  res_MaEnMiNPHuJtu <- readRDS('temp/res_MaEnMiNPHuJtu.rds')
}

if(!file.exists('temp/res_MaEnMiNPHu1yrJtu.rds')) {
  i <- trends[, complete.cases(Jtu.sc, tempchange_abs.sc, REALM, tempave_metab.sc, duration.sc, mass.sc, endothermfrac.sc,
                               microclim.sc, npp.sc, human_bowler.sc, nspp.sc) &
                duration == 1] # needed because model fit with trends[i,]

  res_MaEnMiNPHu1yrJtu <- simulateResiduals(modFullMaEnMiNPHu1yrJtu, n = 250)
  
  saveRDS(res_MaEnMiNPHu1yrJtu, file = 'temp/res_MaEnMiNPHu1yrJtu.rds')
} else {
  res_MaEnMiNPHu1yrJtu <- readRDS('temp/res_MaEnMiNPHu1yrJtu.rds')
}


if(!file.exists('temp/res_MaEnMiNPHu10yrJtu.rds')) {
  i <- trends[, complete.cases(Jtu.sc, tempchange_abs.sc, REALM, tempave_metab.sc, duration.sc, mass.sc, endothermfrac.sc,
                               microclim.sc, npp.sc, human_bowler.sc, nspp.sc) &
                duration == 10] # needed because model fit with trends[i,]

  res_MaEnMiNPHu10yrJtu <- simulateResiduals(modFullMaEnMiNPHu10yrJtu, n = 250)
  
  saveRDS(res_MaEnMiNPHu10yrJtu, file = 'temp/res_MaEnMiNPHu10yrJtu.rds')
} else {
  res_MaEnMiNPHu10yrJtu <- readRDS('temp/res_MaEnMiNPHu10yrJtu.rds')
}
```

##### Plot residuals
All data
```{r plot darma maenminphu}
i <- trends[, complete.cases(Jtu.sc, tempchange_abs.sc, REALM, tempave_metab.sc, duration.sc, mass.sc, endothermfrac.sc,
                               microclim.sc, npp.sc, human_bowler.sc, nspp.sc)]
plot(res_MaEnMiNPHuJtu)
plotResiduals(res_MaEnMiNPHuJtu, form=trends$tempchange_abs.sc[i], xlab = 'tempchange_abs.sc', main = '')
plotResiduals(res_MaEnMiNPHuJtu, form=trends$REALM[i], xlab = 'REALM', main = '')
plotResiduals(res_MaEnMiNPHuJtu, trends$tempave_metab.sc[i], xlab = 'tempave_metab.sc', main = '')
plotResiduals(res_MaEnMiNPHuJtu, trends$duration.sc[i], xlab = 'duration.sc', main = '')
plotResiduals(res_MaEnMiNPHuJtu, trends$mass.sc[i], xlab = 'mass.sc', main = '')
plotResiduals(res_MaEnMiNPHuJtu, trends$endothermfrac.sc[i], xlab = 'endothermfrac.sc', main = '')
plotResiduals(res_MaEnMiNPHuJtu, trends$microclim.sc[i], xlab = 'microclim.sc', main = '')
plotResiduals(res_MaEnMiNPHuJtu, trends$npp.sc[i], xlab = 'npp.sc', main = '')
plotResiduals(res_MaEnMiNPHuJtu, form=trends$human_bowler.sc[i], xlab = 'human_bowler.sc', main = '')
```


1yr data
```{r plot darma maenminphu1yr}
i <- trends[, complete.cases(Jtu.sc, tempchange_abs.sc, REALM, tempave_metab.sc, duration.sc, mass.sc, endothermfrac.sc,
                             microclim.sc, npp.sc, human_bowler.sc, nspp.sc) &
              duration == 1]
plot(res_MaEnMiNPHu1yrJtu)
plotResiduals(res_MaEnMiNPHu1yrJtu, form=trends$tempchange_abs.sc[i], xlab = 'tempchange_abs.sc', main = '')
plotResiduals(res_MaEnMiNPHu1yrJtu, form=trends$REALM[i], xlab = 'REALM', main = '')
plotResiduals(res_MaEnMiNPHu1yrJtu, trends$tempave_metab.sc[i], xlab = 'tempave_metab.sc', main = '')
plotResiduals(res_MaEnMiNPHu1yrJtu, trends$mass.sc[i], xlab = 'mass.sc', main = '')
plotResiduals(res_MaEnMiNPHu1yrJtu, trends$endothermfrac.sc[i], xlab = 'endothermfrac.sc', main = '')
plotResiduals(res_MaEnMiNPHu1yrJtu, trends$microclim.sc[i], xlab = 'microclim.sc', main = '')
plotResiduals(res_MaEnMiNPHu1yrJtu, trends$npp.sc[i], xlab = 'npp.sc', main = '')
plotResiduals(res_MaEnMiNPHu1yrJtu, form=trends$human_bowler.sc[i], xlab = 'human_bowler.sc', main = '')
```

10yr data
```{r plot darma maenminphu1yr}
i <- trends[, complete.cases(Jtu.sc, tempchange_abs.sc, REALM, tempave_metab.sc, duration.sc, mass.sc, endothermfrac.sc,
                             microclim.sc, npp.sc, human_bowler.sc, nspp.sc) &
              duration == 10]
plot(res_MaEnMiNPHu10yrJtu)
plotResiduals(res_MaEnMiNPHu10yrJtu, form=trends$tempchange_abs.sc[i], xlab = 'tempchange_abs.sc', main = '')
plotResiduals(res_MaEnMiNPHu10yrJtu, form=trends$REALM[i], xlab = 'REALM', main = '')
plotResiduals(res_MaEnMiNPHu10yrJtu, trends$tempave_metab.sc[i], xlab = 'tempave_metab.sc', main = '')
plotResiduals(res_MaEnMiNPHu10yrJtu, trends$mass.sc[i], xlab = 'mass.sc', main = '')
plotResiduals(res_MaEnMiNPHu10yrJtu, trends$endothermfrac.sc[i], xlab = 'endothermfrac.sc', main = '')
plotResiduals(res_MaEnMiNPHu10yrJtu, trends$microclim.sc[i], xlab = 'microclim.sc', main = '')
plotResiduals(res_MaEnMiNPHu10yrJtu, trends$npp.sc[i], xlab = 'npp.sc', main = '')
plotResiduals(res_MaEnMiNPHu10yrJtu, form=trends$human_bowler.sc[i], xlab = 'human_bowler.sc', main = '')
```

##### Overdispersion
```{r}
i <- trends[, complete.cases(Jtu.sc, tempchange_abs.sc, REALM, tempave_metab.sc, duration.sc, mass.sc, endothermfrac.sc,
                             microclim.sc, npp.sc, human_bowler.sc, nspp.sc)]
testDispersion(res_MaEnMiNPHuJtu)

i <- trends[, complete.cases(Jtu.sc, tempchange_abs.sc, REALM, tempave_metab.sc, duration.sc, mass.sc, endothermfrac.sc,
                             microclim.sc, npp.sc, human_bowler.sc, nspp.sc) &
              duration == 1]
testDispersion(res_MaEnMiNPHu1yrJtu)

i <- trends[, complete.cases(Jtu.sc, tempchange_abs.sc, REALM, tempave_metab.sc, duration.sc, mass.sc, endothermfrac.sc,
                             microclim.sc, npp.sc, human_bowler.sc, nspp.sc) &
              duration == 10]
testDispersion(res_MaEnMiNPHu10yrJtu)
```

##### Near-zero-inflation
Zero values have been transformed to slightly >0, so can't test zero-inflation directly
```{r}
countNearZero <- function(x) sum(x < 0.0001)
i <- trends[, complete.cases(Jtu.sc, tempchange_abs.sc, REALM, tempave_metab.sc, duration.sc, mass.sc, endothermfrac.sc,
                             microclim.sc, npp.sc, human_bowler.sc, nspp.sc)]
testGeneric(res_MaEnMiNPHuJtu, summary = countNearZero, alternative = 'greater')

i <- trends[, complete.cases(Jtu.sc, tempchange_abs.sc, REALM, tempave_metab.sc, duration.sc, mass.sc, endothermfrac.sc,
                             microclim.sc, npp.sc, human_bowler.sc, nspp.sc) &
              duration == 1]
testGeneric(res_MaEnMiNPHu1yrJtu, summary = countNearZero, alternative = 'greater')

i <- trends[, complete.cases(Jtu.sc, tempchange_abs.sc, REALM, tempave_metab.sc, duration.sc, mass.sc, endothermfrac.sc,
                             microclim.sc, npp.sc, human_bowler.sc, nspp.sc) &
              duration == 10]
testGeneric(res_MaEnMiNPHu10yrJtu, summary = countNearZero, alternative = 'greater')
```

##### Near-one-inflation
```{r}
countNearOne <- function(x) sum(x > 0.9999)
i <- trends[, complete.cases(Jtu.sc, tempchange_abs.sc, REALM, tempave_metab.sc, duration.sc, mass.sc, endothermfrac.sc,
                             microclim.sc, npp.sc, human_bowler.sc, nspp.sc)]
testGeneric(res_MaEnMiNPHuJtu, summary = countNearOne, alternative = 'greater')

i <- trends[, complete.cases(Jtu.sc, tempchange_abs.sc, REALM, tempave_metab.sc, duration.sc, mass.sc, endothermfrac.sc,
                             microclim.sc, npp.sc, human_bowler.sc, nspp.sc) &
              duration == 1]
testGeneric(res_MaEnMiNPHu1yrJtu, summary = countNearOne, alternative = 'greater')

i <- trends[, complete.cases(Jtu.sc, tempchange_abs.sc, REALM, tempave_metab.sc, duration.sc, mass.sc, endothermfrac.sc,
                             microclim.sc, npp.sc, human_bowler.sc, nspp.sc) &
              duration == 10]
testGeneric(res_MaEnMiNPHu10yrJtu, summary = countNearOne, alternative = 'greater')
```


## Plot the response
Set up the new data and write to file
```{r}
scaling <- fread('output/turnover_w_covariates_scaling.csv') # the scalings

# set up the variables to plot
# if variable is logged before scaling (see 'center and scale' above), then need to mark it here and express the limits on a log10 scale (even though log transforming is log)
vars <- data.frame(vars = c('tempchange_abs', 'tempave_metab', 'microclim', 'mass', 'npp', 'duration', 'endothermfrac', 'human_bowler', 'human_bowler'),
                   min =      c(0,    0,   0,   -1,  1.9, 0.5, 0,   0,   0), 
                   max =      c(4,    30,  0.8, 4,   3.7, 2,   1,   1,   1),
                   log =      c(F,    F,   T,   T,   T,   T,   F,   T,   T),
                   len =      c(100,  100, 100, 100, 100, 100, 100, 100, 100),
                   discrete = c(F,    F,   F,   F,   F,   F,   F,   F,   F),
                   plus =     c(0,    0,   0,   0,   0,   0,   0,   1,   1), # what to add before log-scaling
                   REALM = c(rep('Terrestrial', 8), 'Marine'),
                   REALM2 = c(rep('TerrFresh', 8), 'Marine'),
                   stringsAsFactors = FALSE)
baseall <- trends[, .(type = 'all', 
                      tempchange = -0.0001,
                      tempchange_abs.sc = 0.0001,
                      tempave_metab.sc = mean(tempave_metab.sc, na.rm=TRUE), 
                      microclim.sc = mean(microclim.sc, na.rm=TRUE), 
                      mass.sc = mean(mass.sc, na.rm=TRUE), 
                      endothermfrac.sc = mean(endothermfrac.sc, na.rm=TRUE),
                      nspp.sc = 60, 
                      npp.sc = mean(npp.sc, na.rm=TRUE), 
                      human_bowler.sc = mean(human_bowler.sc, na.rm=TRUE))]
baseterr <- trends[REALM == 'Terrestrial', 
                   .(type = 'Terrestrial', 
                     tempchange = -0.0001,
                     tempchange_abs.sc = 0.0001,
                     tempave_metab.sc = mean(tempave_metab.sc, na.rm=TRUE), 
                     microclim.sc = mean(microclim.sc, na.rm=TRUE), 
                     mass.sc = mean(mass.sc, na.rm=TRUE), 
                     endothermfrac.sc = mean(endothermfrac.sc, na.rm=TRUE),
                     nspp.sc = 60, 
                     npp.sc = mean(npp.sc, na.rm=TRUE), 
                     human_bowler.sc = mean(human_bowler.sc, na.rm=TRUE))]
basemar <- trends[REALM == 'Marine', 
                  .(type = 'Marine',
                    tempchange = -0.0001,
                    tempchange_abs.sc = 0.0001,
                    tempave_metab.sc = mean(tempave_metab.sc, na.rm=TRUE), 
                    microclim.sc = mean(microclim.sc, na.rm=TRUE), 
                    mass.sc = mean(mass.sc, na.rm=TRUE), 
                    endothermfrac.sc = mean(endothermfrac.sc, na.rm=TRUE),
                    nspp.sc = 60, 
                    npp.sc = mean(npp.sc, na.rm=TRUE), 
                    human_bowler.sc = mean(human_bowler.sc, na.rm=TRUE))]
basetab <- rbind(baseall, baseterr, basemar)
basetab[, ':='(duration.sc = 0, nyrBT = 20, STUDY_ID = 127L, rarefyID = '127_514668')]

# make the data frames for each interaction to plot                
for(j in 1:nrow(vars)){
    # set up the main effects
    if(vars$log[j]){
        thisdat <- data.frame(new = 10^seq(vars$min[j], vars$max[j], length.out = vars$len[j]),
                              var = vars$vars[j], stringsAsFactors = FALSE)
    } 
    if(!vars$log[j]){
        thisdat <- data.frame(new = seq(vars$min[j], vars$max[j], length.out = vars$len[j]),
                              var = vars$vars[j], stringsAsFactors = FALSE)
    }
    names(thisdat) <- c(vars$vars[j], 'var')
    
    # scale the variable
    cent <- scaling$center[scaling$var == paste0(vars$vars[j], '.sc')]
    scl <- scaling$scale[scaling$var == paste0(vars$vars[j], '.sc')]
    if(is.null(cent)) cent <- 0
    if(!is.null(cent) & !is.null(scl)){
        if(vars$log[j]) thisdat[[paste0(vars$var[j], '.sc')]] <- (log(thisdat[[vars$vars[j]]] + vars$plus[j]) - cent)/scl
        if(!vars$log[j]) thisdat[[paste0(vars$var[j], '.sc')]] <- (thisdat[[vars$var[j]]] - cent)/scl
    }
    
    # merge with the rest of the columns
    # use realm-specific averages for human impacts
    colnamestouse <- setdiff(colnames(basetab), paste0(vars$vars[j], '.sc'))
    if(vars$vars[j] != 'human_bowler'){
        thisdat <- cbind(thisdat, basetab[type == 'all', ..colnamestouse])
    }
    if(vars$vars[j] == 'human_bowler' & vars$REALM[j] == 'Terrestrial'){
        thisdat <- cbind(thisdat, basetab[type == 'Terrestrial', ..colnamestouse])
    }
    if(vars$vars[j] == 'human_bowler' & vars$REALM[j] == 'Marine'){
        thisdat <- cbind(thisdat, basetab[type == 'Marine', ..colnamestouse])
    }
    
    # add realm
    thisdat$REALM <- vars$REALM[j]
    thisdat$REALM2 <- vars$REALM2[j]
    
    # merge with the previous iterations
    if(j == 1) newdat <- thisdat
    if(j > 1){
        colstoadd <- setdiff(colnames(thisdat), colnames(newdat))
        for(toadd in colstoadd){
            newdat[[toadd]] <- NA
        }
        
        colstoadd2 <- setdiff(colnames(newdat), colnames(thisdat))
        for(toadd in colstoadd2){
            thisdat[[toadd]] <- NA
        }
        
        newdat <- rbind(newdat, thisdat)
    } 
}

# character so that new levels can be added
newdat$REALM <- as.character(newdat$REALM)
newdat$REALM2 <- as.character(newdat$REALM2)

# add extra rows so that all factor levels are represented (for predict.lme to work)
newdat <- rbind(newdat[1:6, ], newdat)
newdat$REALM[1:6] <- c('Marine', 'Marine', 'Freshwater', 'Freshwater', 'Terrestrial', 'Terrestrial')
newdat$REALM2[1:6] <- c('Marine', 'Marine', 'TerrFresh', 'TerrFresh', 'TerrFresh', 'TerrFresh')
newdat$tempchange_abs.sc[1:6] <- rep(0.0001, 6)
newdat$tempchange[1:6] <- rep(c(0.0001, -0.0001), 3)
newdat$var[1:6] <- 'test'

# write out
write.csv(newdat, 'temp/newdata.csv', row.names = FALSE)

```

Now go run on the command line
nohup code/turnover_vs_temperature_GLMM_pred.R temp/modFullMaEnMiNPHuJtu.rds temp/newdata.csv > logs/turnover_vs_temperature_GLMMmodFullMaEnMiNPHuJtu_pred.Rout &

Load the predictions and plot
```{r}
newdat <- readRDS('temp/modFullMaEnMiNPHuJtu_preds.rds')


ggplot(newdat[var == 'tempchange_abs.sc'], aes(tempchange_abs.sc, pred)) +
  geom_line() +
  geom_ribbon(aes(ymin=pred-1.96*pred.se, ymax=pred+1.96*pred.se), alpha = 0.1, linetype = 'blank')
```




