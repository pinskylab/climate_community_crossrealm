---
title: 'Community dissimilarity through time using beta models: Evaluate and plot models'
output: 
    github_document:
        toc: true
        toc_depth: 3

---
# Prep
First run turnover_vs_temperature_GLMM_fit.R and related scripts to fit the models.
```{r setup, echo=FALSE}
library(data.table) # for handling large datasets
library(ggplot2) # for some plotting
library(glmmTMB) # for ME models
library(lme4) # for plotting random effects dotplot
library(bbmle) # for AICtab
library(gridExtra) # to combine ggplots together
library(grid) # to combine ggplots together
library(RColorBrewer)
library(scales) # for defining custom scales in ggplot
library(DHARMa) # for model diagnostics
library(here) # for relative paths
library(performance) # for r2 calculations
library(lavaan) # for SEM models of slopes

options(width=500) # turn off most text wrapping

signedsqrt = function(x) sign(x)*sqrt(abs(x))
signedsq = function(x) sign(x) * x^2
signedsqrttrans <- trans_new(name = 'signedsqrt', transform = signedsqrt, inverse = signedsq)
scaleme <- function(x, nm){
  if(!(nm %in% scalingall[,var])) stop('nm not found in scalingall')
  if(scalingall[var==nm, log]){
    x.sc <- (log(x + scalingall[var==nm, plus]) - scalingall[var == nm, center]) / scalingall[var == nm, scale]  
  } else {
    x.sc <- (x  + scalingall[var==nm, plus] - scalingall[var == nm, center]) / scalingall[var == nm, scale]
  }
  return(x.sc)
}

unscaleme <- function(x.sc, nm){
  if(!(nm %in% scalingall[,var])) stop('nm not found in scalingall')
  if(scalingall[var==nm, log]){
    x <- exp(x.sc * scalingall[var == nm, scale] + scalingall[var == nm, center]) - scalingall[var==nm, plus]
  } else {
    x <- x.sc * scalingall[var == nm, scale] + scalingall[var == nm, center] - scalingall[var==nm, plus]
  }
  return(x)
}

# tell RStudio to use project root directory as the root for this notebook. Needed since we are storing code in a separate directory.
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file()) 

# Turnover and covariates assembled by turnover_vs_temperature_prep.Rmd
trendsall <- fread(here('output', 'turnover_w_covariates.csv.gz'))

# And the scaling factors
scalingall <- fread(here('output', 'turnover_w_covariates_scaling.csv'))


```


# Summary stats
## Examine how many data points are available
### Just turnover and non-zero tempchange
```{r sample size all}
cat('Overall # dissimilarities: ', nrow(trendsall), '\n')
cat('# studies: ', trendsall[, length(unique(STUDY_ID))], '\n')
cat('# timeseries: ', trendsall[, length(unique(rarefyID))], '\n')
trendsall[!duplicated(rarefyID), table(REALM)]
trendsall[!duplicated(rarefyID), table(taxa_mod)]
trendsall[!duplicated(rarefyID), table(taxa_mod, REALM)]
```

### With all covariates
Use Bowler for human impact
```{r sample size Jtu covariates}
# the cases we can compare
apply(trendsall[, .(Jtu.sc, REALM, tempave_metab.sc, microclim.sc, tempchange.sc, nspp.sc, human_bowler.sc)], MARGIN = 2, FUN = function(x) sum(!is.na(x)))
i <- trendsall[, complete.cases(Jtu.sc, tempave_metab.sc, microclim.sc, tempchange.sc, nspp.sc, human_bowler.sc)]
cat('Overall # dissimilarities: ', sum(i), '\n')
cat('# studies: ', trendsall[i, length(unique(STUDY_ID))], '\n')
cat('# timeseries: ', trendsall[i, length(unique(rarefyID))], '\n')
trendsall[i & !duplicated(rarefyID), table(REALM)]
trendsall[i & !duplicated(rarefyID), table(taxa_mod)]
trendsall[i & !duplicated(rarefyID), table(taxa_mod, REALM)]
```

# Models
## Choose the variance structure
Try combinations of

- beta errors
- variance scaled to Nspp or to Nspp + REALM
- random intercept for taxa_mod2, STUDY_ID, rarefyID
- random slopes for duration

Did not try random intercept for compID (for overdispersion), since had trouble converging.
Use a full set of fixed effects and choose the RE with lowest AIC.
Many of the 3- and 5-year models with random slopes had singular convergence issues.

### 10-years
This chooses beta errors, random slopes (duration.sc) & intercepts for STUDY_ID and rarefyID, and variance scaled to nspp + realm.
We haven't dealt with potential testing on the boundary issues here.
```{r choose variance structure, echo=FALSE}
mods10 <- vector('list', length = 17)
i = 1
if(file.exists(here('temp', 'modRFgauss10.rds'))){ mods10[[i]] <- readRDS(here('temp', 'modRFgauss10.rds')); names(mods10)[i] <- 'modRFgauss10'; i = i+1}
if(file.exists(here('temp', 'modRFbeta10.rds'))){ mods10[[i]] <- readRDS(here('temp', 'modRFbeta10.rds')); names(mods10)[i] <- 'modRFbeta10'; i = i+1}
if(file.exists(here('temp', 'modRFrID10.rds'))){ mods10[[i]] <- readRDS(here('temp', 'modRFrID10.rds')); names(mods10)[i] <- 'modRFrID10'; i = i+1}
if(file.exists(here('temp', 'modRF2lev10.rds'))){ mods10[[i]] <- readRDS(here('temp', 'modRF2lev10.rds')); names(mods10)[i] <- 'modRF2lev10'; i = i+1}
if(file.exists(here('temp', 'modRFnestedRE10.rds'))){ mods10[[i]] <- readRDS(here('temp', 'modRFnestedRE10.rds')); names(mods10)[i] <- 'modRFnestedRE10'; i = i+1}
if(file.exists(here('temp', 'modRFslopeRE10.rds'))){ mods10[[i]] <- readRDS(here('temp', 'modRFslopeRE10.rds')); names(mods10)[i] <- 'modRFslopeRE10'; i = i+1}
if(file.exists(here('temp', 'modRFslopeRE2lev10.rds'))){ mods10[[i]] <- readRDS(here('temp', 'modRFslopeRE2lev10.rds')); names(mods10)[i] <- 'modRFslopeRE2lev10'; i = i+1}
if(file.exists(here('temp', 'modRFdisp10.rds'))){ mods10[[i]] <- readRDS(here('temp', 'modRFdisp10.rds')); names(mods10)[i] <- 'modRFdisp10'; i = i+1}
if(file.exists(here('temp', 'modRF2levdisp10.rds'))){ mods10[[i]] <- readRDS(here('temp', 'modRF2levdisp10.rds')); names(mods10)[i] <- 'modRF2levdisp10'; i = i+1}
if(file.exists(here('temp', 'modRFslopeRE2levdisp10.rds'))){ mods10[[i]] <- readRDS(here('temp', 'modRFslopeRE2levdisp10.rds')); names(mods10)[i] <- 'modRFslopeRE2levdisp10'; i = i+1}
if(file.exists(here('temp', 'modRFslopeREdisp10.rds'))){ mods10[[i]] <- readRDS(here('temp', 'modRFslopeREdisp10.rds')); names(mods10)[i] <- 'modRFslopeREdisp10'; i = i+1}
if(file.exists(here('temp', 'modRF2levdisprealm10.rds'))){ mods10[[i]] <- readRDS(here('temp', 'modRF2levdisprealm10.rds')); names(mods10)[i] <- 'modRF2levdisprealm10'; i = i+1}
if(file.exists(here('temp', 'modRFslopeRE2levdisprealm10.rds'))){ mods10[[i]] <- readRDS(here('temp', 'modRFslopeRE2levdisprealm10.rds')); names(mods10)[i] <- 'modRFslopeRE2levdisprealm10'; i = i+1}

# with log duration
if(file.exists(here('temp', 'modRFdurlog2levdisp10.rds'))){ mods10[[i]] <- readRDS(here('temp', 'modRFdurlog2levdisp10.rds')); names(mods10)[i] <- 'modRFdurlog2levdisp10'; i = i+1}
if(file.exists(here('temp', 'modRFdurlogslopeRE2levdisp10.rds'))){ mods10[[i]] <- readRDS(here('temp', 'modRFdurlogslopeRE2levdisp10.rds')); names(mods10)[i] <- 'modRFdurlogslopeRE2levdisp10'; i = i+1}
# if(file.exists(here('temp', 'modRFdurlogslopeREdisp10.rds'))){ mods10[[i]] <- readRDS(here('temp', 'modRFdurlogslopeREdisp10.rds')); names(mods10)[i] <- 'modRFdurlogslopeREdisp10'; i = i+1} # convergence error
if(file.exists(here('temp', 'modRFdurlog2levdisprealm10.rds'))){ mods10[[i]] <- readRDS(here('temp', 'modRFdurlog2levdisprealm10.rds')); names(mods10)[i] <- 'modRFdurlog2levdisprealm10'; i = i+1}
if(file.exists(here('temp', 'modRFdurlogslopeRE2levdisprealm10.rds'))){ mods10[[i]] <- readRDS(here('temp', 'modRFdurlogslopeRE2levdisprealm10.rds')); names(mods10)[i] <- 'modRFdurlogslopeRE2levdisprealm10'; i = i+1}

modes <- sapply(X = mods10, FUN = mode)
aics <- sapply(X = mods10[modes == 'list'], FUN = AIC)
aics - min(aics)
```


### Summary of the chosen model

```{r, echo=FALSE}
summary(mods10[[which(names(mods10)=='modRFslopeRE2levdisprealm10')]])
```


### Plot random effects
No clear discontinuities. Looks ok.
```{r, echo=FALSE}
lme4:::dotplot.ranef.mer(ranef(mods10[[which(names(mods10)=='modRFslopeRE2levdisprealm10')]])$cond)
```

### DHARMa model evaluation
```{r, echo=FALSE, eval=FALSE}
## run the top part by hand if needed. takes ~3 hrs
if(FALSE) {
  i10 <- trends10[, complete.cases(Jtu.sc, tempchange_abs.sc, REALM, tempave_metab.sc, duration.sc, microclim.sc, human_bowler.sc, nspp.sc)]

  res_RFslopeRE2levdisprealm10 <- simulateResiduals(mods10[[which(names(mods10)=='modRFslopeRE2levdisprealm10')]], n = 250)
  
  saveRDS(res_RFslopeRE2levdisprealm10, file = 'temp/res_RFslopeRE2levdisprealm10.rds')
} else {
  if(file.exists('temp/res_RFslopeRE2levdisprealm10.rds')) res_RFslopeRE2levdisprealm10 <- readRDS('temp/res_res_RFslopeRE2levdisprealm10.rds')
  i10 <- trends10[, complete.cases(Jtu.sc, tempchange_abs.sc, REALM, tempave_metab.sc, duration.sc, microclim.sc, human_bowler.sc, nspp.sc)]
}
```

#### Plot residuals for model fit to all data
There are many outliers and signs of underdispersion, but this is probably ok.
```{r, echo=FALSE, eval=FALSE}
if(exists('res_RFslopeRE2levdisprealm10')){
  plot(res_RFslopeRE2levdisprealm10)
  plotResiduals(res_RFslopeRE2levdisprealm10, form=trends10$tempchange_abs.sc[i10], xlab = 'tempchange_abs.sc', main = '')
  plotResiduals(res_RFslopeRE2levdisprealm10, form=trends10$REALM[i10], xlab = 'REALM', main = '')
  plotResiduals(res_RFslopeRE2levdisprealm10, trends10$tempave_metab.sc[i10], xlab = 'tempave_metab.sc', main = '')
  plotResiduals(res_RFslopeRE2levdisprealm10, trends10$duration.sc[i10], xlab = 'duration.sc', main = '')
  plotResiduals(res_RFslopeRE2levdisprealm10, trends10$microclim.sc[i10], xlab = 'microclim.sc', main = '')
  plotResiduals(res_RFslopeRE2levdisprealm10, form=trends10$human_bowler.sc[i10], xlab = 'human_bowler.sc', main = '')
}
```


#### Overdispersion
There is underdispersion.
```{r, echo=FALSE, eval=FALSE}
testDispersion(res_RFslopeRE2levdisprealm10)

```

#### Near-zero-inflation
(Zero values have been transformed to slightly >0, so can't test zero-inflation directly)

Near-zero values are not inflated.
```{r, eval=FALSE}
countNearZero <- function(x) sum(x < 0.0001)
testGeneric(res_RFslopeRE2levdisprealm10, summary = countNearZero, alternative = 'greater')

```

#### Near-one-inflation
Near-one values are not inflated.
```{r, eval=FALSE}
countNearOne <- function(x) sum(x > 0.9999)
testGeneric(res_RFslopeRE2levdisprealm10, summary = countNearOne, alternative = 'greater')

```

## Realm x duration
Compare very basic models w/ and w/out realm as an explanatory factor for differences in turnover (proportion species/yr)
```{r}
modAllJtu <- readRDS('temp/modAllJtu.rds')
modRealmAllJtu <- readRDS('temp/modRealmAllJtu.rds')
```

A model with REALM is worse than a model without (just looking at average slopes, no other covariates)
```{r}
aics <- AIC(modAllJtu, modRealmAllJtu)
aics$dAIC <- aics$AIC - min(aics$AIC)
aics
```

## Temperature models
### AIC for Jtu
```{r, rows.print=20}
modAllJtu <- readRDS(here('temp', 'modAllJtu.rds')) # just duration
modRealmAllJtu <- readRDS(here('temp', 'modRealmAllJtu.rds')) # realm
modTaxamod2AllJtu <- readRDS(here('temp', 'modTaxamod2AllJtu.rds')) # taxa
modsdTtsignAllJtu <- readRDS(here('temp', 'modsdTtsignAllJtu.rds')) # tsign, tempchange_abs
modsdTRealmtsignAllJtu <- readRDS(here('temp', 'modsdTRealmtsignAllJtu.rds')) # tsign, tempchange_abs, realm
modrawTsdTTRealmtsignAllJtu <- readRDS(here('temp', 'modrawTsdTTRealmtsignAllJtu.rds')) # tempave * tempchange_abs, realm, tsign

aics3 <- AIC(modAllJtu, modRealmAllJtu,modTaxamod2AllJtu, # no tempchange
             modsdTtsignAllJtu, modsdTRealmtsignAllJtu, # tempchange w/out or w/ realm
             modrawTsdTTRealmtsignAllJtu)# add tempave*tempchange and realm
aics3$dAIC <- aics3$AIC - min(aics3$AIC)
aics3
```

### AIC for Horn
```{r, rows.print=20}
modAllHorn <- readRDS(here('temp', 'modAllHorn.rds')) # just duration
modRealmAllHorn <- readRDS(here('temp', 'modRealmAllHorn.rds')) # realm
modTaxamod2AllHorn <- readRDS(here('temp', 'modTaxamod2AllHorn.rds')) # taxa
modsdTtsignAllHorn <- readRDS(here('temp', 'modsdTtsignAllHorn.rds')) # tsign, tempchange_abs
modsdTRealmtsignAllHorn <- readRDS(here('temp', 'modsdTRealmtsignAllHorn.rds')) # tsign, tempchange_abs, realm
modrawTsdTTRealmtsignAllHorn <- readRDS(here('temp', 'modrawTsdTTRealmtsignAllHorn.rds')) # tempave * tempchange_abs, realm, tsign

aics3 <- AIC(modAllHorn, modRealmAllHorn, modTaxamod2AllHorn,
             modsdTtsignAllHorn, modsdTRealmtsignAllHorn, # tempchange w/out and with realm
             modrawTsdTTRealmtsignAllHorn
             )# add tempave*tempchange and realm
aics3$dAIC <- aics3$AIC - min(aics3$AIC)
aics3
```

### Plots for Jtu
#### Make/load predictions
Uses output from scripts.
```{r, echo = FALSE}
# using tsign:tempchange_abs:realm
if(file.exists(here('temp', 'slopes_modsdTRealmtsignAllJtu.rds'))){
  slopessdTRealmtsignAllJtu <- readRDS(here('temp', 'slopes_modsdTRealmtsignAllJtu.rds'))
  print('Loaded sdTRealmtsignAllJtu predictions from file')
} else {
  print('No modsdTRealmtsignAllJtu effects. Need to run code/pred_modrawXAllJtu.sh modsdTRealmtsignAllJtu')
}

# using tsign:tempchange_abs * tempave * realm
if(file.exists(here('temp', 'slopes_rawTsdTTRealmtsign.rds'))){
  slopesTsdTTRealmtsignJtu <- readRDS(here('temp', 'slopes_rawTsdTTRealmtsign.rds'))
  print('Loaded TsdTTRealmtsignJtu predictions from file')
} else {
  print('No TsdTTRealmtsignJtu effects. Need to run pred_GLMMmodrawXAllJtu.R')
}

```
#### tsign:tempchange_abs:realm plots
##### Confidence bounds
CIs are from a SEM fit to the trends.
```{r, echo = FALSE}
vals <- slopessdTRealmtsignAllJtu[c(which.min(abs(tempave - 0)), which.min(abs(tempave-25))), unique(tempave)] # show 0 and 25degC
ggplot(slopessdTRealmtsignAllJtu[tempave %in% vals,], 
       aes(tempchange, slope, color = factor(round(tempave)), group = tempave)) +
    geom_line() +
    geom_pointrange(aes(ymin=slope-1.96*slope.se, ymax=slope+1.96*slope.se), alpha = 0.25) + 
    facet_grid(cols = vars(REALM))  +
    labs(x = 'dT [degC/yr]') +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
          panel.background = element_blank(), axis.line = element_line(colour = "black"),
          legend.key=element_blank(),
          axis.text=element_text(size=8),
          axis.title=element_text(size=8),
          plot.title=element_text(size=8))  

```




#### tsign:tempchange_abs*tempave:realm effects
```{r}
fixef(modTsdTTRealmtsignAllJtu)

```

##### Interaction
modrawTsdTTRealmtsignAllJtu model
```{r, echo = FALSE}
# plot
p1 <- ggplot(slopesTsdTTRealmtsignJtu[REALM=='Marine'], aes(tempchange, tempave, z = slope)) +
  geom_raster(aes(fill = slope)) +
  labs(x = 'Temperature change (degC per year)', y = 'Temperature (degC)', title = 'Marine') +
  scale_fill_gradient2(high= "#B2182B", mid = "white", low= "#2166AC", midpoint = 0, name = 'Jtu slope') +
  theme(axis.text = element_text(size = 12), 
        axis.title = element_text(size = 14),
        panel.background = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.position = "top",
        legend.margin = margin(c(0, 0.1, -20, 0)),
        legend.justification = c(0.92, 0.9),
        legend.text=element_text(size= 12),
        legend.title=element_text(size= 18),
        legend.title.align = 1)
p2 <- ggplot(slopesTsdTTRealmtsignJtu[REALM=='Terrestrial'], aes(tempchange, tempave, z = slope)) +
  geom_raster(aes(fill = slope)) +
  labs(x = 'Temperature change (degC per year)', y = 'Temperature (degC)', title = 'Terrestrial') +
  scale_fill_gradient2(high= "#B2182B", mid = "white", low= "#2166AC", midpoint = 0, name = 'Jtu slope') +
  theme(axis.text = element_text(size = 12), 
        axis.title = element_text(size = 14),
        panel.background = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.position = "top",
        legend.margin = margin(c(0, 0.1, -20, 0)),
        legend.justification = c(0.92, 0.9),
        legend.text=element_text(size= 12),
        legend.title=element_text(size= 18),
        legend.title.align = 1)
p3 <- ggplot(slopesTsdTTRealmtsignJtu[REALM=='Freshwater'], aes(tempchange, tempave, z = slope)) +
  geom_raster(aes(fill = slope)) +
  labs(x = 'Temperature change (degC per year)', y = 'Temperature (degC)', title = 'Freshwater') +
  scale_fill_gradient2(high= "#B2182B", mid = "white", low= "#2166AC", midpoint = 0, name = 'Jtu slope') +
  theme(axis.text = element_text(size = 12), 
        axis.title = element_text(size = 14),
        panel.background = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.position = "top",
        legend.margin = margin(c(0, 0.1, -20, 0)),
        legend.justification = c(0.92, 0.9),
        legend.text=element_text(size= 12),
        legend.title=element_text(size= 18),
        legend.title.align = 1)

p1
p2
p3
```

##### Confidence bounds
CIs are from a SEM fit to the trends.
```{r, echo=FALSE}
vals <- slopesTsdTTRealmtsignJtu[c(which.min(abs(tempave - 0)), which.min(abs(tempave-25))), unique(tempave)] # show 0 and 25degC
ggplot(slopesTsdTTRealmtsignJtu[tempave %in% vals,], 
       aes(tempchange, slope, color = factor(round(tempave)), group = tempave)) +
    geom_line() +
    geom_pointrange(aes(ymin=slope-1.96*slope.se, ymax=slope+1.96*slope.se), alpha = 0.25) + 
    facet_grid(cols = vars(REALM))  +
    labs(x = 'dT [degC/yr]') +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
          panel.background = element_blank(), axis.line = element_line(colour = "black"),
          legend.key=element_blank(),
          axis.text=element_text(size=8),
          axis.title=element_text(size=8),
          plot.title=element_text(size=8))  

```


#### Which species are common in each quadrant?
FALSE is less than 20degC, TRUE is greater than.
```{r}
trendsall[!is.na(tempave.sc) & !duplicated(rarefyID), table(taxa_mod2, unscaleme(tempave.sc, 'tempave.sc') > 20, REALM)]
trendsall[!is.na(tempave.sc) & !duplicated(rarefyID), round(prop.table(table(taxa_mod2, unscaleme(tempave.sc, 'tempave.sc') > 20, REALM), margin = c(2,3)),2)]
```


## Latitude or temperature?
Compare temperature vs. latitude in an interaction with abs(tempchange). Not very useful until we fit abs(latitude) model so that effects are mirrored at each pole.
```{r}
modTsdTTRealmAllJtu <- readRDS(here('temp', 'modTsdTTRealmAllJtu.rds')) # uses temperature
modrawTsdTTRealmAllJtu <- readRDS(here('temp', 'modrawTsdTTRealmAllJtu.rds')) # uses environmental temperature
modLatsdTTRealmAllJtu <- readRDS(here('temp', 'modLatsdTTRealmAllJtu.rds')) # uses latitude
```

### AIC
Clearly chooses environmental temperature.
```{r}
aics <- AIC(modTsdTTRealmAllJtu, modLatsdTTRealmAllJtu, modrawTsdTTRealmAllJtu)
aics$dAIC <- aics$AIC - min(aics$AIC)
aics
```


## Covariate models
### Load models
```{r, echo = FALSE}
# simple to more complex models
modRealmAllJtu <- readRDS(here('temp', 'modRealmAllJtu.rds')) # only realm
modrawTsdTTRealmtsignAllJtu <- readRDS(here('temp', 'modrawTsdTTRealmtsignAllJtu.rds')) # tempave, tempchange_abs, realm, tsign

# covariate models with tsign
modrawTsdTTRealmtsignhumanAllJtu <- readRDS(here('temp', 'modrawTsdTTRealmtsignhumanAllJtu.rds')) # human
modrawTsdTTRealmtsignmicroclimAllJtu <- readRDS(here('temp', 'modrawTsdTTRealmtsignmicroclimAllJtu.rds')) # microclim

# double covariate model with tsign
modrawTsdTTRealmtsignmicroclimhumanAllJtu <- readRDS(here('temp', 'modrawTsdTTRealmtsignmicroclimhumanAllJtu.rds')) 

```

### AIC
```{r, rows.print=15}
aics <- AIC(modRealmAllJtu, modrawTsdTTRealmtsignAllJtu,
            modrawTsdTTRealmtsignmicroclimAllJtu, modrawTsdTTRealmtsignhumanAllJtu,
            modrawTsdTTRealmtsignmicroclimhumanAllJtu)
aics$dAIC <- aics$AIC - min(aics$AIC)
aics

```


### plots of single covariate models
#### Load the interactions
```{r, echo = FALSE}

if(file.exists(here('temp', 'slopes_rawTsdTTRealmtsignCovariate.rds'))){
  slopes_rawTsdTTRealmtsignCovariate <- readRDS(here('temp', 'slopes_rawTsdTTRealmtsignCovariate.rds'))
  print('Loaded tsign interaction predictions from file')

} else {
  print('Need to run pred_GLMMmodrawTsdTTRealmCovariate.R with argument tsign')
  
}

if(file.exists(here('temp', 'slopes_rawinteractions2.rds'))){
  slopesraw2 <- readRDS(here('temp', 'slopes_rawinteractions2.rds'))
  print('Loaded complex interaction predictions from file')

} else {
  print('Need to run pred_GLMMmodrawTsdTTRealmCovariate.R with argument full')
  
}

```

#### Plot covariate interactions as lines
Covariate only interacts with tempchange_abs.

Error bars are 95% CIs
```{r echo=FALSE, fig.height=15, fig.width=6}
# plot
p1 <- ggplot(slopes_rawTsdTTRealmtsignCovariate, aes(tempchange, slope_microclim, 
                                                     color = microclim, group = microclim)) +
    geom_line() +
    geom_pointrange(aes(ymin=slope_microclim-1.96*slope_microclim.se, 
                        ymax=slope_microclim+1.96*slope_microclim.se), alpha = 0.25) + 
    facet_grid(cols = vars(REALM), rows = vars(tempave), labeller = label_both)
p4 <- ggplot(slopes_rawTsdTTRealmtsignCovariate, aes(tempchange, slope_human, 
                                                     color = human_bowler, group = human_bowler)) +
    geom_line() +
    geom_pointrange(aes(ymin=slope_human-1.96*slope_human.se, ymax=slope_human+1.96*slope_human.se), alpha = 0.25) + 
    facet_grid(cols = vars(REALM), rows = vars(tempave), labeller = label_both)

p1
p4
```



#### Plot tempchange:tempave interaction
##### microclimate model
Predictions were only made for a few tempaves, so the plot shows only strips.  
However, 
```{r, echo = FALSE}
# plot
p1 <- ggplot(slopes_rawTsdTTRealmtsignCovariate[microclim == min(microclim), ], aes(tempchange, tempave, z = slope_microclim)) +
  geom_raster(aes(fill = slope_microclim)) +
  labs(x = 'Temperature change (degC per year)', y = 'Temperature (degC)', title = 'Marine') +
  scale_fill_gradient2(high= "#B2182B", mid = "white", low= "#2166AC", midpoint = 0, name = 'Jtu slope') +
  theme(axis.text = element_text(size = 12), 
        axis.title = element_text(size = 14),
        panel.background = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.position = "top",
        legend.margin = margin(c(0, 0.1, -10, 0)),
        legend.justification = c(0.92, 0.9),
        legend.text=element_text(size= 8),
        legend.title=element_text(size= 12),
        legend.title.align = 1) +
  facet_grid(cols = vars(REALM))
p1
```

### plots of double covariate models
Only microclimate + human so far.
#### Load the interactions

```{r, echo = FALSE}

if(file.exists(here('temp', 'slopes_rawTsdTTRealmtsignmicroclimhuman.rds'))){
  slopes_rawTsdTTRealmtsignmicroclimhuman <- readRDS(here('temp', 'slopes_rawTsdTTRealmtsignmicroclimhuman.rds'))
  print('Loaded microclim+human interaction predictions from file')

} else {
  print('Need to run pred_GLMMmodrawTsdTTRealmmicroclimhumanAllJtu.R')
}

```

#### Plot covariate interactions as lines
Covariates only interact with tempchange_abs.

Error bars are 95% CIs
```{r echo=FALSE, fig.height=15, fig.width=8}
# plot
p1 <- ggplot(slopes_rawTsdTTRealmtsignmicroclimhuman, aes(tempchange, slope_microclimhuman, 
                                                     color = microclim, group = microclim)) +
    geom_line() +
    geom_pointrange(aes(ymin=slope_microclimhuman-1.96*slope_microclimhuman.se, 
                        ymax=slope_microclimhuman+1.96*slope_microclimhuman.se), alpha = 0.25) + 
    facet_grid(tempave ~ REALM + human_bowler, labeller = label_both)
p2 <- ggplot(slopes_rawTsdTTRealmtsignmicroclimhuman, aes(tempchange, slope_microclimhuman, color = human_bowler, group = human_bowler)) +
    geom_line() +
    geom_pointrange(aes(ymin=slope_microclimhuman-1.96*slope_microclimhuman.se, 
                        ymax=slope_microclimhuman+1.96*slope_microclimhuman.se), alpha = 0.25) + 
    facet_grid(tempave ~ REALM + microclim, labeller = label_both)

p1
p2
```




## Taxon test
Models with taxon effects interacted with temperature change all returned singular fits (NAs for SEs). Using simplest model here.
```{r, echo = FALSE}
modTaxamod2AllJtu <- readRDS(here('temp', 'modTaxamod2AllJtu.rds')) # has taxa_mod2

# previous models
modAllJtu <- readRDS(here('temp', 'modAllJtu.rds')) # only duration
modRealmAllJtu <- readRDS(here('temp', 'modRealmAllJtu.rds')) # only realm

```

#### AIC
```{r}
aics <- AIC(modAllJtu, modRealmAllJtu, modTaxamod2AllJtu)
aics$dAIC <- aics$AIC - min(aics$AIC, na.rm=TRUE)
aics

```


#### Summary
```{r}
summary(modTaxamod2AllJtu)
```



