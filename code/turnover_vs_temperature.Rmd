---
title: "Turnover vs. temperature exploration"
output: html_notebook 
#github_document # latter for displaying on github, but turning it on (or even putting this comment on the same line) disables auto-update of the html notebook
---

```{r setup}
library(data.table)
library(ggplot2)
library(lme4)

knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file()) # tell RStudio to use project root directory as the root for this notebook. Needed since we are storing code in a separate directory.
```

### Load data
```{r load data}
# BioTime
load('data/biotime_blowes/bt.Rdata')
bt <- data.table(bt_malin); rm(bt_malin)

# Temperature trends from CRU TS (on land)
tmptrendbyyr <- fread('output/cruts_tmptrend_byyear.csv.gz', drop = 1)
tmptrendallyr <- fread('output/cruts_tmptrend_allyear.csv.gz', drop = 1)

# Temperature trends from ERSST (ocean)
ssttrendbyyr <- fread('output/ersst_ssttrend_byyear.csv.gz', drop = 1)
ssttrendallyr <- fread('output/ersst_ssttrend_allyear.csv.gz', drop = 1)

# Seasonality
seascru <- fread('output/cruts_seas.csv.gz', drop = 1)
seasersst <- fread('output/ersst_seas.csv.gz', drop = 1)

# Average temperature
tavecru <- fread('output/cruts_tmpave_allyear.csv.gz', drop = 1)
taveersst <- fread('output/ersst_sstave_allyear.csv.gz', drop = 1)

# NPP
npp <- fread('output/npplandocean.csv.gz')

```

### Assemble dataset of trends (turnover and temperature) and covariates
```{r assemble trends and covariates}
# calculate temporal turnover
calctrend <- function(Jtu_base, YEAR){ # function to calc trends
    mod <- lm(Jtu_base ~ YEAR)
    list(Jtutrend = coef(mod)[2], # coef for the slope
         Jtutrend_se = sqrt(diag(vcov(mod)))[2]) # SE
    }

setkey(bt, STUDY_ID, rarefyID, YEAR)
trends <- bt[, calctrend(Jtu_base, YEAR), 
    by = .(REALM, Biome, taxa_mod, STUDY_ID, rarefyID, rarefyID_x, rarefyID_y)] # calculate trend in Jaccard turnover from first year, plus SEs
trends$nyrBT <-  bt[, .(length(YEAR)), by = .(REALM, Biome, taxa_mod, STUDY_ID, rarefyID, rarefyID_x, rarefyID_y)][, V1] # number of years in time-series
minse <- trends[Jtutrend_se != 0 & nyrBT > 4 , min(Jtutrend_se)] # find smallest non-zero se with 5 or more datapoints (a decent sample size)
trends[, Jtutrend_se_nz := pmax(Jtutrend_se, minse)] # create an SE that is not zero

trends$Strend <- bt[, .(coef(lm(I(log(S)) ~ YEAR))[2]), by = .(REALM, Biome, taxa_mod, STUDY_ID, rarefyID, rarefyID_x, rarefyID_y)][, V1] # trend in log(S)

# add temperature trends
trends <- merge(trends, tmptrendbyyr, all.x = TRUE, by = 'rarefyID') # add temperature trend (years that match biotime)
trends <- merge(trends, tmptrendallyr[, .(rarefyID, tmptrendallyr)], all.x = TRUE, by = 'rarefyID') # add temperature trend (all years from first to last of each time-series)
trends <- merge(trends, ssttrendbyyr[, .(rarefyID, ssttrendbyyr)], all.x = TRUE, by = 'rarefyID') # sst
trends <- merge(trends, ssttrendallyr[, .(rarefyID, ssttrendallyr)], all.x = TRUE, by = 'rarefyID')

# add covariates
trends <- merge(trends, seascru[, .(rarefyID, seas_cruts)], all.x = TRUE, by = 'rarefyID') # seasonality from CRU TS
trends <- merge(trends, seasersst[, .(rarefyID, seas_ersst)], all.x = TRUE, by = 'rarefyID') # seasonality from ERSST
trends <- merge(trends, tavecru[, .(rarefyID, tmpaveallyr)], all.x = TRUE, by = 'rarefyID')
trends <- merge(trends, taveersst[, .(rarefyID, sstaveallyr)], all.x = TRUE, by = 'rarefyID')
trends <- merge(trends, npp, all.x = TRUE, by = 'rarefyID') # npp, centered and scale
```

Do some basic checks
```{r basic checks}
# basic checks
trends
trends[, .(minJ = min(Jtutrend), maxJ = max(Jtutrend), minS = min(Strend), maxS = max(Strend)), by = REALM]
trends[, .(nJ = sum(Jtutrend < 0), nS = sum(Strend < 0)), by = REALM] # why are some turnover trends < 0?
trends[, .(nJ = sum(Jtutrend > 0), nS = sum(Strend > 0)), by = REALM]

# are the temperature trends correlated?
# compare trends calculated from all sampled years in BioTime vs. all years from min to max year in BioTime
ggplot(trends, aes(tmptrendallyr, tmptrendbyyr)) +
    geom_point() +
    geom_smooth()

ggplot(trends, aes(ssttrendallyr, ssttrendbyyr)) +
    geom_point() +
    geom_smooth()

# compare temperature trends from CRU TS vs ERSST
ggplot(trends, aes(tmptrendallyr, ssttrendbyyr)) + # ERSST more muted at fastest rates of change in CRU TS
    geom_point() +
    geom_smooth()

# average temperature from CRU TS and ERSST
ggplot(trends, aes(tmpaveallyr, sstaveallyr, color = rarefyID_y)) + # ERSST more muted at fastest rates of change in CRU TS
    geom_point() +
    geom_smooth()

# compare seasonality from CRU TS and ERSST
ggplot(trends, aes(seas_cruts, seas_ersst, color = rarefyID_y)) + # ERSST more muted at fastest rates of change in CRU TS
    geom_point() +
    geom_smooth()

```

### Combine CRU TS and ERSST
```{r combine cruts and ersst}
# temperature trend
trends[ , temptrend_comb_allyr := tmptrendallyr] # CRU TS for land and freshwater
trends[REALM == 'Marine', temptrend_comb_allyr := ssttrendallyr] # ERSST for marine

# average temperature
trends[, tempave_comb := tmpaveallyr]
trends[REALM == 'Marine', tempave_comb := sstaveallyr]

# seasonality
trends[, seas_comb := seas_cruts]
trends[REALM == 'Marine', seas_comb := seas_ersst]

```

### Center and scale covariates
``` {r center and scale}
trends[, temptrend_comb_allyr.sc := scale(temptrend_comb_allyr)]
trends[, temptrend_comb_allyr_abs.sc := scale(abs(temptrend_comb_allyr))]
trends[, seas_comb.sc := scale(seas_comb)]
trends[, tempave_comb.sc := scale(tempave_comb)]
trends[, npp.sc := scale(npp)]
```

### Plot turnover vs. temperature trends
Trends are impressively symmetric around no trend in temperature. Instead, abs(trend) looks better.
There are very odd values for marine at 0, making me think the Jtu_base values are incorrect there.
```{r plot turnover v temp trend}
# Jaccard turnover trend vs. temperature trend (across all years)
ggplot(trends, aes(temptrend_comb_allyr, Jtutrend, color = REALM)) +
    geom_point(size = 0.2, alpha = 0.5) + 
    geom_smooth()

# Jaccard turnover trend vs. abs temperature trend (across all years)
ggplot(trends, aes(abs(temptrend_comb_allyr), Jtutrend, group = REALM, color = REALM)) +
    geom_point(size = 0.2, alpha = 0.5) + 
    geom_smooth() +
    geom_smooth(method = 'lm')
```

### Plot Richness trend vs. temperature trends
```{r richness trend v temp trend}
# Richness trend vs. temperature trend (across all years)
ggplot(trends, aes(temptrend_comb_allyr, Strend, color = REALM)) +
    geom_point(size = 0.2, alpha = 0.5) + 
    geom_smooth()

# Richness trend vs. abs temperature trend (across all years)
ggplot(trends, aes(abs(temptrend_comb_allyr), Strend, group = REALM, color = REALM)) +
    geom_point(size = 0.2, alpha = 0.5) + 
    geom_smooth()
```

### Model choice: Jaccard turnover trend vs. temperature trend (across all years)
Baseline turnover is slowest in terrestrial, fastest in marine
Freshwater turnover is fastest with temperature, terrestrial slowest
Turnover lower with higher seasonality, turnover response to temperature is lower with more seasonality
After accounting for seasonality, marine baseline turnover is lower than terrestrial, but marine response to temperature is stronger than on land
```{r model choice}
# the cases we can compare
cat('Number of data points available:\n')
apply(trends[, .(Jtutrend, temptrend_comb_allyr, REALM, seas_comb, npp)], MARGIN = 2, FUN = function(x) sum(!is.na(x)))
i <- trends[, complete.cases(Jtutrend, temptrend_comb_allyr, REALM, seas_comb, npp, tempave_comb)]
cat('Overall:\n')
sum(i) 

# fit models
mods <- vector('list', 0)
mods[[1]] <- lmer(Jtutrend ~ temptrend_comb_allyr.sc + REALM + (1|STUDY_ID), data = trends[i,], weights = 1/trends$Jtutrend_se_nz[i])
mods[[2]] <- lmer(Jtutrend ~ temptrend_comb_allyr_abs.sc + REALM + (1|STUDY_ID), data = trends[i,], weights = 1/trends$Jtutrend_se_nz[i])
mods[[3]] <- lmer(Jtutrend ~ temptrend_comb_allyr_abs.sc*REALM + (1|STUDY_ID), data = trends[i,], weights = 1/trends$Jtutrend_se_nz[i])
mods[[4]] <- lmer(Jtutrend ~ temptrend_comb_allyr_abs.sc*seas_comb.sc + (1|STUDY_ID), data = trends[i,], weights = 1/trends$Jtutrend_se_nz[i])
mods[[5]] <- lmer(Jtutrend ~ temptrend_comb_allyr_abs.sc*seas_comb.sc + REALM + (1|STUDY_ID), data = trends[i,], weights = 1/trends$Jtutrend_se_nz[i])
mods[[6]] <- lmer(Jtutrend ~ temptrend_comb_allyr_abs.sc*seas_comb.sc + 
                      temptrend_comb_allyr_abs.sc*REALM + 
                      (1|STUDY_ID), data = trends[i,], weights = 1/trends$Jtutrend_se_nz[i])
mods[[7]] <- lmer(Jtutrend ~ temptrend_comb_allyr_abs.sc*seas_comb.sc + 
                      temptrend_comb_allyr_abs.sc*REALM + 
                      temptrend_comb_allyr_abs.sc*tempave_comb.sc + 
                      (1|STUDY_ID), data = trends[i,], weights = 1/trends$Jtutrend_se_nz[i])
mods[[8]] <- lmer(Jtutrend ~ temptrend_comb_allyr_abs.sc*npp.sc + 
                      (1|STUDY_ID), data = trends[i,], weights = 1/trends$Jtutrend_se_nz[i])
mods[[9]] <- lmer(Jtutrend ~ temptrend_comb_allyr_abs.sc*npp.sc + 
                      REALM + 
                      (1|STUDY_ID), data = trends[i,], weights = 1/trends$Jtutrend_se_nz[i])

# examine models
cat('AIC:\n')
sapply(mods, AIC) - min(sapply(mods, AIC))
cat('\nModel terms:\n')
lapply(mods, summary)
```