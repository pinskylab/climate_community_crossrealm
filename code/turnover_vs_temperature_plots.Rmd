---
title: 'Turnover vs. temperature plots'
output: 
    github_document: default

---
# Prep
<details>
<summary>Click to expand code</summary>

```{r setup}
library(data.table) # for handling large datasets
library(ggplot2) # for some plotting
library(gridExtra) # to combine ggplots together
library(grid) # to combine ggplots together
library(RColorBrewer)
library(scales) # for defining custom scales in ggplot

options(width=500) # turn off most text wrapping

signedsqrt = function(x) sign(x)*sqrt(abs(x))
signedsq = function(x) sign(x) * x^2
signedsqrttrans <- trans_new(name = 'signedsqrt', transform = signedsqrt, inverse = signedsq)


# tell RStudio to use project root directory as the root for this notebook. Needed since we are storing code in a separate directory.
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file()) 
```


```{r load data}
# Turnover and covariates assembled by turnover_vs_temperature_prep.Rmd
trends <- fread('output/turnover_w_covariates.csv.gz')

# set realm order
trends[, REALM := factor(REALM, levels = c('Freshwater', 'Marine', 'Terrestrial'), ordered = FALSE)]

# set up sign of temperature change
trends[, tsign := factor(sign(tempchange))]

# realm that combined Terrestrial and Freshwater, for interacting with human impact
trends[, REALM2 := REALM]
levels(trends$REALM2) = list(TerrFresh = "Freshwater", TerrFresh = "Terrestrial", Marine = "Marine")

# group Marine invertebrates/plants in with All
trends[, taxa_mod2 := taxa_mod]
trends[taxa_mod == 'Marine invertebrates/plants', taxa_mod2 := 'All']

# calculate duration
trends[, duration := year2 - year1]
```


</details>

# Plot dissimilarity vs. temperature change
## All temporal scales
```{r plot diss vs temp change, echo=FALSE, fig.height = 9, fig.width = 11}
cbPalette <- sample(c("#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7"), 
                    length(unique(trends$rarefyID)),
                    replace = TRUE)

p1 <- ggplot(trends, aes(tempchange, Jtu)) +
  geom_point(aes(color = as.factor(rarefyID)), size = 2, alpha = 0.05, na.rm = TRUE) + 
  geom_smooth(method = 'lm', formula = y ~ abs(x), na.rm = TRUE) + 
  labs(x = 'Temperature change (°C)', y = 'Jaccard turnover') +
  facet_grid(~REALM, scales = 'free') + 
  theme(legend.position = "none") + 
  theme(legend.position = "none", axis.text = element_text(size = 16)) +
  scale_color_manual(values=cbPalette)

p2 <- ggplot(trends, aes(tempchange, Jbeta)) +
  geom_point(aes(color = as.factor(rarefyID)), size = 2, alpha = 0.05, na.rm = TRUE) + 
  geom_smooth(method = 'lm', formula = y ~ abs(x), na.rm = TRUE) +
  labs(x = 'Temperature change (°C)', y = 'Jaccard total') +
  facet_grid(~REALM, scales = 'free') + 
  theme(legend.position = "none", axis.text = element_text(size = 16)) +
  scale_color_manual(values=cbPalette)

p3 <- ggplot(trends, aes(tempchange, Horn)) +
  geom_point(aes(color = as.factor(rarefyID)), size = 2, alpha = 0.05, na.rm = TRUE) + 
  geom_smooth(method = 'lm', formula = y ~ abs(x), na.rm = TRUE) +
  labs(x = 'Temperature change (°C)', y = 'Morisita-Horn') +
  facet_grid(~REALM, scales = 'free') + 
  theme(legend.position = "none") + 
  theme(legend.position = "none", axis.text = element_text(size = 16)) +
  scale_color_manual(values=cbPalette)



grid.arrange(p1, p2, p3, ncol = 1)
```

## Only 1 year differences
```{r plot diss vs temp change 1 yr, echo=FALSE, fig.height = 9, fig.width = 11}
p1 <- ggplot(trends[duration == 1, ], aes(tempchange, Jtu)) +
  geom_point(size = 0.2, alpha = 0.2, na.rm = TRUE) + 
  geom_smooth(method = 'lm', formula = y ~ abs(x), na.rm = TRUE) +
  facet_grid(~REALM, scales = 'free') + 
  labs(x = 'Temperature change (°C)', y = 'Jaccard turnover')

p2 <- ggplot(trends[duration == 1, ], aes(tempchange, Jbeta)) +
  geom_point(size = 0.2, alpha = 0.2, na.rm = TRUE) + 
  geom_smooth(method = 'lm', formula = y ~ abs(x), na.rm = TRUE) +
  facet_grid(~REALM, scales = 'free') + 
  labs(x = 'Temperature change (°C)', y = 'Jaccard total')

p3 <- ggplot(trends[duration == 1, ], aes(tempchange, Horn)) +
  geom_point(size = 0.2, alpha = 0.2, na.rm = TRUE) + 
  geom_smooth(method = 'lm', formula = y ~ abs(x), na.rm = TRUE) +
  facet_grid(~REALM, scales = 'free') + 
  labs(x = 'Temperature change (°C)', y = 'Morisita-Horn')

grid.arrange(p1, p2, p3, ncol = 1)
```

## Only 10 year differences
```{r plot diss vs temp change 10 yr, echo=FALSE, fig.height = 9, fig.width = 11}
p1 <- ggplot(trends[duration == 10, ], aes(tempchange, Jtu)) +
  geom_point(size = 0.2, alpha = 0.2, na.rm = TRUE) + 
  geom_smooth(method = 'lm', formula = y ~ abs(x), na.rm = TRUE) +
  facet_grid(~REALM, scales = 'free') + 
  labs(x = 'Temperature change (°C)', y = 'Jaccard turnover')

p2 <- ggplot(trends[duration == 10, ], aes(tempchange, Jbeta)) +
  geom_point(size = 0.2, alpha = 0.2, na.rm = TRUE) + 
  geom_smooth(method = 'lm', formula = y ~ abs(x), na.rm = TRUE) +
  facet_grid(~REALM, scales = 'free') + 
  labs(x = 'Temperature change (°C)', y = 'Jaccard total')

p3 <- ggplot(trends[duration == 10, ], aes(tempchange, Horn)) +
  geom_point(size = 0.2, alpha = 0.2, na.rm = TRUE) + 
  geom_smooth(method = 'lm', formula = y ~ abs(x), na.rm = TRUE) +
  facet_grid(~REALM, scales = 'free') + 
  labs(x = 'Temperature change (°C)', y = 'Morisita-Horn')

grid.arrange(p1, p2, p3, ncol = 1)
```

## Only 20 year differences
```{r plot diss vs temp change 20 yr, echo=FALSE, fig.height = 9, fig.width = 11}
p1 <- ggplot(trends[duration == 20, ], aes(tempchange, Jtu)) +
  geom_point(size = 0.2, alpha = 0.2, na.rm = TRUE) + 
  geom_smooth(method = 'lm', formula = y ~ abs(x), na.rm = TRUE) +
  facet_grid(~REALM, scales = 'free') + 
  labs(x = 'Temperature change (°C)', y = 'Jaccard turnover')

p2 <- ggplot(trends[duration == 20, ], aes(tempchange, Jbeta)) +
  geom_point(size = 0.2, alpha = 0.2, na.rm = TRUE) + 
  geom_smooth(method = 'lm', formula = y ~ abs(x), na.rm = TRUE) +
  facet_grid(~REALM, scales = 'free') + 
  labs(x = 'Temperature change (°C)', y = 'Jaccard total')

p3 <- ggplot(trends[duration == 20, ], aes(tempchange, Horn)) +
  geom_point(size = 0.2, alpha = 0.2, na.rm = TRUE) + 
  geom_smooth(method = 'lm', formula = y ~ abs(x), na.rm = TRUE) +
  facet_grid(~REALM, scales = 'free') + 
  labs(x = 'Temperature change (°C)', y = 'Morisita-Horn')

grid.arrange(p1, p2, p3, ncol = 1)
```


# Focus on marine
## All temporal scales
```{r plot diss vs temp change marine, echo=FALSE, fig.height = 3, fig.width = 11}
p1 <- ggplot(trends[REALM == 'Marine',], aes(tempchange, Jtu)) +
  geom_point(aes(color = as.factor(STUDY_ID)), size = 0.2, alpha = 0.5, na.rm = TRUE) + 
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = "cs"), na.rm = TRUE) +
  geom_smooth(method = 'lm', formula = y ~ abs(x), na.rm = TRUE) +
  labs(x = 'Temperature change (°C)', y = 'Jaccard turnover') + 
  theme(legend.position = "none")

p2 <- ggplot(trends[REALM == 'Marine',], aes(tempchange, Jbeta)) +
  geom_point(aes(color = as.factor(STUDY_ID)), size = 0.2, alpha = 0.5, na.rm = TRUE) + 
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = "cs"), na.rm = TRUE) +
  geom_smooth(method = 'lm', formula = y ~ abs(x), na.rm = TRUE) +
  labs(x = 'Temperature change (°C)', y = 'Jaccard total') + 
  theme(legend.position = "none")

p3 <- ggplot(trends[REALM == 'Marine',], aes(tempchange, Horn)) +
  geom_point(aes(color = as.factor(STUDY_ID)), size = 0.2, alpha = 0.5, na.rm = TRUE) + 
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = "cs"), na.rm = TRUE) +
  geom_smooth(method = 'lm', formula = y ~ abs(x), na.rm = TRUE) +
  labs(x = 'Temperature change (°C)', y = 'Morisita-Horn') + 
  theme(legend.position = "none")



grid.arrange(p1, p2, p3, ncol = 3)
```

## Only 1 year differences
```{r plot diss vs temp change 1 yr marine, echo=FALSE, fig.height = 3, fig.width = 11}
p1 <- ggplot(trends[duration == 1 & REALM == 'Marine', ], aes(tempchange, Jtu)) +
  geom_point(aes(color = as.factor(STUDY_ID)), size = 0.2, na.rm = TRUE) + 
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = "cs"), na.rm = TRUE) +
  geom_smooth(method = 'lm', formula = y ~ abs(x), na.rm = TRUE) +
  labs(x = 'Temperature change (°C)', y = 'Jaccard turnover') + 
  theme(legend.position = "none")

p2 <- ggplot(trends[duration == 1 & REALM == 'Marine', ], aes(tempchange, Jbeta)) +
  geom_point(aes(color = as.factor(STUDY_ID)), size = 0.2, alpha = 0.5, na.rm = TRUE) + 
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = "cs"), na.rm = TRUE) +
  geom_smooth(method = 'lm', formula = y ~ abs(x), na.rm = TRUE) +
  labs(x = 'Temperature change (°C)', y = 'Jaccard total') + 
  theme(legend.position = "none")

p3 <- ggplot(trends[duration == 1 & REALM == 'Marine', ], aes(tempchange, Horn)) +
  geom_point(aes(color = as.factor(STUDY_ID)), size = 0.2, alpha = 0.5, na.rm = TRUE) + 
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = "cs"), na.rm = TRUE) +
  geom_smooth(method = 'lm', formula = y ~ abs(x), na.rm = TRUE) +
  labs(x = 'Temperature change (°C)', y = 'Morisita-Horn') + 
  theme(legend.position = "none")

grid.arrange(p1, p2, p3, ncol = 3)
```

## Only 10 year differences
```{r plot diss vs temp change 10 yr marine, echo=FALSE, fig.height = 3, fig.width = 11}
p1 <- ggplot(trends[duration == 10 & REALM == 'Marine', ], aes(tempchange, Jtu)) +
  geom_point(aes(color = as.factor(STUDY_ID)), size = 0.2, na.rm = TRUE) + 
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = "cs"), na.rm = TRUE) +
  geom_smooth(method = 'lm', formula = y ~ abs(x), na.rm = TRUE) +
  labs(x = 'Temperature change (°C)', y = 'Jaccard turnover') + 
  theme(legend.position = "none")

p2 <- ggplot(trends[duration == 10 & REALM == 'Marine', ], aes(tempchange, Jbeta)) +
  geom_point(aes(color = as.factor(STUDY_ID)), size = 0.2, alpha = 0.5, na.rm = TRUE) + 
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = "cs"), na.rm = TRUE) +
  geom_smooth(method = 'lm', formula = y ~ abs(x), na.rm = TRUE) +
  labs(x = 'Temperature change (°C)', y = 'Jaccard total') + 
  theme(legend.position = "none")

p3 <- ggplot(trends[duration == 10 & REALM == 'Marine', ], aes(tempchange, Horn)) +
  geom_point(aes(color = as.factor(STUDY_ID)), size = 0.2, alpha = 0.5, na.rm = TRUE) + 
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = "cs"), na.rm = TRUE) +
  geom_smooth(method = 'lm', formula = y ~ abs(x), na.rm = TRUE) +
  labs(x = 'Temperature change (°C)', y = 'Morisita-Horn') + 
  theme(legend.position = "none")

grid.arrange(p1, p2, p3, ncol = 3)
```

# Temperature trend and time-series length
```{r ts length and temp trend}
ggplot(trends, aes(year2 - year1, tempchange, color = REALM, group = REALM)) +
  geom_point(alpha = 0.2) +
  geom_smooth()
```

# Summary plots and stats
## Average community dissimilarity
```{r rates of turnover rem0}
trends[abs(tempchange) >= 1, tempchangetext1 := 'Change >=1']
trends[abs(tempchange) <= 0.5, tempchangetext1 := 'Stable <=0.5']
trends[tempchange <= -1, tempchangetext2 := 'Cool <= -1']
trends[tempchange >= 1, tempchangetext2 := 'Warm >= 1']

# reshape to long format
measurenms <- c('Jbeta', 'Jtu', 'Jne', 'Horn')
idnms <- setdiff(names(trends), measurenms)
trends2 <- melt(trends, id.vars = idnms, measure.vars = measurenms)

# changing vs. stable
trendsum1 <- trends2[!is.na(tempchangetext1), 
                    .(ave = mean(value, na.rm=TRUE), 
                      se = sd(value, na.rm=TRUE)/sqrt(sum(!is.na(value))),
                      n = sum(!is.na(value))),
                    by = .(text = tempchangetext1, type = variable, REALM = REALM)] # turnover per year for locations changing temperature
trendsum1[, duration := NA_integer_]


# warming vs. cooling
trendsum2 <- trends2[!is.na(tempchangetext2), 
                    .(ave = mean(value, na.rm=TRUE), 
                      se = sd(value, na.rm=TRUE)/sqrt(sum(!is.na(value))),
                      n = sum(!is.na(value))),
                    by = .(text = tempchangetext2, type = variable, REALM = REALM)] # inc. direction
trendsum2[, duration := NA_integer_]

# 1, 10, or 20 year intervals
trendsum3 <- trends2[!is.na(tempchangetext1) & duration %in% c(1, 10, 20), 
                    .(ave = mean(value, na.rm=TRUE), 
                      se = sd(value, na.rm=TRUE)/sqrt(sum(!is.na(value))),
                      n = sum(!is.na(value))),
                    by = .(text = tempchangetext1, type = variable, duration, REALM = REALM)] # inc. time interval
setorder(trendsum3, type, duration, text)

# combine
trendsum4 <- rbind(trendsum1, trendsum2, trendsum3)
setorder(trendsum4, type, text, duration)

write.csv(trendsum4, file = 'output/trendsummary.csv', row.names = FALSE)

trendsum4
```

## Plots of turnover rates binned by warming rates
```{r turnover vs. temperature violin plot, message = FALSE, warning = FALSE, echo=FALSE}
ggplot(trends[!is.na(tempchangetext1), ], aes(tempchangetext1, Jbeta)) +
  geom_violin(draw_quantiles = c(0.25, 0.5, 0.75), fill = 'grey') +
  labs(x = '', y = 'Jaccard dissimilarity', tag = 'A', title = 'Temperature change') +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(), axis.line = element_line(colour = "black"),
        legend.key=element_blank(),
        axis.text=element_text(size=8),
        axis.title=element_text(size=10)) +
  geom_abline(intercept = 0, slope = 0) +
  facet_grid(~REALM)

ggplot(trends[!is.na(tempchangetext1), ], aes(tempchangetext1, Jtu)) +
  geom_violin(draw_quantiles = c(0.25, 0.5, 0.75), fill = 'grey') +
  labs(x = '', y = 'Jaccard turnover', tag = 'A', title = 'Temperature change') +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(), axis.line = element_line(colour = "black"),
        legend.key=element_blank(),
        axis.text=element_text(size=8),
        axis.title=element_text(size=10)) +
  geom_abline(intercept = 0, slope = 0) +
  facet_grid(~REALM)

ggplot(trends[!is.na(tempchangetext1), ], aes(tempchangetext1, Horn)) +
  geom_violin(draw_quantiles = c(0.25, 0.5, 0.75), fill = 'grey') +
  labs(x = '', y = 'Horn dissimilarity', tag = 'A', title = 'Temperature change') +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(), axis.line = element_line(colour = "black"),
        legend.key=element_blank(),
        axis.text=element_text(size=8),
        axis.title=element_text(size=10)) +
  geom_abline(intercept = 0, slope = 0) +
  facet_grid(~REALM)


```

# Plot dissimilarity binned by tempchange vs duration
## Jaccard turnover dissimilarity
Very slow to render (10 min?)
```{r diss vs. temperature trend vs. duration, message = FALSE, warning = FALSE, fig.width=10, fig.height = 3}
ggplot(trends[abs(tempchange) <= 0.05, ], aes(x=duration, y=Jtu)) +
  geom_smooth(aes(color = '<=0.05')) +
  geom_smooth(data = trends[abs(tempchange) <= 0.1 & abs(tempchange) > 0.05,], aes(color = '0.05-0.1')) +
  geom_smooth(data = trends[abs(tempchange) <= 0.5 & abs(tempchange) > 0.1,], aes(color = '0.1-0.5')) +
  geom_smooth(data = trends[abs(tempchange) >= 0.5,], method = 'lm', aes(color = '>=0.5')) +
  scale_x_log10() + 
  labs(y = 'Jaccard dissimilarity', color = '°C change')
```

## By realm
```{r diss vs. temperature trend vs. duration by realm, message = FALSE, warning = FALSE, fig.width=10, fig.height = 3}
terr <- trends[REALM == 'Terrestrial', ]
p1 <- ggplot(terr[abs(tempchange) <= 0.05, ], aes(x=duration, y=Jtu)) +
  geom_smooth(aes(color = '<=0.05')) +
  geom_smooth(data = terr[abs(tempchange) <= 0.1 & abs(tempchange) > 0.05,], aes(color = '0.05-0.1')) +
  geom_smooth(data = terr[abs(tempchange) <= 0.5 & abs(tempchange) > 0.1,], aes(color = '0.1-0.5')) +
  geom_smooth(data = terr[abs(tempchange) >= 0.5,], method = 'lm', aes(color = '>=0.5')) +
  scale_x_log10() + 
  labs(y = 'Jaccard dissimilarity', color = '°C change', title = 'Terrestrial')

mar <- trends[REALM == 'Marine', ]
p2 <- ggplot(mar[abs(tempchange) <= 0.05, ], aes(x=duration, y=Jtu)) +
  geom_smooth(aes(color = '<=0.05')) +
  geom_smooth(data = mar[abs(tempchange) <= 0.1 & abs(tempchange) > 0.05,], aes(color = '0.05-0.1')) +
  geom_smooth(data = mar[abs(tempchange) <= 0.5 & abs(tempchange) > 0.1,], aes(color = '0.1-0.5')) +
  geom_smooth(data = mar[abs(tempchange) >= 0.5,], method = 'lm', aes(color = '>=0.5')) +
  scale_x_log10() + 
  labs(y = 'Jaccard dissimilarity', color = '°C change', title = 'Marine')

fre <- trends[REALM == 'Freshwater', ]
p3 <- ggplot(fre[abs(tempchange) <= 0.05, ], aes(x=duration, y=Jtu)) +
  geom_smooth(aes(color = '<=0.05')) +
  geom_smooth(data = fre[abs(tempchange) <= 0.1 & abs(tempchange) > 0.05,], aes(color = '0.05-0.1')) +
  geom_smooth(data = fre[abs(tempchange) <= 0.5 & abs(tempchange) > 0.1,], aes(color = '0.1-0.5')) +
  geom_smooth(data = fre[abs(tempchange) >= 0.5,], method = 'lm', aes(color = '>=0.5')) +
  scale_x_log10() + 
  labs(y = 'Jaccard dissimilarity', color = '°C change', title = 'Freshwater')

grid.arrange(p1, p2, p3, ncol = 3)

```

## By body size
```{r diss vs. temperature trend vs. duration by body size, message = FALSE, warning = FALSE, fig.width=10, fig.height = 3}
small <- trends[mass_mean_weight < 1, ]
p1 <- ggplot(small[abs(tempchange) <= 0.05, ], aes(x=duration, y=Jtu)) +
  geom_smooth(aes(color = '<=0.05')) +
  geom_smooth(data = small[abs(tempchange) <= 0.1 & abs(tempchange) > 0.05,], aes(color = '0.05-0.1')) +
  geom_smooth(data = small[abs(tempchange) <= 0.5 & abs(tempchange) > 0.1,], aes(color = '0.1-0.5')) +
  geom_smooth(data = small[abs(tempchange) >= 0.5,], method = 'lm', aes(color = '>=0.5')) +
  scale_x_log10() + 
  labs(y = 'Jaccard dissimilarity', color = '°C change', title = '<1 g')

med <- trends[mass_mean_weight < 10000 & mass_mean_weight >= 1, ]
p2 <- ggplot(med[abs(tempchange) <= 0.05, ], aes(x=duration, y=Jtu)) +
  geom_smooth(aes(color = '<=0.05')) +
  geom_smooth(data = med[abs(tempchange) <= 0.1 & abs(tempchange) > 0.05,], aes(color = '0.05-0.1')) +
  geom_smooth(data = med[abs(tempchange) <= 0.5 & abs(tempchange) > 0.1,], aes(color = '0.1-0.5')) +
  geom_smooth(data = med[abs(tempchange) >= 0.5,], method = 'lm', aes(color = '>=0.5')) +
  scale_x_log10() + 
  labs(y = 'Jaccard dissimilarity', color = '°C change', title = '1g to 10kg')

lg <- trends[mass_mean_weight >= 10000, ]
p3 <- ggplot(lg[abs(tempchange) <= 0.05, ], aes(x=duration, y=Jtu)) +
  geom_smooth(aes(color = '<=0.05')) +
  geom_smooth(data = lg[abs(tempchange) <= 0.1 & abs(tempchange) > 0.05,], aes(color = '0.05-0.1')) +
  geom_smooth(data = lg[abs(tempchange) <= 0.5 & abs(tempchange) > 0.1,], aes(color = '0.1-0.5')) +
  geom_smooth(data = lg[abs(tempchange) >= 0.5,], method = 'lm', aes(color = '>=0.5')) +
  scale_x_log10() + 
  labs(y = 'Jaccard dissimilarity', color = '°C change', title = '>10kg')

grid.arrange(p1, p2, p3, ncol = 3)

```


## By endo/ectotherm
```{r diss vs. temperature trend vs. duration by endofrac, message = FALSE, warning = FALSE, fig.width=7, fig.height = 3}
ecto <- trends[endofrac <= 0.5, ]
p1 <- ggplot(ecto[abs(tempchange) <= 0.05, ], aes(x=duration, y=Jtu)) +
  geom_smooth(aes(color = '<=0.05')) +
  geom_smooth(data = ecto[abs(tempchange) <= 0.1 & abs(tempchange) > 0.05,], aes(color = '0.05-0.1')) +
  geom_smooth(data = ecto[abs(tempchange) <= 0.5 & abs(tempchange) > 0.1,], aes(color = '0.1-0.5')) +
  geom_smooth(data = ecto[abs(tempchange) >= 0.5,], method = 'lm', aes(color = '>=0.5')) +
  scale_x_log10() + 
  labs(y = 'Jaccard dissimilarity', color = '°C change', title = 'Mostly ectotherms')

endo <- trends[endofrac > 0.5, ]
p2 <- ggplot(endo[abs(tempchange) <= 0.05, ], aes(x=duration, y=Jtu)) +
  geom_smooth(aes(color = '<=0.05')) +
  geom_smooth(data = endo[abs(tempchange) <= 0.1 & abs(tempchange) > 0.05,], aes(color = '0.05-0.1')) +
  geom_smooth(data = endo[abs(tempchange) <= 0.5 & abs(tempchange) > 0.1,], aes(color = '0.1-0.5')) +
  geom_smooth(data = endo[abs(tempchange) >= 0.5,], method = 'lm', aes(color = '>=0.5')) +
  scale_x_log10() + 
  labs(y = 'Jaccard dissimilarity', color = '°C change', title = 'Mostly endotherms')

grid.arrange(p1, p2, ncol = 2)

```

# Plot dissimilarity binned by duration vs tempchange
## Jaccard turnover dissimilarity
```{r diss vs. tempchange by duration, message = FALSE, warning = FALSE, fig.width=10, fig.height = 3}
ggplot(trends[duration == 1, ], aes(x=abs(tempchange), y=Jtu)) +
  geom_smooth(aes(color = '1')) +
  geom_smooth(data = trends[duration ==5,], aes(color = '5')) +
  geom_smooth(data = trends[duration==10,], aes(color = '10')) +
  geom_smooth(data = trends[duration==15,], aes(color = '15')) +
  geom_smooth(data = trends[duration>15,], aes(color = '>15')) +
  labs(y = 'Jaccard dissimilarity', color = 'Duration')
```

## By realm
```{r diss vs. tempchange by duration by realm, message = FALSE, warning = FALSE, fig.width=10, fig.height = 3}
terr <- trends[REALM == 'Terrestrial', ]
p1 <- ggplot(terr[duration==1, ], aes(x=abs(tempchange), y=Jtu)) +
  geom_smooth(aes(color = '1')) +
  geom_smooth(data = terr[duration==5,], aes(color = '5')) +
  geom_smooth(data = terr[duration==10,], aes(color = '10')) +
  geom_smooth(data = terr[duration==15,], aes(color = '15')) +
  geom_smooth(data = terr[duration>15,], aes(color = '>15')) +
  labs(y = 'Jaccard dissimilarity', color = 'Duration', title = 'Terrestrial')

mar <- trends[REALM == 'Marine', ]
p2 <- ggplot(mar[duration==1, ], aes(x=abs(tempchange), y=Jtu)) +
  geom_smooth(aes(color = '1')) +
  geom_smooth(data = mar[duration==5,], aes(color = '5')) +
  geom_smooth(data = mar[duration==10,], aes(color = '10')) +
  geom_smooth(data = mar[duration==15,], aes(color = '15')) +
  geom_smooth(data = mar[duration>15,], aes(color = '>15')) +
  labs(y = 'Jaccard dissimilarity', color = 'Duration', title = 'Marine')

fre <- trends[REALM == 'Freshwater', ]
p3 <- ggplot(fre[duration==1, ], aes(x=abs(tempchange), y=Jtu)) +
  geom_smooth(aes(color = '1')) +
  geom_smooth(data = fre[duration==5,], aes(color = '5')) +
  geom_smooth(data = fre[duration==10,], aes(color = '10')) +
  geom_smooth(data = fre[duration==15,], aes(color = '15')) +
  geom_smooth(data = fre[duration>15,], aes(color = '>15')) +
  labs(y = 'Jaccard dissimilarity', color = 'Duration', title = 'Freshwater')

grid.arrange(p1, p2, p3, ncol = 3)

```

## By body size
```{r diss vs. temperature trend by duration by body size, message = FALSE, warning = FALSE, fig.width=10, fig.height = 3}
small <- trends[mass_mean_weight < 1, ]
p1 <- ggplot(small[duration==1, ], aes(x=abs(tempchange), y=Jtu)) +
  geom_smooth(aes(color = '1')) +
  geom_smooth(data = small[duration==5,], aes(color = '5')) +
  geom_smooth(data = small[duration==10,], aes(color = '10')) +
  geom_smooth(data = small[duration==15,], aes(color = '15')) +
  geom_smooth(data = small[duration>15,], aes(color = '>15')) +
  labs(y = 'Jaccard dissimilarity', color = 'Duration', title = '<1 g')

med <- trends[mass_mean_weight < 10000 & mass_mean_weight >= 1, ]
p2 <- ggplot(med[duration==1, ], aes(x=abs(tempchange), y=Jtu)) +
  geom_smooth(aes(color = '1')) +
  geom_smooth(data = med[duration==5,], aes(color = '5')) +
  geom_smooth(data = med[duration==10,], aes(color = '10')) +
  geom_smooth(data = med[duration==15,], aes(color = '15')) +
  geom_smooth(data = med[duration>15,], aes(color = '>15')) +
  labs(y = 'Jaccard dissimilarity', color = 'Duration', title = '1g to 10kg')

lg <- trends[mass_mean_weight >= 10000, ]
p3 <- ggplot(lg[duration==1, ], aes(x=abs(tempchange), y=Jtu)) +
  geom_smooth(aes(color = '1')) +
  geom_smooth(data = lg[duration==5,], aes(color = '5')) +
  geom_smooth(data = lg[duration==10,], aes(color = '10')) +
  geom_smooth(data = lg[duration==15,], aes(color = '15')) +
  labs(y = 'Jaccard dissimilarity', color = 'Duration', title = '>10kg')

grid.arrange(p1, p2, p3, ncol = 3)

```


## By endo/ectotherm
```{r diss vs. temperature trend by duration by endofrac, message = FALSE, warning = FALSE, fig.width=7, fig.height = 3}
ecto <- trends[endofrac <= 0.5, ]
p1 <- ggplot(ecto[duration==1, ], aes(x=abs(tempchange), y=Jtu)) +
  geom_smooth(aes(color = '1')) +
  geom_smooth(data = ecto[duration==5,], aes(color = '5')) +
  geom_smooth(data = ecto[duration==10,], aes(color = '10')) +
  geom_smooth(data = ecto[duration==15,], aes(color = '15')) +
  geom_smooth(data = ecto[duration>15,], aes(color = '>15')) +
  labs(y = 'Jaccard dissimilarity', color = 'Duration', title = 'Mostly ectotherms')

endo <- trends[endofrac > 0.5, ]
p2 <- ggplot(endo[duration==1, ], aes(x=abs(tempchange), y=Jtu)) +
  geom_smooth(aes(color = '1')) +
  geom_smooth(data = endo[duration==5,], aes(color = '5')) +
  geom_smooth(data = endo[duration==10,], aes(color = '10')) +
  geom_smooth(data = endo[duration==15,], aes(color = '15')) +
  geom_smooth(data = ecto[duration>15,], aes(color = '>15')) +
  labs(y = 'Jaccard dissimilarity', color = 'Duration', title = 'Mostly endotherms')

grid.arrange(p1, p2, ncol = 2)

```
## By realm and body size
```{r diss vs. tempchange by duration mass, message = FALSE, warning = FALSE, fig.width=7, fig.height = 7}
trends[duration == 1, dur_bin := '[1] yr']
trends[duration > 1 & duration <= 5, dur_bin := '(1-5] yr']
trends[duration > 5 & duration <= 10, dur_bin := '(5-10] yr']
trends[duration > 10 & duration <= 20, dur_bin := '(10-20] yr']
trends[duration > 20, dur_bin := '>20 yr']
trends[mass_mean_weight <= 1, mass_bin := '<=1 g']
trends[mass_mean_weight > 1 & mass_mean_weight <= 10000, mass_bin := '(1 g-10 kg]']
trends[mass_mean_weight > 10000, mass_bin := '>10 kg']
ggplot(trends[!is.na(mass_bin), ], aes(x=abs(tempchange), y=Jtu, color = dur_bin, group = dur_bin)) +
  geom_smooth() +
  facet_grid(mass_bin~REALM, scales = 'free') +
  labs(y = 'Jaccard dissimilarity', title = '')
```

## By realm, body size AND endo/ecto
```{r diss vs. tempchange by duration mass endofrac, message = FALSE, warning = FALSE, fig.width=7, fig.height = 7}
trends[duration == 1, dur_bin := '[1] yr']
trends[duration > 1 & duration <= 5, dur_bin := '(1-5] yr']
trends[duration > 5 & duration <= 10, dur_bin := '(5-10] yr']
trends[duration > 10 & duration <= 20, dur_bin := '(10-20] yr']
trends[duration > 20, dur_bin := '>20 yr']
trends[mass_mean_weight <= 1, mass_bin := '<=1 g']
trends[mass_mean_weight > 1 & mass_mean_weight <= 10000, mass_bin := '(1 g-10 kg]']
trends[mass_mean_weight > 10000, mass_bin := '>10 kg']
trends[endofrac > 0.5, endoTF := 'endo']
trends[endofrac <= 0.5, endoTF := 'ecto']
ggplot(trends[!is.na(mass_bin), ], aes(x=abs(tempchange), y=Jtu, color = dur_bin, group = dur_bin)) +
  geom_smooth() +
  facet_grid(mass_bin + endoTF~REALM, scales = 'free') +
  labs(y = 'Jaccard dissimilarity', title = '')
```


