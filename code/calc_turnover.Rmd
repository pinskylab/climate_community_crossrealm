---
title: "Calculate biodiversity urnover"
output: github_document: default
---

```{r setup, include=FALSE}
library(data.table)
library(ggplot2)


knitr::opts_chunk$set(echo = TRUE, warning = FALSE)

knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file()) # tell RStudio to use project root directory as the root for this notebook. Needed since we are storing code in a separate directory.

```

# Load data
```{r load data}
# BioTime
load('data/biotime_blowes/bt_malin.Rdata') # loads bt_malin
bt <- data.table(bt_malin); rm(bt_malin) # rename

# BioTime data type
load('data/biotime_blowes/time_series_data_type.Rdata') # loads rarefyID_type
bt <- merge(bt, rarefyID_type, by = 'rarefyID', all.x = TRUE) # merge with biotime

# BioTime temporal turnover null model
load('data/biotime_blowes/z_scores_SAD.Rdata') # loads sim_summary

# richness
rich <- fread('output/richness_by_rarefyID.csv.gz') # number of species
```

Remove studies with only 1 species and trim to count data
```{r remove 1-spp studies}
length(unique(bt$rarefyID))
bt <- bt[rarefyID %in% rich[Nspp > 1, rarefyID] & BROAD_TYPE == 'count', ]
length(unique(bt$rarefyID))
```

# Plot turnover example
Michaelis-Menton or Exponential fits (2- or 3-parameter).
```{r plot turnover}
test <- bt[rarefyID == '339_1085477',]
test[, YEAR0 := YEAR - min(YEAR)]

# fit a 2- or 3-parameter Michaelis-Menton curve (latter includes an intercept)
modmm2 <- nls(Jtu_base ~ Vm * YEAR0/(K + YEAR0), data = test[YEAR0 != 0, ], 
              start = list(K = mean(test$YEAR0), Vm = 1),
              algorithm = 'port', # to allow bounds to be set
              lower = c(0, 0),
              upper = c(max(test$YEAR0), 1))
modmm3 <- nls(Jtu_base ~ c + Vm * YEAR0/(K + YEAR0), 
              data = test[YEAR0 != 0, ], 
              start = list(c = 0, K = mean(test$YEAR0), Vm = 1),
              algorithm = 'port',
              lower = c(0, 0, 0),
              upper = c(1, max(test$YEAR0), 1))

# fit a 2- or 3-parameter exponential decay
modexp2 <- nls(Jtu_base ~ Vm - exp(a * YEAR0)*Vm, data = test[YEAR0 != 0, ], 
              start = list(a = -0.5, Vm = 1),
              algorithm = 'port',
              lower = c(-Inf, 0),
              upper = c(0, 1))
modexp3 <- nls(Jtu_base ~ Vm - exp(a * (YEAR0 + o))*Vm, data = test[YEAR0 != 0, ], 
              start = list(a = -0.5, Vm = 1, o = 0),
              algorithm = 'port',
              lower = c(-Inf, 0, -Inf),
              upper = c(Inf, 1, Inf))

# make predictions
mml <- data.frame(YEAR0 = seq(0, diff(range(test$YEAR)), length.out = 100))
mml$YEAR <- mml$YEAR0 + min(test$YEAR)
mml$Jtu_base.mm2 <- predict(modmm2, newdata = mml)
mml$Jtu_base.mm3 <- predict(modmm3, newdata = mml)
mml$Jtu_base.exp2 <- predict(modexp2, newdata = mml)
mml$Jtu_base.exp3 <- predict(modexp3, newdata = mml)

# calc half-saturations
cmm2 <- coef(modmm2)
cmm3 <- coef(modmm3)
cexp2 <- coef(modexp2)
cexp3 <- coef(modexp3)

hsmm2 <- cmm2[['K']] + min(test$YEAR)
hsmm3 <- with(as.data.frame(t(cmm3)), K*(Vm-c)/(Vm+c)) + min(test$YEAR)
hsexp2 <- with(as.data.frame(t(cexp2)), log(1/2)/a) + min(test$YEAR)
hsexp3 <- with(as.data.frame(t(cexp3)), log(exp(a*o)/2)/a - o) + min(test$YEAR)

# get colors to match ggplot
hues = seq(15, 375, length = 5 + 1)
cols <- hcl(h = hues, l = 65, c = 100)[1:5]

# make plot
ggplot(test, aes(YEAR, Jtu_base, color = 'Linear')) +
    geom_point() +
    geom_smooth(data = test[YEAR != min(YEAR), ], 
                method = 'lm') + # a straight line fit
    geom_line(data = mml, aes(YEAR, Jtu_base.mm2, color = 'Michaelis-Menton 2-param')) + # MM
    geom_line(data = mml, aes(YEAR, Jtu_base.mm3, color = 'Michaelis-Menton 3-param'), linetype = 'dashed', size = 1) +
    geom_line(data = mml, aes(YEAR, Jtu_base.exp2, color = 'Exponential 2-param')) +
    geom_line(data = mml, aes(YEAR, Jtu_base.exp3, color = 'Exponential 3-param'), linetype = 'dashed', size = 1) +
    geom_vline(xintercept = c(hsmm2, hsmm3, hsexp2, hsexp3), color = cols[c(4,5,1,2)], size = c(0.5, 1, 0.5, 1), 
               linetype = c('solid', 'dashed', 'solid', 'dashed')) +
    labs(x = 'Year', y = 'Jaccard dissimilarity', color = 'Functional form')

```

Vertical lines are the half-saturations.

# Calculate temporal trends (temporal turnover)
```{r assemble trends, warning=FALSE, message=FALSE}
# function to calc linear trend, removing first year with 0
calctrendrem0 <- function(y, YEAR, nm = 'y'){
  if(length(YEAR)>2){
     # remove year 1 comparison
    o <- order(YEAR)
    YEAR2 <- YEAR[o][2:length(YEAR)]
    y2 <- y[o][2:length(y)]
    
    if(sum(!is.na(y2)) >= 2){ # make sure enough values to fit a line
      mod <- lm(y2 ~ YEAR2) # fit line
      out <- list(y = coef(mod)[2], # coef for the slope
                  y_se = sqrt(diag(vcov(mod)))[2]) # SE
      names(out) <- c(nm, paste0(nm, '_se'))
      return(out)
      
    } else {
      out <- list(y = NA_real_, y_se = NA_real_)
      names(out) <- c(nm, paste0(nm, '_se'))
      return(out)
    }
    
  } else {
    out <- list(y = NA_real_, y_se = NA_real_)
    names(out) <- c(nm, paste0(nm, '_se'))
    return(out)
  }
  

}

# function to get distance from last to first year
calcfirstlast <- function(y, YEAR, nm = 'y'){
  if(length(YEAR)>1){
    o <- order(YEAR)
    YEAR2 <- YEAR[o][2:length(YEAR)]
    y2 <- y[o][2:length(y)]
    
    out <- list(y = y2[length(y2)], # dissimilarity for last year
                y_se = NA_real_)
  } else {
    out <- list(y = NA_real_, y_se = NA_real_)
  }

  names(out) <- c(nm, paste0(nm, '_se'))
  return(out)
}

# calc half-saturation constant from exponential fit
# 3-param if 3 or more years, 2 param if only 2 years
calcexp <- function(y, YEAR, nm = 'y'){
    if(length(YEAR)>2){
        o <- order(YEAR)
        YEAR2 <- YEAR[o][2:length(YEAR)] - YEAR[1]
        y2 <- y[o][2:length(y)]
        
        if(sum(!is.na(y2)) >= 2){ # make sure enough values to fit
            
            out <- tryCatch({
                #print('in trycatch')
                if(sum(!is.na(y2)) == 2){ 
                    #print('fit 2-parameter')
                    
                    modexp2 <- nls(y2 ~ Vm - exp(a * YEAR2)*Vm, 
                                   start = list(a = -0.5, Vm = 1),
                                   algorithm = 'port',
                                   lower = c(-Inf, 0),
                                   upper = c(0, 1))
                    
                    # calc half-saturations
                    cexp2 <- coef(modexp2)
                    hsexp <- with(as.data.frame(t(cexp2)), log(1/2)/a)
                }
                if(sum(!is.na(y2)) > 2){ 
                    #print('fit 3-parameter')
                    modexp3 <- nls(y2 ~ Vm - exp(a * (YEAR2 + o))*Vm, 
                                   start = list(a = -0.5, Vm = 1, o = 0),
                                   algorithm = 'port',
                                   lower = c(-Inf, 0, 0),
                                   upper = c(0, 1, Inf))
                    cexp3 <- coef(modexp3)
                    # calc half-saturations
                    hsexp <- with(as.data.frame(t(cexp3)), log(exp(a*o)/2)/a - o)
                }

                out <- list(y = hsexp) # half-saturation
                names(out) <- nm
                out
            
            }, warning = function(w) {
                #print('warning')
                out <- list(y = NA_real_)
                names(out) <- nm
                return(out)
            }, error = function(e) {
                #print('error')
                out <- list(y = NA_real_)
                names(out) <- nm
                return(out)
            })
            return(out)
            
        } else {
            out <- list(y = NA_real_)
            names(out) <- nm
            return(out)
        }
        
    } else {
        out <- list(y = NA_real_)
        names(out) <- nm
        return(out)
    }
}

# do calculations
setkey(bt, STUDY_ID, rarefyID, YEAR)

if(file.exists('temp/trendstemp.rds')){
    print('File already exists. Will not do calculations')
} else {
    print('Calculating from scratch')
    
    trends1 <- bt[, calctrendrem0(Jtu_base, YEAR, 'Jtutrendrem0'), 
                  by = .(REALM, Biome, taxa_mod, STUDY_ID, 
                         rarefyID, rarefyID_x, rarefyID_y)] # calculate trend in Jaccard turnover without first year
    trends2 <- bt[, calctrendrem0(Jbeta_base, YEAR, 'Jbetatrendrem0'),
                  by = .(rarefyID)]
    trends3 <- bt[, calctrendrem0(1-Horn_base, YEAR, 'Horntrendrem0'),
                  by = .(rarefyID)]
    
    trends4 <- bt[, calcfirstlast(Jtu_base, YEAR, 'Jtulast'),
                  by = .(rarefyID)]
    trends5 <- bt[, calcfirstlast(Jbeta_base, YEAR, 'Jbetalast'),
                  by = .(rarefyID)]
    trends6 <- bt[, calcfirstlast(1-Horn_base, YEAR, 'Hornlast'),
                   by = .(rarefyID)]
    
    trends7 <- bt[, calcexp(Jtu_base, YEAR, 'Jtuexp'),
                  by = .(rarefyID)]
    trends8 <- bt[, calcexp(Jbeta_base, YEAR, 'Jbetaexp'),
                  by = .(rarefyID)]
    trends9 <- bt[, calcexp(1-Horn_base, YEAR, 'Hornexp'),
                   by = .(rarefyID)]
    
    nyrBT <-  bt[, .(nyrBT = length(YEAR),
                     minyrBT = min(YEAR),
                     maxyrBT = max(YEAR),
                     medianyrBT = median(YEAR),
                     meanyrBT = mean(YEAR)),
                 by = .(rarefyID)] # number of years in time-series
    
    trends <- merge(trends1, trends2)
    trends <- merge(trends, trends3)
    trends <- merge(trends, trends4)
    trends <- merge(trends, trends5)
    trends <- merge(trends, trends6)
    trends <- merge(trends, trends7)
    trends <- merge(trends, trends8)
    trends <- merge(trends, trends9)
    trends <- merge(trends, nyrBT)
    
    saveRDS(trends, file = 'temp/trendstemp.rds')
    
}

nrow(trends)
```




## Output a file with plots of every Jtu timeseries (a lot!)
Not run during knitting
```{r plot of all ts, eval=FALSE}
rids <- trends[Nspp > 1 & nyrBT > 2, sort(unique(rarefyID))]
setkey(bt, rarefyID, YEAR)
print(paste(length(rids), ' rarefyIDs'))
filenum <- 1
plotnum <- 1
for(i in 1:length(rids)){
  jtutrendrem0 <- trends[rarefyID == rids[i], Jtutrendrem0]
  nspp <- trends[rarefyID == rids[i], Nspp]
  x <- bt[rarefyID == rids[i], YEAR]
  y <- bt[rarefyID == rids[i], Jtu_base]
  
  if(length(x) > 2 & nspp > 1){
    if(plotnum %% 400 == 1){
      if(plotnum >1) dev.off()
      png(file = paste0('figures/jtu_plots/jtu_plots', formatC(filenum, width = 3, format = 'd', flag = '0'), '.png'), width = 36, height = 36, units = 'in', res = 100)
      par(mfrow=c(20,20), mai = c(0.4, 0.5, 0.5, 0.1))
      filenum <- filenum + 1
    }
    plot(x, y, main = paste('Jtu rem0:', signif(jtutrendrem0, 3), '\nNspp:', nspp, '\nrID:', rids[i]), xlab = '', ylab = 'Jtu',
         cex.main = 0.7)
    abline(lm(y ~ x))
    
    x2 <- x[2:length(x)]
    y2 <- y[2:length(y)]
    abline(lm(y2 ~ x2), col = 'red')
    
    plotnum <- plotnum + 1
  }
}
  
dev.off()
```


### Standardize slope values against null model simulations
```{r plot sds}
# remove some duplicates
sim_summary <- as.data.table(sim_summary)
sim_summary <- sim_summary[!duplicated(sim_summary), ]

# hist
hist(sim_summary[metric == 'Jaccard (total)', sd], breaks = 200, col = 'grey')
hist(sim_summary[metric == 'Nestedness', sd], breaks = 200, col = 'grey')
hist(sim_summary[metric == 'Morisita-Horn', sd], breaks = 200, col = 'grey')

# plot
sim_summary[metric == 'Jaccard (total)', plot(expected, log10(sd+1))]
abline(h = 0, col = 'red')

sim_summary[metric == 'Nestedness', plot(expected, log10(sd+1))]
abline(h = 0, col = 'red')

sim_summary[metric == 'Morisita-Horn', plot(expected, log10(sd+1))]
abline(h = 0, col = 'red')

# vs #yrs
sim_summary[metric == 'Jaccard (total)', plot(Nyrs, sd+0.001, log = 'y', main = 'Null SD declines with #yrs')]
abline(h = 0.001, col = 'red')
abline(h = 0.001+0.001, col = 'green')
abline(h = 0.01+0.001, col = 'grey')


# vs #spp
sim_summary[metric == 'Jaccard (total)', plot(Nspp, sd+0.001, log = 'y')]
abline(h = 0.001, col = 'red')
abline(h = 0.001+0.001, col = 'green')
abline(h = 0.01+0.001, col = 'grey')
```

Merge null model
```{r merge nul model}
# merge
trends <- merge(trends, sim_summary[metric == 'Jaccard (total)', .(Jbeta_exp = expected, Jbeta_sd = sd, rarefyID)], by = 'rarefyID', all.x = TRUE)
trends <- merge(trends, sim_summary[metric == 'Nestedness', .(Jtu_exp = expected, Jtu_sd = sd, rarefyID)], by = 'rarefyID', all.x = TRUE)
trends <- merge(trends, sim_summary[metric == 'Morisita-Horn', .(Horn_exp = expected, Horn_sd = sd, rarefyID)], by = 'rarefyID', all.x = TRUE)
```

Set a threshold and only standardize those timeseries with SD > 0.001
```{r standardize}
# standardize, only where sd >0
trends[, Jtutrendz := NA_real_]
trends[, Jbetatrendz := NA_real_]
trends[, Horntrendz := NA_real_]

trends[Jtu_sd > 0.001, Jtutrendz := (Jtutrendrem0 - Jtu_exp)/Jtu_sd]
trends[Jbeta_sd > 0.001, Jbetatrendz := (Jbetatrendrem0 - Jbeta_exp)/Jbeta_sd]
trends[Horn_sd > 0.001, Horntrendz := (Horntrendrem0 - Horn_exp)/Horn_sd]

nrow(trends)
```


### Do some basic checks of the turnover calculations
```{r summary of change}
# basic checks
trends

summary(trends$Jtutrendrem0)
summary(trends$Jbetatrendrem0)
summary(trends$Horntrendrem0)

summary(trends$Jtutrendz)
summary(trends$Jbetatrendz)
summary(trends$Horntrendz)

summary(trends$Jtulast)
summary(trends$Jbetalast)
summary(trends$Hornlast)

```

#### Histograms of temporal change
Standardized slopes have very large and small values
```{r histograms of change, messages = FALSE}
x <- trends[, hist(Jtutrendrem0)]
x <- trends[, hist(Jbetatrendrem0)]
x <- trends[, hist(Horntrendrem0)]

x <- trends[, hist(Jtutrendz, breaks = 100)]
x <- trends[, hist(Jbetatrendz, breaks = 100)]
x <- trends[, hist(Horntrendz, breaks = 100)]

x <- trends[, hist(Jtulast)]
x <- trends[, hist(Jbetalast)]
x <- trends[, hist(Hornlast)]

```

#### Turnover calculations are correlated, though less so for Horn
```{r basic pairwise graphs of turnover metrics}
# are turnover calculations correlated?
ggplot(trends, aes(Jbetatrendrem0, Jtutrendrem0)) +
    geom_point(alpha = 0.3) +
    geom_smooth()

ggplot(trends, aes(Jbetatrendrem0, Horntrendrem0)) +
    geom_point(alpha = 0.3) +
    geom_smooth()

ggplot(trends, aes(Jbetatrendrem0, Jbetatrendz)) +
    geom_point(alpha = 0.3) +
    geom_smooth()

ggplot(trends, aes(Jtutrendrem0, Jtutrendz)) +
    geom_point(alpha = 0.3) +
    geom_smooth()

ggplot(trends, aes(Horntrendrem0, Horntrendz)) +
    geom_point(alpha = 0.3) +
    geom_smooth()

ggplot(trends, aes(Jbetatrendz, Jtutrendz)) +
    geom_point(alpha = 0.3) +
    geom_smooth()

ggplot(trends, aes(Jbetatrendz, Horntrendz)) +
    geom_point(alpha = 0.3) +
    geom_smooth()

ggplot(trends, aes(Jbetatrendrem0, Jbetalast)) +
    geom_point(alpha = 0.3) +
    geom_smooth()

ggplot(trends, aes(Jtutrendrem0, Jtulast)) +
    geom_point(alpha = 0.3) +
    geom_smooth()

ggplot(trends, aes(Horntrendrem0, Hornlast)) +
    geom_point(alpha = 0.3) +
    geom_smooth()

ggplot(trends, aes(Jbetalast, Jtulast)) +
    geom_point(alpha = 0.3) +
    geom_smooth()

ggplot(trends, aes(Jbetalast, Hornlast)) +
    geom_point(alpha = 0.3) +
    geom_smooth()

```
Standardization	has the effect of up-weighting some of the smaller trends, as expected
Strange that Jbetatrendz and Jtutrendz are not really correlated
\*last correlated to \*trendrem0. Also constrained to a parallelogram
Jtulast is lower diagonal of Jbetalast, which makes sense
Hornlast correlated but with lots of scatter to Jbetalast


#### Change compared to number of years in time-series
```{r change vs. num years}
# number of year
trends[, summary(nyrBT)]
x <- trends[, hist(nyrBT)]
par(mfrow=c(1,3))
trends[, plot(nyrBT, Jtutrendrem0, log = 'x', col = '#00000033')]; abline(h = 0)
trends[, plot(nyrBT, Jbetatrendrem0, log = 'x', col = '#00000033')]; abline(h = 0)
trends[, plot(nyrBT, Horntrendrem0, log = 'x', col = '#00000033')]; abline(h = 0)

trends[, plot(nyrBT, Jtutrendz, log = 'x', col = '#00000033')]; abline(h = 0)
trends[, plot(nyrBT, Jbetatrendz, log = 'x', col = '#00000033')]; abline(h = 0)
trends[, plot(nyrBT, Horntrendz, log = 'x', col = '#00000033')]; abline(h = 0)

trends[, plot(nyrBT, Jtulast, log = 'x', col = '#00000033')]; abline(h = 0)
trends[, plot(nyrBT, Jbetalast, log = 'x', col = '#00000033')]; abline(h = 0)
trends[, plot(nyrBT, Hornlast, log = 'x', col = '#00000033')]; abline(h = 0)
```

#### Change compared to number of species in time-series
```{r change vs. number of species}
# number of species
trends[, summary(Nspp)]
x <- trends[, hist(Nspp)]
par(mfrow=c(1,3))
trends[, plot(Nspp, Jtutrendrem0, log = 'x', col = '#00000033')]; abline(h=0)
trends[, plot(Nspp, Jbetatrendrem0, log = 'x', col = '#00000033')]; abline(h=0)
trends[, plot(Nspp, Horntrendrem0, log = 'x', col = '#00000033')]; abline(h=0)

trends[, plot(Nspp, Jtutrendz, log = 'x', col = '#00000033')]; abline(h=0)
trends[, plot(Nspp, Jbetatrendz, log = 'x', col = '#00000033')]; abline(h=0)
trends[, plot(Nspp, Horntrendz, log = 'x', col = '#00000033')]; abline(h=0)

trends[, plot(Nspp, Jtulast, log = 'x', col = '#00000033')]
trends[, plot(Nspp, Jbetalast, log = 'x', col = '#00000033')]
trends[, plot(Nspp, Hornlast, log = 'x', col = '#00000033')]
```


#### Average change compared to #years, #species in time-series
```{r ave change vs. num years}
# number of years
ggplot(trends, aes(nyrBT, Jtutrendrem0, color = 'Jtu trend')) +
  geom_smooth() +
  geom_smooth(aes(y = Jbetatrendrem0, color = 'Jbeta trend')) +
  geom_smooth(aes(y = Horntrendrem0, color = 'Horn trend')) +
  scale_x_log10() +
  labs(y = 'Slope') +
  geom_abline(intercept = 0, slope = 0)

ggplot(trends, aes(nyrBT, Jtutrendz, color = 'Jtu z')) +
  geom_smooth() +
  geom_smooth(aes(y = Jbetatrendz, color = 'Jbeta z')) +
  geom_smooth(aes(y = Horntrendz, color = 'Horn z')) +
  scale_x_log10() +
  labs(y = 'Dissimilarity') +
  geom_abline(intercept = 0, slope = 0)

ggplot(trends, aes(nyrBT, Jtulast, color = 'Jtu last')) +
  geom_smooth() +
  geom_smooth(aes(y = Jbetalast, color = 'Jbeta last')) +
  geom_smooth(aes(y = Hornlast, color = 'Horn last')) +
  scale_x_log10() +
  labs(y = 'Dissimilarity') +
  geom_abline(intercept = 0, slope = 0)

# number of species
ggplot(trends, aes(Nspp, Jtutrendrem0, color = 'Jtu trend')) +
  geom_smooth() +
  geom_smooth(aes(y = Jbetatrendrem0, color = 'Jbeta trend')) +
  geom_smooth(aes(y = Horntrendrem0, color = 'Horn trend')) +
  scale_x_log10() +
  labs(y = 'Slope') +
  geom_abline(intercept = 0, slope = 0)

ggplot(trends, aes(Nspp, Jtutrendz, color = 'Jtu z')) +
  geom_smooth() +
  geom_smooth(aes(y = Jbetatrendz, color = 'Jbeta z')) +
  geom_smooth(aes(y = Horntrendz, color = 'Horn z')) +
  scale_x_log10() +
  labs(y = 'Slope') +
  geom_abline(intercept = 0, slope = 0)

ggplot(trends, aes(Nspp, Jtulast, color = 'Jtu last')) +
  geom_smooth() +
  geom_smooth(aes(y = Jbetalast, color = 'Jbeta last')) +
  geom_smooth(aes(y = Hornlast, color = 'Horn last')) +
  scale_x_log10() +
  labs(y = 'Dissimilarity') +
  geom_abline(intercept = 0, slope = 0)
```


