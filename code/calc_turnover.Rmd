---
title: "Calculate biodiversity turnover as slope of dissimilarity vs. time"
output:
  github_document:
    toc: true
    toc_depth: 3
---
# Set up
```{r setup, include=FALSE}
if(Sys.info()['nodename'] == 'annotate.sebs.rutgers.edu'){
  library('mgcv', lib.loc = '/usr/lib64/R/library') # when running on Annotate. Need to load 1.8-26, not 1.8-33.
} else {
  library('mgcv')
}
library(data.table)
library(ggplot2)
library(gridExtra) # for grid.arrange
library(here)


knitr::opts_chunk$set(echo = TRUE, warning = FALSE)

knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file()) # tell RStudio to use project root directory as the root for this notebook. Needed since we are storing code in a separate directory.

```

# Load data
```{r load data}
# BioTime
# biotime community dissimilarity data
load(here::here('data', 'biotime_blowes', 'all_pairs_beta.Rdata')) # load rarefied_beta_medians, which has all pairwise dissimilarities
bt <- data.table(rarefied_beta_medians); rm(rarefied_beta_medians)
bt[, year1 := as.numeric(year1)] # not sure why it gets read in as character
bt[, year2 := as.numeric(year2)]
bt[, Horn := 1-Hornsim] # convert similarity to dissimilarity
bt[, Hornsim := NULL]

# BioTime data type
load(here('data', 'biotime_blowes', 'time_series_data_type.Rdata')) # loads rarefyID_type
bt <- merge(bt, rarefyID_type, by = 'rarefyID', all.x = TRUE) # merge with biotime

# biotime taxa category and other info
load(here::here('data', 'biotime_blowes', 'bt_malin.Rdata')) # load bt_malin
btinfo <- data.table(bt_malin); rm(bt_malin)
btinfo[, Nave := mean(N), by = rarefyID] # average number of individuals in the timeseries
btinfo2 <- btinfo[!duplicated(rarefyID), .(rarefyID, rarefyID_x, rarefyID_y, Nave, Biome, taxa_mod, REALM, STUDY_ID)]
bt <- merge(bt, btinfo2, by = 'rarefyID') # trims out rarefyIDs not in bt_malin

# richness
rich <- fread(here('output','richness_by_rarefyID.csv.gz')) # number of species
```


## Examine number of species and individuals per sample
```{r numspp per samp}
hist(log10(btinfo$N)); abline(v = log10(10), col = 'red') # line at 10 individuals
hist(log10(btinfo$S)); abline(v = log10(5), col = 'red') # line at 5 species

nrow(btinfo)
btinfo[S == 1, .N]

```

## Remove studies that don't meet quality thresholds
Keep studies with:
- >=5 species
- >=2 years
- >=10 individuals on average.
```{r QAQC}
length(unique(bt$rarefyID))
length(setdiff(bt$rarefyID, rich$rarefyID))


# number of years per study (in remaining samples)
nyrs <- bt[, .(nyrBT = length(unique(c(year1, year2)))), by = rarefyID]
length(setdiff(bt$rarefyID, nyrs$rarefyID))
invisible(nyrs[, hist(nyrBT, breaks=seq(0.5,100.5,by=1))])
nyrs[nyrBT < 2, .N]

# >=5 species, >=2 yrs, >=10 individuals
bt <- bt[rarefyID %in% rich[Nspp >= 5, rarefyID], ]
length(unique(bt$rarefyID))

bt <- bt[rarefyID %in% nyrs[nyrBT >= 2, rarefyID], ]
length(unique(bt$rarefyID))

bt <- bt[Nave >= 10 | is.na(Nave), ]
length(unique(bt$rarefyID))
```


## Plot turnover examples
```{r plot turnover}
test <- bt[rarefyID == '339_1085477',]
test[, dY := year2 - year1]
ggplot(test, aes(dY, Jtu)) +
    geom_point(alpha = 0.5) +
    geom_smooth(data = test, 
                method = 'lm') + # a straight line fit
    labs(x = 'Year', y = 'Jaccard turnover')


# a declining 3-year slope
test <- bt[rarefyID == '112_529867' & year1>= 2002 & year2 <= 2004, ]
test[, dY := year2 - year1]
ggplot(test, aes(dY, Jtu)) +
    geom_point(alpha = 0.5) +
    geom_smooth(data = test, 
                method = 'lm') + # a straight line fit
    labs(x = 'Difference in years', y = 'Jaccard turnover')


# a declining 20-year slope
test <- bt[rarefyID == '213_435199' & year1>= 1987 & year2 <= 2006, ]
test[, dY := year2 - year1]
ggplot(test, aes(dY, Jtu)) +
    geom_point(alpha = 0.5) +
    geom_smooth(data = test, 
                method = 'lm') + # a straight line fit
    labs(x = 'Difference in years', y = 'Jaccard turnover')
```

## Examine autocorrelation in dissimilarities
Calculate from year1. A large fraction are NAs for some reason. Histogram is centered slightly <0. May suggest observation error around a true state is a substantial fraction of the variance in the data.
```{r autocor}
acfy1 <- function(year1, year2, Jtu){
  keep <- year1 == min(year1)
  year2 <- year2[keep]
  Jtu <- Jtu[keep]
  mod <- lm(Jtu ~ year2)
  return(acf(residuals(mod), lag.max = 1, plot=FALSE)$acf[2])
}

acfy1s <- bt[,acfy1(year1, year2, Jtu), by = rarefyID]

print('Fraction NA: '); acfy1s[, sum(is.na(V1))]/nrow(acfy1s) # faction NA for acf AR1

hist <- acfy1s[, hist(V1)] # histogram of AR1
```


# Calculate temporal trends (temporal turnover)
This only recalculates from scratch if temp/trendstemp.rds is not available.


## Do calculations
Write out trendstemp.rds, which has the slopes for all timeseries that meet criteria (all pairwise dissimilarities, all dissimilarities from year 1, durations 3 to 20 and annual sampling, or durations 3 to 20 and minimum 3 samples), focused on the last series in each rarefyID.  
Also write out trendstempallmin3.rds, which has slopes for all timeseries in all rarefyIDs (not just the last series).
```{r do calculations}
setkey(bt, STUDY_ID, rarefyID, year1,  year2)

# for trendstemp.rds
if(file.exists('temp/trendstemp.rds')){
    print('Read in temp/trendstemp.rds')
    trends <- readRDS('temp/trendstemp.rds')
} else {
  print('Need to run calc_turnover.R')
}

# for trendstempallmin3.rds
if(file.exists('temp/trendstempallmin3.rds')){
    print('Read in trendstempallmin3.rds')
    trendsallmin3 <- readRDS('temp/trendstempallmin3.rds')
} else {
  print('Need to run calc_turnover.R')
}

nrow(trends)
nrow(trendsallmin3)
```

## Add species richness and realm to trends for plotting
```{r add richness}
trends <- merge(trends, rich, all.x = TRUE) # species richness
realms <- bt[, .(REALM = unique(REALM)), by = rarefyID]
trends <- merge(trends, realms, all.x = TRUE)
```


## Plot every Jtu timeseries (a lot!)
Not run during knitting. Not yet updated to new format and content of trends data.table
```{r plot of all ts, eval=FALSE, echo = FALSE}
rids <- trends[nyrBT > 2, sort(unique(rarefyID))]
setkey(bt, rarefyID, YEAR)
print(paste(length(rids), ' rarefyIDs'))
filenum <- 1
plotnum <- 1
for(i in 1:length(rids)){
#for(i in 1:400){ # for testing
  jtutrendrem0 <- trends[rarefyID == rids[i], Jtutrendrem0]
  jtuexp <- trends[rarefyID == rids[i], Jtuexp]
  jtumm <- trends[rarefyID == rids[i], Jtumm]
  nspp <- trends[rarefyID == rids[i], Nspp]
  x <- bt[rarefyID == rids[i], YEAR]
  y <- bt[rarefyID == rids[i], Jtu_base]
  
  if(length(x) > 2 & nspp > 1){
    if(plotnum %% 400 == 1){
      if(plotnum >1) dev.off()
      png(file = paste0('figures/jtu_plots/jtu_plots', formatC(filenum, width = 3, format = 'd', flag = '0'), '.png'), 
          width = 36, height = 36, units = 'in', res = 100)
      par(mfrow=c(20,20), mai = c(0.4, 0.5, 0.5, 0.1))
      filenum <- filenum + 1
    }
    plot(x, y, main = paste('Jtu rem0:', signif(jtutrendrem0, 3), 'Jtu exp:', signif(jtuexp, 3), '\nJtu mm:', signif(jtumm, 3), 'Nspp:', nspp, '\nrID:', rids[i]), xlab = '', ylab = 'Jtu',
         cex.main = 0.7)
    abline(lm(y ~ x))
    if(plotnum %% 400 == 1){
      legend('topleft', legend = c('linear', 'rem0', 'exp', 'mm'), lty = 1, 
             col = c('black', 'red', 'blue', 'green'), cex = 0.5)
    }
    
    x2 <- x[2:length(x)]
    y2 <- y[2:length(y)]
    abline(lm(y2 ~ x2), col = 'red')
    
    x3 <- calcexp(y, x, pred = TRUE)
    lines(x3$YEAR, x3$pred, col = 'blue')
    
    x4 <- calcmm(y, x, pred = TRUE)
    lines(x4$YEAR, x4$pred, col = 'green')
    
    plotnum <- plotnum + 1
  }
}
  
dev.off()
```



# Examine the turnover calculations
## How many values?
### print
```{r number of values}
trends[, .N, by = c('measure', 'duration_group')]
```
### plot
```{r number of values plot}
counts <- trends[, .N, by = c('measure', 'duration_group')]
counts[!(duration_group %in% c('All', 'Ally1')), duration := as.numeric(gsub('annual|min3', '', duration_group))]
counts[!(duration_group %in% c('All', 'Ally1')), group := sub('^[[:digit:]]+', '', duration_group)]
counts[(duration_group %in% c('All', 'Ally1')), group := duration_group]
counts[!is.na(duration), duration_string := as.character(duration)]
counts[is.na(duration), duration_string := group]
counts[, duration_string := factor(duration_string, levels = c('3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', 'All', 'Ally1'))]

ggplot(counts, aes(duration_string, N, fill = group)) +
  geom_bar(stat = 'identity', position=position_dodge())
```

## Do some basic checks of the turnover calculations
```{r summary of change}
# basic checks
trends

trends[measure == 'Jtu', summary(disstrend)]
trends[measure == 'Jbeta', summary(disstrend)]
trends[measure == 'Horn', summary(disstrend)]
```

## Histograms of temporal change
Standardized slopes have very large and small values
```{r histograms of change, messages = FALSE}
x <- trends[measure == 'Jtu' & duration_group == '3annual', hist(disstrend)]
x <- trends[measure == 'Jbeta' & duration_group == '3annual', hist(disstrend)]
x <- trends[measure == 'Horn' & duration_group == '3annual', hist(disstrend)]

x <- trends[measure == 'Jtu' & duration_group == '5annual', hist(disstrend)]
x <- trends[measure == 'Jbeta' & duration_group == '5annual', hist(disstrend)]
x <- trends[measure == 'Horn' & duration_group == '5annual', hist(disstrend)]

x <- trends[measure == 'Jtu' & duration_group == '10annual', hist(disstrend)]
x <- trends[measure == 'Jbeta' & duration_group == '10annual', hist(disstrend)]
x <- trends[measure == 'Horn' & duration_group == '10annual', hist(disstrend)]

x <- trends[measure == 'Jtu' & duration_group == '20annual', hist(disstrend)]
x <- trends[measure == 'Jbeta' & duration_group == '20annual', hist(disstrend)]
x <- trends[measure == 'Horn' & duration_group == '20annual', hist(disstrend)]

x <- trends[measure == 'Jtu' & duration_group == 'All', hist(disstrend)]
x <- trends[measure == 'Jbeta' & duration_group == 'All', hist(disstrend)]
x <- trends[measure == 'Horn' & duration_group == 'All', hist(disstrend)]

```

## Pairs plots
Turnover calculations are correlated, though less so for Horn
```{r pairs, fig.height=10, fig.width=10, echo = FALSE}
panel.cor <- function(x, y, digits = 2, prefix = "", cex.cor, ...)
{
    usr <- par("usr"); on.exit(par(usr))
    par(usr = c(0, 1, 0, 1))
    r <- cor(x, y, use = 'pairwise.complete.obs')
    txt <- format(c(r, 0.123456789), digits = digits)[1]
    txt <- paste0(prefix, txt)
    if(missing(cex.cor)) cex.cor <- 0.8/strwidth(txt)
    text(0.5, 0.5, txt, cex = 0.5) #, cex = cex.cor * r)
}

# make wide dataset for pairs plotting
trendswide <- dcast(trends[duration_group %in% c('3annual', '5annual', '10annual', '20annual', 
                                                 '3min3', '5min3', '10min3', '20min3', 'All', 'Ally1')], 
                    rarefyID ~ measure + duration_group, value.var = 'disstrend')

# plots
pairs(formula = ~ Jtu_3annual + Jtu_5annual + Jtu_10annual + Jtu_20annual +
        Jtu_3min3 + Jtu_5min3 + Jtu_10min3 + Jtu_20min3 +
        Jtu_All + Jtu_Ally1, 
      data = trendswide, gap = 1/10, cex = 0.2, col = '#00000022', 
      lower.panel = panel.cor,
      upper.panel = panel.smooth)

pairs(formula = ~ Jtu_5annual + Jbeta_5annual + Horn_5annual, 
      data = trendswide, gap = 1/10, cex = 0.2, col = '#00000022', 
      lower.panel = panel.cor,
      upper.panel = panel.smooth)

pairs(formula = ~ Jtu_All + Jbeta_All + Horn_All, 
      data = trendswide, gap = 1/10, cex = 0.2, col = '#00000022', 
      lower.panel = panel.cor,
      upper.panel = panel.smooth)

```



# Change compared to time-series characteristics
## Duration
Do shorter timeseries have steeper slopes?
### Across timeseries
Compare timeseries of different durations, using the slopes with unstandardized durations. We see that shorter timeseries have steeper slopes.
```{r plot slope vs duration, echo=FALSE, fig.height = 6, fig.width = 11}
trends[, duration := year2 - year1]
p1 <- ggplot(trends[measure == 'Jtu' & duration_group == 'All',], aes(duration, disstrend)) +
  geom_point(size = 0.2, alpha = 0.5, na.rm = TRUE) + 
  geom_smooth(na.rm = TRUE) +
  scale_color_brewer(palette="Set1") + 
  labs(x = 'Years', y = 'Jaccard turnover slope')

p2 <- ggplot(trends[measure == 'Jbeta' & duration_group == 'All',], aes(duration, disstrend)) +
  geom_point(size = 0.2, alpha = 0.5, na.rm = TRUE) + 
  geom_smooth(na.rm = TRUE) +
  scale_color_brewer(palette="Set1") + 
  labs(x = 'Years', y = 'Jaccard total slope')

p3 <- ggplot(trends[measure == 'Horn' & duration_group == 'All',], aes(duration, disstrend)) +
  geom_point(size = 0.2, alpha = 0.5, na.rm = TRUE) + 
  geom_smooth(na.rm = TRUE) +
  scale_color_brewer(palette="Set1") + 
  labs(x = 'Years', y = 'Morisita-Horn slope')

# without points
p4 <- ggplot(trends[measure == 'Jtu' & duration_group == 'All',], aes(duration, disstrend)) +
  geom_smooth(na.rm = TRUE) +
  scale_color_brewer(palette="Set1") + 
  labs(x = 'Years', y = 'Jaccard turnover slope')

p5 <- ggplot(trends[measure == 'Jbeta' & duration_group == 'All',], aes(duration, disstrend)) +
  geom_smooth(na.rm = TRUE) +
  scale_color_brewer(palette="Set1") + 
  labs(x = 'Years', y = 'Jaccard total slope')

p6 <- ggplot(trends[measure == 'Horn' & duration_group == 'All',], aes(duration, disstrend)) +
  geom_smooth(na.rm = TRUE) +
  scale_color_brewer(palette="Set1") + 
  labs(x = 'Years', y = 'Morisita-Horn slope')

grid.arrange(p1, p2, p3, p4, p5, p6, ncol = 3)
```
### Within timeseries
Compare slopes of different durations within the same timeseries (only ts with durations 3 to 20). Short durations are clearly steeper.
```{r plot slope vs duration min3, echo=FALSE, fig.height = 9, fig.width = 11}
longtsJtu <- trendsallmin3[measure == 'Jtu', .(n = length(unique(duration_group))), by = rarefyID][n==18, ] # find IDs for timeseries with at least 15 different durations
longtsJbeta <- trendsallmin3[measure == 'Jbeta', .(n = length(unique(duration_group))), by = rarefyID][n==18, ]
longtsHorn <- trendsallmin3[measure == 'Horn', .(n = length(unique(duration_group))), by = rarefyID][n==18, ]

# some examples
p0a <- ggplot(trendsallmin3[measure == 'Jtu' & rarefyID == '18_335699'], aes(year2 - year1 + 1, disstrend, group = rarefyID, color = rarefyID)) +
  geom_point() + 
  geom_smooth(na.rm = TRUE) +
  theme(legend.position = 'none') + 
  labs(x = 'Duration', y = 'Jaccard turnover slope', title = '18_335699')

p0b <- ggplot(trendsallmin3[measure == 'Jtu' & rarefyID == '39_407478'], aes(year2 - year1 + 1, disstrend, group = rarefyID, color = rarefyID)) +
  geom_point() + 
  geom_smooth(na.rm = TRUE) +
  theme(legend.position = 'none') + 
  labs(x = 'Duration', y = 'Jaccard turnover slope' ,title = '39_407478')

p0c <- ggplot(trendsallmin3[measure == 'Jtu' & rarefyID == '42_605049'], aes(year2 - year1 + 1, disstrend, group = rarefyID, color = rarefyID)) +
  geom_point() + 
  geom_smooth(na.rm = TRUE) +
  theme(legend.position = 'none') + 
  labs(x = 'Duration', y = 'Jaccard turnover slope', title = '42_605049')

# with lines for each ts
p1 <- ggplot(trendsallmin3[measure == 'Jtu' & rarefyID %in% longtsJtu$rarefyID,], aes(year2 - year1 + 1, disstrend, group = rarefyID, color = rarefyID)) +
  geom_line(alpha = 0.1) + 
  theme(legend.position = 'none') + 
  labs(x = 'Duration', y = 'Jaccard turnover slope')

p2 <- ggplot(trendsallmin3[measure == 'Jbeta' & rarefyID %in% longtsJbeta$rarefyID,], aes(year2 - year1 + 1, disstrend, group = rarefyID, color = rarefyID)) +
  geom_line(alpha = 0.1) + 
  theme(legend.position = 'none') + 
  labs(x = 'Duration', y = 'Jaccard total slope')

p3 <- ggplot(trendsallmin3[measure == 'Horn' & rarefyID %in% longtsHorn$rarefyID,], aes(year2 - year1 + 1, disstrend, group = rarefyID, color = rarefyID)) +
  geom_line(alpha = 0.1) + 
  theme(legend.position = 'none') + 
  labs(x = 'Duration', y = 'Morisita-Horn slope')

# without points
p4 <- ggplot(trendsallmin3[measure == 'Jtu' & rarefyID %in% longtsJtu$rarefyID,], aes(year2 - year1 + 1, disstrend)) +
  geom_smooth(na.rm = TRUE) +
  labs(x = 'Duration', y = 'Jaccard turnover slope')

p5 <- ggplot(trendsallmin3[measure == 'Jbeta' & rarefyID %in% longtsJbeta$rarefyID,], aes(year2 - year1 + 1, disstrend)) +
  geom_smooth(na.rm = TRUE) +
  labs(x = 'Duration', y = 'Jaccard total slope')

p6 <- ggplot(trendsallmin3[measure == 'Horn' & rarefyID %in% longtsHorn$rarefyID,], aes(year2 - year1 + 1, disstrend)) +
  geom_smooth(na.rm = TRUE) +
  labs(x = 'Duration', y = 'Morisita-Horn slope')

grid.arrange(p0a, p0b, p0c, p1, p2, p3, p4, p5, p6, ncol = 3)
```

### Duration vs. start year
```{r}
ggplot(trends, aes(year1, year2 - year1 + 1)) +
  geom_point(alpha = 0.1) + 
  geom_smooth() +
  labs(x = 'Start year', y = 'Duration')

```
## Number of samples
Use the slopes with standardized durations to avoid confounding with duration
### Up to 20 years
```{r plot slope vs nsamps20, echo=FALSE, fig.height = 6, fig.width = 11}
p1 <- ggplot(trends[measure == 'Jtu' & duration_group == '20min3',], aes(nsamps, disstrend)) +
  geom_point(size = 0.2, alpha = 0.5, na.rm = TRUE) + 
  geom_smooth(na.rm = TRUE) +
  scale_color_brewer(palette="Set1") + 
  labs(x = 'Number of samples', y = 'Jaccard turnover slope')

p2 <- ggplot(trends[measure == 'Jbeta' & duration_group == '20min3',], aes(nsamps, disstrend)) +
  geom_point(size = 0.2, alpha = 0.5, na.rm = TRUE) + 
  geom_smooth(na.rm = TRUE) +
  scale_color_brewer(palette="Set1") + 
  labs(x = 'Number of samples', y = 'Jaccard total slope')

p3 <- ggplot(trends[measure == 'Horn' & duration_group == '20min3',], aes(nsamps, disstrend)) +
  geom_point(size = 0.2, alpha = 0.5, na.rm = TRUE) + 
  geom_smooth(na.rm = TRUE) +
  scale_color_brewer(palette="Set1") + 
  labs(x = 'Number of samples', y = 'Morisita-Horn slope')

# without points
p4 <- ggplot(trends[measure == 'Jtu' & duration_group == '20min3',], aes(nsamps, disstrend)) +
  geom_smooth(na.rm = TRUE) +
  scale_color_brewer(palette="Set1") + 
  labs(x = 'Number of samples', y = 'Jaccard turnover slope')

p5 <- ggplot(trends[measure == 'Jbeta' & duration_group == '20min3',], aes(nsamps, disstrend)) +
  geom_smooth(na.rm = TRUE) +
  scale_color_brewer(palette="Set1") + 
  labs(x = 'Number of samples', y = 'Jaccard total slope')

p6 <- ggplot(trends[measure == 'Horn' & duration_group == '20min3',], aes(nsamps, disstrend)) +
  geom_smooth(na.rm = TRUE) +
  scale_color_brewer(palette="Set1") + 
  labs(x = 'Number of samples', y = 'Morisita-Horn slope')

p7 <- ggplot(trends[measure == 'Jtu' & duration_group == '20min3',], aes(nsamps, trendse)) +
  geom_smooth(na.rm = TRUE) +
  scale_color_brewer(palette="Set1") + 
  labs(x = 'Number of samples', y = 'Jaccard turnover slope SE')

p8 <- ggplot(trends[measure == 'Jbeta' & duration_group == '20min3',], aes(nsamps, trendse)) +
  geom_smooth(na.rm = TRUE) +
  scale_color_brewer(palette="Set1") + 
  labs(x = 'Number of samples', y = 'Jaccard total slope SE')

p9 <- ggplot(trends[measure == 'Jtu' & duration_group == '20min3',], aes(nsamps, trendse)) +
  geom_smooth(na.rm = TRUE) +
  scale_color_brewer(palette="Set1") + 
  labs(x = 'Number of samples', y = 'Morisita-Horn slope SE')


grid.arrange(p1, p2, p3, p4, p5, p6, p7, p8, p9, ncol = 3)
```

### Up to 10 years
```{r plot slope vs nsamps10, echo=FALSE, fig.height = 6, fig.width = 11}
p1 <- ggplot(trends[measure == 'Jtu' & duration_group == '10min3',], aes(nsamps, disstrend)) +
  geom_point(size = 0.2, alpha = 0.5, na.rm = TRUE) + 
  geom_smooth(na.rm = TRUE, method = 'loess') + # loess is slow but works with this few x-values
  scale_color_brewer(palette="Set1") + 
  labs(x = 'Number of samples', y = 'Jaccard turnover slope')

p2 <- ggplot(trends[measure == 'Jbeta' & duration_group == '10min3',], aes(nsamps, disstrend)) +
  geom_point(size = 0.2, alpha = 0.5, na.rm = TRUE) + 
  geom_smooth(na.rm = TRUE, method = 'loess') +
  scale_color_brewer(palette="Set1") + 
  labs(x = 'Number of samples', y = 'Jaccard total slope')

p3 <- ggplot(trends[measure == 'Horn' & duration_group == '10min3',], aes(nsamps, disstrend)) +
  geom_point(size = 0.2, alpha = 0.5, na.rm = TRUE) + 
  geom_smooth(na.rm = TRUE, method = 'loess') +
  scale_color_brewer(palette="Set1") + 
  labs(x = 'Number of samples', y = 'Morisita-Horn slope')

# without points
p4 <- ggplot(trends[measure == 'Jtu' & duration_group == '10min3',], aes(nsamps, disstrend)) +
  geom_smooth(na.rm = TRUE, method = 'loess') +
  scale_color_brewer(palette="Set1") + 
  labs(x = 'Number of samples', y = 'Jaccard turnover slope')

p5 <- ggplot(trends[measure == 'Jbeta' & duration_group == '10min3',], aes(nsamps, disstrend)) +
  geom_smooth(na.rm = TRUE, method = 'loess') +
  scale_color_brewer(palette="Set1") + 
  labs(x = 'Number of samples', y = 'Jaccard total slope')

p6 <- ggplot(trends[measure == 'Horn' & duration_group == '10min3',], aes(nsamps, disstrend)) +
  geom_smooth(na.rm = TRUE, method = 'loess') +
  scale_color_brewer(palette="Set1") + 
  labs(x = 'Number of samples', y = 'Morisita-Horn slope')

grid.arrange(p1, p2, p3, p4, p5, p6, ncol = 3)
```

## Number of species
```{r change vs. num spp, fig.height =12, echo=FALSE}
par(mfrow=c(4,3))
trends[measure == 'Jtu' & duration_group == '3annual', plot(Nspp, disstrend, log = 'x', col = '#00000033')]; abline(h=0)
trends[measure == 'Jbeta' & duration_group == '3annual', plot(Nspp, disstrend, log = 'x', col = '#00000033')]; abline(h=0)
trends[measure == 'Horn' & duration_group == '3annual', plot(Nspp, disstrend, log = 'x', col = '#00000033')]; abline(h=0)

trends[measure == 'Jtu' & duration_group == '5annual', plot(Nspp, disstrend, log = 'x', col = '#00000033')]; abline(h=0)
trends[measure == 'Jbeta' & duration_group == '5annual', plot(Nspp, disstrend, log = 'x', col = '#00000033')]; abline(h=0)
trends[measure == 'Horn' & duration_group == '5annual', plot(Nspp, disstrend, log = 'x', col = '#00000033')]; abline(h=0)

trends[measure == 'Jtu' & duration_group == '10annual', plot(Nspp, disstrend, log = 'x', col = '#00000033')]; abline(h=0)
trends[measure == 'Jbeta' & duration_group == '10annual', plot(Nspp, disstrend, log = 'x', col = '#00000033')]; abline(h=0)
trends[measure == 'Horn' & duration_group == '10annual', plot(Nspp, disstrend, log = 'x', col = '#00000033')]; abline(h=0)

trends[measure == 'Jtu' & duration_group == '20annual', plot(Nspp, disstrend, log = 'x', col = '#00000033')]; abline(h=0)
trends[measure == 'Jbeta' & duration_group == '20annual', plot(Nspp, disstrend, log = 'x', col = '#00000033')]; abline(h=0)
trends[measure == 'Horn' & duration_group == '20annual', plot(Nspp, disstrend, log = 'x', col = '#00000033')]; abline(h=0)

trends[measure == 'Jtu' & duration_group == 'All', plot(Nspp, disstrend, log = 'x', col = '#00000033')]; abline(h=0)
trends[measure == 'Jbeta' & duration_group == 'All', plot(Nspp, disstrend, log = 'x', col = '#00000033')]; abline(h=0)
trends[measure == 'Horn' & duration_group == 'All', plot(Nspp, disstrend, log = 'x', col = '#00000033')]; abline(h=0)


```

## Average change compared to number of species
```{r ave change vs. num spp, message = FALSE}
trendswide <- dcast(trends[duration_group %in% c('3annual', '5annual', '10annual', '20annual', 
                                                 '3min3', '5min3', '10min3', '20min3', 'All', 'Ally1')], 
                    rarefyID + Nspp ~ measure + duration_group, value.var = 'disstrend')

ggplot(trendswide, aes(Nspp, Jtu_3annual, color = 'Jtu trend3')) +
  geom_smooth() +
  geom_smooth(aes(y = Jbeta_3annual, color = 'Jbeta trend3')) +
  geom_smooth(aes(y = Horn_3annual, color = 'Horn trend3')) +
  geom_smooth(aes(y = Jtu_5annual, color = 'Jtu trend5')) +
  geom_smooth(aes(y = Jbeta_5annual, color = 'Jbeta trend5')) +
  geom_smooth(aes(y = Horn_5annual, color = 'Horn trend5')) +
  geom_smooth(aes(y = Jtu_10annual, color = 'Jtu trend10')) +
  geom_smooth(aes(y = Jbeta_10annual, color = 'Jbeta trend10')) +
  geom_smooth(aes(y = Horn_10annual, color = 'Horn trend10')) +
  geom_smooth(aes(y = Jtu_20annual, color = 'Jtu trend20')) +
  geom_smooth(aes(y = Jbeta_20annual, color = 'Jbeta trend20')) +
  geom_smooth(aes(y = Horn_20annual, color = 'Horn trend20')) +
  geom_smooth(aes(y = Jtu_All, color = 'Jtu trendAll')) +
  geom_smooth(aes(y = Jbeta_All, color = 'Jbeta trendAll')) +
  geom_smooth(aes(y = Horn_All, color = 'Horn trendAll')) +
  scale_x_log10() +
  labs(y = 'Slope') +
  geom_abline(intercept = 0, slope = 0)


```


## Initial year
Check whether slopes in more recent time-periods are steeper. There don't appear to be clear indications of that pattern.
### 5 year slopes
Use the slopes with standardized 5min3 durations for all possible slopes within each rarefyID.
```{r plot slope vs initial year 5min3, echo=FALSE, fig.height = 6, fig.width = 11}
longtsJtu <- trendsallmin3[measure == 'Jtu' & duration_group == '5min3', .(n = .N), by = rarefyID][n>=20, ] # find IDs for timeseries with at least 20 values
longtsJbeta <- trendsallmin3[measure == 'Jbeta' & duration_group == '5min3', .(n = .N), by = rarefyID][n>=20, ] # find IDs for timeseries with at least 20 values
longtsHorn <- trendsallmin3[measure == 'Horn' & duration_group == '5min3', .(n = .N), by = rarefyID][n>=20, ] # find IDs for timeseries with at least 20 values

p1 <- ggplot(trendsallmin3[measure == 'Jtu' & duration_group == '5min3' & rarefyID %in% longtsJtu$rarefyID,], aes(year1, disstrend, group = rarefyID, color = rarefyID)) +
  geom_line(alpha = 0.1) + 
  theme(legend.position = 'none') + 
  labs(x = 'Years', y = 'Jaccard turnover slope')

p2 <- ggplot(trendsallmin3[measure == 'Jbeta' & duration_group == '5min3' & rarefyID %in% longtsJbeta$rarefyID,], aes(year1, disstrend, group = rarefyID, color = rarefyID)) +
  geom_line(alpha = 0.1) + 
  theme(legend.position = 'none') + 
  labs(x = 'Years', y = 'Jaccard total slope')

p3 <- ggplot(trendsallmin3[measure == 'Horn' & duration_group == '5min3' & rarefyID %in% longtsHorn$rarefyID,], aes(year1, disstrend, group = rarefyID, color = rarefyID)) +
  geom_line(alpha = 0.1) + 
  theme(legend.position = 'none') + 
  labs(x = 'Years', y = 'Morisita-Horn slope')

# without points
p4 <- ggplot(trendsallmin3[measure == 'Jtu' & duration_group == '5min3' & rarefyID %in% longtsJtu$rarefyID,], aes(year1, disstrend)) +
  geom_smooth(na.rm = TRUE) +
  labs(x = 'Years', y = 'Jaccard turnover slope')

p5 <- ggplot(trendsallmin3[measure == 'Jbeta' & duration_group == '5min3' & rarefyID %in% longtsJbeta$rarefyID,], aes(year1, disstrend)) +
  geom_smooth(na.rm = TRUE) +
  labs(x = 'Years', y = 'Jaccard total slope')

p6 <- ggplot(trendsallmin3[measure == 'Horn' & duration_group == '5min3' & rarefyID %in% longtsHorn$rarefyID,], aes(year1, disstrend)) +
  geom_smooth(na.rm = TRUE) +
  labs(x = 'Years', y = 'Morisita-Horn slope')

grid.arrange(p1, p2, p3, p4, p5, p6, ncol = 3)
```


### 10 year slopes
Use the slopes with standardized 10min3 durations for all possible slopes within each rarefyID.
```{r plot slope vs initial year 10min3, echo=FALSE, fig.height = 6, fig.width = 11}
longtsJtu <- trendsallmin3[measure == 'Jtu' & duration_group == '10min3', .(n = .N), by = rarefyID][n>=20, ] # find IDs for timeseries with at least 20 values
longtsJbeta <- trendsallmin3[measure == 'Jbeta' & duration_group == '10min3', .(n = .N), by = rarefyID][n>=20, ] # find IDs for timeseries with at least 20 values
longtsHorn <- trendsallmin3[measure == 'Horn' & duration_group == '10min3', .(n = .N), by = rarefyID][n>=20, ] # find IDs for timeseries with at least 20 values

p1 <- ggplot(trendsallmin3[measure == 'Jtu' & duration_group == '10min3' & rarefyID %in% longtsJtu$rarefyID,], aes(year1, disstrend, group = rarefyID, color = rarefyID)) +
  geom_line(alpha = 0.1) + 
  theme(legend.position = 'none') + 
  labs(x = 'Years', y = 'Jaccard turnover slope')

p2 <- ggplot(trendsallmin3[measure == 'Jbeta' & duration_group == '10min3' & rarefyID %in% longtsJbeta$rarefyID,], aes(year1, disstrend, group = rarefyID, color = rarefyID)) +
  geom_line(alpha = 0.1) + 
  theme(legend.position = 'none') + 
  labs(x = 'Years', y = 'Jaccard total slope')

p3 <- ggplot(trendsallmin3[measure == 'Horn' & duration_group == '10min3' & rarefyID %in% longtsHorn$rarefyID,], aes(year1, disstrend, group = rarefyID, color = rarefyID)) +
  geom_line(alpha = 0.1) + 
  theme(legend.position = 'none') + 
  labs(x = 'Years', y = 'Morisita-Horn slope')

# without points
p4 <- ggplot(trendsallmin3[measure == 'Jtu' & duration_group == '10min3' & rarefyID %in% longtsJtu$rarefyID,], aes(year1, disstrend)) +
  geom_smooth(na.rm = TRUE) +
  labs(x = 'Years', y = 'Jaccard turnover slope')

p5 <- ggplot(trendsallmin3[measure == 'Jbeta' & duration_group == '10min3' & rarefyID %in% longtsJbeta$rarefyID,], aes(year1, disstrend)) +
  geom_smooth(na.rm = TRUE) +
  labs(x = 'Years', y = 'Jaccard total slope')

p6 <- ggplot(trendsallmin3[measure == 'Horn' & duration_group == '10min3' & rarefyID %in% longtsHorn$rarefyID,], aes(year1, disstrend)) +
  geom_smooth(na.rm = TRUE) +
  labs(x = 'Years', y = 'Morisita-Horn slope')

grid.arrange(p1, p2, p3, p4, p5, p6, ncol = 3)
```