---
title: "Calculate biodiversity turnover as slope of dissimilarity vs. time"
output:
  github_document: default
---
# Set up
```{r setup, include=FALSE}
if(Sys.info()$nodename == 'annotate.sebs.rutgers.edu'){
  library('mgcv', lib.loc = '/usr/lib64/R/library') # when running on Annotate. Need to load 1.8-26, not 1.8-33.
} else {
  library('mgcv')
}
library(data.table)
library(ggplot2)


knitr::opts_chunk$set(echo = TRUE, warning = FALSE)

knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file()) # tell RStudio to use project root directory as the root for this notebook. Needed since we are storing code in a separate directory.

```

# Load data
```{r load data}
# BioTime
# biotime community dissimilarity data
load(here::here('data', 'biotime_blowes', 'all_pairs_beta.Rdata')) # load rarefied_beta_medians, which has all pairwise dissimilarities
bt <- data.table(rarefied_beta_medians); rm(rarefied_beta_medians)
bt[, year1 := as.numeric(year1)] # not sure why it gets read in as character
bt[, year2 := as.numeric(year2)]
bt[, Horn := 1-Hornsim] # convert similarity to dissimilarity
bt[, Hornsim := NULL]

# BioTime data type
load('data/biotime_blowes/time_series_data_type.Rdata') # loads rarefyID_type
bt <- merge(bt, rarefyID_type, by = 'rarefyID', all.x = TRUE) # merge with biotime

# biotime taxa category and other info
load(here::here('data', 'biotime_blowes', 'bt_malin.Rdata')) # load bt_malin
btinfo <- data.table(bt_malin); rm(bt_malin)
btinfo2 <- btinfo[!duplicated(rarefyID), .(rarefyID, rarefyID_x, rarefyID_y, Biome, taxa_mod, REALM, STUDY_ID)]
bt <- merge(bt, btinfo2, by = 'rarefyID', all.x = TRUE)

# richness
rich <- fread('output/richness_by_rarefyID.csv.gz') # number of species
```


## Examine number of species and individuals per sample
```{r numspp per samp}
hist(log10(btinfo$N))
hist(log10(btinfo$S)); abline(v = log10(2), col = 'red') # line at 2 species

nrow(btinfo)
btinfo[S == 1, .N]

```

## Remove studies that don't meet quality thresholds
Keep studies with:
- >2 species


```{r QAQC}
length(unique(bt$rarefyID))



# number of years per study (in remaining samples)
nyrs <- bt[, .(nyrBT = length(unique(c(year1, year2)))), by = rarefyID]

# >2 species, >2 yrs
bt <- bt[rarefyID %in% rich[Nspp > 2, rarefyID] & 
           rarefyID %in% nyrs[nyrBT > 2, rarefyID], ]

length(unique(bt$rarefyID))
```

# Plot turnover example
```{r plot turnover}
test <- bt[rarefyID == '339_1085477',]
test[, dY := year2 - year1]


# make plot
ggplot(test, aes(dY, Jtu)) +
    geom_point(alpha = 0.5) +
    geom_smooth(data = test, 
                method = 'lm') + # a straight line fit
    labs(x = 'Year', y = 'Jaccard turnover')

```


# Calculate temporal trends (temporal turnover)
This only recalculates from scratch if temp/trendstemp.rds is not available.
## Set up functions
```{r assemble trends, warning=FALSE, message=FALSE}
# function to calc linear trend from last numyears of the time-series
calctrendlast <- function(y, year1, year2, numyrs, nm = 'y'){
  yrs <- sort(unique(c(year1, year2)))
  dy <- diff(yrs) # find intervals between years
  rl <- rle(dy) # run length encoding
  end = cumsum(rl$lengths) # find ends of runs
  start = c(1, head(end, -1) + 1) # find starts of runs
  rlkeep <- which(rl$lengths >= numyrs & rl$values == 1) # find runs with desired length and 1 year intervals
  if(length(rlkeep)>0){
    rlkeep <- max(rlkeep) # find the latest run that meets our criteria
    start <- start[rlkeep] # start of this run
    end <- end[rlkeep] # end of this run
    dykeep <- rep(FALSE, length(dy)) # year intervals to keep
    dykeep[start:end] <- TRUE
    yrs2 <- yrs[c(dykeep, FALSE) | c(FALSE, dykeep)] # keep years involved in at least one interval to keep
    maxyr <- max(yrs2)
    yrs3 <- yrs2[yrs2 > maxyr - numyrs] # only last numyrs years
    ykeep <- year1 %in% yrs3 & year2 %in% yrs3 # keep values in pairwise comparisons for the years we want
    y <- y[ykeep] # trim the timeseries
    year1 <- year1[ykeep]
    year2 <- year2[ykeep]
    run <- TRUE
  } else{
    run <- FALSE
  }
  
  if(run){
    dy <- year2 - year1
    
    mod <- lm(y ~ dy) # fit line
    out <- list(y = coef(mod)[2], # coef for the slope
                y_se = sqrt(diag(vcov(mod)))[2],
                year1 = min(yrs3), 
                year2 = max(yrs3)) # SE
    names(out) <- c(nm, paste0(nm, '_se'), paste0(nm, '_y1'), paste0(nm, '_y2'))
    return(out)

  } else {
    out <- list(y = NA_real_, y_se = NA_real_, year1 = NA_real_, year2 = NA_real_)
    names(out) <- c(nm, paste0(nm, '_se'), paste0(nm, '_y1'), paste0(nm, '_y2'))
    return(out)
  }
  

}

```

## Do calculations
And write out trendstemp.rds
```{r do calculations}
setkey(bt, STUDY_ID, rarefyID, year1,  year2)

if(file.exists('temp/trendstemp.rds')){
    print('File already exists. Will not do calculations')
    trends2 <- readRDS('temp/trendstemp.rds')
} else {
  print('Calculating from scratch')
  
  # 3-year trends
  trends1 <- bt[, calctrendlast(Jtu, year1, year2, 3, 'Jtutrend3'), 
                by = .(REALM, Biome, taxa_mod, STUDY_ID, 
                       rarefyID, rarefyID_x, rarefyID_y)] # calculate trend in Jaccard turnover without first year
  trends2 <- bt[, calctrendlast(Jbeta, year1, year2, 3, 'Jbetatrend3'),
                by = .(rarefyID)]
  trends3 <- bt[!is.na(Horn), calctrendlast(1-Horn, year1, year2, 3, 'Horntrend3'),
                by = .(rarefyID)]
  
  # 5 year
  trends4 <- bt[, calctrendlast(Jtu, year1, year2, 5, 'Jtutrend5'), 
                by = .(rarefyID)]
  trends5 <- bt[, calctrendlast(Jbeta, year1, year2, 5, 'Jbetatrend5'),
                by = .(rarefyID)]
  trends6 <- bt[!is.na(Horn), calctrendlast(1-Horn, year1, year2, 5, 'Horntrend5'),
                by = .(rarefyID)]


  # 10 year
  trends7 <- bt[, calctrendlast(Jtu, year1, year2, 10, 'Jtutrend10'), 
                by = .(rarefyID)]
  trends8 <- bt[, calctrendlast(Jbeta, year1, year2, 10, 'Jbetatrend10'),
                by = .(rarefyID)]
  trends9 <- bt[!is.na(Horn), calctrendlast(1-Horn, year1, year2, 10, 'Horntrend10'),
                by = .(rarefyID)]
  
  # 20 year
  trends10 <- bt[, calctrendlast(Jtu, year1, year2, 20, 'Jtutrend20'), 
                by = .(rarefyID)]
  trends11 <- bt[, calctrendlast(Jbeta, year1, year2, 20, 'Jbetatrend20'),
                by = .(rarefyID)]
  trends12 <- bt[!is.na(Horn), calctrendlast(1-Horn, year1, year2, 20, 'Horntrend20'),
                by = .(rarefyID)]
  
  trends <- merge(trends1, trends2, all = TRUE)
  trends <- merge(trends, trends3, all = TRUE)
  trends <- merge(trends, trends4, all = TRUE)
  trends <- merge(trends, trends5, all = TRUE)
  trends <- merge(trends, trends6, all = TRUE)
  trends <- merge(trends, trends7, all = TRUE)
  trends <- merge(trends, trends8, all = TRUE)
  trends <- merge(trends, trends9, all = TRUE)
  trends <- merge(trends, trends10, all = TRUE)
  trends <- merge(trends, trends11, all = TRUE)
  trends <- merge(trends, trends12, all = TRUE)
  
  trends2 <- trends[!is.na(Jtutrend3) | !is.na(Jbetatrend3) | !is.na(Horntrend3), ]

  saveRDS(trends2, file = 'temp/trendstemp.rds')
  
}

nrow(trends2)
```

## Add species richness to trends
```{r add richness}
trends2 <- merge(trends2, rich, all.x = TRUE) # species richness
```


## Plot every Jtu timeseries (a lot!)
Not run during knitting
```{r plot of all ts, eval=FALSE}
rids <- trends2[nyrBT > 2, sort(unique(rarefyID))]
setkey(bt, rarefyID, YEAR)
print(paste(length(rids), ' rarefyIDs'))
filenum <- 1
plotnum <- 1
for(i in 1:length(rids)){
#for(i in 1:400){ # for testing
  jtutrendrem0 <- trends2[rarefyID == rids[i], Jtutrendrem0]
  jtuexp <- trends2[rarefyID == rids[i], Jtuexp]
  jtumm <- trends2[rarefyID == rids[i], Jtumm]
  nspp <- trends2[rarefyID == rids[i], Nspp]
  x <- bt[rarefyID == rids[i], YEAR]
  y <- bt[rarefyID == rids[i], Jtu_base]
  
  if(length(x) > 2 & nspp > 1){
    if(plotnum %% 400 == 1){
      if(plotnum >1) dev.off()
      png(file = paste0('figures/jtu_plots/jtu_plots', formatC(filenum, width = 3, format = 'd', flag = '0'), '.png'), 
          width = 36, height = 36, units = 'in', res = 100)
      par(mfrow=c(20,20), mai = c(0.4, 0.5, 0.5, 0.1))
      filenum <- filenum + 1
    }
    plot(x, y, main = paste('Jtu rem0:', signif(jtutrendrem0, 3), 'Jtu exp:', signif(jtuexp, 3), '\nJtu mm:', signif(jtumm, 3), 'Nspp:', nspp, '\nrID:', rids[i]), xlab = '', ylab = 'Jtu',
         cex.main = 0.7)
    abline(lm(y ~ x))
    if(plotnum %% 400 == 1){
      legend('topleft', legend = c('linear', 'rem0', 'exp', 'mm'), lty = 1, 
             col = c('black', 'red', 'blue', 'green'), cex = 0.5)
    }
    
    x2 <- x[2:length(x)]
    y2 <- y[2:length(y)]
    abline(lm(y2 ~ x2), col = 'red')
    
    x3 <- calcexp(y, x, pred = TRUE)
    lines(x3$YEAR, x3$pred, col = 'blue')
    
    x4 <- calcmm(y, x, pred = TRUE)
    lines(x4$YEAR, x4$pred, col = 'green')
    
    plotnum <- plotnum + 1
  }
}
  
dev.off()
```



# Examine the turnover calculations
## How many values?
```{r number of values}
apply(trends2[, .(Jtutrend3, Jbetatrend3, Horntrend3,
                 Jtutrend5, Jbetatrend5, Horntrend5,
                Jtutrend10, Jbetatrend10, Horntrend10,
                Jtutrend20, Jbetatrend20, Horntrend20)], MARGIN = 2, 
      function(x) sum(!is.na(x)))
```

## Do some basic checks of the turnover calculations
```{r summary of change}
# basic checks
trends2

summary(trends2$Jtutrend3)
summary(trends2$Jbetatrend3)
summary(trends2$Horntrend3)

```

## Histograms of temporal change
Standardized slopes have very large and small values
```{r histograms of change, messages = FALSE}
x <- trends2[, hist(Jtutrend3)]
x <- trends2[, hist(Jbetatrend3)]
x <- trends2[, hist(Horntrend3)]

x <- trends2[, hist(Jtutrend5)]
x <- trends2[, hist(Jbetatrend5)]
x <- trends2[, hist(Horntrend5)]

x <- trends2[, hist(Jtutrend10)]
x <- trends2[, hist(Jbetatrend10)]
x <- trends2[, hist(Horntrend10)]

x <- trends2[, hist(Jtutrend20)]
x <- trends2[, hist(Jbetatrend20)]
x <- trends2[, hist(Horntrend20)]

```

## Turnover calculations are correlated, though less so for Horn
```{r pairs, fig.height=10, fig.width=10}
panel.cor <- function(x, y, digits = 2, prefix = "", cex.cor, ...)
{
    usr <- par("usr"); on.exit(par(usr))
    par(usr = c(0, 1, 0, 1))
    r <- cor(x, y, use = 'pairwise.complete.obs')
    txt <- format(c(r, 0.123456789), digits = digits)[1]
    txt <- paste0(prefix, txt)
    if(missing(cex.cor)) cex.cor <- 0.8/strwidth(txt)
    text(0.5, 0.5, txt, cex = 0.5) #, cex = cex.cor * r)
}
pairs(formula = ~ Jtutrend3 + Jbetatrend3 + Horntrend3 +
        Jtutrend5 + Jbetatrend5 + Horntrend5 +
        Jtutrend10 + Jbetatrend10 + Horntrend10 +
        Jtutrend20 + Jbetatrend20 + Horntrend20, 
      data = trends2, gap = 1/10, cex = 0.2, col = '#00000022', 
      lower.panel = panel.cor,
      upper.panel = panel.smooth)

```



# Change compared to time-series characteristics
## Number of species
```{r change vs. num spp, fig.height =12}
par(mfrow=c(4,3))
trends2[, plot(Nspp, Jtutrend3, log = 'x', col = '#00000033')]; abline(h=0)
trends2[, plot(Nspp, Jbetatrend3, log = 'x', col = '#00000033')]; abline(h=0)
trends2[, plot(Nspp, Horntrend3, log = 'x', col = '#00000033')]; abline(h=0)

trends2[, plot(Nspp, Jtutrend5, log = 'x', col = '#00000033')]; abline(h=0)
trends2[, plot(Nspp, Jbetatrend5, log = 'x', col = '#00000033')]; abline(h=0)
trends2[, plot(Nspp, Horntrend5, log = 'x', col = '#00000033')]; abline(h=0)

trends2[, plot(Nspp, Jtutrend10, log = 'x', col = '#00000033')]; abline(h=0)
trends2[, plot(Nspp, Jbetatrend10, log = 'x', col = '#00000033')]; abline(h=0)
trends2[, plot(Nspp, Horntrend10, log = 'x', col = '#00000033')]; abline(h=0)

trends2[, plot(Nspp, Jtutrend20, log = 'x', col = '#00000033')]; abline(h=0)
trends2[, plot(Nspp, Jbetatrend20, log = 'x', col = '#00000033')]; abline(h=0)
trends2[, plot(Nspp, Horntrend20, log = 'x', col = '#00000033')]; abline(h=0)


```

## Average change compared to #species
```{r ave change vs. num spp, message = FALSE}
# number of species
ggplot(trends2, aes(Nspp, Jtutrend3, color = 'Jtu trend3')) +
    geom_smooth() +
    geom_smooth(aes(y = Jbetatrend3, color = 'Jbeta trend3')) +
    geom_smooth(aes(y = Horntrend3, color = 'Horn trend3')) +
    geom_smooth(aes(y = Jtutrend5, color = 'Jtu trend5')) +
    geom_smooth(aes(y = Jbetatrend5, color = 'Jbeta trend5')) +
    geom_smooth(aes(y = Horntrend5, color = 'Horn trend5')) +
  geom_smooth(aes(y = Jtutrend10, color = 'Jtu trend10')) +
    geom_smooth(aes(y = Jbetatrend10, color = 'Jbeta trend10')) +
    geom_smooth(aes(y = Horntrend10, color = 'Horn trend10')) +
  geom_smooth(aes(y = Jtutrend20, color = 'Jtu trend20')) +
    geom_smooth(aes(y = Jbetatrend20, color = 'Jbeta trend20')) +
    geom_smooth(aes(y = Horntrend20, color = 'Horn trend20')) +
    scale_x_log10() +
    labs(y = 'Slope') +
    geom_abline(intercept = 0, slope = 0)


```


