---
title: "Replicate and extend analyses from Antao et al. 2020"
output: 
    github_document: default
---

# Load data
```{r setup, echo=FALSE}
library(glmmTMB)
library(data.table)
library(here)
library(MuMIn)
library(parallel) # for mclapply()
library(ggplot2)

# Antao data
load(url('https://github.com/lauraantao/Temp_Biodiv_Change/raw/master/R/lm_slopes_meta_temperature3.Rdata')) # load Antao data
dat <- data.table(lm_slopes_meta_temperature3)

datRichMar <- droplevels(dat[model_id == 'logS_lm' & REALM=='Marine',])
datRichTerr <- droplevels(dat[model_id == 'logS_lm' & REALM=='Terrestrial',])

# my dataset
trends <- fread(here('output', 'slope_w_covariates.csv.gz'))
scaling <- fread(here('output', 'slope_w_covariates_scaling.csv'))
scaling$center <- as.numeric(scaling$center)


# original dataset from Shane
load(here::here('data', 'biotime_blowes', 'all_pairs_beta.Rdata')) # load rarefied_beta_medians, which has all pairwise dissimilarities
bt <- data.table(rarefied_beta_medians); rm(rarefied_beta_medians)

# richness
rich <- fread(here('output','richness_by_rarefyID.csv.gz')) # number of species


# merge
comb <- merge(dat, trends[duration_group == 'Ally1', !c("rarefyID_y" ,"duration", 'REALM')], by = c('STUDY_ID', 'rarefyID'), all = TRUE, allow.cartesian = TRUE)
comb5 <- merge(dat[model_id == 'logS_lm', ], trends[duration_group == '5annual', !c("rarefyID_y" ,"duration", 'REALM')], by = c('STUDY_ID', 'rarefyID'), all = TRUE)
comb5min3 <- merge(dat[model_id == 'logS_lm', ], trends[duration_group == '5min3', !c("rarefyID_y" ,"duration", 'REALM')], by = c('STUDY_ID', 'rarefyID'), all = TRUE)
comb10min3 <- merge(dat[model_id == 'logS_lm', ], trends[duration_group == '10min3', !c("rarefyID_y" ,"duration", 'REALM')], by = c('STUDY_ID', 'rarefyID'), all = TRUE)
comb20min3 <- merge(dat[model_id == 'logS_lm', ], trends[duration_group == '20min3', !c("rarefyID_y" ,"duration", 'REALM')], by = c('STUDY_ID', 'rarefyID'), all = TRUE)

# data subsets
datS <- dat[model_id == 'logS_lm',]
combMHlogS <- comb[model_id == 'logS_lm' & !is.na(human_bowler.sc) & !is.na(mass.sc), ]

```

# Compare datasets
## Trends included
```{r}
# how many ts missing?
length(setdiff(dat$rarefyID, bt$rarefyID))
length(missing <- setdiff(dat$rarefyID, trends$rarefyID))
length(setdiff(bt$rarefyID, trends$rarefyID))
length(setdiff(dat$rarefyID, rich$rarefyID))

#richness of missing ts
rich[rarefyID %in% missing, summary(Nspp)]
rich[rarefyID %in% missing & Nspp < 3, .N] # only 69 fail because too few species

# years in missing ts
nyrs <- bt[, .(nyrBT = length(unique(c(year1, year2)))), by = rarefyID]
nyrs[rarefyID %in% missing, summary(nyrBT)]
nyrs[rarefyID %in% missing & nyrBT < 5, .N] # none fail because too few years

# Full Antao vs. Antao now with human and mass
length(setdiff(dat$rarefyID, combMHlogS$rarefyID)) # only missing 92 ts

```
## Response variables
### Plots
```{r, echo = FALSE}
col = '#00000033'
# compare
comb[, plot(startYear, year1)]
comb[, plot(endYear, year2)]
comb[, plot(TempGAMCoef, temptrend)]; abline(0,1)
comb[, plot(new_sTempYear, tempave.sc, col = c('green', 'blue')[(REALM=='Marine')+1])]; abline(0,1)
comb[model_id == 'logS_lm' & measure == 'Jtu', plot(slope, disstrend, xlab = 'logS slope', ylab = 'Jtu slope', col = col)]
comb[model_id == 'Gains_lm' & measure == 'Jtu', plot(slope, disstrend, xlab = 'Gains slope', ylab = 'Jtu slope', col = col)]
comb[model_id == 'Losses_lm' & measure == 'Jtu', plot(slope, disstrend, xlab = 'Losses slope', ylab = 'Jtu slope', col = col)]

comb[model_id == 'logS_lm' & measure == 'Jbeta', plot(slope, disstrend, xlab = 'logS slope', ylab = 'Jbeta slope', col = col)]
comb[model_id == 'Gains_lm' & measure == 'Jbeta', plot(slope, disstrend, xlab = 'Gains slope', ylab = 'Jbeta slope', col = col)]
comb[model_id == 'Losses_lm' & measure == 'Jbeta', plot(slope, disstrend, xlab = 'Losses slope', ylab = 'Jbeta slope', col = col)]

comb[model_id == 'logS_lm' & measure == 'Horn', plot(slope, disstrend, xlab = 'logS slope', ylab = 'Horn slope', col = col)]
comb[model_id == 'logN_lm' & measure == 'Horn', plot(slope, disstrend, xlab = 'logN slope', ylab = 'Horn slope', col = col)]
comb[model_id == 'Gains_lm' & measure == 'Horn', plot(slope, disstrend, xlab = 'Gains slope', ylab = 'Horn slope', col = col)]
comb[model_id == 'Losses_lm' & measure == 'Horn', plot(slope, disstrend, xlab = 'Losses slope', ylab = 'Horn slope', col = col)]

```

### Correlations
```{r}
comb[model_id == 'logS_lm' & measure == 'Jtu', cor(slope, disstrend)]
comb[model_id == 'Gains_lm' & measure == 'Jtu', cor(slope, disstrend)]
comb[model_id == 'Losses_lm' & measure == 'Jtu', cor(slope, disstrend)]

comb[model_id == 'logS_lm' & measure == 'Jbeta', cor(slope, disstrend)]
comb[model_id == 'Gains_lm' & measure == 'Jbeta', cor(slope, disstrend)]
comb[model_id == 'Losses_lm' & measure == 'Jbeta', cor(slope, disstrend)]

comb[model_id == 'logS_lm' & measure == 'Horn', cor(slope, disstrend)]
comb[model_id == 'logN_lm' & measure == 'Horn', cor(slope, disstrend)]
comb[model_id == 'Gains_lm' & measure == 'Horn', cor(slope, disstrend)]
comb[model_id == 'Losses_lm' & measure == 'Horn', cor(slope, disstrend)]

```

# Fit richness model
## Original model with glmmTMB
The richness (logS) model fit with glmmTMB as a single model matches the published results (realm-specific models fit with brms) if the error and RE terms are realm-specific.
```{r}
# published model
mod0 <- glmmTMB(slope ~ 0 + new_sTempYear:REALM + TempGAMCoef:REALM + TempGAMCoef:new_sTempYear:REALM
                +(0 + TempGAMCoef|REALM/taxa_mod1) +(1|REALM/taxa_mod1/STUDY_ID), 
                disp = ~std.error*REALM,
                data = datS)

summary(mod0)
```
### Plot
```{r, echo = FALSE}
# set up prediction frame
newdatM <- expand.grid(new_sTempYear = seq(-2, 2.5, length.out = 100), TempGAMCoef = seq(-0.35, 0.35, length.out = 100))
newdatM$REALM <- 'Marine'
newdatM$taxa_mod1 <- 'All'
newdatM$STUDY_ID <- 33
newdatM$std.error <- 0.03
sdTM <- sd(datS$newtempvalues[datS$REALM == 'Marine'])
meanTM <- mean(datS$newtempvalues[datS$REALM == 'Marine'])
newdatM$newtempvalues <- newdatM$new_sTempYear * sdTM + meanTM

newdatT <- expand.grid(new_sTempYear = seq(-2.5, 2.7, length.out = 100), TempGAMCoef = seq(-0.3, 0.5, length.out = 100))
newdatT$REALM <- 'Terrestrial'
newdatT$taxa_mod1 <- 'Terrestrial plants'
newdatT$STUDY_ID <- 18
newdatT$std.error <- 0.03
sdTT <- sd(datS$newtempvalues[datS$REALM == 'Terrestrial'])
meanTT <- mean(datS$newtempvalues[datS$REALM == 'Terrestrial'])
newdatT$newtempvalues <- newdatT$new_sTempYear * sdTT + meanTT

# predict
newdatM$slope <- predict(mod0, newdata = newdatM, se.fit = FALSE, re.form = NA)
newdatT$slope <- predict(mod0, newdata = newdatT, se.fit = FALSE, re.form = NA)

# plot
p1 <- ggplot(newdatM, aes(TempGAMCoef, newtempvalues, z = slope)) +
    geom_raster(aes(fill = slope)) +
    labs(x = 'Temperature change (degC per year)', y = 'Long-term temperature (degC)', title = 'Marine') +
    scale_fill_gradient2(high= "#B2182B", mid = "white", low= "#2166AC", midpoint = 0) +
    theme(axis.text = element_text(size = 12), 
          axis.title = element_text(size = 14),
          panel.background = element_blank(),
          axis.line = element_line(colour = "black"),
          legend.position = "top",
          legend.margin = margin(c(0, 0.1, -20, 0)),
          legend.justification = c(0.92, 0.9),
          legend.text=element_text(size= 12),
          legend.title=element_text(size= 18),
          legend.title.align = 1)
p2 <- ggplot(newdatT, aes(TempGAMCoef, newtempvalues, z = slope)) +
    geom_raster(aes(fill = slope)) +
    labs(x = 'Temperature change (degC per year)', y = 'Long-term temperature (degC)', title = 'Terrestrial') +
    scale_fill_gradient2(high= "#B2182B", mid = "white", low= "#2166AC", midpoint = 0) +
    theme(axis.text = element_text(size = 12), 
          axis.title = element_text(size = 14),
          panel.background = element_blank(),
          axis.line = element_line(colour = "black"),
          legend.position = "top",
          legend.margin = margin(c(0, 0.1, -20, 0)),
          legend.justification = c(0.92, 0.9),
          legend.text=element_text(size= 12),
          legend.title=element_text(size= 18),
          legend.title.align = 1)

p1
p2
```

## With an intercept
Adding an intercept to allow turnover at 0 temperature change doesn't alter the results
```{r}
# add an intercept to allow some turnover at 0 temperature change and ave temp. wouldn't converge with realm-specific intercept.
mod1 <- glmmTMB(slope ~ 1 + new_sTempYear:REALM + TempGAMCoef:REALM + TempGAMCoef:new_sTempYear:REALM
                +(0 + TempGAMCoef|REALM/taxa_mod1) +(1|REALM/taxa_mod1/STUDY_ID), 
                disp = ~std.error*REALM,
                data = datS)
summary(mod1)
```

Another approach to adding an intercept: realm-specific, but with simpler REs. This model but also with REALM-specific RE intercepts won't converge.
```{r}
# realm-specific intercept. Simplify REs that were near zero.
mod2 <- glmmTMB(slope ~ 0 + REALM + new_sTempYear:REALM + TempGAMCoef:REALM + TempGAMCoef:new_sTempYear:REALM
                +(0 + TempGAMCoef|REALM/taxa_mod1) +(1|taxa_mod1/STUDY_ID), 
                disp = ~std.error*REALM,
                data = datS)


summary(mod2)
```

## With my temperature data
```{r}
# 
mod0alt_tempdata <- glmmTMB(slope ~ 0 + tempave.sc:REALM + temptrend.sc:REALM + temptrend.sc:tempave.sc:REALM
                +(0 + temptrend.sc|REALM/taxa_mod1) +(1|REALM/taxa_mod1/STUDY_ID), 
                disp = ~std.error*REALM,
                data = comb[!duplicated(rarefyID) & model_id == 'logS_lm',])

summary(mod0alt_tempdata)
```

### Plot
```{r, echo = FALSE}
# set up prediction frame
newdatM <- expand.grid(tempave.sc = seq(-2, 1.8, length.out = 100), temptrend.sc = seq(-1.8, 1.8, length.out = 100))
newdatM$REALM <- 'Marine'
newdatM$taxa_mod1 <- 'All'
newdatM$STUDY_ID <- 33
newdatM$std.error <- 0.03
newdatM$tempave <- newdatM$tempave.sc * scaling[var == 'tempave.sc', scale] + scaling[var == 'tempave.sc', center]
newdatM$temptrend <- newdatM$temptrend.sc * scaling[var == 'temptrend.sc', scale] + scaling[var == 'temptrend.sc', center]

newdatT <- expand.grid(tempave.sc = seq(-2.2, 1.3, length.out = 100), temptrend.sc = seq(-1.8, 3, length.out = 100))
newdatT$REALM <- 'Terrestrial'
newdatT$taxa_mod1 <- 'Terrestrial plants'
newdatT$STUDY_ID <- 18
newdatT$std.error <- 0.03
newdatT$tempave <- newdatT$tempave.sc * scaling[var == 'tempave.sc', scale] + scaling[var == 'tempave.sc', center]
newdatT$temptrend <- newdatT$temptrend.sc * scaling[var == 'temptrend.sc', scale] + scaling[var == 'temptrend.sc', center]

# predict
newdatM$slope <- predict(mod0alt_tempdata, newdata = newdatM, se.fit = FALSE, re.form = NA)
newdatT$slope <- predict(mod0alt_tempdata, newdata = newdatT, se.fit = FALSE, re.form = NA)

# plot
p1 <- ggplot(newdatM, aes(temptrend, tempave, z = slope)) +
    geom_raster(aes(fill = slope)) +
    labs(x = 'Temperature change (degC per year)', y = 'Long-term temperature (degC)', title = 'Marine') +
    scale_fill_gradient2(high= "#B2182B", mid = "white", low= "#2166AC", midpoint = 0) +
    theme(axis.text = element_text(size = 12), 
          axis.title = element_text(size = 14),
          panel.background = element_blank(),
          axis.line = element_line(colour = "black"),
          legend.position = "top",
          legend.margin = margin(c(0, 0.1, -20, 0)),
          legend.justification = c(0.92, 0.9),
          legend.text=element_text(size= 12),
          legend.title=element_text(size= 18),
          legend.title.align = 1)
p2 <- ggplot(newdatT, aes(temptrend, tempave, z = slope)) +
    geom_raster(aes(fill = slope)) +
    labs(x = 'Temperature change (degC per year)', y = 'Long-term temperature (degC)', title = 'Terrestrial') +
    scale_fill_gradient2(high= "#B2182B", mid = "white", low= "#2166AC", midpoint = 0) +
    theme(axis.text = element_text(size = 12), 
          axis.title = element_text(size = 14),
          panel.background = element_blank(),
          axis.line = element_line(colour = "black"),
          legend.position = "top",
          legend.margin = margin(c(0, 0.1, -20, 0)),
          legend.justification = c(0.92, 0.9),
          legend.text=element_text(size= 12),
          legend.title=element_text(size= 18),
          legend.title.align = 1)

p1
p2
```
## With abs(tempchange)
abs(tempchange) is favored substantially (deltaAIC 70) over tempchange. Coefficients are largely the same other than this major changw. 
```{r}
# realm-specific intercept. Simplify REs that were near zero.
mod3 <- glmmTMB(slope ~ 0 + REALM + new_sTempYear:REALM + abs(TempGAMCoef):REALM + abs(TempGAMCoef):new_sTempYear:REALM
                +(0 + abs(TempGAMCoef)|REALM/taxa_mod1) +(1|taxa_mod1/STUDY_ID), 
                disp = ~std.error*REALM,
                data = datS)


summary(mod3)
AIC(mod2)
AIC(mod3)
AIC(mod2) - AIC(mod3)


```

### Plot abs(tempchange) effects
```{r, echo = FALSE}
# set up prediction frame
newdatM <- expand.grid(new_sTempYear = seq(-2, 2.5, length.out = 100), TempGAMCoef = seq(-0.35, 0.35, length.out = 100))
newdatM$REALM <- 'Marine'
newdatM$taxa_mod1 <- 'All'
newdatM$STUDY_ID <- 33
newdatM$std.error <- 0.03
sdTM <- sd(datS$newtempvalues[datS$REALM == 'Marine'])
meanTM <- mean(datS$newtempvalues[datS$REALM == 'Marine'])
newdatM$newtempvalues <- newdatM$new_sTempYear * sdTM + meanTM

newdatT <- expand.grid(new_sTempYear = seq(-2.5, 2.7, length.out = 100), TempGAMCoef = seq(-0.3, 0.5, length.out = 100))
newdatT$REALM <- 'Terrestrial'
newdatT$taxa_mod1 <- 'Terrestrial plants'
newdatT$STUDY_ID <- 18
newdatT$std.error <- 0.03
sdTT <- sd(datS$newtempvalues[datS$REALM == 'Terrestrial'])
meanTT <- mean(datS$newtempvalues[datS$REALM == 'Terrestrial'])
newdatT$newtempvalues <- newdatT$new_sTempYear * sdTT + meanTT

# predict
newdatM$slope <- predict(mod3, newdata = newdatM, se.fit = FALSE, re.form = NA)
newdatT$slope <- predict(mod3, newdata = newdatT, se.fit = FALSE, re.form = NA)

# plot
p1 <- ggplot(newdatM, aes(TempGAMCoef, newtempvalues, z = slope)) +
    geom_raster(aes(fill = slope)) +
    labs(x = 'Temperature change (degC per year)', y = 'Long-term temperature (degC)', title = 'Marine') +
    scale_fill_gradient2(high= "#B2182B", mid = "white", low= "#2166AC", midpoint = 0) +
    theme(axis.text = element_text(size = 12), 
          axis.title = element_text(size = 14),
          panel.background = element_blank(),
          axis.line = element_line(colour = "black"),
          legend.position = "top",
          legend.margin = margin(c(0, 0.1, -20, 0)),
          legend.justification = c(0.92, 0.9),
          legend.text=element_text(size= 12),
          legend.title=element_text(size= 18),
          legend.title.align = 1)
p2 <- ggplot(newdatT, aes(TempGAMCoef, newtempvalues, z = slope)) +
    geom_raster(aes(fill = slope)) +
    labs(x = 'Temperature change (degC per year)', y = 'Long-term temperature (degC)', title = 'Terrestrial') +
    scale_fill_gradient2(high= "#B2182B", mid = "white", low= "#2166AC", midpoint = 0) +
    theme(axis.text = element_text(size = 12), 
          axis.title = element_text(size = 14),
          panel.background = element_blank(),
          axis.line = element_line(colour = "black"),
          legend.position = "top",
          legend.margin = margin(c(0, 0.1, -20, 0)),
          legend.justification = c(0.92, 0.9),
          legend.text=element_text(size= 12),
          legend.title=element_text(size= 18),
          legend.title.align = 1)

p1
p2
```

## Fit richness model with mass and human
```{r}
modMH0 <- glmmTMB(slope ~ 0 + REALM + mass.sc + human_bowler.sc:REALM 
                 + new_sTempYear:REALM + TempGAMCoef:REALM + TempGAMCoef:new_sTempYear:REALM
                +(0 + TempGAMCoef|REALM/taxa_mod1) +(1|taxa_mod1/STUDY_ID), 
                disp = ~std.error*REALM,
                data = combMHlogS)

summary(modMH0)

modMHFull <- glmmTMB(slope ~ 0 + REALM + mass.sc + human_bowler.sc:REALM +
                         new_sTempYear:REALM + new_sTempYear:mass.sc + new_sTempYear:human_bowler.sc:REALM + 
                         new_sTempYear:mass.sc:REALM + 
                         TempGAMCoef:REALM + TempGAMCoef:mass.sc + TempGAMCoef:human_bowler.sc:REALM + 
                         TempGAMCoef:mass.sc:REALM + 
                         TempGAMCoef:new_sTempYear:REALM
                     +(0 + TempGAMCoef|REALM/taxa_mod1) +(1|taxa_mod1/STUDY_ID), 
                     disp = ~std.error*REALM,
                     data = combMHlogS)

# modevalsMH <- dredge(modMHFull, evaluate = FALSE) # get the model calls
# length(modevalsMH) # how many to fit?
# modsMH <- mclapply(modevalsMH, eval, mc.cores = 25) # call in parallel
# #saveRDS(modsMH, file = here('temp', 'modsdredgeAntaoMH.rds'))
# 
# cl <- sapply(modsMH, class)
# keep <- which(cl == 'glmmTMB') # those that didn't throw an error
# sum(cl != 'glmmTMB') # 158
# ll <- sapply(modsMH[keep], logLik)
# sum(is.na(ll)) # number that didn't converge. 38
# keep2 <- keep[!is.na(ll)] # find models that converged (non-NA logLik)
# ai <- sapply(modsMH[keep2], AIC)
# sum(is.na(ai)) # no AIC value (0)
# keep3 <- keep2[!is.na(ai)]
# length(keep3)
# 
# modselMH <- model.sel(modsMH[keep3], rank = 'AIC', fit = FALSE)
# modselMH[modselMH$delta < 4,]
# 
# modavgMH <- model.avg(modsMH[keep3])
# summary(modavgMH)
# confint(modavgMH, full = TRUE)
# coefTable(modselMH[1,]) # coefficients from the top model
# importance(modavgMH) # relative variable importance

# a simpler model to capture the main effects
modMH1 <- glmmTMB(slope ~ 0 + REALM + mass.sc:REALM + human_bowler.sc:REALM +
                         new_sTempYear:REALM + new_sTempYear:human_bowler.sc:REALM + 
                         new_sTempYear:mass.sc:REALM + 
                         TempGAMCoef:REALM + TempGAMCoef:human_bowler.sc:REALM + 
                         TempGAMCoef:new_sTempYear:REALM
                     +(0 + TempGAMCoef|REALM/taxa_mod1) +(1|taxa_mod1/STUDY_ID), 
                     disp = ~std.error*REALM,
                     data = combMHlogS)

summary(modMH1)
```

# Fit a Jtu model
## Original Antao-style

- Just like the richness model, using Antao predictors, but with Jtu slope as the response. All durations.
- Results quite similar to the richness model for the marine realm (see plot)
- Continue to find MORE turnover with warming at higher average temperatures in marine (the interaction), like the richness and gains models.
- Terrestrial is positive slope everywhere, and temperature effects not significant

```{r}
# realm-specific intercept. Simplify REs that were near zero.
modJtuAll0 <- glmmTMB(disstrend ~ 0 + REALM + new_sTempYear:REALM + TempGAMCoef:REALM + TempGAMCoef:new_sTempYear:REALM
                +(0 + TempGAMCoef|REALM/taxa_mod1) +(1|taxa_mod1/STUDY_ID),
                disp = ~trendse*REALM,
                data = comb[measure == 'Jtu' & model_id == 'logS_lm',])


summary(modJtuAll0)
```

### Plot
```{r, echo = FALSE}
# set up prediction frame
newdatM <- expand.grid(new_sTempYear = seq(-2, 2.5, length.out = 100), TempGAMCoef = seq(-0.35, 0.35, length.out = 100))
newdatM$REALM <- 'Marine'
newdatM$taxa_mod1 <- 'All'
newdatM$STUDY_ID <- 33
newdatM$trendse <- 0.015
sdTM <- sd(datS$newtempvalues[datS$REALM == 'Marine'])
meanTM <- mean(datS$newtempvalues[datS$REALM == 'Marine'])
newdatM$newtempvalues <- newdatM$new_sTempYear * sdTM + meanTM

newdatT <- expand.grid(new_sTempYear = seq(-2.5, 2.7, length.out = 100), TempGAMCoef = seq(-0.3, 0.5, length.out = 100))
newdatT$REALM <- 'Terrestrial'
newdatT$taxa_mod1 <- 'Terrestrial plants'
newdatT$STUDY_ID <- 18
newdatT$trendse <- 0.015
sdTT <- sd(datS$newtempvalues[datS$REALM == 'Terrestrial'])
meanTT <- mean(datS$newtempvalues[datS$REALM == 'Terrestrial'])
newdatT$newtempvalues <- newdatT$new_sTempYear * sdTT + meanTT

# predict
newdatM$slope <- predict(modJtuAll0, newdata = newdatM, se.fit = FALSE, re.form = NA)
newdatT$slope <- predict(modJtuAll0, newdata = newdatT, se.fit = FALSE, re.form = NA)

# plot
p1 <- ggplot(newdatM, aes(TempGAMCoef, newtempvalues, z = slope)) +
    geom_raster(aes(fill = slope)) +
    labs(x = 'Temperature change (degC per year)', y = 'Long-term temperature (degC)', title = 'Marine') +
    scale_fill_gradient2(high= "#B2182B", mid = "white", low= "#2166AC", midpoint = 0) +
    theme(axis.text = element_text(size = 12), 
          axis.title = element_text(size = 14),
          panel.background = element_blank(),
          axis.line = element_line(colour = "black"),
          legend.position = "top",
          legend.margin = margin(c(0, 0.1, -20, 0)),
          legend.justification = c(0.92, 0.9),
          legend.text=element_text(size= 12),
          legend.title=element_text(size= 18),
          legend.title.align = 1)
p2 <- ggplot(newdatT, aes(TempGAMCoef, newtempvalues, z = slope)) +
    geom_raster(aes(fill = slope)) +
    labs(x = 'Temperature change (degC per year)', y = 'Long-term temperature (degC)', title = 'Terrestrial') +
    scale_fill_gradient2(high= "#B2182B", mid = "white", low= "#2166AC", midpoint = 0) +
    theme(axis.text = element_text(size = 12), 
          axis.title = element_text(size = 14),
          panel.background = element_blank(),
          axis.line = element_line(colour = "black"),
          legend.position = "top",
          legend.margin = margin(c(0, 0.1, -20, 0)),
          legend.justification = c(0.92, 0.9),
          legend.text=element_text(size= 12),
          legend.title=element_text(size= 18),
          legend.title.align = 1)

p1
p2
```
## abs(temptrend)
AIC selects abs(temptrend) by deltaAIC 8. Results are now quite different from the richness model: 

- less turnover at higher temperatures in marine (warming or cooling)
- less turnover at faster temperature change in marine (temperatures > 17degC)
- less turnover at higher temperatures per unit temperature change (interaction)

```{r}
# realm-specific intercept. Simplify REs that were near zero.
modJtuAll1 <- glmmTMB(disstrend ~ 0 + REALM + new_sTempYear:REALM + abs(TempGAMCoef):REALM + abs(TempGAMCoef):new_sTempYear:REALM
                +(0 + abs(TempGAMCoef)|REALM/taxa_mod1) +(1|taxa_mod1/STUDY_ID),
                disp = ~trendse*REALM,
                data = comb[measure == 'Jtu' & model_id == 'logS_lm',])


summary(modJtuAll1)
AIC(modJtuAll0)
AIC(modJtuAll1)
AIC(modJtuAll0) - AIC(modJtuAll1)
```

### Plot
```{r, echo = FALSE}
# set up prediction frame
newdatM <- expand.grid(new_sTempYear = seq(-2, 2.5, length.out = 100), TempGAMCoef = seq(-0.35, 0.35, length.out = 100))
newdatM$REALM <- 'Marine'
newdatM$taxa_mod1 <- 'All'
newdatM$STUDY_ID <- 33
newdatM$trendse <- 0.015
sdTM <- sd(datS$newtempvalues[datS$REALM == 'Marine'])
meanTM <- mean(datS$newtempvalues[datS$REALM == 'Marine'])
newdatM$newtempvalues <- newdatM$new_sTempYear * sdTM + meanTM

newdatT <- expand.grid(new_sTempYear = seq(-2.5, 2.7, length.out = 100), TempGAMCoef = seq(-0.3, 0.5, length.out = 100))
newdatT$REALM <- 'Terrestrial'
newdatT$taxa_mod1 <- 'Terrestrial plants'
newdatT$STUDY_ID <- 18
newdatT$trendse <- 0.015
sdTT <- sd(datS$newtempvalues[datS$REALM == 'Terrestrial'])
meanTT <- mean(datS$newtempvalues[datS$REALM == 'Terrestrial'])
newdatT$newtempvalues <- newdatT$new_sTempYear * sdTT + meanTT

# predict
newdatM$slope <- predict(modJtuAll1, newdata = newdatM, se.fit = FALSE, re.form = NA)
newdatT$slope <- predict(modJtuAll1, newdata = newdatT, se.fit = FALSE, re.form = NA)

# plot
p1 <- ggplot(newdatM, aes(TempGAMCoef, newtempvalues, z = slope)) +
    geom_raster(aes(fill = slope)) +
    labs(x = 'Temperature change (degC per year)', y = 'Long-term temperature (degC)', title = 'Marine') +
    scale_fill_gradient2(high= "#B2182B", mid = "white", low= "#2166AC", midpoint = 0) +
    theme(axis.text = element_text(size = 12), 
          axis.title = element_text(size = 14),
          panel.background = element_blank(),
          axis.line = element_line(colour = "black"),
          legend.position = "top",
          legend.margin = margin(c(0, 0.1, -20, 0)),
          legend.justification = c(0.92, 0.9),
          legend.text=element_text(size= 12),
          legend.title=element_text(size= 18),
          legend.title.align = 1)
p2 <- ggplot(newdatT, aes(TempGAMCoef, newtempvalues, z = slope)) +
    geom_raster(aes(fill = slope)) +
    labs(x = 'Temperature change (degC per year)', y = 'Long-term temperature (degC)', title = 'Terrestrial') +
    scale_fill_gradient2(high= "#B2182B", mid = "white", low= "#2166AC", midpoint = 0) +
    theme(axis.text = element_text(size = 12), 
          axis.title = element_text(size = 14),
          panel.background = element_blank(),
          axis.line = element_line(colour = "black"),
          legend.position = "top",
          legend.margin = margin(c(0, 0.1, -20, 0)),
          legend.justification = c(0.92, 0.9),
          legend.text=element_text(size= 12),
          legend.title=element_text(size= 18),
          legend.title.align = 1)

p1
p2
```

## 5-year standardized duration

- Only for datasets of exactly 5 consecutive years
- Only realm intercepts are significantly different from zero

```{r}
modJtu5 <- glmmTMB(disstrend ~ 0 + REALM + new_sTempYear:REALM + TempGAMCoef:REALM + TempGAMCoef:new_sTempYear:REALM
                +(0 + TempGAMCoef|REALM/taxa_mod1) +(1|taxa_mod1/STUDY_ID),
                disp = ~trendse*REALM,
                data = comb5[measure == 'Jtu',])


summary(modJtu5)
```

### Plot
```{r, echo = FALSE}
# set up prediction frame
newdatM <- expand.grid(new_sTempYear = seq(-2, 2.5, length.out = 100), TempGAMCoef = seq(-0.35, 0.35, length.out = 100))
newdatM$REALM <- 'Marine'
newdatM$taxa_mod1 <- 'All'
newdatM$STUDY_ID <- 33
newdatM$trendse <- 0.015
sdTM <- sd(datS$newtempvalues[datS$REALM == 'Marine'])
meanTM <- mean(datS$newtempvalues[datS$REALM == 'Marine'])
newdatM$newtempvalues <- newdatM$new_sTempYear * sdTM + meanTM

newdatT <- expand.grid(new_sTempYear = seq(-2.5, 2.7, length.out = 100), TempGAMCoef = seq(-0.3, 0.5, length.out = 100))
newdatT$REALM <- 'Terrestrial'
newdatT$taxa_mod1 <- 'Terrestrial plants'
newdatT$STUDY_ID <- 18
newdatT$trendse <- 0.015
sdTT <- sd(datS$newtempvalues[datS$REALM == 'Terrestrial'])
meanTT <- mean(datS$newtempvalues[datS$REALM == 'Terrestrial'])
newdatT$newtempvalues <- newdatT$new_sTempYear * sdTT + meanTT

# predict
newdatM$slope <- predict(modJtu5, newdata = newdatM, se.fit = FALSE, re.form = NA)
newdatT$slope <- predict(modJtu5, newdata = newdatT, se.fit = FALSE, re.form = NA)

# plot
p1 <- ggplot(newdatM, aes(TempGAMCoef, newtempvalues, z = slope)) +
    geom_raster(aes(fill = slope)) +
    labs(x = 'Temperature change (degC per year)', y = 'Long-term temperature (degC)', title = 'Marine') +
    scale_fill_gradient2(high= "#B2182B", mid = "white", low= "#2166AC", midpoint = 0) +
    theme(axis.text = element_text(size = 12), 
          axis.title = element_text(size = 14),
          panel.background = element_blank(),
          axis.line = element_line(colour = "black"),
          legend.position = "top",
          legend.margin = margin(c(0, 0.1, -20, 0)),
          legend.justification = c(0.92, 0.9),
          legend.text=element_text(size= 12),
          legend.title=element_text(size= 18),
          legend.title.align = 1)
p2 <- ggplot(newdatT, aes(TempGAMCoef, newtempvalues, z = slope)) +
    geom_raster(aes(fill = slope)) +
    labs(x = 'Temperature change (degC per year)', y = 'Long-term temperature (degC)', title = 'Terrestrial') +
    scale_fill_gradient2(high= "#B2182B", mid = "white", low= "#2166AC", midpoint = 0) +
    theme(axis.text = element_text(size = 12), 
          axis.title = element_text(size = 14),
          panel.background = element_blank(),
          axis.line = element_line(colour = "black"),
          legend.position = "top",
          legend.margin = margin(c(0, 0.1, -20, 0)),
          legend.justification = c(0.92, 0.9),
          legend.text=element_text(size= 12),
          legend.title=element_text(size= 18),
          legend.title.align = 1)

p1
p2
```

# Fit a Jbeta model
## Original

- Much like the richness model, using Antao predictors, but with Jbeta slope as the response. Dropped the REALM random slope to allow convergence.
- Positive temp:temptrend interaction, just like richness and gains models.

```{r}
# realm-specific intercept. Simplify REs that were near zero.
modJbetaAll0 <- glmmTMB(disstrend ~ 0 + REALM + new_sTempYear:REALM + TempGAMCoef:REALM + TempGAMCoef:new_sTempYear:REALM
                +(0 + TempGAMCoef|REALM:taxa_mod1) +(1|taxa_mod1/STUDY_ID),
                disp = ~trendse*REALM,
                data = comb[measure == 'Jbeta' & model_id == 'logS_lm',])

summary(modJbetaAll0)
```

### Plot
```{r, echo = FALSE}
# set up prediction frame
newdatM <- expand.grid(new_sTempYear = seq(-2, 2.5, length.out = 100), TempGAMCoef = seq(-0.35, 0.35, length.out = 100))
newdatM$REALM <- 'Marine'
newdatM$taxa_mod1 <- 'All'
newdatM$STUDY_ID <- 33
newdatM$trendse <- 0.015
sdTM <- sd(datS$newtempvalues[datS$REALM == 'Marine'])
meanTM <- mean(datS$newtempvalues[datS$REALM == 'Marine'])
newdatM$newtempvalues <- newdatM$new_sTempYear * sdTM + meanTM

newdatT <- expand.grid(new_sTempYear = seq(-2.5, 2.7, length.out = 100), TempGAMCoef = seq(-0.3, 0.5, length.out = 100))
newdatT$REALM <- 'Terrestrial'
newdatT$taxa_mod1 <- 'Terrestrial plants'
newdatT$STUDY_ID <- 18
newdatT$trendse <- 0.015
sdTT <- sd(datS$newtempvalues[datS$REALM == 'Terrestrial'])
meanTT <- mean(datS$newtempvalues[datS$REALM == 'Terrestrial'])
newdatT$newtempvalues <- newdatT$new_sTempYear * sdTT + meanTT

# predict
newdatM$slope <- predict(modJbetaAll0, newdata = newdatM, se.fit = FALSE, re.form = NA)
newdatT$slope <- predict(modJbetaAll0, newdata = newdatT, se.fit = FALSE, re.form = NA)

# plot
p1 <- ggplot(newdatM, aes(TempGAMCoef, newtempvalues, z = slope)) +
    geom_raster(aes(fill = slope)) +
    labs(x = 'Temperature change (degC per year)', y = 'Long-term temperature (degC)', title = 'Marine') +
    scale_fill_gradient2(high= "#B2182B", mid = "white", low= "#2166AC", midpoint = 0) +
    theme(axis.text = element_text(size = 12), 
          axis.title = element_text(size = 14),
          panel.background = element_blank(),
          axis.line = element_line(colour = "black"),
          legend.position = "top",
          legend.margin = margin(c(0, 0.1, -20, 0)),
          legend.justification = c(0.92, 0.9),
          legend.text=element_text(size= 12),
          legend.title=element_text(size= 18),
          legend.title.align = 1)
p2 <- ggplot(newdatT, aes(TempGAMCoef, newtempvalues, z = slope)) +
    geom_raster(aes(fill = slope)) +
    labs(x = 'Temperature change (degC per year)', y = 'Long-term temperature (degC)', title = 'Terrestrial') +
    scale_fill_gradient2(high= "#B2182B", mid = "white", low= "#2166AC", midpoint = 0) +
    theme(axis.text = element_text(size = 12), 
          axis.title = element_text(size = 14),
          panel.background = element_blank(),
          axis.line = element_line(colour = "black"),
          legend.position = "top",
          legend.margin = margin(c(0, 0.1, -20, 0)),
          legend.justification = c(0.92, 0.9),
          legend.text=element_text(size= 12),
          legend.title=element_text(size= 18),
          legend.title.align = 1)

p1
p2
```


## abs(temptrend)
Results are now entirely different than richness model: 

- Strongly selects abs(temptrend) over temptrend
- less turnover at higher temperatures in marine
- less turnover at faster temperature change in marine
- less turnover at higher temperatures per unit temperature change (interaction)

```{r}
# realm-specific intercept. Simplify REs that were near zero.
modJbetaAll1 <- glmmTMB(disstrend ~ 0 + REALM + new_sTempYear:REALM + abs(TempGAMCoef):REALM + abs(TempGAMCoef):new_sTempYear:REALM
                +(0 + abs(TempGAMCoef)|REALM:taxa_mod1) +(1|taxa_mod1/STUDY_ID),
                disp = ~trendse*REALM,
                data = comb[measure == 'Jbeta' & model_id == 'logS_lm',])


summary(modJbetaAll1)
AIC(modJbetaAll0)
AIC(modJbetaAll1)
```


## 5-year duration, annual samples

- Only for datasets of exactly 5 consecutive years
- Had to drop the random slopes to allow convergence (were very close to 0)
- Only realm intercepts are significantly different from zero

```{r}
modJbeta5 <- glmmTMB(disstrend ~ 0 + REALM + new_sTempYear:REALM + TempGAMCoef:REALM + TempGAMCoef:new_sTempYear:REALM
                 +(1|taxa_mod1/STUDY_ID),
                disp = ~trendse*REALM,
                data = comb5[measure == 'Jbeta',])


summary(modJbeta5)
```

### Plot
```{r, echo = FALSE}
# set up prediction frame
newdatM <- expand.grid(new_sTempYear = seq(-2, 2.5, length.out = 100), TempGAMCoef = seq(-0.35, 0.35, length.out = 100))
newdatM$REALM <- 'Marine'
newdatM$taxa_mod1 <- 'All'
newdatM$STUDY_ID <- 33
newdatM$trendse <- 0.015
sdTM <- sd(datS$newtempvalues[datS$REALM == 'Marine'])
meanTM <- mean(datS$newtempvalues[datS$REALM == 'Marine'])
newdatM$newtempvalues <- newdatM$new_sTempYear * sdTM + meanTM

newdatT <- expand.grid(new_sTempYear = seq(-2.5, 2.7, length.out = 100), TempGAMCoef = seq(-0.3, 0.5, length.out = 100))
newdatT$REALM <- 'Terrestrial'
newdatT$taxa_mod1 <- 'Terrestrial plants'
newdatT$STUDY_ID <- 18
newdatT$trendse <- 0.015
sdTT <- sd(datS$newtempvalues[datS$REALM == 'Terrestrial'])
meanTT <- mean(datS$newtempvalues[datS$REALM == 'Terrestrial'])
newdatT$newtempvalues <- newdatT$new_sTempYear * sdTT + meanTT

# predict
newdatM$slope <- predict(modJbeta5, newdata = newdatM, se.fit = FALSE, re.form = NA)
newdatT$slope <- predict(modJbeta5, newdata = newdatT, se.fit = FALSE, re.form = NA)

# plot
p1 <- ggplot(newdatM, aes(TempGAMCoef, newtempvalues, z = slope)) +
    geom_raster(aes(fill = slope)) +
    labs(x = 'Temperature change (degC per year)', y = 'Long-term temperature (degC)', title = 'Marine') +
    scale_fill_gradient2(high= "#B2182B", mid = "white", low= "#2166AC", midpoint = 0) +
    theme(axis.text = element_text(size = 12), 
          axis.title = element_text(size = 14),
          panel.background = element_blank(),
          axis.line = element_line(colour = "black"),
          legend.position = "top",
          legend.margin = margin(c(0, 0.1, -20, 0)),
          legend.justification = c(0.92, 0.9),
          legend.text=element_text(size= 12),
          legend.title=element_text(size= 18),
          legend.title.align = 1)
p2 <- ggplot(newdatT, aes(TempGAMCoef, newtempvalues, z = slope)) +
    geom_raster(aes(fill = slope)) +
    labs(x = 'Temperature change (degC per year)', y = 'Long-term temperature (degC)', title = 'Terrestrial') +
    scale_fill_gradient2(high= "#B2182B", mid = "white", low= "#2166AC", midpoint = 0) +
    theme(axis.text = element_text(size = 12), 
          axis.title = element_text(size = 14),
          panel.background = element_blank(),
          axis.line = element_line(colour = "black"),
          legend.position = "top",
          legend.margin = margin(c(0, 0.1, -20, 0)),
          legend.justification = c(0.92, 0.9),
          legend.text=element_text(size= 12),
          legend.title=element_text(size= 18),
          legend.title.align = 1)

p1
p2
```

## 5-year duration, min3 samples

- Only for datasets of exactly 5 year duration with at least 3 samples
- Effect is now the opposite of non-standardized (see interaction term for marine)

```{r}
modJbeta5min3 <- glmmTMB(disstrend ~ 0 + REALM + new_sTempYear:REALM + TempGAMCoef:REALM + TempGAMCoef:new_sTempYear:REALM
                 +(1|taxa_mod1/STUDY_ID),
                disp = ~trendse*REALM,
                data = comb5min3[measure == 'Jbeta',])


summary(modJbeta5min3)
```

### Plot
```{r, echo = FALSE}
# set up prediction frame
newdatM <- expand.grid(new_sTempYear = seq(-2, 2.5, length.out = 100), TempGAMCoef = seq(-0.35, 0.35, length.out = 100))
newdatM$REALM <- 'Marine'
newdatM$taxa_mod1 <- 'All'
newdatM$STUDY_ID <- 33
newdatM$trendse <- 0.015
sdTM <- sd(datS$newtempvalues[datS$REALM == 'Marine'])
meanTM <- mean(datS$newtempvalues[datS$REALM == 'Marine'])
newdatM$newtempvalues <- newdatM$new_sTempYear * sdTM + meanTM

newdatT <- expand.grid(new_sTempYear = seq(-2.5, 2.7, length.out = 100), TempGAMCoef = seq(-0.3, 0.5, length.out = 100))
newdatT$REALM <- 'Terrestrial'
newdatT$taxa_mod1 <- 'Terrestrial plants'
newdatT$STUDY_ID <- 18
newdatT$trendse <- 0.015
sdTT <- sd(datS$newtempvalues[datS$REALM == 'Terrestrial'])
meanTT <- mean(datS$newtempvalues[datS$REALM == 'Terrestrial'])
newdatT$newtempvalues <- newdatT$new_sTempYear * sdTT + meanTT

# predict
newdatM$slope <- predict(modJbeta5min3, newdata = newdatM, se.fit = FALSE, re.form = NA)
newdatT$slope <- predict(modJbeta5min3, newdata = newdatT, se.fit = FALSE, re.form = NA)

# plot
p1 <- ggplot(newdatM, aes(TempGAMCoef, newtempvalues, z = slope)) +
    geom_raster(aes(fill = slope)) +
    labs(x = 'Temperature change (degC per year)', y = 'Long-term temperature (degC)', title = 'Marine') +
    scale_fill_gradient2(high= "#B2182B", mid = "white", low= "#2166AC", midpoint = 0) +
    theme(axis.text = element_text(size = 12), 
          axis.title = element_text(size = 14),
          panel.background = element_blank(),
          axis.line = element_line(colour = "black"),
          legend.position = "top",
          legend.margin = margin(c(0, 0.1, -20, 0)),
          legend.justification = c(0.92, 0.9),
          legend.text=element_text(size= 12),
          legend.title=element_text(size= 18),
          legend.title.align = 1)
p2 <- ggplot(newdatT, aes(TempGAMCoef, newtempvalues, z = slope)) +
    geom_raster(aes(fill = slope)) +
    labs(x = 'Temperature change (degC per year)', y = 'Long-term temperature (degC)', title = 'Terrestrial') +
    scale_fill_gradient2(high= "#B2182B", mid = "white", low= "#2166AC", midpoint = 0) +
    theme(axis.text = element_text(size = 12), 
          axis.title = element_text(size = 14),
          panel.background = element_blank(),
          axis.line = element_line(colour = "black"),
          legend.position = "top",
          legend.margin = margin(c(0, 0.1, -20, 0)),
          legend.justification = c(0.92, 0.9),
          legend.text=element_text(size= 12),
          legend.title=element_text(size= 18),
          legend.title.align = 1)

p1
p2
```

## 10-year duration, min3 samples

- Only for datasets of exactly 10 year duration with at least 3 samples
- Had to drop the random slopes to allow convergence (were very close to 0)
- Only realm intercepts are significantly different from zero

```{r}
modJbeta10min3 <- glmmTMB(disstrend ~ 0 + REALM + new_sTempYear:REALM + TempGAMCoef:REALM + TempGAMCoef:new_sTempYear:REALM
                 +(1|taxa_mod1/STUDY_ID),
                disp = ~trendse*REALM,
                data = comb10min3[measure == 'Jbeta',])


summary(modJbeta10min3)
```

### Plot
```{r, echo = FALSE}
# set up prediction frame
newdatM <- expand.grid(new_sTempYear = seq(-2, 2.5, length.out = 100), TempGAMCoef = seq(-0.35, 0.35, length.out = 100))
newdatM$REALM <- 'Marine'
newdatM$taxa_mod1 <- 'All'
newdatM$STUDY_ID <- 33
newdatM$trendse <- 0.015
sdTM <- sd(datS$newtempvalues[datS$REALM == 'Marine'])
meanTM <- mean(datS$newtempvalues[datS$REALM == 'Marine'])
newdatM$newtempvalues <- newdatM$new_sTempYear * sdTM + meanTM

newdatT <- expand.grid(new_sTempYear = seq(-2.5, 2.7, length.out = 100), TempGAMCoef = seq(-0.3, 0.5, length.out = 100))
newdatT$REALM <- 'Terrestrial'
newdatT$taxa_mod1 <- 'Terrestrial plants'
newdatT$STUDY_ID <- 18
newdatT$trendse <- 0.015
sdTT <- sd(datS$newtempvalues[datS$REALM == 'Terrestrial'])
meanTT <- mean(datS$newtempvalues[datS$REALM == 'Terrestrial'])
newdatT$newtempvalues <- newdatT$new_sTempYear * sdTT + meanTT

# predict
newdatM$slope <- predict(modJbeta10min3, newdata = newdatM, se.fit = FALSE, re.form = NA)
newdatT$slope <- predict(modJbeta10min3, newdata = newdatT, se.fit = FALSE, re.form = NA)

# plot
p1 <- ggplot(newdatM, aes(TempGAMCoef, newtempvalues, z = slope)) +
    geom_raster(aes(fill = slope)) +
    labs(x = 'Temperature change (degC per year)', y = 'Long-term temperature (degC)', title = 'Marine') +
    scale_fill_gradient2(high= "#B2182B", mid = "white", low= "#2166AC", midpoint = 0) +
    theme(axis.text = element_text(size = 12), 
          axis.title = element_text(size = 14),
          panel.background = element_blank(),
          axis.line = element_line(colour = "black"),
          legend.position = "top",
          legend.margin = margin(c(0, 0.1, -20, 0)),
          legend.justification = c(0.92, 0.9),
          legend.text=element_text(size= 12),
          legend.title=element_text(size= 18),
          legend.title.align = 1)
p2 <- ggplot(newdatT, aes(TempGAMCoef, newtempvalues, z = slope)) +
    geom_raster(aes(fill = slope)) +
    labs(x = 'Temperature change (degC per year)', y = 'Long-term temperature (degC)', title = 'Terrestrial') +
    scale_fill_gradient2(high= "#B2182B", mid = "white", low= "#2166AC", midpoint = 0) +
    theme(axis.text = element_text(size = 12), 
          axis.title = element_text(size = 14),
          panel.background = element_blank(),
          axis.line = element_line(colour = "black"),
          legend.position = "top",
          legend.margin = margin(c(0, 0.1, -20, 0)),
          legend.justification = c(0.92, 0.9),
          legend.text=element_text(size= 12),
          legend.title=element_text(size= 18),
          legend.title.align = 1)

p1
p2
```

## Standardized durations, min3 samples

- To do: All durations in one model, but allow slopes to differ by duration

```{r}
# modJbetaXmin3 <- glmmTMB(disstrend ~ 0 + REALM + new_sTempYear:REALM + TempGAMCoef:REALM + TempGAMCoef:new_sTempYear:REALM
#                  +(1|taxa_mod1/STUDY_ID),
#                 disp = ~trendse*REALM,
#                 data = comb10min3[measure == 'Jbeta',])


#summary(modJbetaXmin3)
```


# Fit a Horn model
## Original

- Like the richness model, using Antao predictors, but with Horn slope as the response. Had to drop the REALM random slope to allow convergence.
- Now find LESS turnover at higher temperature in marine (opposite of richness and gains slope models).
- Find more turnover with changing temperatures at higher average temperatures in TERRESTRIAL (the interaction), not marine. Not like the richness and gains models.

```{r}
# realm-specific intercept. Simplify REs that were near zero.
modHornAll0 <- glmmTMB(disstrend ~ 0 + REALM + new_sTempYear:REALM + TempGAMCoef:REALM + TempGAMCoef:new_sTempYear:REALM
                +(0 + TempGAMCoef|taxa_mod1) +(1|taxa_mod1/STUDY_ID),
                disp = ~trendse*REALM,
                data = comb[measure == 'Horn' & model_id == 'logS_lm',])


summary(modHornAll0)
```

## abs(temptrend)
AIC selects temptrend instead of abs(temptrend). Results are entirely different than richness model: 

- LESS turnover at higher temperatures in marine
- LESS turnover at higher temperatures per unit temperature change in marine (interaction)
- more turnover per unit temperature change in TERRESTRIAL

```{r}
# realm-specific intercept. Simplify REs that were near zero.
modHornAll1 <- glmmTMB(disstrend ~ 0 + REALM + new_sTempYear:REALM + abs(TempGAMCoef):REALM + abs(TempGAMCoef):new_sTempYear:REALM
                +(0 + abs(TempGAMCoef)|taxa_mod1) +(1|taxa_mod1/STUDY_ID),
                disp = ~trendse*REALM,
                data = comb[measure == 'Horn' & model_id == 'logS_lm',])


summary(modHornAll1)
AIC(modHornAll0)
AIC(modHornAll1)
```


## 5-year standardized duration

- Only for datasets of exactly 5 consecutive years. Removed random slope to allow convergence (was close to 0)
- Only realm intercepts are significantly different from zero

```{r}
modHorn5 <- glmmTMB(disstrend ~ 0 + REALM + new_sTempYear:REALM + TempGAMCoef:REALM + TempGAMCoef:new_sTempYear:REALM
                +(1|taxa_mod1/STUDY_ID),
                disp = ~trendse*REALM,
                data = comb5[measure == 'Horn',])


summary(modHorn5)
```
