---
title: "Gains/losses and turnover rate"
output: 
    github_document: default
---
Do the proportion of gains and losses differ by realm, temperature state, or microclimate heterogeneity?

```{r setup, include=FALSE}
library(data.table) # for handling large datasets
library(ggplot2) # for some plotting
library(glmmTMB) # for beta regression
library(here) # for navigating directories in the repo
if(Sys.info()['nodename'] == 'annotate.sebs.rutgers.edu'){
  library('mgcv', lib.loc = '/usr/lib64/R/library') # when running on Annotate. Need to load 1.8-26, not 1.8-33, for geom_smooth() in ggplot
} else {
  library('mgcv')
}
source(here('code', 'util.R')) # simple utility functions

# tell RStudio to use project root directory as the root for this notebook. Needed since we are storing code in a separate directory.
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file()) 

```

# Load data and set up
```{r}
# gains and losses data
load('data/biotime_blowes/bt-rarefy-collate.Rdata') # loads rarefied_alpha_medians and rarefied_beta_medians
rarefied_alpha_medians <- as.data.table(rarefied_alpha_medians)
rarefied_beta_medians <- as.data.table(rarefied_beta_medians)

# biotime community dissimilarity data
bt <- fread('output/turnover_w_covariates.csv.gz') # the timeseries that pass QA/QC. from assemble_turnover_covariates.Rmd
nrow(bt)

# add initial dissimilarities to dissimilarity data
bt[, minduration := min(duration), by = rarefyID]
initdiss <- bt[duration == minduration, .(Jtu.init = mean(Jtu.sc)), by = .(rarefyID)] # initial dissimilarities
bt <- merge(bt, initdiss[, .(rarefyID, Jtu.init)])
nrow(bt)

# add gains and losses to dissimilarity data
bt <- merge(bt, rarefied_alpha_medians[, .(rarefyID, year1 = YEAR, S1 = S)], by = c('rarefyID', 'year1')) # merge in num species in first year
bt <- merge(bt, rarefied_alpha_medians[, .(rarefyID, year2 = YEAR, S2 = S)], by = c('rarefyID', 'year2')) # and second year
bt <- merge(bt, rarefied_beta_medians[, .(rarefyID, year1 = as.numeric(YEAR1), year2 = as.numeric(YEAR2), gains, losses)], by = c('rarefyID', 'year1', 'year2')) # merge in num gains and losses. not clear why YEAR1 and YEAR2 got read as characters, but coercing to numeric seems fine.
nrow(bt)

# missing some gains and losses
bt[, sum(is.na(gains))]
bt[, sum(is.na(losses))]

# make a long version of gains/losses summarized by rarefyID for plotting
btgainloss <- rbind(bt[, .(prop = mean(gains/S1), type = 'gain'), by = .(REALM, tempchange_abs = abs(tempchange), microclim.sc, rarefyID)],
                    bt[, .(prop = mean(losses/S1), type = 'loss'), by = .(REALM, tempchange_abs = abs(tempchange), microclim.sc, rarefyID)],
                    bt[, .(prop = mean(gains/losses), type = 'gainlossratio'), by = .(REALM, tempchange_abs = abs(tempchange), microclim.sc, rarefyID)])

# turnover rate (slope of dissimilarity vs. time)
trends <- fread('output/slope.csv.gz') # linear slopes. from calc_turnover.R

# add turnover rate to initdiss
trends <- merge(initdiss, trends[measure == 'Jtu' & duration_group == 'All'], by = 'rarefyID')
nrow(trends)

# add gains/losses to initdiss
trends <- merge(trends, bt[, .(gainlossprop = mean(gains/losses)), by = .(rarefyID)])
nrow(trends)
```

# Examine gainloss differences across the dataset
## By realm
### Plot
Terrestrial tends to have a smaller proportion of gains and of losses
```{r}
# plots
ggplot(btgainloss[type %in% c('gain', 'loss')], aes(REALM, prop)) +
  geom_boxplot() +
  scale_y_log10() + 
  facet_wrap(~type)

```

```{r}
ggplot(btgainloss[type == 'gainlossratio'], aes(REALM, prop)) +
  geom_boxplot() +
  scale_y_log10() + 
  facet_wrap(~type) +
  labs(y = 'Gain-loss ratio')

```

### Stats
Nonparametric test of gains by realm.
```{r}
kruskal.test(prop ~ REALM, data = btgainloss[type == 'gain' & is.finite(prop), .(prop, REALM = as.factor(REALM))])

```

Nonparametric test of losses by realm.
```{r}
kruskal.test(prop ~ REALM, data = btgainloss[type == 'loss' & is.finite(prop), .(prop, REALM = as.factor(REALM))])

```
Nonparametric test of gains vs. losses by realm.
```{r}
kruskal.test(prop ~ REALM, data = btgainloss[type == 'gainlossratio' & is.finite(prop), .(prop, REALM = as.factor(REALM))])

```

## By tempchange_abs
### Plot
```{r}
ggplot(btgainloss[type == 'gainlossratio' & !is.na(tempchange_abs)], aes(tempchange_abs, prop)) +
  geom_point(alpha = 0.3) +
  geom_smooth() +
  scale_y_log10() + 
  scale_x_sqrt() + 
  facet_wrap(~type) +
  labs(y = 'Gain-loss ratio')

```
### Stats
Nonparametric test of gains vs. losses by tempchange_abs. Suggests slightly more losses at faster temperature change.
```{r}
cor.test(~ prop + tempchange_abs, method = 'spearman', data = btgainloss[type == 'gainlossratio' & is.finite(prop)])

```

## By microclim
### Plot
```{r}
ggplot(btgainloss[type == 'gainlossratio' & !is.na(microclim.sc)], aes(microclim.sc, prop)) +
  geom_point(alpha = 0.3) +
  geom_smooth() +
  scale_y_log10() + 
  facet_wrap(~type) +
  labs(y = 'Gain-loss ratio')

```
### Stats
Nonparametric test of gains vs. losses by microclim. Suggests ...
```{r}
cor.test(~ prop + microclim.sc, method = 'spearman', data = btgainloss[type == 'gainlossratio' & is.finite(prop)])

```
## Interaction of gains/losses with initial dissimilarity
### Plot
More losses to the left, more gains to the right. Don't see any clear evidence for the hypothesis that losses have a big impact when initial dissimilarity is low.
```{r}
ggplot(trends, aes(gainlossprop, disstrend, color = year2 - year1)) + 
    geom_point(alpha = 0.5) +
    geom_smooth() +
  geom_vline(xintercept = 1, linetype = 'dashed') +
  facet_wrap(~cut(Jtu.init, breaks = 4), scales = "free_y") +
  scale_color_gradient(trans = 'log10') +
  scale_x_log10()
 
```

# Examine Tchange models with gainlossprop
Fit by code/turnover_vs_temperature_GLMM_fit_Jtu.gainloss.R.
## Load models
```{r}
# with gainlossprop for Table 1
if(!exists('modGainLossAllJtu')) modGainLossAllJtu <- readRDS(here('temp', 'modGainLossAllJtu.rds')) # Null
#if(!exists('modRealmGainLossAllJtu')) modRealmGainLossAllJtu <- readRDS('temp/modRealmGainLossAllJtu.rds') # Realm. 
#if(!exists('modTaxamod2GainLossAllJtu')) modTaxamod2GainLossAllJtu <- readRDS('temp/modTaxamod2GainLossAllJtu.rds') # Taxon. 
#if(!exists('modsdTtsignGainLossAllJtu')) modsdTtsignGainLossAllJtu <- readRDS(here('temp', 'modsdTtsignGainLossAllJtu.rds')) # tsign, tempchange_abs.
if(!exists('modsdTRealmtsignGainLossAllJtu')) modsdTRealmtsignGainLossAllJtu <- readRDS(here('temp', 'modsdTRealmtsignGainLossAllJtu.rds')) # tsign:tempchange_abs by realm. 
#if(!exists('modabsLatsdTabsLatRealmtsignGainLossAllJtu')) modabsLatsdTabsLatRealmtsignGainLossAllJtu <- readRDS(here('temp', 'modabsLatsdTabsLatRealmtsignGainLossAllJtu.rds')) # tsign:tempchange_abs:absLat. Not yet included since not fit yet
if(!exists('modrawTsdTTRealmtsignGainLossAllJtu')) modrawTsdTTRealmtsignGainLossAllJtu <- readRDS(here('temp','modrawTsdTTRealmtsignGainLossAllJtu.rds')) # tsign:tempchange_abs:tempave:realm. 

# with GainLoss for Table S3
#if(!exists('modGainLossAllHorn')) modGainLossAllHorn <- readRDS(here('temp', 'modGainLossAllHorn.rds')) # Null with only duration
#if(!exists('modRealmGainLossAllHorn')) modRealmGainLossAllHorn <- readRDS('temp/modRealmGainLossAllHorn.rds') # Realm
#if(!exists('modTaxamod2GainLossAllHorn')) modTaxamod2GainLossAllHorn <- readRDS('temp/modTaxamod2GainLossAllHorn.rds') # Taxon
#if(!exists('modsdTtsignGainLossAllHorn')) modsdTtsignGainLossAllHorn <- readRDS(here('temp', 'modsdTtsignGainLossAllHorn.rds')) # tsign, tempchange_abs
#if(!exists('modsdTRealmtsignGainLossAllHorn')) modsdTRealmtsignGainLossAllHorn <- readRDS(here('temp', 'modsdTRealmtsignGainLossAllHorn.rds')) # tsign:tempchange by realm
#if(!exists('modrawTsdTTRealmtsignGainLossAllHorn')) modrawTsdTTRealmtsignGainLossAllHorn <- readRDS(here('temp','modrawTsdTTRealmtsignGainLossAllHorn.rds')) # adds tsign to tempave:tempchange:realm

# with GainLoss for Table S4
#if(!exists('modrawTsdTTRealmtsignmicroclimGainLossAllJtu')) modrawTsdTTRealmtsignmicroclimGainLossAllJtu <- readRDS('temp/modrawTsdTTRealmtsignmicroclimGainLossAllJtu.rds') # has microclimates
#if(!exists('modrawTsdTTRealmtsignhumanGainLossAllJtu')) modrawTsdTTRealmtsignhumanGainLossAllJtu <- readRDS('temp/modrawTsdTTRealmtsignhumanGainLossAllJtu.rds') # has human impact. 


# w/out
if(!exists('modsdTRealmtsignAllJtu')) modsdTRealmtsignAllJtu <- readRDS(here('temp', 'modsdTRealmtsignAllJtu.rds')) # Fit by code/turnover_vs_temperature_GLMM_fit_Jtu.R
if(!exists('modrawTsdTTRealmtsignAllJtu')) modrawTsdTTRealmtsignAllJtu <- readRDS(here('temp', 'modrawTsdTTRealmtsignAllJtu.rds')) # Fit by code/turnover_vs_temperature_GLMM_fit_Jtu.R


```

## Summaries
```{r}
# calculating these are slow, so only do if they don't yet exist
if(!exists('sum.null')) sum.null <- summary(modGainLossAllJtu)
if(!exists('sum.Tchange')) sum.Tchange <- summary(modsdTRealmtsignGainLossAllJtu)
if(!exists('sum.TchangeTave')) sum.TchangeTave <- summary(modrawTsdTTRealmtsignGainLossAllJtu)

# display
sum.null
sum.Tchange
sum.TchangeTave
```


## AIC
### Like Table 1 (main Jtu models)
```{r}

aics <- AIC(modGainLossAllJtu, 
            #modRealmGainLossAllJtu, 
            #modTaxamod2GainLossAllJtu, # simple models w/out tempchange
            #modsdTtsignGainLossAllJtu, 
            modsdTRealmtsignGainLossAllJtu, # tsign:tempchange_abs w/out or w/ realm
            #modabsLatsdTabsLatRealmtsignGainLossAllJtu,
            modrawTsdTTRealmtsignGainLossAllJtu) # add tempave:tempchange_abs
aics$dAIC <- aics$AIC - min(aics$AIC)
aics$dAICnull <- aics$AIC - aics$AIC[rownames(aics)=='modGainLossAllJtu']
aics

```

## Plot predictions
### Gainloss vs. init effect
```{r}
# predicted slopes from the tsign model (no tempave)
slopes <- readRDS(here('temp', 'slopes_modInitGainLossAllJtu.rds')) # made by pred_modrawInitGainLossAllJtu.sh/.r

ggplot(slopes[tempave == -20 & tempchange == 2], aes(gainlossprop, slope, ymin=slope-1.96*slope.se,  ymax=slope+1.96*slope.se)) +
  geom_ribbon(alpha = 0.5) +
  geom_line() +
  facet_grid(Jtu.init ~REALM)

```

### 1D plot like Fig. 2
```{r}

# predicted slopes from the tsign model (no tempave)
slopessdTRealmtsigninitJtu <- readRDS(here('temp', 'slopes_modsdTRealmtsigninitAllJtu.rds')) # made by pred_modrawXAllJtu.sh/.r

# predicted slopes from the tempave interaction model
slopesrawTsdTTRealmtsigninitJtu <- readRDS(here('temp', 'slopes_rawTsdTTRealmtsigninit.rds')) # made by pred_modrawXAllJtu.sh/.r
vals <- slopesrawTsdTTRealmtsigninitJtu[c(which.min(abs(tempave - 0)), which.min(abs(tempave-25))), unique(tempave)] # show 0 and 25degC (+/-2SD from the mean)
slopesrawTsdTTRealmtsigninitJtu <- slopesrawTsdTTRealmtsigninitJtu[tempave %in% vals,]
slopesrawTsdTTRealmtsigninitJtu[, tempave := factor(as.character(round(tempave)), levels = c('0', '25'))] # re-order factor for nicer plotting

# b) plot of change vs. dT
p2 <- ggplot() +
    geom_hline(yintercept = 0, linetype = 'dotted') +
    geom_line(data = slopessdTRealmtsigninitJtu, mapping=aes(tempchange, slope), size=0.5) +
    geom_ribbon(data = slopessdTRealmtsigninitJtu, alpha = 0.2, color = NA, 
                aes(tempchange, slope,
                    ymin=slope - slope.se, 
                    ymax=slope + slope.se)) +
    geom_line(data = slopesrawTsdTTRealmtsigninitJtu, mapping=aes(tempchange, slope, color = tempave, group = tempave), linetype = 'dashed') +
    geom_ribbon(data = slopesrawTsdTTRealmtsigninitJtu, alpha = 0.2, color = NA,
                aes(tempchange, slope, fill = tempave,
                    ymin=slope - slope.se,
                    ymax=slope + slope.se)) +
    scale_color_brewer(palette = 'Dark2') +
    scale_fill_brewer(palette = 'Dark2') +
    facet_grid(cols = vars(REALM), scales = 'free')  +
    labs(tag = 'B)', x = 'Temperature change [°C/year]', y = expression(atop('Turnover rate','['~Delta~'Turnover/year]')), 
         fill = 'Average temperature [°C]', 
         color = 'Average temperature [°C]',
         size = 'Duration [years]') +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
          panel.background = element_blank(), axis.line = element_line(colour = "black"),
          legend.key=element_blank(),
          axis.text=element_text(size=8),
          axis.title=element_text(size=8),
          plot.title=element_text(size=8)) +
    scale_y_continuous(trans = signedsqrttrans, 
                       breaks = c(seq(-1,-0.2, by = 0.2), -0.1, 0, 0.1, seq(0.2, 1, by=0.2))) +
    scale_size(trans='log', range = c(0.8,3), breaks = c(2, 5, 20, 50)) +
    guides(size = guide_legend(override.aes = list(alpha=1))) # set alpha to 1 for points in the legend
    
p2 <- addSmallLegend(p2, pointSize = 0.8, spaceLegend = 0.1, textSize = 6)
p2
```

### 1D plot like Fig. 3
```{r}
### Figure 3: interactions ---------
# read in sensitivities with resampling CIs
sensitivity2 <- readRDS(here('temp', 'sensitivity_rawTsdTTRealmtsignCovariateInit.rds')) # from code/pred_GLMMmodrawTsdTTRealmCovariateAllJtu.R

# calc change in turnover rate per °C/yr (simple linear regression, no resampling)
# sensitivity.microclim <- slopes2[, .(sensitivity_microclim = coef(lm(slope_microclim ~ tempchange))[2],
#                                      sensitivity_microclim.se = summary(lm(slope_microclim ~ tempchange))$coefficients[2,2]), 
#                                  by = .(microclim, REALM)]
# sensitivity.human <- slopes2[, .(rate_human = coef(lm(slope_human ~ tempchange))[2]), by = .(human_bowler,REALM)]
# sensitivity2 <- merge(sensitivity.microclim, sensitivity.human)

# plots
p1 <- ggplot(sensitivity2, aes(microclim, sensitivity_microclim, 
                          ymin=sensitivity_microclim-1.96*sensitivity_microclim.se,  ymax=sensitivity_microclim+1.96*sensitivity_microclim.se)) +
  geom_ribbon(alpha = 0.25, color = NA, show.legend = FALSE) +
  geom_line() +
  facet_grid(cols = vars(REALM)) +
  labs(tag = 'A)', x = 'Microclimate availability', y = expression(atop('Sensitivity of turnover rate to temperature change','[('~Delta~'Turnover rate)/'~Delta~'°C/year)]'))) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(), axis.line = element_line(colour = "black"),
        legend.key=element_blank(),
        axis.text=element_text(size=8),
        axis.title=element_text(size=8),
        plot.title=element_text(size=8)) +
  scale_x_log10()

p2 <- ggplot(sensitivity2, aes(human_bowler, sensitivity_human, 
                          ymin=sensitivity_human-1.96*sensitivity_human.se,  ymax=sensitivity_human+1.96*sensitivity_human.se)) +
  geom_ribbon(alpha = 0.25, color = NA, show.legend = FALSE) +
  geom_line() +
  facet_grid(cols = vars(REALM)) +
  labs(tag = 'A)', x = 'Human impact', y = expression(atop('Sensitivity of turnover rate to temperature change','[('~Delta~'Turnover rate)/('~Delta~'°C/year)]'))) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(), axis.line = element_line(colour = "black"),
        legend.key=element_blank(),
        axis.text=element_text(size=8),
        axis.title=element_text(size=8),
        plot.title=element_text(size=8)) +
  scale_x_log10()
p1
p2
```

