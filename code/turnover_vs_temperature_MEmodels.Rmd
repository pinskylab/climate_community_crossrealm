---
title: 'Community dissimilarity slope through time using ME models'
output: 
    github_document: default

---
# Prep
```{r setup, echo = FALSE}
library(data.table) # for handling large datasets
library(ggplot2) # for some plotting
library(glmmTMB) # for ME models
library(maps) # for map
library(gridExtra) # to combine ggplots together
library(grid) # to combine ggplots together
library(RColorBrewer)
library(MASS) # for stepAIC
library(DHARMa) # for model evaluation
library(performance) # for r2() for nlme models
library(scales) # for defining custom scales in ggplot

options(width=500) # turn off most text wrapping

signedsqrt = function(x) sign(x)*sqrt(abs(x))
signedsq = function(x) sign(x) * x^2
signedsqrttrans <- trans_new(name = 'signedsqrt', transform = signedsqrt, inverse = signedsq)


# tell RStudio to use project root directory as the root for this notebook. Needed since we are storing code in a separate directory.
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file()) 
```


```{r load data}
# Dissimilarity slope and covariates assembled by assemble_slope_covariates.Rmd
trends <- fread('output/slope_w_covariates.csv.gz')
scaling <- fread('output/slope_w_covariates_scaling.csv')
scaling$center <- as.numeric(scaling$center)
```

```{r set up useful vars}
# set realm order
trends[, REALM := factor(REALM, levels = c('Freshwater', 'Marine', 'Terrestrial'), ordered = FALSE)]
trends[, tsign := sign(temptrend)]

scl <- scaling$scale[scaling$var == 'nspp.sc']
cent <- scaling$center[scaling$var == 'nspp.sc']
trends[, nspp := exp(nspp.sc*scl+cent)]
```

# Summary stats
## Examine how many data points are available
### Just turnover and non-zero tempchange
```{r sample size all}
cat('Overall # slopes: '); table(trends$duration, trends$measure)
cat('# studies: ', trends[, length(unique(STUDY_ID))], '\n')
cat('# timeseries: ', trends[, length(unique(rarefyID))], '\n')
trends[!duplicated(rarefyID) & duration == 2 & measure == 'Jtu', table(REALM)]
trends[!duplicated(rarefyID) & duration == 2 & measure == 'Jtu', table(taxa_mod)]
trends[!duplicated(rarefyID) & duration == 2 & measure == 'Jtu', table(taxa_mod, REALM)]
```

### With all covariates
Use Bowler for human impact
```{r sample size Jtu covariates}
# the cases we can compare
apply(trends[measure == 'Jtu' & duration == 2, .(disstrend, REALM, tempave_metab.sc, seas.sc, microclim.sc, temptrend.sc, mass.sc, endothermfrac.sc, nspp.sc, thermal_bias.sc, npp.sc, human_bowler.sc)], MARGIN = 2, FUN = function(x) sum(!is.na(x)))
i <- trends[, complete.cases(disstrend, tempave_metab.sc, seas.sc, microclim.sc, temptrend.sc, mass.sc, nspp.sc, thermal_bias.sc, npp.sc, human_bowler.sc) & measure == 'Jtu' & duration == 2]
cat('Overall # 3-year Jtu trends: ', sum(i), '\n')
cat('# studies: ', trends[i, length(unique(STUDY_ID))], '\n')
cat('# timeseries: ', trends[i, length(unique(rarefyID))], '\n')
trends[i & !duplicated(rarefyID), table(REALM)]
trends[i & !duplicated(rarefyID), table(taxa_mod)]
trends[i & !duplicated(rarefyID), table(taxa_mod, REALM)]
```

# Models
## Choose the variance structure for mixed effects models
Try combinations of

- variance scaled to REALM, taxon group and/or number of species
- random intercept for taxa_mod2, STUDY_ID, and/or rarefyID

And choose the one with lowest AIC
```{r choose variance structure, echo = FALSE}
# fit models for variance structure
fixed <- 'disstrend ~ temptrend_abs.sc*REALM + temptrend_abs.sc*tempave_metab.sc + temptrend_abs.sc*seas.sc + temptrend_abs.sc*microclim.sc + temptrend_abs.sc*nspp.sc + temptrend_abs.sc*npp.sc + temptrend_abs.sc*mass.sc + temptrend_abs.sc*human_bowler.sc:REALM2 + temptrend_abs.sc*thermal_bias.sc:tsign'
cont <- glmmTMBControl(optCtrl=list(iter.max=1e3,eval.max=1e3))
i <- trends[, complete.cases(disstrend, temptrend_abs.sc, REALM, tempave_metab.sc, seas.sc, 
                             microclim.sc, mass.sc, nspp.sc, thermal_bias.sc,
                             npp.sc, human_bowler.sc) & measure == 'Jtu' & duration == 4]
sum(i)

mods <- vector('list', 0)
# variance structure
mods[[1]] <- glmmTMB(formula(fixed), data = trends[i,], control = cont)
mods[[2]] <- glmmTMB(formula(fixed), data = trends[i,], disp = ~nspp.sc, control = cont)
mods[[3]] <- glmmTMB(formula(fixed), data = trends[i,], disp = ~REALM, control = cont)
mods[[4]] <- glmmTMB(formula(fixed), data = trends[i,], disp = ~taxa_mod2, control = cont)
mods[[5]] <- glmmTMB(formula(fixed), data = trends[i,], disp = ~trendse, control = cont)

mods[[6]] <- glmmTMB(formula(fixed), data = trends[i,], disp = ~nspp.sc + REALM, control = cont)
mods[[7]] <- glmmTMB(formula(fixed), data = trends[i,], disp = ~nspp.sc + taxa_mod2, control = cont)
mods[[8]] <- glmmTMB(formula(fixed), data = trends[i,], disp = ~nspp.sc + trendse, control = cont)
mods[[9]] <- glmmTMB(formula(fixed), data = trends[i,], disp = ~REALM + taxa_mod2, control = cont)
mods[[10]] <- glmmTMB(formula(fixed), data = trends[i,], disp = ~REALM + trendse, control = cont)
mods[[11]] <- glmmTMB(formula(fixed), data = trends[i,], disp = ~taxa_mod2 + trendse, control = cont)

mods[[12]] <- glmmTMB(formula(fixed), data = trends[i,], disp = ~nspp.sc + REALM + taxa_mod2, control = cont)
mods[[13]] <- glmmTMB(formula(fixed), data = trends[i,], disp = ~nspp.sc + REALM + trendse, control = cont)
mods[[14]] <- glmmTMB(formula(fixed), data = trends[i,], disp = ~nspp.sc + taxa_mod2 + trendse, control = cont)
mods[[15]] <- glmmTMB(formula(fixed), data = trends[i,], disp = ~REALM + taxa_mod2 + trendse, control = cont)

mods[[16]] <- glmmTMB(formula(fixed), data = trends[i,], disp = ~nspp.sc + REALM + taxa_mod2 + trendse, control = cont)

# only RE
mods[[17]] <- glmmTMB(formula(paste0(fixed, '+(1|taxa_mod2)')), data = trends[i,], control = cont)
mods[[18]] <- glmmTMB(formula(paste0(fixed, '+(1|STUDY_ID)')), data = trends[i,], control = cont)
mods[[19]] <- glmmTMB(formula(paste0(fixed, '+(1|rarefyID)')), data = trends[i,], control = cont)
mods[[20]] <- glmmTMB(formula(paste0(fixed, '+(1|taxa_mod2/STUDY_ID)')), data = trends[i,], control = cont)
mods[[21]] <- glmmTMB(formula(paste0(fixed, '+(1|STUDY_ID/rarefyID)')), data = trends[i,], control = cont)
mods[[22]] <- glmmTMB(formula(paste0(fixed, '+(1|taxa_mod2/STUDY_ID/rarefyID)')), data = trends[i,], control = cont) # convergence problems

# RE and variance structure
mods[[23]] <- glmmTMB(formula(paste0(fixed, '+(1|taxa_mod2)')), disp = ~nspp.sc, data = trends[i,], control = cont)
mods[[24]] <- glmmTMB(formula(paste0(fixed, '+(1|taxa_mod2)')), disp = ~REALM, data = trends[i,], control = cont)
mods[[25]] <- glmmTMB(formula(paste0(fixed, '+(1|taxa_mod2)')), disp = ~taxa_mod2, data = trends[i,], control = cont)
mods[[26]] <- glmmTMB(formula(paste0(fixed, '+(1|taxa_mod2)')), disp = ~trendse, data = trends[i,], control = cont)
mods[[27]] <- glmmTMB(formula(paste0(fixed, '+(1|taxa_mod2)')), disp = ~nspp.sc + REALM, data = trends[i,], control = cont)
mods[[28]] <- glmmTMB(formula(paste0(fixed, '+(1|taxa_mod2)')), disp = ~nspp.sc + taxa_mod2, data = trends[i,], control = cont)
mods[[29]] <- glmmTMB(formula(paste0(fixed, '+(1|taxa_mod2)')), disp = ~nspp.sc + trendse, data = trends[i,], control = cont)
mods[[30]] <- glmmTMB(formula(paste0(fixed, '+(1|taxa_mod2)')), disp = ~REALM + taxa_mod2, data = trends[i,], control = cont)
mods[[31]] <- glmmTMB(formula(paste0(fixed, '+(1|taxa_mod2)')), disp = ~REALM + trendse, data = trends[i,], control = cont)
mods[[32]] <- glmmTMB(formula(paste0(fixed, '+(1|taxa_mod2)')), disp = ~taxa_mod2 + trendse, data = trends[i,], control = cont)
mods[[33]] <- glmmTMB(formula(paste0(fixed, '+(1|taxa_mod2)')), disp = ~nspp.sc + REALM + taxa_mod2, data = trends[i,], control = cont)
mods[[34]] <- glmmTMB(formula(paste0(fixed, '+(1|taxa_mod2)')), disp = ~nspp.sc + REALM + trendse, data = trends[i,], control = cont)
mods[[35]] <- glmmTMB(formula(paste0(fixed, '+(1|taxa_mod2)')), disp = ~nspp.sc + taxa_mod2 + trendse, data = trends[i,], control = cont)
mods[[36]] <- glmmTMB(formula(paste0(fixed, '+(1|taxa_mod2)')), disp = ~REALM + taxa_mod2 + trendse, data = trends[i,], control = cont)
mods[[37]] <- glmmTMB(formula(paste0(fixed, '+(1|taxa_mod2)')), disp = ~nspp.sc + REALM + taxa_mod2 + trendse, data = trends[i,], control = cont)

mods[[38]] <- glmmTMB(formula(paste0(fixed, '+(1|STUDY_ID)')), disp = ~nspp.sc, data = trends[i,], control = cont)
mods[[39]] <- glmmTMB(formula(paste0(fixed, '+(1|STUDY_ID)')), disp = ~REALM, data = trends[i,], control = cont)
mods[[40]] <- glmmTMB(formula(paste0(fixed, '+(1|STUDY_ID)')), disp = ~taxa_mod2, data = trends[i,], control = cont)
mods[[41]] <- glmmTMB(formula(paste0(fixed, '+(1|STUDY_ID)')), disp = ~trendse, data = trends[i,], control = cont)
mods[[42]] <- glmmTMB(formula(paste0(fixed, '+(1|STUDY_ID)')), disp = ~nspp.sc + REALM, data = trends[i,], control = cont)
mods[[43]] <- glmmTMB(formula(paste0(fixed, '+(1|STUDY_ID)')), disp = ~nspp.sc + taxa_mod2, data = trends[i,], control = cont)
mods[[44]] <- glmmTMB(formula(paste0(fixed, '+(1|STUDY_ID)')), disp = ~nspp.sc + trendse, data = trends[i,], control = cont)
mods[[45]] <- glmmTMB(formula(paste0(fixed, '+(1|STUDY_ID)')), disp = ~REALM + taxa_mod2, data = trends[i,], control = cont)
mods[[46]] <- glmmTMB(formula(paste0(fixed, '+(1|STUDY_ID)')), disp = ~REALM + trendse, data = trends[i,], control = cont)
mods[[47]] <- glmmTMB(formula(paste0(fixed, '+(1|STUDY_ID)')), disp = ~taxa_mod2 + trendse, data = trends[i,], control = cont)
mods[[48]] <- glmmTMB(formula(paste0(fixed, '+(1|STUDY_ID)')), disp = ~nspp.sc + REALM + taxa_mod2, data = trends[i,], control = cont)
mods[[49]] <- glmmTMB(formula(paste0(fixed, '+(1|STUDY_ID)')), disp = ~nspp.sc + REALM + trendse, data = trends[i,], control = cont)
mods[[50]] <- glmmTMB(formula(paste0(fixed, '+(1|STUDY_ID)')), disp = ~nspp.sc + taxa_mod2 + trendse, data = trends[i,], control = cont)
mods[[51]] <- glmmTMB(formula(paste0(fixed, '+(1|STUDY_ID)')), disp = ~REALM + taxa_mod2 + trendse, data = trends[i,], control = cont)
mods[[52]] <- glmmTMB(formula(paste0(fixed, '+(1|STUDY_ID)')), disp = ~nspp.sc + REALM + taxa_mod2 + trendse, data = trends[i,], control = cont)

mods[[53]] <- glmmTMB(formula(paste0(fixed, '+(1|rarefyID)')), disp = ~nspp.sc, data = trends[i,], control = cont)
mods[[54]] <- glmmTMB(formula(paste0(fixed, '+(1|rarefyID)')), disp = ~REALM, data = trends[i,], control = cont)
mods[[55]] <- glmmTMB(formula(paste0(fixed, '+(1|rarefyID)')), disp = ~taxa_mod2, data = trends[i,], control = cont)
mods[[56]] <- glmmTMB(formula(paste0(fixed, '+(1|rarefyID)')), disp = ~trendse, data = trends[i,], control = cont)
mods[[57]] <- glmmTMB(formula(paste0(fixed, '+(1|rarefyID)')), disp = ~nspp.sc + REALM, data = trends[i,], control = cont)
mods[[58]] <- glmmTMB(formula(paste0(fixed, '+(1|rarefyID)')), disp = ~nspp.sc + taxa_mod2, data = trends[i,], control = cont)
mods[[59]] <- glmmTMB(formula(paste0(fixed, '+(1|rarefyID)')), disp = ~nspp.sc + trendse, data = trends[i,], control = cont)
mods[[60]] <- glmmTMB(formula(paste0(fixed, '+(1|rarefyID)')), disp = ~REALM + taxa_mod2, data = trends[i,], control = cont)
mods[[61]] <- glmmTMB(formula(paste0(fixed, '+(1|rarefyID)')), disp = ~REALM + trendse, data = trends[i,], control = cont)
mods[[62]] <- glmmTMB(formula(paste0(fixed, '+(1|rarefyID)')), disp = ~taxa_mod2 + trendse, data = trends[i,], control = cont)
mods[[63]] <- glmmTMB(formula(paste0(fixed, '+(1|rarefyID)')), disp = ~nspp.sc + REALM + taxa_mod2, data = trends[i,], control = cont)
mods[[64]] <- glmmTMB(formula(paste0(fixed, '+(1|rarefyID)')), disp = ~nspp.sc + REALM + trendse, data = trends[i,], control = cont)
mods[[65]] <- glmmTMB(formula(paste0(fixed, '+(1|rarefyID)')), disp = ~nspp.sc + taxa_mod2 + trendse, data = trends[i,], control = cont)
mods[[66]] <- glmmTMB(formula(paste0(fixed, '+(1|rarefyID)')), disp = ~REALM + taxa_mod2 + trendse, data = trends[i,], control = cont)
mods[[67]] <- glmmTMB(formula(paste0(fixed, '+(1|rarefyID)')), disp = ~nspp.sc + REALM + taxa_mod2 + trendse, data = trends[i,], control = cont)

mods[[68]] <- glmmTMB(formula(paste0(fixed, '+(1|taxa_mod2/STUDY_ID)')), disp = ~nspp.sc, data = trends[i,], control = cont)
mods[[69]] <- glmmTMB(formula(paste0(fixed, '+(1|taxa_mod2/STUDY_ID)')), disp = ~REALM, data = trends[i,], control = cont)
mods[[70]] <- glmmTMB(formula(paste0(fixed, '+(1|taxa_mod2/STUDY_ID)')), disp = ~taxa_mod2, data = trends[i,], control = cont)
mods[[71]] <- glmmTMB(formula(paste0(fixed, '+(1|taxa_mod2/STUDY_ID)')), disp = ~trendse, data = trends[i,], control = cont)
mods[[72]] <- glmmTMB(formula(paste0(fixed, '+(1|taxa_mod2/STUDY_ID)')), disp = ~nspp.sc + REALM, data = trends[i,], control = cont)
mods[[73]] <- glmmTMB(formula(paste0(fixed, '+(1|taxa_mod2/STUDY_ID)')), disp = ~nspp.sc + taxa_mod2, data = trends[i,], control = cont)
mods[[74]] <- glmmTMB(formula(paste0(fixed, '+(1|taxa_mod2/STUDY_ID)')), disp = ~nspp.sc + trendse, data = trends[i,], control = cont)
mods[[75]] <- glmmTMB(formula(paste0(fixed, '+(1|taxa_mod2/STUDY_ID)')), disp = ~REALM + taxa_mod2, data = trends[i,], control = cont)
mods[[76]] <- glmmTMB(formula(paste0(fixed, '+(1|taxa_mod2/STUDY_ID)')), disp = ~REALM + trendse, data = trends[i,], control = cont)
mods[[77]] <- glmmTMB(formula(paste0(fixed, '+(1|taxa_mod2/STUDY_ID)')), disp = ~taxa_mod2 + trendse, data = trends[i,], control = cont)
mods[[78]] <- glmmTMB(formula(paste0(fixed, '+(1|taxa_mod2/STUDY_ID)')), disp = ~nspp.sc + REALM + taxa_mod2, data = trends[i,], control = cont)
mods[[79]] <- glmmTMB(formula(paste0(fixed, '+(1|taxa_mod2/STUDY_ID)')), disp = ~nspp.sc + REALM + trendse, data = trends[i,], control = cont)
mods[[80]] <- glmmTMB(formula(paste0(fixed, '+(1|taxa_mod2/STUDY_ID)')), disp = ~nspp.sc + taxa_mod2 + trendse, data = trends[i,], control = cont)
mods[[81]] <- glmmTMB(formula(paste0(fixed, '+(1|taxa_mod2/STUDY_ID)')), disp = ~REALM + taxa_mod2 + trendse, data = trends[i,], control = cont)
mods[[82]] <- glmmTMB(formula(paste0(fixed, '+(1|taxa_mod2/STUDY_ID)')), disp = ~nspp.sc + REALM + taxa_mod2 + trendse, data = trends[i,], control = cont)

mods[[83]] <- glmmTMB(formula(paste0(fixed, '+(1|STUDY_ID/rarefyID)')), disp = ~nspp.sc, data = trends[i,], control = cont)
mods[[84]] <- glmmTMB(formula(paste0(fixed, '+(1|STUDY_ID/rarefyID)')), disp = ~REALM, data = trends[i,], control = cont)
mods[[85]] <- glmmTMB(formula(paste0(fixed, '+(1|STUDY_ID/rarefyID)')), disp = ~taxa_mod2, data = trends[i,], control = cont)
mods[[86]] <- glmmTMB(formula(paste0(fixed, '+(1|STUDY_ID/rarefyID)')), disp = ~trendse, data = trends[i,], control = cont)
mods[[87]] <- glmmTMB(formula(paste0(fixed, '+(1|STUDY_ID/rarefyID)')), disp = ~nspp.sc + REALM, data = trends[i,], control = cont)
mods[[88]] <- glmmTMB(formula(paste0(fixed, '+(1|STUDY_ID/rarefyID)')), disp = ~nspp.sc + taxa_mod2, data = trends[i,], control = cont)
mods[[89]] <- glmmTMB(formula(paste0(fixed, '+(1|STUDY_ID/rarefyID)')), disp = ~nspp.sc + trendse, data = trends[i,], control = cont)
mods[[90]] <- glmmTMB(formula(paste0(fixed, '+(1|STUDY_ID/rarefyID)')), disp = ~REALM + taxa_mod2, data = trends[i,], control = cont)
mods[[91]] <- glmmTMB(formula(paste0(fixed, '+(1|STUDY_ID/rarefyID)')), disp = ~REALM + trendse, data = trends[i,], control = cont)
mods[[92]] <- glmmTMB(formula(paste0(fixed, '+(1|STUDY_ID/rarefyID)')), disp = ~taxa_mod2 + trendse, data = trends[i,], control = cont)
mods[[93]] <- glmmTMB(formula(paste0(fixed, '+(1|STUDY_ID/rarefyID)')), disp = ~nspp.sc + REALM + taxa_mod2, data = trends[i,], control = cont)
mods[[94]] <- glmmTMB(formula(paste0(fixed, '+(1|STUDY_ID/rarefyID)')), disp = ~nspp.sc + REALM + trendse, data = trends[i,], control = cont)
mods[[95]] <- glmmTMB(formula(paste0(fixed, '+(1|STUDY_ID/rarefyID)')), disp = ~nspp.sc + taxa_mod2 + trendse, data = trends[i,], control = cont)
mods[[96]] <- glmmTMB(formula(paste0(fixed, '+(1|STUDY_ID/rarefyID)')), disp = ~REALM + taxa_mod2 + trendse, data = trends[i,], control = cont)
mods[[97]] <- glmmTMB(formula(paste0(fixed, '+(1|STUDY_ID/rarefyID)')), disp = ~nspp.sc + REALM + taxa_mod2 + trendse, data = trends[i,], control = cont)


save(mods, file = 'temp/modsslopeRF.RData')

aics <- sapply(mods, AIC)
minaics <- aics - min(aics, na.rm = TRUE)
minaics
paste0('Lowest AIC is model #', which.min(aics))
paste0('AICs within 4 are model #s ', paste(which(minaics < 4 & minaics >0), collapse = ', '))
summary(mods[[which.min(aics)]])
```
Chooses the random intercepts for STUDY_ID, and variance scaled to number of species, REALM, taxa_mod2, and the standard error of the dissimilarity slope.

We haven't dealt with potential testing on the boundary issues here yet.

### DHARMa model evaluation
```{r, echo=FALSE}
res_bestVar <- simulateResiduals(mods[[52]], n = 250)
```

#### Plot residuals for model fit to all data
There are many outliers and signs of minor underdispersion, but this is probably ok.
```{r, echo=FALSE}
plot(res_bestVar)
plotResiduals(res_bestVar, form=trends$temptrend_abs.sc[i], xlab = 'temptrend_abs.sc', main = '')
plotResiduals(res_bestVar, form=trends$REALM[i], xlab = 'REALM', main = '')
plotResiduals(res_bestVar, trends$tempave_metab.sc[i], xlab = 'tempave_metab.sc', main = '')
plotResiduals(res_bestVar, trends$mass.sc[i], xlab = 'mass.sc', main = '')
plotResiduals(res_bestVar, trends$endothermfrac.sc[i], xlab = 'endothermfrac.sc', main = '')
plotResiduals(res_bestVar, trends$microclim.sc[i], xlab = 'microclim.sc', main = '')
plotResiduals(res_bestVar, trends$npp.sc[i], xlab = 'npp.sc', main = '')
plotResiduals(res_bestVar, form=trends$human_bowler.sc[i], xlab = 'human_bowler.sc', main = '')
```


#### Overdispersion
Evidence for under-dispersion
```{r, echo=FALSE}
testDispersion(res_bestVar)

```


## Temperature-trend-only models
### Fit the models
```{r LME temperature only}

form <- formula('disstrend ~ abs(temptrend) + (1|STUDY_ID)')
dispform <- formula('~nspp.sc + REALM + taxa_mod2 + trendse')

# Jtu
if(file.exists('temp/modslopeTtrendJtu3.rds')){
  modslopeTtrendJtu3 <- readRDS('temp/modslopeTtrendJtu3.rds')
} else {
  i <- trends[, complete.cases(disstrend, temptrend) & duration == 2 & measure == 'Jtu']
  modslopeTtrendJtu3 <- glmmTMB(form, disp = dispform, data = trends[i,])
  saveRDS(modslopeTtrendJtu3, file = 'temp/modslopeTtrendJtu3.rds')
}

if(file.exists('temp/modslopeTtrendJtu5.rds')){
  modslopeTtrendJtu5 <- readRDS('temp/modslopeTtrendJtu5.rds')
} else {
  i <- trends[, complete.cases(disstrend, temptrend) & duration == 4 & measure == 'Jtu']
  modslopeTtrendJtu5 <- glmmTMB(form, disp = dispform, data = trends[i,])
  saveRDS(modslopeTtrendJtu5, file = 'temp/modslopeTtrendJtu5.rds')
}

if(file.exists('temp/modslopeTtrendJtu10.rds')){
  modslopeTtrendJtu10 <- readRDS('temp/modslopeTtrendJtu10.rds')
} else {
  i <- trends[, complete.cases(disstrend, temptrend) & duration == 9 & measure == 'Jtu']
  modslopeTtrendJtu10 <- glmmTMB(form, disp = dispform, data = trends[i,])
  saveRDS(modslopeTtrendJtu10, file = 'temp/modslopeTtrendJtu10.rds')
}

if(file.exists('temp/modslopeTtrendJtu20.rds')){
  modslopeTtrendJtu20 <- readRDS('temp/modslopeTtrendJtu20.rds')
} else {
  i <- trends[, complete.cases(disstrend, temptrend) & duration == 19 & measure == 'Jtu']
  modslopeTtrendJtu20 <- glmmTMB(form, disp = dispform, data = trends[i,], control = glmmTMBControl(profile=TRUE))
  saveRDS(modslopeTtrendJtu20, file = 'temp/modslopeTtrendJtu20.rds')
}

# Jbeta
if(file.exists('temp/modslopeTtrendJbeta3.rds')){
  modslopeTtrendJbeta3 <- readRDS('temp/modslopeTtrendJbeta3.rds')
} else {
  i <- trends[, complete.cases(disstrend, temptrend) & duration == 2 & measure == 'Jbeta']
  modslopeTtrendJbeta3 <- glmmTMB(form, disp = dispform, data = trends[i,])
  saveRDS(modslopeTtrendJbeta3, file = 'temp/modslopeTtrendJbeta3.rds')
}

if(file.exists('temp/modslopeTtrendJbeta5.rds')){
  modslopeTtrendJbeta5 <- readRDS('temp/modslopeTtrendJbeta5.rds')
} else {
  i <- trends[, complete.cases(disstrend, temptrend) & duration == 4 & measure == 'Jbeta']
  modslopeTtrendJbeta5 <- glmmTMB(form, disp = dispform, data = trends[i,])
  saveRDS(modslopeTtrendJbeta5, file = 'temp/modslopeTtrendJbeta5.rds')
}

if(file.exists('temp/modslopeTtrendJbeta10.rds')){
  modslopeTtrendJbeta10 <- readRDS('temp/modslopeTtrendJbeta10.rds')
} else {
  i <- trends[, complete.cases(disstrend, temptrend) & duration == 9 & measure == 'Jbeta']
  modslopeTtrendJbeta10 <- glmmTMB(form, disp = dispform, data = trends[i,])
  saveRDS(modslopeTtrendJbeta10, file = 'temp/modslopeTtrendJbeta10.rds')
}

if(file.exists('temp/modslopeTtrendJbeta20.rds')){
  modslopeTtrendJbeta20 <- readRDS('temp/modslopeTtrendJbeta20.rds')
} else {
  i <- trends[, complete.cases(disstrend, temptrend) & duration == 19 & measure == 'Jbeta']
  modslopeTtrendJbeta20 <- glmmTMB(form, disp = dispform, data = trends[i,], control = glmmTMBControl(profile=TRUE))
  saveRDS(modslopeTtrendJbeta20, file = 'temp/modslopeTtrendJbeta20.rds')
}

# Horn
if(file.exists('temp/modslopeTtrendHorn3.rds')){
  modslopeTtrendHorn3 <- readRDS('temp/modslopeTtrendHorn3.rds')
} else {
  i <- trends[, complete.cases(disstrend, temptrend) & duration == 2 & measure == 'Horn']
  modslopeTtrendHorn3 <- glmmTMB(form, disp = dispform, data = trends[i,])
  saveRDS(modslopeTtrendHorn3, file = 'temp/modslopeTtrendHorn3.rds')
}

if(file.exists('temp/modslopeTtrendHorn5.rds')){
  modslopeTtrendHorn5 <- readRDS('temp/modslopeTtrendHorn5.rds')
} else {
  i <- trends[, complete.cases(disstrend, temptrend) & duration == 4 & measure == 'Horn']
  modslopeTtrendHorn5 <- glmmTMB(form, disp = dispform, data = trends[i,])
  saveRDS(modslopeTtrendHorn5, file = 'temp/modslopeTtrendHorn5.rds')
}

if(file.exists('temp/modslopeTtrendHorn10.rds')){
  modslopeTtrendHorn10 <- readRDS('temp/modslopeTtrendHorn10.rds')
} else {
  i <- trends[, complete.cases(disstrend, temptrend) & duration == 9 & measure == 'Horn']
  modslopeTtrendHorn10 <- glmmTMB(form, disp = dispform, data = trends[i,])
  saveRDS(modslopeTtrendHorn10, file = 'temp/modslopeTtrendHorn10.rds')
}

if(file.exists('temp/modslopeTtrendHorn20.rds')){
  modslopeTtrendHorn20 <- readRDS('temp/modslopeTtrendHorn20.rds')
} else {
  i <- trends[, complete.cases(disstrend, temptrend) & duration == 19 & measure == 'Horn']
  modslopeTtrendHorn20 <- glmmTMB(form, disp = dispform, data = trends[i,], control = glmmTMBControl(profile=TRUE))
  saveRDS(modslopeTtrendHorn20, file = 'temp/modslopeTtrendHorn20.rds')
}
```

### Summary
```{r summary of Tchangeonly mods}
summary(modslopeTtrendJtu3)
summary(modslopeTtrendJtu5)
summary(modslopeTtrendJtu10)
#summary(modslopeTtrendJtu20)

summary(modslopeTtrendJbeta3)
summary(modslopeTtrendJbeta5)
summary(modslopeTtrendJbeta10)
#summary(modslopeTtrendJbeta20)

summary(modslopeTtrendHorn3)
summary(modslopeTtrendHorn5)
summary(modslopeTtrendHorn10)
#summary(modslopeTtrendHorn20)
```

## Temperature-trend models with REALM
### Fit the models
```{r LME temperature realm}

form <- formula('disstrend ~ abs(temptrend) + REALM + (1|STUDY_ID)')
dispform <- formula('~nspp.sc + REALM + taxa_mod2')

# Jtu
if(file.exists('temp/modslopeTtrendReJtu3.rds')){
  modslopeTtrendReJtu3 <- readRDS('temp/modslopeTtrendReJtu3.rds')
} else {
  i <- trends[, complete.cases(disstrend, temptrend) & duration == 2 & measure == 'Jtu']
  modslopeTtrendReJtu3 <- glmmTMB(form, disp = dispform, data = trends[i,])
  saveRDS(modslopeTtrendReJtu3, file = 'temp/modslopeTtrendReJtu3.rds')
}

if(file.exists('temp/modslopeTtrendReJtu5.rds')){
  modslopeTtrendReJtu5 <- readRDS('temp/modslopeTtrendReJtu5.rds')
} else {
  i <- trends[, complete.cases(disstrend, temptrend) & duration == 4 & measure == 'Jtu']
  modslopeTtrendReJtu5 <- glmmTMB(form, disp = dispform, data = trends[i,])
  saveRDS(modslopeTtrendReJtu5, file = 'temp/modslopeTtrendReJtu5.rds')
}

if(file.exists('temp/modslopeTtrendReJtu10.rds')){
  modslopeTtrendReJtu10 <- readRDS('temp/modslopeTtrendReJtu10.rds')
} else {
  i <- trends[, complete.cases(disstrend, temptrend) & duration == 9 & measure == 'Jtu']
  modslopeTtrendReJtu10 <- glmmTMB(form, disp = dispform, data = trends[i,])
  saveRDS(modslopeTtrendReJtu10, file = 'temp/modslopeTtrendReJtu10.rds')
}

if(file.exists('temp/modslopeTtrendReJtu20.rds')){
  modslopeTtrendReJtu20 <- readRDS('temp/modslopeTtrendReJtu20.rds')
} else {
  i <- trends[, complete.cases(disstrend, temptrend) & duration == 19 & measure == 'Jtu']
  modslopeTtrendReJtu20 <- glmmTMB(form, disp = dispform, data = trends[i,], control = glmmTMBControl(profile=TRUE))
  saveRDS(modslopeTtrendReJtu20, file = 'temp/modslopeTtrendReJtu20.rds')
}

# Jbeta
if(file.exists('temp/modslopeTtrendReJbeta3.rds')){
  modslopeTtrendReJbeta3 <- readRDS('temp/modslopeTtrendReJbeta3.rds')
} else {
  i <- trends[, complete.cases(disstrend, temptrend) & duration == 2 & measure == 'Jbeta']
  modslopeTtrendReJbeta3 <- glmmTMB(form, disp = dispform, data = trends[i,])
  saveRDS(modslopeTtrendReJbeta3, file = 'temp/modslopeTtrendReJbeta3.rds')
}

if(file.exists('temp/modslopeTtrendReJbeta5.rds')){
  modslopeTtrendReJbeta5 <- readRDS('temp/modslopeTtrendReJbeta5.rds')
} else {
  i <- trends[, complete.cases(disstrend, temptrend) & duration == 4 & measure == 'Jbeta']
  modslopeTtrendReJbeta5 <- glmmTMB(form, disp = dispform, data = trends[i,])
  saveRDS(modslopeTtrendReJbeta5, file = 'temp/modslopeTtrendReJbeta5.rds')
}

if(file.exists('temp/modslopeTtrendReJbeta10.rds')){
  modslopeTtrendReJbeta10 <- readRDS('temp/modslopeTtrendReJbeta10.rds')
} else {
  i <- trends[, complete.cases(disstrend, temptrend) & duration == 9 & measure == 'Jbeta']
  modslopeTtrendReJbeta10 <- glmmTMB(form, disp = dispform, data = trends[i,])
  saveRDS(modslopeTtrendReJbeta10, file = 'temp/modslopeTtrendReJbeta10.rds')
}

if(file.exists('temp/modslopeTtrendReJbeta20.rds')){
  modslopeTtrendReJbeta20 <- readRDS('temp/modslopeTtrendReJbeta20.rds')
} else {
  i <- trends[, complete.cases(disstrend, temptrend) & duration == 19 & measure == 'Jbeta']
  modslopeTtrendReJbeta20 <- glmmTMB(form, disp = dispform, data = trends[i,], control = glmmTMBControl(profile=TRUE))
  saveRDS(modslopeTtrendReJbeta20, file = 'temp/modslopeTtrendReJbeta20.rds')
}

# Horn
if(file.exists('temp/modslopeTtrendReHorn3.rds')){
  modslopeTtrendReHorn3 <- readRDS('temp/modslopeTtrendReHorn3.rds')
} else {
  i <- trends[, complete.cases(disstrend, temptrend) & duration == 2 & measure == 'Horn']
  modslopeTtrendReHorn3 <- glmmTMB(form, disp = dispform, data = trends[i,])
  saveRDS(modslopeTtrendReHorn3, file = 'temp/modslopeTtrendReHorn3.rds')
}

if(file.exists('temp/modslopeTtrendReHorn5.rds')){
  modslopeTtrendReHorn5 <- readRDS('temp/modslopeTtrendReHorn5.rds')
} else {
  i <- trends[, complete.cases(disstrend, temptrend) & duration == 4 & measure == 'Horn']
  modslopeTtrendReHorn5 <- glmmTMB(form, disp = dispform, data = trends[i,])
  saveRDS(modslopeTtrendReHorn5, file = 'temp/modslopeTtrendReHorn5.rds')
}

if(file.exists('temp/modslopeTtrendReHorn10.rds')){
  modslopeTtrendReHorn10 <- readRDS('temp/modslopeTtrendReHorn10.rds')
} else {
  i <- trends[, complete.cases(disstrend, temptrend) & duration == 9 & measure == 'Horn']
  modslopeTtrendReHorn10 <- glmmTMB(form, disp = dispform, data = trends[i,])
  saveRDS(modslopeTtrendReHorn10, file = 'temp/modslopeTtrendReHorn10.rds')
}

if(file.exists('temp/modslopeTtrendReHorn20.rds')){
  modslopeTtrendReHorn20 <- readRDS('temp/modslopeTtrendReHorn20.rds')
} else {
  i <- trends[, complete.cases(disstrend, temptrend) & duration == 19 & measure == 'Horn']
  modslopeTtrendReHorn20 <- glmmTMB(form, disp = dispform, data = trends[i,], control = glmmTMBControl(profile=TRUE))
  saveRDS(modslopeTtrendReHorn20, file = 'temp/modslopeTtrendReHorn20.rds')
}
```

### Summary
```{r summary of TD mods}
summary(modslopeTtrendReJtu3)
summary(modslopeTtrendReJtu5)
summary(modslopeTtrendReJtu10)
summary(modslopeTtrendReJtu20)

summary(modslopeTtrendReJbeta3)
summary(modslopeTtrendReJbeta5)
summary(modslopeTtrendReJbeta10)
summary(modslopeTtrendReJbeta20)

summary(modslopeTtrendReHorn3)
summary(modslopeTtrendReHorn5)
summary(modslopeTtrendReHorn10)
#summary(modslopeTtrendReHorn20) # convergence issues
```


## Temperature & realm models
Includes metabolic temperature, temperature trend, and their interaction
### Fit the models
```{r}

form <- formula('disstrend ~ temptrend_abs.sc * tempave_metab.sc + REALM + (1|STUDY_ID)')
dispform <- formula('~nspp.sc + REALM + taxa_mod2 + trendse')

# Jtu
if(file.exists('temp/modslopeTtrendTaveJtu3.rds')){
  modslopeTtrendTaveJtu3 <- readRDS('temp/modslopeTtrendTaveJtu3.rds')
} else {
  i <- trends[, complete.cases(disstrend, temptrend_abs.sc, tempave_metab.sc) & duration == 2 & measure == 'Jtu']
  modslopeTtrendTaveJtu3 <- glmmTMB(form, disp = dispform, data = trends[i,])
  saveRDS(modslopeTtrendTaveJtu3, file = 'temp/modslopeTtrendTaveJtu3.rds')
}

if(file.exists('temp/modslopeTtrendTaveJtu5.rds')){
  modslopeTtrendTaveJtu5 <- readRDS('temp/modslopeTtrendTaveJtu5.rds')
} else {
  i <- trends[, complete.cases(disstrend, temptrend_abs.sc, tempave_metab.sc) & duration == 4 & measure == 'Jtu']
  modslopeTtrendTaveJtu5 <- glmmTMB(form, disp = dispform, data = trends[i,])
  saveRDS(modslopeTtrendTaveJtu5, file = 'temp/modslopeTtrendTaveJtu5.rds')
}

if(file.exists('temp/modslopeTtrendTaveJtu10.rds')){
  modslopeTtrendTaveJtu10 <- readRDS('temp/modslopeTtrendTaveJtu10.rds')
} else {
  i <- trends[, complete.cases(disstrend, temptrend_abs.sc, tempave_metab.sc) & duration == 9 & measure == 'Jtu']
  modslopeTtrendTaveJtu10 <- glmmTMB(form, disp = dispform, data = trends[i,])
  saveRDS(modslopeTtrendTaveJtu10, file = 'temp/modslopeTtrendTaveJtu10.rds')
}

# if(file.exists('temp/modslopeTtrendTaveJtu20.rds')){
#   modslopeTtrendTaveJtu20 <- readRDS('temp/modslopeTtrendTaveJtu20.rds')
# } else {
#   i <- trends[, complete.cases(disstrend, temptrend_abs.sc, tempave_metab.sc) & duration == 19 & measure == 'Jtu']
#   modslopeTtrendTaveJtu20 <- glmmTMB(form, disp = dispform, data = trends[i,])
#   saveRDS(modslopeTtrendTaveJtu20, file = 'temp/modslopeTtrendTaveJtu20.rds')
# }

# Jbeta
if(file.exists('temp/modslopeTtrendTaveJbeta3.rds')){
  modslopeTtrendTaveJbeta3 <- readRDS('temp/modslopeTtrendTaveJbeta3.rds')
} else {
  i <- trends[, complete.cases(disstrend, temptrend_abs.sc, tempave_metab.sc) & duration == 2 & measure == 'Jbeta']
  modslopeTtrendTaveJbeta3 <- glmmTMB(form, disp = dispform, data = trends[i,])
  saveRDS(modslopeTtrendTaveJbeta3, file = 'temp/modslopeTtrendTaveJbeta3.rds')
}

if(file.exists('temp/modslopeTtrendTaveJbeta5.rds')){
  modslopeTtrendTaveJbeta5 <- readRDS('temp/modslopeTtrendTaveJbeta5.rds')
} else {
  i <- trends[, complete.cases(disstrend, temptrend_abs.sc, tempave_metab.sc) & duration == 4 & measure == 'Jbeta']
  modslopeTtrendTaveJbeta5 <- glmmTMB(form, disp = dispform, data = trends[i,])
  saveRDS(modslopeTtrendTaveJbeta5, file = 'temp/modslopeTtrendTaveJbeta5.rds')
}

if(file.exists('temp/modslopeTtrendTaveJbeta10.rds')){
  modslopeTtrendTaveJbeta10 <- readRDS('temp/modslopeTtrendTaveJbeta10.rds')
} else {
  i <- trends[, complete.cases(disstrend, temptrend_abs.sc, tempave_metab.sc) & duration == 9 & measure == 'Jbeta']
  modslopeTtrendTaveJbeta10 <- glmmTMB(form, disp = dispform, data = trends[i,])
  saveRDS(modslopeTtrendTaveJbeta10, file = 'temp/modslopeTtrendTaveJbeta10.rds')
}

if(file.exists('temp/modslopeTtrendTaveJbeta20.rds')){
  modslopeTtrendTaveJbeta20 <- readRDS('temp/modslopeTtrendTaveJbeta20.rds')
} else {
  i <- trends[, complete.cases(disstrend, temptrend_abs.sc, tempave_metab.sc) & duration == 19 & measure == 'Jbeta']
  modslopeTtrendTaveJbeta20 <- glmmTMB(form, disp = dispform, data = trends[i,], control = glmmTMBControl(profile=TRUE))
  saveRDS(modslopeTtrendTaveJbeta20, file = 'temp/modslopeTtrendTaveJbeta20.rds')
}

# Horn
if(file.exists('temp/modslopeTtrendTaveHorn3.rds')){
  modslopeTtrendTaveHorn3 <- readRDS('temp/modslopeTtrendTaveHorn3.rds')
} else {
  i <- trends[, complete.cases(disstrend, temptrend_abs.sc, tempave_metab.sc) & duration == 2 & measure == 'Horn']
  modslopeTtrendTaveHorn3 <- glmmTMB(form, disp = dispform, data = trends[i,])
  saveRDS(modslopeTtrendTaveHorn3, file = 'temp/modslopeTtrendTaveHorn3.rds')
}

if(file.exists('temp/modslopeTtrendTaveHorn5.rds')){
  modslopeTtrendTaveHorn5 <- readRDS('temp/modslopeTtrendTaveHorn5.rds')
} else {
  i <- trends[, complete.cases(disstrend, temptrend_abs.sc, tempave_metab.sc) & duration == 4 & measure == 'Horn']
  modslopeTtrendTaveHorn5 <- glmmTMB(form, disp = dispform, data = trends[i,])
  saveRDS(modslopeTtrendTaveHorn5, file = 'temp/modslopeTtrendTaveHorn5.rds')
}

if(file.exists('temp/modslopeTtrendTaveHorn10.rds')){
  modslopeTtrendTaveHorn10 <- readRDS('temp/modslopeTtrendTaveHorn10.rds')
} else {
  i <- trends[, complete.cases(disstrend, temptrend_abs.sc, tempave_metab.sc) & duration == 9 & measure == 'Horn']
  modslopeTtrendTaveHorn10 <- glmmTMB(form, disp = dispform, data = trends[i,])
  saveRDS(modslopeTtrendTaveHorn10, file = 'temp/modslopeTtrendTaveHorn10.rds')
}

if(file.exists('temp/modslopeTtrendTaveHorn20.rds')){
  modslopeTtrendTaveHorn20 <- readRDS('temp/modslopeTtrendTaveHorn20.rds')
} else {
  i <- trends[, complete.cases(disstrend, temptrend_abs.sc, tempave_metab.sc) & duration == 19 & measure == 'Horn']
  modslopeTtrendTaveHorn20 <- glmmTMB(form, disp = dispform, data = trends[i,], control = glmmTMBControl(profile=TRUE))
  saveRDS(modslopeTtrendTaveHorn20, file = 'temp/modslopeTtrendTaveHorn20.rds')
}
```

### Summary
```{r summary of TchangeTave mods}
summary(modslopeTtrendTaveJtu3)
summary(modslopeTtrendTaveJtu5)
#summary(modslopeTtrendTaveJtu10)
#summary(modslopeTtrendTaveJtu20)

summary(modslopeTtrendTaveJbeta3)
summary(modslopeTtrendTaveJbeta5)
#summary(modslopeTtrendTaveJbeta10)
#summary(modslopeTtrendTaveJbeta20)

summary(modslopeTtrendTaveHorn3)
summary(modslopeTtrendTaveHorn5)
summary(modslopeTtrendTaveHorn10)
#summary(modslopeTtrendTaveHorn20)
```


## Main-effect models
Try static covariates:

- realm
- mass
- average metabolic temperature
- temperature trend
- seasonality
- microclimates
- thermal bias:tsign
- NPP
- human footprint


### Fit main effect models
```{r maineffect models}
form <- formula('disstrend ~ REALM + temptrend_abs.sc + tempave_metab.sc + seas.sc + microclim.sc + nspp.sc + npp.sc + mass.sc + human_bowler.sc:REALM2 + thermal_bias.sc:tsign + (1|STUDY_ID)')
dispform <- formula('~taxa_mod2 + REALM + nspp.sc')

completerows <- trends[, complete.cases(REALM, tempave_metab.sc, 
                                seas.sc, microclim.sc, 
                                temptrend_abs.sc, mass.sc,
                                nspp.sc, thermal_bias.sc, npp.sc, 
                                human_bowler.sc)]


# Jtu
if(file.exists('temp/modslopeMainJtu3.rds')){
  modslopeMainJtu3 <- readRDS('temp/modslopeMainJtu3.rds')
} else {
  i <- trends[, complete.cases(disstrend) & duration == 2 & measure == 'Jtu'] & completerows
  sum(i)
  modslopeMainJtu3 <- glmmTMB(form, disp = dispform, data = trends[i,])
  saveRDS(modslopeMainJtu3, file = 'temp/modslopeMainJtu3.rds')
}

if(file.exists('temp/modslopeMainJtu5.rds')){
  modslopeMainJtu5 <- readRDS('temp/modslopeMainJtu5.rds')
} else {
  i <- trends[, complete.cases(disstrend) & duration == 4 & measure == 'Jtu'] & completerows
  sum(i)
  modslopeMainJtu5 <- glmmTMB(form, disp = dispform, data = trends[i,])
  saveRDS(modslopeMainJtu5, file = 'temp/modslopeMainJtu5.rds')
}

if(file.exists('temp/modslopeMainJtu10.rds')){
  modslopeMainJtu10 <- readRDS('temp/modslopeMainJtu10.rds')
} else {
  i <- trends[, complete.cases(disstrend) & duration == 9 & measure == 'Jtu'] & completerows
  modslopeMainJtu10 <- glmmTMB(form, disp = dispform, data = trends[i,])
  saveRDS(modslopeMainJtu10, file = 'temp/modslopeMainJtu10.rds')
}

if(file.exists('temp/modslopeMainJtu20.rds')){
  modslopeMainJtu20 <- readRDS('temp/modslopeMainJtu20.rds')
} else {
  i <- trends[, complete.cases(disstrend) & duration == 19 & measure == 'Jtu'] & completerows
  modslopeMainJtu20 <- glmmTMB(form, disp = dispform, data = trends[i,])
  saveRDS(modslopeMainJtu20, file = 'temp/modslopeMainJtu20.rds')
}

# Jbeta
if(file.exists('temp/modslopeMainJbeta3.rds')){
  modslopeMainJbeta3 <- readRDS('temp/modslopeMainJbeta3.rds')
} else {
  i <- trends[, complete.cases(disstrend) & duration == 2 & measure == 'Jbeta'] & completerows
  sum(i)
  modslopeMainJbeta3 <- glmmTMB(form, disp = dispform, data = trends[i,])
  saveRDS(modslopeMainJbeta3, file = 'temp/modslopeMainJbeta3.rds')
}

if(file.exists('temp/modslopeMainJbeta5.rds')){
  modslopeMainJbeta5 <- readRDS('temp/modslopeMainJbeta5.rds')
} else {
  i <- trends[, complete.cases(disstrend) & duration == 4 & measure == 'Jbeta'] & completerows
  sum(i)
  modslopeMainJbeta5 <- glmmTMB(form, disp = dispform, data = trends[i,])
  saveRDS(modslopeMainJbeta5, file = 'temp/modslopeMainJbeta5.rds')
}

if(file.exists('temp/modslopeMainJbeta10.rds')){
  modslopeMainJbeta10 <- readRDS('temp/modslopeMainJbeta10.rds')
} else {
  i <- trends[, complete.cases(disstrend) & duration == 9 & measure == 'Jbeta'] & completerows
  modslopeMainJbeta10 <- glmmTMB(form, disp = dispform, data = trends[i,])
  saveRDS(modslopeMainJbeta10, file = 'temp/modslopeMainJbeta10.rds')
}

if(file.exists('temp/modslopeMainJbeta20.rds')){
  modslopeMainJbeta20 <- readRDS('temp/modslopeMainJbeta20.rds')
} else {
  i <- trends[, complete.cases(disstrend) & duration == 19 & measure == 'Jbeta'] & completerows
  modslopeMainJbeta20 <- glmmTMB(form, disp = dispform, data = trends[i,])
  saveRDS(modslopeMainJbeta20, file = 'temp/modslopeMainJbeta20.rds')
}

# Horn
if(file.exists('temp/modslopeMainHorn3.rds')){
  modslopeMainHorn3 <- readRDS('temp/modslopeMainHorn3.rds')
} else {
  i <- trends[, complete.cases(disstrend) & duration == 2 & measure == 'Horn'] & completerows
  sum(i)
  modslopeMainHorn3 <- glmmTMB(form, disp = dispform, data = trends[i,])
  saveRDS(modslopeMainHorn3, file = 'temp/modslopeMainHorn3.rds')
}

if(file.exists('temp/modslopeMainHorn5.rds')){
  modslopeMainHorn5 <- readRDS('temp/modslopeMainHorn5.rds')
} else {
  i <- trends[, complete.cases(disstrend) & duration == 4 & measure == 'Horn'] & completerows
  sum(i)
  modslopeMainHorn5 <- glmmTMB(form, disp = dispform, data = trends[i,])
  saveRDS(modslopeMainHorn5, file = 'temp/modslopeMainHorn5.rds')
}

if(file.exists('temp/modslopeMainHorn10.rds')){
  modslopeMainHorn10 <- readRDS('temp/modslopeMainHorn10.rds')
} else {
  i <- trends[, complete.cases(disstrend) & duration == 9 & measure == 'Horn'] & completerows
  modslopeMainHorn10 <- glmmTMB(form, disp = dispform, data = trends[i,])
  saveRDS(modslopeMainHorn10, file = 'temp/modslopeMainHorn10.rds')
}

if(file.exists('temp/modslopeMainHorn20.rds')){
  modslopeMainHorn20 <- readRDS('temp/modslopeMainHorn20.rds')
} else {
  i <- trends[, complete.cases(disstrend) & duration == 19 & measure == 'Horn'] & completerows
  modslopeMainHorn20 <- glmmTMB(form, disp = dispform, data = trends[i,])
  saveRDS(modslopeMainHorn20, file = 'temp/modslopeMainHorn20.rds')
}


```

### Summary
```{r summary full}
summary(modslopeMainJtu3)
summary(modslopeMainJtu5)
summary(modslopeMainJtu10)
summary(modslopeMainJtu20)

summary(modslopeMainJbeta3)
summary(modslopeMainJbeta5)
summary(modslopeMainJbeta10)
summary(modslopeMainJbeta20)

summary(modslopeMainHorn3)
summary(modslopeMainHorn5)
summary(modslopeMainHorn10)
summary(modslopeMainHorn20)

```


### Plot the main effects
```{r main effect plots, fig.width=12, fig.height=12, echo = FALSE}
# mods should be a list of 3 full models
# returns a list with 2 components: the plots and the dataframe
plotmaineffects <- function(mods){
  # set up the variables to plot
  # if variable is logged before scaling (see 'center and scale' above), then need to mark it here and express the limits on a log10 scale (even though log transforming is log)
  vars <- data.frame(vars = c('temptrend_abs', 'tempave_metab', 'seas', 'microclim', 'mass', 
                              'nspp', 'npp', 'duration', 
                              'human_bowler', 'human_bowler'),
                     min =      c(0,  0,   0.1, -2,  0,   0,   0,   0.3, -10, 1.9, 0,   0.5, 0,   0), 
                     max =      c(0.2,  30,  16,  0.8, 8,   2,   1,   2.6, 10,  3.7, 0.3, 2,   1,   1),
                     log =      c(F,  F,   F,   T,   T,   T,   F,   T,   F,   T,   T,   T,   T,   T),
                     len =      c(100,  100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100),
                     discrete = c(F,  F,   F,   F,   F,   F,   F,   F,   F,   F,   F,   F,   F,   F),
                     plus =     c(0,  0,   0,   0,   0,   1,   0,   0,   0,   0,   1,   0,   1,   1), # what to add before log-scaling
                     REALM = c(rep('Terrestrial', 13), 'Marine'),
                     REALM2 = c(rep('TerrFresh', 13), 'Marine'),
                     stringsAsFactors = FALSE)
  baseall <- trends[, .(type = 'all', 
                        tempchange = -0.0001,
                        tempchange_abs.sc = 0.0001,
                        tempave_metab.sc = mean(tempave_metab.sc, na.rm=TRUE), 
                        seas.sc = mean(seas.sc, na.rm=TRUE), 
                        microclim.sc = mean(microclim.sc, na.rm=TRUE), 
                        speed.sc = mean(speed.sc, na.rm=TRUE), 
                        mass.sc = mean(mass.sc, na.rm=TRUE), 
                        nspp.sc = 0, 
                        thermal_bias.sc = mean(thermal_bias.sc, na.rm=TRUE), 
                        npp.sc = mean(npp.sc, na.rm=TRUE), 
                        human_bowler.sc = mean(human_bowler.sc, na.rm=TRUE), 
                        veg.sc = mean(veg.sc, na.rm=TRUE), 
                        consumerfrac.sc = mean(consumerfrac.sc, na.rm=TRUE))]
  baseterr <- trends[REALM == 'Terrestrial', 
                     .(type = 'Terrestrial', 
                       tempchange = -0.0001,
                       tempchange_abs.sc = 0.0001,
                       tempave_metab.sc = mean(tempave_metab.sc, na.rm=TRUE), 
                       seas.sc = mean(seas.sc, na.rm=TRUE), 
                       microclim.sc = mean(microclim.sc, na.rm=TRUE), 
                       speed.sc = mean(speed.sc, na.rm=TRUE), 
                       mass.sc = mean(mass.sc, na.rm=TRUE), 
                       nspp.sc = 0, 
                       thermal_bias.sc = 0, 
                       npp.sc = mean(npp.sc, na.rm=TRUE), 
                       human_bowler.sc = mean(human_bowler.sc, na.rm=TRUE), 
                       veg.sc = mean(veg.sc, na.rm=TRUE), 
                       consumerfrac.sc = mean(consumerfrac.sc, na.rm=TRUE))]
  basemar <- trends[REALM == 'Marine', 
                    .(type = 'Marine',
                      tempchange = -0.0001,
                      tempchange_abs.sc = 0.0001,
                      tempave_metab.sc = mean(tempave_metab.sc, na.rm=TRUE), 
                      seas.sc = mean(seas.sc, na.rm=TRUE), 
                      microclim.sc = mean(microclim.sc, na.rm=TRUE), 
                      speed.sc = mean(speed.sc, na.rm=TRUE), 
                      mass.sc = mean(mass.sc, na.rm=TRUE), 
                      nspp.sc = 0, 
                      thermal_bias.sc = 0, 
                      npp.sc = mean(npp.sc, na.rm=TRUE), 
                      human_bowler.sc = mean(human_bowler.sc, na.rm=TRUE), 
                      veg.sc = mean(veg.sc, na.rm=TRUE), 
                      consumerfrac.sc = mean(consumerfrac.sc, na.rm=TRUE))]
  basetab <- rbind(baseall, baseterr, basemar)
  basetab[, ':='(duration.sc = 0, nyrBT = 20, STUDY_ID = 127L, rarefyID = '127_514668')]
  
  # make the data frames for each interaction to plot                
  for(j in 1:nrow(vars)){
    # set up the main effects
    if(vars$log[j]){
      thisdat <- data.frame(new = 10^seq(vars$min[j], vars$max[j], length.out = vars$len[j]),
                            var = vars$vars[j], stringsAsFactors = FALSE)
    } 
    if(!vars$log[j]){
      thisdat <- data.frame(new = seq(vars$min[j], vars$max[j], length.out = vars$len[j]),
                            var = vars$vars[j], stringsAsFactors = FALSE)
    }
    names(thisdat) <- c(vars$vars[j], 'var')
    
    # scale the variable
    cent <- attr(trends[[paste0(vars$vars[j], '.sc')]], 'scaled:center')
    scl <- attr(trends[[paste0(vars$vars[j], '.sc')]], 'scaled:scale')
    if(is.null(cent)) cent <- 0
    if(!is.null(cent) & !is.null(scl)){
      if(vars$log[j]) thisdat[[paste0(vars$var[j], '.sc')]] <- (log(thisdat[[vars$vars[j]]] + vars$plus[j]) - cent)/scl
      if(!vars$log[j]) thisdat[[paste0(vars$var[j], '.sc')]] <- (thisdat[[vars$var[j]]] - cent)/scl
    }
    
    # merge with the rest of the columns
    # use realm-specific averages for human impacts
    if(vars$vars[j] != 'tsign') colnamestouse <- setdiff(colnames(basetab), paste0(vars$vars[j], '.sc'))
    if(vars$vars[j] == 'tsign') colnamestouse <- setdiff(colnames(basetab), vars$var[j])
    if(vars$vars[j] != 'human_bowler'){
      thisdat <- cbind(thisdat, basetab[type == 'all', ..colnamestouse])
    }
    if(vars$vars[j] == 'human_bowler' & vars$REALM[j] == 'Terrestrial'){
      thisdat <- cbind(thisdat, basetab[type == 'Terrestrial', ..colnamestouse])
    }
    if(vars$vars[j] == 'human_bowler' & vars$REALM[j] == 'Marine'){
      thisdat <- cbind(thisdat, basetab[type == 'Marine', ..colnamestouse])
    }
    
    # add realm
    thisdat$REALM <- vars$REALM[j]
    thisdat$REALM2 <- vars$REALM2[j]
    
    # merge with the previous iterations
    if(j == 1) newdat <- thisdat
    if(j > 1){
      colstoadd <- setdiff(colnames(thisdat), colnames(newdat))
      for(toadd in colstoadd){
        newdat[[toadd]] <- NA
      }
      
      colstoadd2 <- setdiff(colnames(newdat), colnames(thisdat))
      for(toadd in colstoadd2){
        thisdat[[toadd]] <- NA
      }
      
      newdat <- rbind(newdat, thisdat)
    } 
  }
  
  # character so that new levels can be added
  newdat$REALM <- as.character(newdat$REALM)
  newdat$REALM2 <- as.character(newdat$REALM2)
  
  # add extra rows so that all factor levels are represented (for predict.lme to work)
  newdat <- rbind(newdat[1:6, ], newdat)
  newdat$REALM[1:6] <- c('Marine', 'Marine', 'Freshwater', 'Freshwater', 'Terrestrial', 'Terrestrial')
  newdat$REALM2[1:6] <- c('Marine', 'Marine', 'TerrFresh', 'TerrFresh', 'TerrFresh', 'TerrFresh')
  newdat$tempchange_abs.sc[1:6] <- rep(0.0001, 6)
  newdat$tempchange[1:6] <- rep(c(0.0001, -0.0001), 3)
  newdat$var[1:6] <- 'test'
  
  # trim to at least some temperature change (so that tsign is -1 or 1)
  newdat <- newdat[newdat$tempchange_abs.sc != 0,]
  
  # set up tsign
  newdat$tsign <- factor(sign(newdat$tempchange))
  
  
  # make predictions
  newdat$predsJtu <- predict(object = mods[[1]], newdata = newdat, level = 0)
  newdat$predsJbeta <- predict(object = mods[[2]], newdata = newdat, level = 0)
  newdat$predsHorn <- predict(object = mods[[3]], newdata = newdat, level = 0)
  
  #compute standard error for predictions
  # from https://stackoverflow.com/questions/14358811/extract-prediction-band-from-lme-fit
  DesignmatJtu <- model.matrix(eval(eval(modTfullJturem0$call$fixed)[-2]), newdat)
  DesignmatJbeta <- model.matrix(eval(eval(modTfullJbetarem0$call$fixed)[-2]), newdat)
  DesignmatHorn <- model.matrix(eval(eval(modTfullHornrem0$call$fixed)[-2]), newdat)
  
  predvarJtu <- diag(DesignmatJtu %*% modTfullJturem0$varFix %*% t(DesignmatJtu))
  predvarJbeta <- diag(DesignmatJbeta %*% modTfullJbetarem0$varFix %*% t(DesignmatJbeta))
  predvarHorn <- diag(DesignmatHorn %*% modTfullHornrem0$varFix %*% t(DesignmatHorn))
  
  newdat$SE_Jtu <- sqrt(predvarJtu) 
  newdat$SE_Jbeta <- sqrt(predvarJbeta) 
  newdat$SE_Horn <- sqrt(predvarHorn) 
  
  # prep the plots
  varplots <- vector('list', nrow(vars))
  for(j in 1:length(varplots)){
    subs <- newdat$var == vars$vars[j] # which rows of newdat
    xvar <- vars$vars[j]
    title <- vars$vars[j]
    if(vars$vars[j] %in% c('human_bowler')){
      subs <- newdat$var == vars$vars[j] & newdat$REALM2 == vars$REALM2[j]
      title <- paste0('human:', vars$REALM2[j])
    } 
    
    se <- 1
    thisplot <- ggplot(newdat[subs, ], 
                       aes_string(x = xvar, y = 'predsJtu')) +
      geom_line() +
      geom_ribbon(aes(ymin = predsJtu - se*SE_Jtu, ymax = predsJtu + se*SE_Jtu), alpha = 0.5, fill = "grey") +
      geom_line(aes(y = predsJbeta), color = 'red') +
      geom_ribbon(aes(ymin = predsJbeta - se*SE_Jbeta, ymax = predsJbeta + se*SE_Jbeta), alpha = 0.5, fill = "red") +
      geom_line(aes(y = predsHorn), color = 'blue') +
      geom_ribbon(aes(ymin = predsHorn - se*SE_Horn, ymax = predsHorn + se*SE_Horn), alpha = 0.5, fill = "blue") +
      #coord_cartesian(ylim = c(0, 0.4)) +
      theme(plot.margin = unit(c(0.5,0,0.5,0), 'cm')) +
      labs(title = title) 
    varplots[[j]] <- thisplot
    if(vars$log[j] & !vars$discrete[j]){
      varplots[[j]] <- thisplot + scale_x_log10()
    }
  }
  out <- list(varplots = varplots, newdat = newdat)
}

out <- plotmaineffects(mods = list(modTfullJturem0, modTfullJbetarem0, modTfullHornrem0))

grid.arrange(grobs = out$varplots, ncol = 3)

# write out the interactions
write.csv(out$newdat, file = 'output/maineffectsrem0.csv')

```
Grey: Jaccard turnover
Red: Jaccard total
Blue: Horn
Plots are for Terrestrial, except the marine plot.

## Interaction models
Try static covariates intersected with temperature-trend:

- realm
- mass
- average metabolic temperature
- seasonality
- microclimates
- thermal bias:tsign
- NPP
- human footprint


### Fit interaction models
```{r interaction models}
form <- formula('disstrend ~ temptrend_abs.sc*REALM + temptrend_abs.sc*tempave_metab.sc + temptrend_abs.sc*seas.sc + temptrend_abs.sc*microclim.sc + temptrend_abs.sc*nspp.sc + temptrend_abs.sc*npp.sc + temptrend_abs.sc*mass.sc + temptrend_abs.sc*human_bowler.sc:REALM2 + temptrend_abs.sc*thermal_bias.sc:tsign + (1|STUDY_ID)')
dispform <- formula('~taxa_mod2 + REALM + nspp.sc + trendse')

completerows <- trends[, complete.cases(REALM, tempave_metab.sc, 
                                seas.sc, microclim.sc, 
                                temptrend_abs.sc, mass.sc,
                                nspp.sc, npp.sc, thermal_bias.sc,
                                human_bowler.sc)]

# Jtu
if(file.exists('temp/modslopeIntJtu3.rds')){
  modslopeIntJtu3 <- readRDS('temp/modslopeIntJtu3.rds')
} else {
  i <- trends[, complete.cases(disstrend) & duration == 2 & measure == 'Jtu'] & completerows
  sum(i)
  modslopeIntJtu3 <- glmmTMB(form, disp = dispform, data = trends[i,], control = glmmTMBControl(optCtrl=list(iter.max=1e3,eval.max=1e3)))
  saveRDS(modslopeIntJtu3, file = 'temp/modslopeIntJtu3.rds')
}

if(file.exists('temp/modslopeIntJtu5.rds')){
  modslopeIntJtu5 <- readRDS('temp/modslopeIntJtu5.rds')
} else {
  i <- trends[, complete.cases(disstrend) & duration == 4 & measure == 'Jtu'] & completerows
  sum(i)
  modslopeIntJtu5 <- glmmTMB(form, disp = dispform, data = trends[i,], control = glmmTMBControl(optCtrl=list(iter.max=1e3,eval.max=1e3)))
  saveRDS(modslopeIntJtu5, file = 'temp/modslopeIntJtu5.rds')
}

if(file.exists('temp/modslopeIntJtu10.rds')){
  modslopeIntJtu10 <- readRDS('temp/modslopeIntJtu10.rds')
} else {
  i <- trends[, complete.cases(disstrend) & duration == 9 & measure == 'Jtu'] & completerows
  modslopeIntJtu10 <- glmmTMB(form, disp = dispform, data = trends[i,], control = glmmTMBControl(optCtrl=list(iter.max=1e3,eval.max=1e3)))
  saveRDS(modslopeIntJtu10, file = 'temp/modslopeIntJtu10.rds')
}

if(file.exists('temp/modslopeIntJtu20.rds')){
  modslopeIntJtu20 <- readRDS('temp/modslopeIntJtu20.rds')
} else {
  i <- trends[, complete.cases(disstrend) & duration == 19 & measure == 'Jtu'] & completerows
  modslopeIntJtu20 <- glmmTMB(form, disp = dispform, data = trends[i,], control = glmmTMBControl(optCtrl=list(iter.max=1e3,eval.max=1e3)))
  saveRDS(modslopeIntJtu20, file = 'temp/modslopeIntJtu20.rds')
}

# Jbeta
if(file.exists('temp/modslopeIntJbeta3.rds')){
  modslopeIntJbeta3 <- readRDS('temp/modslopeIntJbeta3.rds')
} else {
  i <- trends[, complete.cases(disstrend) & duration == 2 & measure == 'Jbeta'] & completerows
  sum(i)
  modslopeIntJbeta3 <- glmmTMB(form, disp = dispform, data = trends[i,], control = glmmTMBControl(optCtrl=list(iter.max=1e3,eval.max=1e3)))
  saveRDS(modslopeIntJbeta3, file = 'temp/modslopeIntJbeta3.rds')
}

if(file.exists('temp/modslopeIntJbeta5.rds')){
  modslopeIntJbeta5 <- readRDS('temp/modslopeIntJbeta5.rds')
} else {
  i <- trends[, complete.cases(disstrend) & duration == 4 & measure == 'Jbeta'] & completerows
  sum(i)
  modslopeIntJbeta5 <- glmmTMB(form, disp = dispform, data = trends[i,], control = glmmTMBControl(optCtrl=list(iter.max=1e3,eval.max=1e3)))
  saveRDS(modslopeIntJbeta5, file = 'temp/modslopeIntJbeta5.rds')
}

if(file.exists('temp/modslopeIntJbeta10.rds')){
  modslopeIntJbeta10 <- readRDS('temp/modslopeIntJbeta10.rds')
} else {
  i <- trends[, complete.cases(disstrend) & duration == 9 & measure == 'Jbeta'] & completerows
  modslopeIntJbeta10 <- glmmTMB(form, disp = dispform, data = trends[i,], control = glmmTMBControl(optCtrl=list(iter.max=1e3,eval.max=1e3)))
  saveRDS(modslopeIntJbeta10, file = 'temp/modslopeIntJbeta10.rds')
}

if(file.exists('temp/modslopeIntJbeta20.rds')){
  modslopeIntJbeta20 <- readRDS('temp/modslopeIntJbeta20.rds')
} else {
  i <- trends[, complete.cases(disstrend) & duration == 19 & measure == 'Jbeta'] & completerows
  modslopeIntJbeta20 <- glmmTMB(form, disp = dispform, data = trends[i,], control = glmmTMBControl(optCtrl=list(iter.max=1e3,eval.max=1e3)))
  saveRDS(modslopeIntJbeta20, file = 'temp/modslopeIntJbeta20.rds')
}

# Horn
if(file.exists('temp/modslopeIntHorn3.rds')){
  modslopeIntHorn3 <- readRDS('temp/modslopeIntHorn3.rds')
} else {
  i <- trends[, complete.cases(disstrend) & duration == 2 & measure == 'Horn'] & completerows
  sum(i)
  modslopeIntHorn3 <- glmmTMB(form, disp = dispform, data = trends[i,], control = glmmTMBControl(optCtrl=list(iter.max=1e3,eval.max=1e3)))
  saveRDS(modslopeIntHorn3, file = 'temp/modslopeIntHorn3.rds')
}

if(file.exists('temp/modslopeIntHorn5.rds')){
  modslopeIntHorn5 <- readRDS('temp/modslopeIntHorn5.rds')
} else {
  i <- trends[, complete.cases(disstrend) & duration == 4 & measure == 'Horn'] & completerows
  sum(i)
  modslopeIntHorn5 <- glmmTMB(form, disp = dispform, data = trends[i,], control = glmmTMBControl(optCtrl=list(iter.max=1e3,eval.max=1e3)))
  saveRDS(modslopeIntHorn5, file = 'temp/modslopeIntHorn5.rds')
}

if(file.exists('temp/modslopeIntHorn10.rds')){
  modslopeIntHorn10 <- readRDS('temp/modslopeIntHorn10.rds')
} else {
  i <- trends[, complete.cases(disstrend) & duration == 9 & measure == 'Horn'] & completerows
  modslopeIntHorn10 <- glmmTMB(form, disp = dispform, data = trends[i,], control = glmmTMBControl(optCtrl=list(iter.max=1e3,eval.max=1e3)))
  saveRDS(modslopeIntHorn10, file = 'temp/modslopeIntHorn10.rds')
}

if(file.exists('temp/modslopeIntHorn20.rds')){
  modslopeIntHorn20 <- readRDS('temp/modslopeIntHorn20.rds')
} else {
  i <- trends[, complete.cases(disstrend) & duration == 19 & measure == 'Horn'] & completerows
  modslopeIntHorn20 <- glmmTMB(form, disp = dispform, data = trends[i,], control = glmmTMBControl(optCtrl=list(iter.max=1e3,eval.max=1e3)))
  saveRDS(modslopeIntHorn20, file = 'temp/modslopeIntHorn20.rds')
}


```

### Summary
```{r summary interaction}
print('Jtu3'); summary(modslopeIntJtu3)
print('Jtu5'); summary(modslopeIntJtu5)
print('Jtu10'); summary(modslopeIntJtu10)
#summary(modslopeIntJtu20)

print('Jbeta3'); summary(modslopeIntJbeta3)
print('Jbeta5'); summary(modslopeIntJbeta5)
#summary(modslopeIntJbeta10)
#summary(modslopeIntJbeta20)

print('Horn3'); summary(modslopeIntHorn3)
print('Horn5'); summary(modslopeIntHorn5)
print('Horn10'); summary(modslopeIntHorn10)
#summary(modslopeIntHorn20)

```

### Set up function to plot the interactions
```{r interactions plot function, echo = FALSE}
# mod should be a full model
# returns a list with 2 components: the plots and the dataframe
plotinteractions <- function(mod, ylims = c(-0.05, 0.1)){
  # set up the interactions to plot
  # if variable is logged before scaling (see 'center and scale' above), then need to mark it here and express the limits on a log10 scale (even though log transforming is log)
  ints <- data.frame(vars = c('tsign', 'tempave_metab', 'seas', 'microclim', 'mass', 'speed', 
                              'consumerfrac', 'nspp', 'thermal_bias', 'npp', 'veg', 'duration', 
                              'human_bowler', 'human_bowler'),
                     min =      c(1,  0,   0.1, -2,  0,   0,   0,   0.3, -10, 1.9, 0,   0.5, 0,   0), 
                     max =      c(2,  30,  16,  0.8, 8,   2,   1,   2.6, 10,  3.7, 0.3, 2,   1,   1),
                     log =      c(F,  F,   F,   T,   T,   T,   F,   T,   F,   T,   T,   T,   T,   T),
                     len =      c(2,  100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100),
                     discrete = c(T,  F,   F,   F,   F,   F,   F,   F,   F,   F,   F,   F,   F,   F),
                     plus =     c(0,  0,   0,   0,   0,   1,   0,   0,   0,   0,   1,   0,   1,   1), # what to add before log-scaling
                     REALM = c(rep('Terrestrial', 12), 'Terrestrial', 'Marine'),
                     REALM2 = c(rep('TerrFresh', 13), 'Marine'),
                     stringsAsFactors = FALSE)
  baseall <- trends[, .(type = 'all', tempave_metab.sc = mean(tempave_metab.sc, na.rm=TRUE), 
                        seas.sc = mean(seas.sc, na.rm=TRUE), 
                        microclim.sc = mean(microclim.sc, na.rm=TRUE), 
                        speed.sc = mean(speed.sc, na.rm=TRUE), 
                        mass.sc = mean(mass.sc, na.rm=TRUE), 
                        nspp.sc = 0, 
                        thermal_bias.sc = mean(thermal_bias.sc, na.rm=TRUE), 
                        npp.sc = mean(npp.sc, na.rm=TRUE), 
                        human_bowler.sc = mean(human_bowler.sc, na.rm=TRUE), 
                        veg.sc = mean(veg.sc, na.rm=TRUE), 
                        consumerfrac.sc = mean(consumerfrac.sc, na.rm=TRUE))]
  baseterr <- trends[REALM == 'Terrestrial', 
                     .(type = 'Terrestrial', 
                       tempave_metab.sc = mean(tempave_metab.sc, na.rm=TRUE), 
                       seas.sc = mean(seas.sc, na.rm=TRUE), 
                       microclim.sc = mean(microclim.sc, na.rm=TRUE), 
                       speed.sc = mean(speed.sc, na.rm=TRUE), 
                       mass.sc = mean(mass.sc, na.rm=TRUE), 
                       nspp.sc = 0, 
                       thermal_bias.sc = 0, 
                       npp.sc = mean(npp.sc, na.rm=TRUE), 
                       human_bowler.sc = mean(human_bowler.sc, na.rm=TRUE), 
                       veg.sc = mean(veg.sc, na.rm=TRUE), 
                       consumerfrac.sc = mean(consumerfrac.sc, na.rm=TRUE))]
  basemar <- trends[REALM == 'Marine', 
                    .(type = 'Marine',
                      tempave_metab.sc = mean(tempave_metab.sc, na.rm=TRUE), 
                      seas.sc = mean(seas.sc, na.rm=TRUE), 
                      microclim.sc = mean(microclim.sc, na.rm=TRUE), 
                      speed.sc = mean(speed.sc, na.rm=TRUE), 
                      mass.sc = mean(mass.sc, na.rm=TRUE), 
                      nspp.sc = 0, 
                      thermal_bias.sc = 0, 
                      npp.sc = mean(npp.sc, na.rm=TRUE), 
                      human_bowler.sc = mean(human_bowler.sc, na.rm=TRUE), 
                      veg.sc = mean(veg.sc, na.rm=TRUE), 
                      consumerfrac.sc = mean(consumerfrac.sc, na.rm=TRUE))]
  basetab <- rbind(baseall, baseterr, basemar)
  basetab[, ':='(duration.sc = 0, nyrBT = 20, STUDY_ID = 127L, rarefyID = '127_514668')]
  
  # make the data frames for each interaction to plot                
  for(j in 1:nrow(ints)){
    # set up a grid of temperature trends and the interacting variable
    if(ints$log[j]) intvars <- list(tempchange = seq(-0.2, 0.2, length.out = 100), 
                                    new = 10^seq(ints$min[j], ints$max[j], length.out = ints$len[j]),
                                    var = ints$vars[j])
    if(!ints$log[j]) intvars <- list(tempchange = seq(-0.2, 0.2, length.out = 100), 
                                     new = seq(ints$min[j], ints$max[j], length.out = ints$len[j]),
                                     var = ints$vars[j])
    names(intvars) <- c('tempchange', ints$vars[j], 'var')
    thisdat <- expand.grid(intvars)
    
    # scale the interacting variable
    cent <- attr(trends[[paste0(ints$var[j], '.sc')]], 'scaled:center')
    scl <- attr(trends[[paste0(ints$var[j], '.sc')]], 'scaled:scale')
    if(!is.null(cent) & !is.null(scl)){
      if(ints$log[j]) thisdat[[paste0(ints$var[j], '.sc')]] <- (log(thisdat[[ints$vars[j]]] + ints$plus[j]) - cent)/scl
      if(!ints$log[j]) thisdat[[paste0(ints$var[j], '.sc')]] <- (thisdat[[ints$var[j]]] - cent)/scl
    }
    
    # merge with the rest of the columns
    # use realm-specific averages for human impacts
    if(ints$vars[j] != 'tsign') colnamestouse <- setdiff(colnames(basetab), paste0(ints$var[j], '.sc'))
    if(ints$vars[j] == 'tsign') colnamestouse <- setdiff(colnames(basetab), ints$var[j])
    if(ints$vars[j] != 'human_bowler'){
      thisdat <- cbind(thisdat, basetab[type == 'all', ..colnamestouse])
    }
    if(ints$vars[j] == 'human_bowler' & ints$REALM[j] == 'Terrestrial'){
      thisdat <- cbind(thisdat, basetab[type == 'Terrestrial', ..colnamestouse])
    }
    if(ints$vars[j] == 'human_bowler' & ints$REALM[j] == 'Marine'){
      thisdat <- cbind(thisdat, basetab[type == 'Marine', ..colnamestouse])
    }
    
    # add realm
    thisdat$REALM <- ints$REALM[j]
    thisdat$REALM2 <- ints$REALM2[j]
    
    # merge with the previous iterations
    if(j == 1) newdat <- thisdat
    if(j > 1){
      colstoadd <- setdiff(colnames(thisdat), colnames(newdat))
      for(toadd in colstoadd){
        newdat[[toadd]] <- NA
      }
      
      colstoadd2 <- setdiff(colnames(newdat), colnames(thisdat))
      for(toadd in colstoadd2){
        thisdat[[toadd]] <- NA
      }
      
      newdat <- rbind(newdat, thisdat)
    } 
  }
  
  # character so that new levels can be added
  newdat$REALM <- as.character(newdat$REALM)
  newdat$REALM2 <- as.character(newdat$REALM2)
  
  # add extra rows so that all factor levels are represented (for predict.lme to work)
  newdat <- rbind(newdat[1:6, ], newdat)
  newdat$REALM[1:6] <- c('Marine', 'Marine', 'Freshwater', 'Freshwater', 'Terrestrial', 'Terrestrial')
  newdat$REALM2[1:6] <- c('Marine', 'Marine', 'TerrFresh', 'TerrFresh', 'TerrFresh', 'TerrFresh')
  newdat$tempchange[1:6] <- c(-0.2, 0.2, -0.2, 0.2, -0.2, 0.2)
  
  # trim to at least some temperature change (so that tsign is -1 or 1)
  newdat <- newdat[newdat$tempchange != 0,]
  
  # scale the temperature vars
  newdat$tempchange.sc <- newdat$tempchange/attr(trends$tempchange.sc, 'scaled:scale') 
  newdat$tempchange_abs <- abs(newdat$tempchange)
  newdat$tempchange_abs.sc <- (newdat$tempchange_abs)/attr(trends$tempchange_abs.sc, 'scaled:scale')
  newdat$tsign <- factor(sign(newdat$tempchange))
  
  # make predictions
  newdat$preds <- predict(object = mod, newdata = newdat, level = 0)
  
  #remove the extra rows
  newdat <- newdat[5:nrow(newdat), ]
  
  # prep the plots
  intplots <- vector('list', nrow(ints))
  for(j in 1:length(intplots)){
    subs <- newdat$var == ints$vars[j] & newdat$tempchange > 0 # select warming side
    xvar <- 'tempchange_abs'
    title <- ints$vars[j]
    if(ints$vars[j] %in% c('tsign')){
      subs <- newdat$var == ints$vars[j]
    } 
    if(ints$vars[j] %in% c('thermal_bias')){
      subs <- newdat$var == ints$vars[j]
      xvar <- 'tempchange'
    } 
    if(ints$vars[j] %in% c('human_bowler')){
      subs <- newdat$var == ints$vars[j] & newdat$tempchange > 0 & newdat$REALM2 == ints$REALM2[j]
      title <- paste0('human:', ints$REALM2[j])
    } 
    
    thisplot <- ggplot(newdat[subs, ], 
                       aes_string(x = xvar, y = 'preds', 
                                  group = ints$vars[j], 
                                  color = ints$vars[j])) +
      geom_line() +
      coord_cartesian(ylim = ylims) +
      #theme(plot.margin = unit(c(0.5,0,0.5,0), 'cm')) +
      labs(title = title)
    if(ints$log[j] & !ints$discrete[j]){
      intplots[[j]] <- thisplot + scale_color_distiller(palette = "YlGnBu", trans = 'log')
    }
    if(!ints$log[j] & !ints$discrete[j]){
      intplots[[j]] <- thisplot + scale_color_distiller(palette = "YlGnBu", trans = 'identity')
    }
    if(ints$discrete[j]){
      intplots[[j]] <- thisplot + scale_color_brewer(palette = "Dark2")
    }
  }
  out <- list(intplots = intplots, newdat = newdat)
  return(out)
}
```


### Plot interactions (Jaccard turnover rem0)
```{r interaction plots modTfullJturem0, fig.height = 13, fig.width = 9}

out <- plotinteractions(modTfullJturem0, ylims = c(-0.03, 0.03))

grid.arrange(grobs = out$intplots, ncol = 3)

# write out the interactions
write.csv(out$newdat, file = 'temp/interactionsJturem0.csv')

```

### Plot interactions (Horn rem0)
```{r interaction plots modTfullHornrem0, fig.height = 13, fig.width = 9}

out <- plotinteractions(modTfullHornrem0, ylims = c(-0.02, 0.07))

grid.arrange(grobs = out$intplots, ncol = 3)

# write out the interactions
write.csv(out$newdat, file = 'temp/interactionsHornrem0.csv')

```


### DHARMa model evaluation
```{r, fig.height = 10, fig.width=10}

```

## Remove each term from the full model
```{r term deletion from modTfull, eval = FALSE}
AICnas <- function(x){
  if(class(x) == 'NULL'){
    return(NA)
  } else {
    return(AIC(x))
  }
}

# set up the response variables to run
torun = data.frame(var = c('Jtutrendrem0', 'Jbetatrendrem0', 'Horntrendrem0'), 
                   modvar = c('Jtutrendrem0', 'Jbetatrendrem0', 'Horntrendrem0'),
                   run = TRUE, aics = NA)

# check if any already exist. If so, don't re-run that model.
if(file.exists('output/aics_from_full.csv')){
  aicsfromfull <- read.csv('output/aics_from_full.csv')
  
  for(i in 1:nrow(torun)){
    nm <- paste0('dAIC_', torun$var[i])
    if(nm %in% colnames(aicsfromfull)){ # check for column name
      if(!is.na(aicsfromfull[[nm]][1])){ # check that full model is not NA
        torun$run[i] <- FALSE
      }
    }
  }
}

randef <- list(STUDY_ID = ~ tempchange_abs.sc, rarefyID = ~1)
varef <- varPower(-0.5, ~nyrBT)

terms <- c('tempchange_abs.sc*REALM', 
           'tempchange_abs.sc*tsign',
           'tempchange_abs.sc*tempave_metab.sc',
           'tempchange_abs.sc*seas.sc',
           'tempchange_abs.sc*microclim.sc',
           'tempchange_abs.sc*mass.sc',
           'tempchange_abs.sc*speed.sc', 
           'tempchange_abs.sc*consumerfrac.sc',
           'tempchange_abs.sc*nspp.sc',
           'tempchange_abs.sc*thermal_bias.sc:tsign',
           'tempchange_abs.sc*npp.sc',
           'tempchange_abs.sc*veg.sc',
           'tempchange_abs.sc*duration.sc',
           'tempchange_abs.sc*human_bowler.sc:REALM2')

completerows <- trends[, complete.cases(REALM, tempave_metab.sc, 
                                seas.sc, microclim.sc, 
                                tempchange_abs.sc, mass.sc, speed.sc, 
                                consumerfrac.sc, nspp.sc, thermal_bias.sc, npp.sc, 
                                veg.sc, duration.sc, human_bowler.sc)]

if(any(torun$run)){
  for(k in which(torun$run)){

    i <- !is.na(trends[[as.character(torun$var[k])]]) & completerows
    
    modTdrops <- vector('list', length(terms)+2)
    names(modTdrops) <- c('full', '-tempchange_abs.sc', paste0('-', terms))
    
    # fit full model with ML for model comparison
    modTdrops[[1]] <- lme(formula(paste0(torun$modvar[k], ' ~ ', paste(terms, collapse = ' + '))),
                          random = randef, weights = varef, data = trends[i,], method = 'ML',
                          control = lmeControl(maxIter = 100, msMaxIter = 100, niterEM = 50, msMaxEval = 500, opt = 'optim'))
    
    # w/out tempchange
    modTdrops[[2]] <- lme(formula(paste0(torun$modvar[k], ' ~ ', paste(gsub('tempchange_abs.sc\\*', '', terms), 
                                                                       collapse = ' + '))),
                          random = list(STUDY_ID = ~ 1, rarefyID = ~1), weights = varef, data = trends[i,], method = 'ML',
                          control = lmeControl(maxIter = 100, msMaxIter = 100, niterEM = 50, msMaxEval = 500, opt = 'optim'))
    
    for(j in 1:length(terms)){
      print(j)
      tryCatch({
        modTdrops[[j+2]] <- lme(formula(paste0(torun$modvar[k], ' ~ ', paste(terms[-j], collapse = ' + '))),
                                random = randef, weights = varef, data = trends[i,], method = 'ML')
        
      }, error = function(e){
        print('going to optim (Jtu)')
        tryCatch({
          modTdrops[[j+2]] <- lme(formula(paste0(torun$modvar[k], ' ~ ', paste(terms[-j], collapse = ' + '))),
                                  random = randef, weights = varef, data = trends[i,], method = 'ML',
                                  control = lmeControl(opt = 'optim'))
          
        }, error = function(e){
          print('going to more iters (Jtu)') 
          tryCatch({
            modTdrops[[j+2]] <- lme(formula(paste0(torun$modvar[k], ' ~ ', paste(terms[-j], collapse = ' + '))),
                                    random = randef, weights = varef, data = trends[i,], method = 'ML',
                                    control = lmeControl(maxIter = 100, msMaxIter = 100, niterEM = 50, msMaxEval = 500))
            
          }, error= function(e){
            print('giving up on this one')
            modTdrops[[j+2]] <- NA
          })
        })
      })
    }
    
    torun$aics[k] <- list(sapply(modTdrops, AICnas))
  }
}



# if there was anything new
if(any(torun$run)){
  if(!exists('aicsfromfull')){
    aicsfromfull <- data.frame(mod = names(torun$aics[which(torun$run)[1]][[1]]))
  }
  
  # subtract full from each model AIC. Negative means term removal is supported. Positive means full is the better model.
  for(j in which(torun$run)){
    nm <- paste0('dAIC_', torun$var[j])
    aics <- torun$aics[j][[1]]
    aicsfromfull[[nm]] <- aics - aics[1]
  }

  
  # write out
  write.csv(aicsfromfull, file = 'output/aics_from_full.csv', row.names = FALSE)
}

aicsfromfull
```

### Plot deltaAICs for all models
```{r plot dAICs, message = FALSE, warning = FALSE}
# transform for a plot
aicsfromfulllong <- reshape(aicsfromfull, direction = 'long',
                            varying = c('dAIC_Jtutrendrem0', 'dAIC_Jbetatrendrem0', 'dAIC_Horntrendrem0'),
                            v.names = 'dAIC',
                            idvar = 'mod',
                            timevar = 'type',
                            times = c('Jtutrendrem0', 'Jbetatrendrem0', 'Horntrendrem0'))
aicsfromfulllong$response <- gsub('trendrem0', '', aicsfromfulllong$type)
aicsfromfulllong$fit <- gsub('Jtu|Jbeta|Horn', '', aicsfromfulllong$type)

# plot
ggplot(aicsfromfulllong, aes(y=dAIC, x = mod, shape = response, color = fit, group = fit)) +
  geom_point(position = position_dodge(width = 0.5)) +
  scale_y_continuous(trans = signedsqrttrans) +
  coord_flip()
```

Clear that removing temperature trend makes the model quite a bit worse.



## Simplify the full models
This takes a couple days on a laptop to run if temp/ files not available.
Not run when knitting
```{r simplify the full models, eval = FALSE}
randef <- list(STUDY_ID = ~ tempchange_abs.sc, rarefyID = ~1)
varef <- varPower(-0.5, ~nyrBT)

terms <- ' ~ tempchange_abs.sc*REALM + tempchange_abs.sc*tsign + tempchange_abs.sc*tempave_metab.sc + tempchange_abs.sc*seas.sc + tempchange_abs.sc*microclim.sc + tempchange_abs.sc*mass.sc + tempchange_abs.sc*speed.sc + tempchange_abs.sc*consumerfrac.sc + tempchange_abs.sc*nspp.sc + tempchange_abs.sc*thermal_bias.sc:tsign + tempchange_abs.sc*npp.sc + tempchange_abs.sc*veg.sc + tempchange_abs.sc*duration.sc + tempchange_abs.sc*human_bowler.sc:REALM2'

completerows <- trends[, complete.cases(REALM, tempave_metab.sc, 
                                        seas.sc, microclim.sc, 
                                        tempchange_abs.sc, mass.sc, speed.sc, 
                                        consumerfrac.sc, nspp.sc, thermal_bias.sc, npp.sc, 
                                        veg.sc, duration.sc, human_bowler.sc)]

# rem0
if(file.exists('temp/modTsimpJturem0.rds')){
  modTsimpJturem0 <- readRDS('temp/modTsimpJturem0.rds')
} else {
  i <- !is.na(trends$Jtutrendrem0) & completerows
  
  modTfullJturem0ML <- lme(formula(paste0('Jtutrendrem0', terms)),
                           random = randef, weights = varef, data = trends[i,], method = 'ML',
                           control = lmeControl(maxIter = 100, msMaxIter = 100, niterEM = 50, msMaxEval = 500, opt = 'optim'))
  modTsimpJturem0 <- stepAIC(modTfullJturem0ML, direction = 'backward')
  saveRDS(modTsimpJturem0, file = 'temp/modTsimpJturem0.rds')
}

if(file.exists('temp/modTsimpJbetarem0.rds')){
  modTsimpJbetarem0 <- readRDS('temp/modTsimpJbetarem0.rds')
} else {
  i <- !is.na(trends$Jbetatrendrem0) & completerows
  modTfullJbetarem0ML <- lme(formula(paste0('Jbetatrendrem0', terms)),
                       random = randef, weights = varef, data = trends[i,], method = 'ML',
                       control = lmeControl(maxIter = 100, msMaxIter = 100, niterEM = 50, msMaxEval = 500, opt = 'optim'))
  modTsimpJbetarem0 <- stepAIC(modTfullJbetarem0ML, direction = 'backward')
  saveRDS(modTsimpJbetarem0, file = 'temp/modTsimpJbetarem0.rds')
}

if(file.exists('temp/modTsimpHornrem0.rds')){
  modTsimpHornrem0 <- readRDS('temp/modTsimpHornrem0.rds')
} else {
  i <- !is.na(trends$Horntrendrem0) & completerows
  modTfullHornrem0ML <- lme(formula(paste0('Horntrendrem0', terms)),
                            random = randef, weights = varef, data = trends[i,], method = 'ML',
                            control = lmeControl(maxIter = 100, msMaxIter = 100, niterEM = 50, msMaxEval = 500, opt = 'optim'))
  modTsimpHornrem0 <- stepAIC(modTfullHornrem0ML, direction = 'backward')
  saveRDS(modTsimpHornrem0, file = 'temp/modTsimpHornrem0.rds')
}


summary(modTsimpJturem0)
summary(modTsimpJbetarem0)
summary(modTsimpHornrem0)


```


## Make realm-specific models
Not run now
```{r LME Horn models by realm, eval = FALSE}
i1 <- trends[, REALM == 'Terrestrial' & complete.cases(Horntrendrem0, tempave_metab.sc, seas.sc, microclim.sc, 
                             tempchange_abs.sc, mass.sc, speed.sc, 
                             consumerfrac.sc, nspp.sc, thermal_bias.sc, npp.sc, 
                             veg.sc, duration.sc, human_bowler.sc)]
i2 <- trends[, REALM == 'Freshwater' & complete.cases(Horntrendrem0, tempave_metab.sc, seas.sc, microclim.sc, 
                             tempchange_abs.sc, mass.sc, speed.sc, 
                             nspp.sc, thermal_bias.sc, npp.sc, 
                             veg.sc, duration.sc, human_bowler.sc)] # no consumerfrac
i3 <- trends[, REALM == 'Marine' & complete.cases(Horntrendrem0, tempave_metab.sc, seas.sc, microclim.sc, 
                             tempchange_abs.sc, mass.sc, speed.sc, 
                             consumerfrac.sc, nspp.sc, thermal_bias.sc, npp.sc, 
                             duration.sc, human_bowler.sc)] # no veg

print(paste('Terrestrial', sum(i1)))
print(paste('Freshwater', sum(i2)))
print(paste('Marine', sum(i3)))

randef <- list(STUDY_ID = ~ tempchange_abs.sc, rarefyID = ~1)
varef <- varPower(-0.5, ~nyrBT)

# land
if(file.exists('temp/modTfullHornTerr.rds')){
  modTfullHornTerr <- readRDS('temp/modTfullHornTerr.rds')
} else {
  modTfullHornTerr <- lme(Horntrendrem0 ~ 
                         tempchange_abs.sc*tsign +
                         tempchange_abs.sc*tempave_metab.sc + 
                         tempchange_abs.sc*seas.sc + 
                         tempchange_abs.sc*microclim.sc + 
                         tempchange_abs.sc*mass.sc + 
                         tempchange_abs.sc*speed.sc + 
                         tempchange_abs.sc*consumerfrac.sc +
                         tempchange_abs.sc*nspp.sc +
                         tempchange_abs.sc*thermal_bias.sc:tsign +
                         tempchange_abs.sc*npp.sc +
                         tempchange_abs.sc*veg.sc +
                         tempchange_abs.sc*duration.sc +
                         tempchange_abs.sc*human_bowler.sc,
                       random = randef, weights = varef, data = trends[i1,], method = 'REML',
                       control = lmeControl(maxIter = 100, msMaxIter = 100, niterEM = 50, msMaxEval = 500))
  saveRDS(modTfullHornTerr, file = 'temp/modTfullHornTerr.rds')
}

# freshwater
if(file.exists('temp/modTfullHornFresh.rds')){
  modTfullHornFresh <- readRDS('temp/modTfullHornFresh.rds')
} else {
  modTfullHornFresh <- lme(Horntrendrem0 ~ 
                         tempchange_abs.sc*tsign +
                         tempchange_abs.sc*tempave_metab.sc + 
                         tempchange_abs.sc*seas.sc + 
                         tempchange_abs.sc*microclim.sc + 
                         tempchange_abs.sc*mass.sc + 
                         tempchange_abs.sc*speed.sc + 
                         tempchange_abs.sc*nspp.sc +
                         tempchange_abs.sc*thermal_bias.sc:tsign +
                         tempchange_abs.sc*npp.sc +
                         tempchange_abs.sc*veg.sc +
                         tempchange_abs.sc*duration.sc +
                         tempchange_abs.sc*human_bowler.sc,
                       random = randef, weights = varef, data = trends[i2,], method = 'REML',
                       control = lmeControl(maxIter = 100, msMaxIter = 100, niterEM = 50, msMaxEval = 500))
  saveRDS(modTfullHornFresh, file = 'temp/modTfullHornFresh.rds')
}

# marine
if(file.exists('temp/modTfullHornMar.rds')){
  modTfullHornMar <- readRDS('temp/modTfullHornMar.rds')
} else {
  modTfullHornMar <- lme(Horntrendrem0 ~ 
                         tempchange_abs.sc*tsign +
                         tempchange_abs.sc*tempave_metab.sc + 
                         tempchange_abs.sc*seas.sc + 
                         tempchange_abs.sc*microclim.sc + 
                         tempchange_abs.sc*mass.sc + 
                         tempchange_abs.sc*speed.sc + 
                         tempchange_abs.sc*consumerfrac.sc +
                         tempchange_abs.sc*nspp.sc +
                         tempchange_abs.sc*thermal_bias.sc:tsign +
                         tempchange_abs.sc*npp.sc +
                         tempchange_abs.sc*duration.sc +
                         tempchange_abs.sc*human_bowler.sc,
                       random = randef, weights = varef, data = trends[i3,], method = 'REML',
                       control = lmeControl(maxIter = 100, msMaxIter = 100, niterEM = 50, msMaxEval = 500))
  saveRDS(modTfullHornMar, file = 'temp/modTfullHornMar.rds')
}

summary(modTfullHornTerr)
summary(modTfullHornFresh)
summary(modTfullHornMar)
```

### Plot the realm-specific coefficients
Not run now

Also uses the full models across all realms
```{r plot realm mods, fig.height=12, fig.width=9, eval = FALSE}

coefs1 <- summary(modTfullHornrem0)$tTable
coefs2 <- summary(modTfullHornTerr)$tTable
coefs3 <- summary(modTfullHornFresh)$tTable
coefs4 <- summary(modTfullHornMar)$tTable

varstoplot <- unique(c(rownames(coefs1), rownames(coefs2), rownames(coefs3), rownames(coefs4)))
varstoplot <- varstoplot[which(!grepl('Intercept', varstoplot) | grepl(':', varstoplot))] # vars to plot

rows1_1 <- which(rownames(coefs1) %in% varstoplot) # rows in coefs
rows1_2 <- which(rownames(coefs2) %in% varstoplot)
rows1_3 <- which(rownames(coefs3) %in% varstoplot)
rows1_4 <- which(rownames(coefs4) %in% varstoplot)
xlims <- range(c(coefs1[rows1_1,1] - coefs1[rows1_1,2], coefs1[rows1_1,1] + coefs1[rows1_1,2], 
                 coefs2[rows1_2,1] - coefs2[rows1_2,2], coefs2[rows1_2,1] + coefs2[rows1_2,2], 
                 coefs3[rows1_3,1] - coefs3[rows1_3,2], coefs3[rows1_3,1] + coefs3[rows1_3,2],
                 coefs4[rows1_4,1] - coefs4[rows1_4,2], coefs4[rows1_4,1] + coefs4[rows1_4,2]))


cols <- brewer.pal(4, 'Dark2') # for full, terr, fresh, mar
pchs <- c(1, 16, 16, 16)
offs <- c(0.1, 0, -0.1, -0.2) # offset vertically for each model


par(las = 1, mai = c(0.5, 4, 0.1, 0.1))

plot(0,0, col = 'white', xlim = xlims, ylim = c(1,length(varstoplot)), yaxt='n', xlab = '', ylab ='')
axis(2, at = length(varstoplot):1, labels = varstoplot, cex.axis = 0.7)
abline(v = 0, col = 'grey', lty = 2)
abline(h = 1:length(varstoplot), col = 'grey', lty = 3)
for(i in 1:length(varstoplot)){
  if(varstoplot[i] %in% rownames(coefs1)){
    x = coefs1[rownames(coefs1) == varstoplot[i], 1]
    se = coefs1[rownames(coefs1) == varstoplot[i], 2]
    points(x, length(varstoplot) + 1 - i + offs[1], pch = pchs[1], col = cols[1])
    lines(x = c(x-se, x+se), y = c(length(varstoplot) + 1 - i + offs[1], length(varstoplot) + 1 - i + offs[1]), col = cols[1])
  }
  if(varstoplot[i] %in% rownames(coefs2)){
    x = coefs2[rownames(coefs2) == varstoplot[i], 1]
    se = coefs2[rownames(coefs2) == varstoplot[i], 2]
    points(x, length(varstoplot) + 1 - i + offs[2], pch = pchs[2], col = cols[2])
    lines(x = c(x-se, x+se), y = c(length(varstoplot) + 1 - i + offs[2], length(varstoplot) + 1 - i + offs[2]), col = cols[2])
  }
  if(varstoplot[i] %in% rownames(coefs3)){
    x = coefs3[rownames(coefs3) == varstoplot[i], 1]
    se = coefs3[rownames(coefs3) == varstoplot[i], 2]
    points(x, length(varstoplot) + 1 - i + offs[3], pch = pchs[3], col = cols[3])
    lines(x = c(x-se, x+se), y = c(length(varstoplot) + 1 - i + offs[3], length(varstoplot) + 1 - i + offs[3]), col = cols[3])
  }
  if(varstoplot[i] %in% rownames(coefs4)){
    x = coefs4[rownames(coefs4) == varstoplot[i], 1]
    se = coefs4[rownames(coefs4) == varstoplot[i], 2]
    points(x, length(varstoplot) + 1 - i + offs[4], pch = pchs[4], col = cols[4])
    lines(x = c(x-se, x+se), y = c(length(varstoplot) + 1 - i + offs[4], length(varstoplot) + 1 - i + offs[4]), col = cols[4])
  }
}
legend('bottomleft', col = cols, pch = pchs, lwd = 1, legend = c('All', 'Terestrial', 'Freshwater', 'Marine'))
```

[End text in hopes this helps the last figure show up when knitted]