---
title: 'Temperature change and the community response to temperature change across realms'
subtitle: '(using mixed effects models)'
output: 
    github_document: default

---
# Prep
<details>
<summary>Click to expand code</summary>

```{r setup}
library(data.table) # for handling large datasets
library(ggplot2) # for some plotting
library(nlme) # for ME models
library(maps) # for map
library(gridExtra) # to combine ggplots together
library(grid) # to combine ggplots together
library(RColorBrewer)
library(MASS) # for stepAIC
library(piecewiseSEM) # for rsquared() for nlme models
library(scales) # for defining custom scales in ggplot

options(width=500) # turn off most text wrapping

signedsqrt = function(x) sign(x)*sqrt(abs(x))
signedsq = function(x) sign(x) * x^2
signedsqrttrans <- trans_new(name = 'signedsqrt', transform = signedsqrt, inverse = signedsq)


# tell RStudio to use project root directory as the root for this notebook. Needed since we are storing code in a separate directory.
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file()) 
```


```{r load data}
# Turnover and covariates assembled by turnover_vs_temperature_prep.Rmd
trends <- fread('output/turnover_w_covariates.csv.gz')
```

```{r trim data}
# trim to only data with some temperature change
# important since sign of temperature change is a variable
trends[tempchange == 0, .N] # number to remove
trends <- trends[tempchange != 0, ] # also removes any NA values
```

```{r set up use vars}
# set realm order
trends[, REALM := factor(REALM, levels = c('Freshwater', 'Marine', 'Terrestrial'), ordered = FALSE)]

# set up sign of temperature change
trends[, tsign := factor(sign(tempchange))]

# realm that combines Terrestrial and Freshwater, for interacting with human impact
trends[, REALM2 := REALM]
levels(trends$REALM2) = list(TerrFresh = "Freshwater", TerrFresh = "Terrestrial", Marine = "Marine")

# group Marine invertebrates/plants in with All
trends[, taxa_mod2 := taxa_mod]
trends[taxa_mod == 'Marine invertebrates/plants', taxa_mod2 := 'All']

# calculate duration
trends[, duration := year2 - year1]

#add a comparison id
trends[, compID := paste0(rarefyID, '_', year1, '_', year2)]

```


## Log-transform some variables, then center and scale. 
``` {r center and scale}
trends[, tempave.sc := scale(tempave)]
trends[, tempave_metab.sc := scale(tempave_metab)]
trends[, seas.sc := scale(seas)]
trends[, microclim.sc := scale(log(microclim))]
trends[, tempchange.sc := scale(tempchange, center = FALSE)] # do not center
trends[, tempchange_abs.sc := scale(abs(tempchange), center = FALSE)] # do not center, so that 0 is still 0 temperature change
trends[, mass.sc := scale(log(mass_mean_weight))]
trends[, speed.sc := scale(log(speed_mean_weight+1))]
trends[, lifespan.sc := scale(log(lifespan_mean_weight))]
trends[, consumerfrac.sc := scale(consfrac)]
trends[, endothermfrac.sc := scale(endofrac)]
trends[, nspp.sc := scale(log(Nspp))]
trends[, thermal_bias.sc := scale(thermal_bias)]
trends[, npp.sc := scale(log(npp))]
trends[, veg.sc := scale(log(veg+1))]
trends[, duration.sc := scale(log(duration))]
trends[, human_bowler.sc := scale(log(human_bowler+1)), by = REALM2] # separate scaling by realm
trends[REALM2 == 'TerrFresh', human_footprint.sc := scale(log(human_venter+1))]
trends[REALM2 == 'Marine', human_footprint.sc := scale(log(human_halpern))]
```

</details>

# Summary stats
## Examine how many data points are available
### Just turnover and non-zero tempchange
```{r sample size all}
cat('Overall # dissimilarities: ', nrow(trends), '\n')
cat('# studies: ', trends[, length(unique(STUDY_ID))], '\n')
cat('# timeseries: ', trends[, length(unique(rarefyID))], '\n')
trends[!duplicated(rarefyID), table(REALM)]
trends[!duplicated(rarefyID), table(taxa_mod)]
trends[!duplicated(rarefyID), table(taxa_mod, REALM)]
```

### With all covariates
Use Bowler for human impact
```{r sample size Jtu covariates}
# the cases we can compare
apply(trends[, .(Jtu, REALM, tempave_metab.sc, seas.sc, microclim.sc, tempchange.sc, mass.sc, speed.sc, consumerfrac.sc, endothermfrac.sc, nspp.sc, thermal_bias.sc, npp.sc, veg.sc, human_bowler.sc)], MARGIN = 2, FUN = function(x) sum(!is.na(x)))
i <- trends[, complete.cases(Jtu, tempave_metab.sc, seas.sc, microclim.sc, tempchange.sc, mass.sc, speed.sc, consumerfrac.sc, nspp.sc, thermal_bias.sc, npp.sc, veg.sc, human_bowler.sc)]
cat('Overall # dissimilarities: ', sum(i), '\n')
cat('# studies: ', trends[i, length(unique(STUDY_ID))], '\n')
cat('# timeseries: ', trends[i, length(unique(rarefyID))], '\n')
trends[i & !duplicated(rarefyID), table(REALM)]
trends[i & !duplicated(rarefyID), table(taxa_mod)]
trends[i & !duplicated(rarefyID), table(taxa_mod, REALM)]
```

# Models
## Choose the variance structure for mixed effects models
Try combinations of

- variance scaled to a power of the abs temperature trend
- random intercept for taxa_mod2
- random intercept for STUDY_ID
- random intercept for rarefyID
- random slope (abs temperature trend) for taxa_mod
- random slope (abs temperature trend) for STUDY_ID
- random intercept for compID (for overdispersion)

And choose the one with lowest AIC (not run: takes a long time)
```{r choose variance structure, eval = FALSE}
# fit models for variance structure
fixed <- formula(Jtu ~ tempchange_abs.sc*REALM +
                     tempchange_abs.sc*tsign + 
                     tempchange_abs.sc*tempave_metab.sc + 
                     tempchange_abs.sc*seas.sc + 
                     tempchange_abs.sc*microclim.sc + 
                     tempchange_abs.sc*mass.sc + 
                     tempchange_abs.sc*speed.sc + 
                     tempchange_abs.sc*consumerfrac.sc +
                     tempchange_abs.sc*nspp.sc +
                     tempchange_abs.sc*thermal_bias.sc:tsign +
                     tempchange_abs.sc*npp.sc +
                     tempchange_abs.sc*veg.sc +
                     tempchange_abs.sc*duration.sc +
                     tempchange_abs.sc*human_bowler.sc:REALM2)
i <- trends[, complete.cases(Jtu, tempchange_abs.sc, REALM, tsign, tempave_metab.sc, seas.sc, 
                             microclim.sc, mass.sc, speed.sc, consumerfrac.sc, nspp.sc,
                             thermal_bias.sc, npp.sc, veg.sc, human_bowler.sc)]
mods <- vector('list', 0)
mods[[1]] <- gls(fixed, data = trends[i,])
mods[[2]] <- gls(fixed, data = trends[i,], weights = varPower(0.5, ~tempchange_abs.sc))

mods[[3]] <- lme(fixed, data = trends[i,], random = ~1|taxa_mod2, control = lmeControl(opt = "optim"))
mods[[4]] <- lme(fixed, data = trends[i,], random = ~1|STUDY_ID, control = lmeControl(opt = "optim"))
mods[[5]] <- lme(fixed, data = trends[i,], random = ~1|taxa_mod2/STUDY_ID, control = lmeControl(opt = "optim"))
mods[[6]] <- lme(fixed, data = trends[i,], random = ~1|STUDY_ID/rarefyID, control = lmeControl(opt = "optim"))
mods[[7]] <- lme(fixed, data = trends[i,], random = ~1|taxa_mod2/STUDY_ID/rarefyID, control = lmeControl(opt = "optim"))
mods[[8]] <- lme(fixed, data = trends[i,], random = ~1|STUDY_ID/rarefyID/compID, control = lmeControl(opt = "optim"))
mods[[9]] <- lme(fixed, data = trends[i,], random = ~1|taxa_mod2/STUDY_ID/rarefyID/compID, control = lmeControl(opt = "optim"))

mods[[10]] <- lme(fixed, data = trends[i,], random = ~tempchange_abs.sc | taxa_mod2)
mods[[11]] <- lme(fixed, data = trends[i,], random = list(taxa_mod2 = ~ tempchange_abs.sc, STUDY_ID = ~ tempchange_abs.sc))
mods[[12]] <- lme(fixed, data = trends[i,], random = list(taxa_mod2 = ~ tempchange_abs.sc, STUDY_ID = ~ tempchange_abs.sc, rarefyID = ~tempchange_abs.sc))
mods[[13]] <- lme(fixed, data = trends[i,], random = list(STUDY_ID = ~ tempchange_abs.sc, rarefyID = ~tempchange_abs.sc))

mods[[14]] <- lme(fixed, data = trends[i,], random = list(STUDY_ID = ~tempchange_abs.sc, rarefyID = ~tempchange_abs.sc), 
                  weights = varPower(-0.5, ~tempchange_abs.sc))
mods[[15]] <- lme(fixed, data = trends[i,], random = list(taxa_mod2 = ~ tempchange_abs.sc, 
                                                          STUDY_ID = ~ tempchange_abs.sc, 
                                                          rarefyID = ~tempchange_abs.sc), 
                  weights = varPower(-0.5, ~tempchange_abs.sc))

save(mods, file = 'temp/modsRF.RData')

aics <- sapply(mods, AIC)
minaics <- aics - min(aics)
minaics
which.min(aics)
```
Chooses the random slopes (tempchange_abs.sc) & intercepts for taxa_mod2, STUDY_ID, rarefyID, and variance scaled to tempchange_abs.sc.
We haven't dealt with potential testing on the boundary issues here yet.


## Temperature-only models
### Fit/load the models
```{r LME temperature only}

randef <- list(taxa_mod2 = ~ abs(tempchange), STUDY_ID = ~ abs(tempchange), rarefyID = ~abs(tempchange))
varef <- varPower(-0.5, ~abs(tempchange))

if(file.exists('temp/modonlyTchangeJtu.rds')){
  modonlyTchangeJtu <- readRDS('temp/modonlyTchangeJtu.rds')
} else {
  i <- trends[, complete.cases(Jtu, tempchange)]
  modonlyTchangeJtu <- lme(Jtu ~ abs(tempchange),
                   random = randef, weights = varef, data = trends[i,], method = 'REML')
  saveRDS(modonlyTchangeJtu, file = 'temp/modonlyTchangeJtu.rds')
}

if(file.exists('temp/modonlyTchangeJbeta.rds')){
  modonlyTchangeJbeta <- readRDS('temp/modonlyTchangeJbeta.rds')
} else {
  i <- trends[, complete.cases(Jbeta, tempchange)]
  modonlyTchangeJbeta <- lme(Jbeta ~ abs(tempchange),
                   random = randef, weights = varef, data = trends[i,], method = 'REML', 
                   control=lmeControl(msMaxIter = 100, maxIter = 100))
  saveRDS(modonlyTchangeJbeta, file = 'temp/modonlyTchangeJbeta.rds')
}

if(file.exists('temp/modonlyTchangeHorn.rds')){
  modonlyTchangeHorn <- readRDS('temp/modonlyTchangeHorn.rds')
} else {
  i <- trends[, complete.cases(Horn, tempchange)]
  modonlyTchangeHorn <- lme(Horn ~ abs(tempchange),
                   random = randef, weights = varef, data = trends[i,], method = 'REML')
  saveRDS(modonlyTchangeHorn, file = 'temp/modonlyTchangeHorn.rds')
}

```

### Summary: Slope of dissimilarity
```{r summary of Tchangeonly mods}
summary(modonlyTchangeJtu)
summary(modonlyTchangeJbeta)
summary(modonlyTchangeHorn)
```

### Plot the temp-only coefficients
```{r modonlyT coefs}
# make table of coefficients
coefs1 <- as.data.frame(summary(modonlyTchangeJtu)$tTable)
coefs2 <- as.data.frame(summary(modonlyTchangeJbeta)$tTable)
coefs3 <- as.data.frame(summary(modonlyTchangeHorn)$tTable)
coefs1$response <- 'Jtu'
coefs2$response <- 'Jbeta'
coefs3$response <- 'Horn'
rows1 <- which(grepl('tempchange', rownames(coefs1))) # extract temperature effect
cols <- c('Value', 'Std.Error', 'response')
allcoefs <- rbind(coefs1[rows1, cols], coefs2[rows1, cols], coefs3[rows1, cols])

allcoefs$lCI <- allcoefs$Value - 1.96 * allcoefs$Std.Error # lower confidence interval
allcoefs$uCI <- allcoefs$Value + 1.96 * allcoefs$Std.Error
allcoefs$y <- c(3, 2, 1) # y-values

ggplot(subset(allcoefs), aes(x = response, y = Value)) +
  geom_point() + 
  geom_errorbar(aes(ymin=lCI, ymax=uCI), width=.1) +
  labs(y = 'Dissimilarity per |°C change|') + 
  coord_cartesian(ylim = c(-0.01, 0.05))


```
CIs are 1.96*SE

## Temperature&duration models
### Fit/load the models
```{r LME temperature and duration}

randef <- list(taxa_mod2 = ~ abs(tempchange), STUDY_ID = ~ abs(tempchange), rarefyID = ~abs(tempchange))
varef <- varPower(-0.5, ~abs(tempchange))

if(file.exists('temp/modTDJtu.rds')){
  modTDJtu <- readRDS('temp/modTDJtu.rds')
} else {
  i <- trends[, complete.cases(Jtu, REALM, tempchange)]
  modTDJtu <- lme(Jtu ~ abs(tempchange) * duration,
                   random = randef, weights = varef, data = trends[i,], method = 'REML')
  saveRDS(modTDJtu, file = 'temp/modTDJtu.rds')
}

if(file.exists('temp/modTDJbeta.rds')){
  modTDJbeta <- readRDS('temp/modTDJbeta.rds')
} else {
  i <- trends[, complete.cases(Jbeta, REALM, tempchange)]
  modTDJbeta <- lme(Jbeta ~ abs(tempchange)*duration,
                   random = randef, weights = varef, data = trends[i,], method = 'REML', 
                   control=lmeControl(msMaxIter = 100, maxIter = 100))
  saveRDS(modTDJbeta, file = 'temp/modTDJbeta.rds')
}

if(file.exists('temp/modTDHorn.rds')){
  modTDHorn <- readRDS('temp/modTDHorn.rds')
} else {
  i <- trends[, complete.cases(Horn, REALM, tempchange)]
  modTDHorn <- lme(Horn ~ abs(tempchange)*duration,
                   random = randef, weights = varef, data = trends[i,], method = 'REML')
  saveRDS(modTDHorn, file = 'temp/modTDHorn.rds')
}


```

### Summary: Slope of dissimilarity
```{r summary of TD mods}
summary(modTDJtu)
summary(modTDJbeta)
summary(modTDHorn)
```


### Plot the temp coefficients from TD models
```{r modTD coefs}

coefs1 <- summary(modTDJtu)$tTable
coefs2 <- summary(modTDJbeta)$tTable
coefs3 <- summary(modTDHorn)$tTable

varstoplot <- unique(c(rownames(coefs1), rownames(coefs2), rownames(coefs3)))
varstoplot <- varstoplot[which(!grepl('Intercept', varstoplot) | grepl(':', varstoplot))] # vars to plot

rows1_1 <- which(rownames(coefs1) %in% varstoplot) # rows in coefs
rows1_2 <- which(rownames(coefs2) %in% varstoplot)
rows1_3 <- which(rownames(coefs3) %in% varstoplot)
xlims <- range(c(coefs1[rows1_1,1] - 1.96*coefs1[rows1_1,2], coefs1[rows1_1,1] + 1.96*coefs1[rows1_1,2], 
                  coefs2[rows1_2,1] - 1.96*coefs2[rows1_2,2], coefs2[rows1_2,1] + 1.96*coefs2[rows1_2,2], 
                  coefs3[rows1_3,1] - 1.96*coefs3[rows1_3,2], coefs3[rows1_3,1] + 1.96*coefs3[rows1_3,2]))

cols <- brewer.pal(3, 'Dark2') # for Jtu, Jbeta and Horn models
pchs <- c(16, 16, 16)
offs <- c(0.1, 0, -0.1) # offset vertically for each model

par(las = 1, mai = c(0.5, 4, 0.1, 0.1))

plot(0,0, col = 'white', xlim = xlims, ylim = c(0.9,length(varstoplot)+0.1), yaxt='n', xlab = '', ylab ='')
axis(2, at = length(varstoplot):1, labels = varstoplot, cex.axis = 0.7)
abline(v = 0, col = 'grey', lty = 2)
abline(h = 1:length(varstoplot), col = 'grey', lty = 3)
for(i in 1:length(varstoplot)){
  if(varstoplot[i] %in% rownames(coefs1)){
    x = coefs1[rownames(coefs1) == varstoplot[i], 1]
    se = coefs1[rownames(coefs1) == varstoplot[i], 2]
    points(x, length(varstoplot) + 1 - i + offs[1], pch = pchs[1], col = cols[1])
    lines(x = c(x-1.96*se, x+1.96*se), y = c(length(varstoplot) + 1 - i + offs[1], length(varstoplot) + 1 - i + offs[1]), col = cols[1])
  }
  if(varstoplot[i] %in% rownames(coefs2)){
    x = coefs2[rownames(coefs2) == varstoplot[i], 1]
    se = coefs2[rownames(coefs2) == varstoplot[i], 2]
    points(x, length(varstoplot) + 1 - i + offs[2], pch = pchs[2], col = cols[2])
    lines(x = c(x-1.96*se, x+1.96*se), y = c(length(varstoplot) + 1 - i + offs[2], length(varstoplot) + 1 - i + offs[2]), col = cols[2])
  }
  if(varstoplot[i] %in% rownames(coefs3)){
    x = coefs3[rownames(coefs3) == varstoplot[i], 1]
    se = coefs3[rownames(coefs3) == varstoplot[i], 2]
    points(x, length(varstoplot) + 1 - i + offs[3], pch = pchs[3], col = cols[3])
    lines(x = c(x-1.96*se, x+1.96*se), y = c(length(varstoplot) + 1 - i + offs[3], length(varstoplot) + 1 - i + offs[3]), col = cols[3])
  }
}
legend('bottomright', col = cols, pch = 16, lwd = 1, legend = c('Jtu', 'Jbeta', 'Horn'), cex = 0.5)
```

## Temperature and duration models separated by REALM
### Fit/load the models
```{r LME temperature duration realm}

randef <- list(taxa_mod2 = ~ abs(tempchange), STUDY_ID = ~ abs(tempchange), rarefyID = ~abs(tempchange))
varef <- varPower(-0.5, ~abs(tempchange))

if(file.exists('temp/modTDrealmJtu.rds')){
  modTDrealmJtu <- readRDS('temp/modTDrealmJtu.rds')
} else {
  i <- trends[, complete.cases(Jtu, REALM, tempchange)]
  modTDrealmJtu <- lme(Jtu ~ abs(tempchange) * duration + abs(tempchange) * REALM,
                   random = randef, weights = varef, data = trends[i,], method = 'REML')
  saveRDS(modTDrealmJtu, file = 'temp/modTDrealmJtu.rds')
}

if(file.exists('temp/modTDrealmJbeta.rds')){
  modTDrealmJbeta <- readRDS('temp/modTDrealmJbeta.rds')
} else {
  i <- trends[, complete.cases(Jbeta, REALM, tempchange)]
  modTDrealmJbeta <- lme(Jbeta ~ abs(tempchange)*duration + abs(tempchange) * REALM,
                   random = randef, weights = varef, data = trends[i,], method = 'REML', 
                   control=lmeControl(msMaxIter = 100, maxIter = 100))
  saveRDS(modTDrealmJbeta, file = 'temp/modTDrealmJbeta.rds')
}

if(file.exists('temp/modTDrealmHorn.rds')){
  modTDrealmHorn <- readRDS('temp/modTDrealmHorn.rds')
} else {
  i <- trends[, complete.cases(Horn, REALM, tempchange)]
  modTDrealmHorn <- lme(Horn ~ abs(tempchange)*duration + abs(tempchange) * REALM,
                   random = randef, weights = varef, data = trends[i,], method = 'REML')
  saveRDS(modTDrealmHorn, file = 'temp/modTDrealmHorn.rds')
}


```

### Summary
```{r summary of TD mods}
summary(modTDrealmJtu)
summary(modTDrealmJbeta)
summary(modTDrealmHorn)
```


### Plot the temp coefficients from TD realm models
```{r modTD coefs}

coefs1 <- summary(modTDrealmJtu)$tTable
coefs2 <- summary(modTDrealmJbeta)$tTable
coefs3 <- summary(modTDrealmHorn)$tTable

varstoplot <- unique(c(rownames(coefs1), rownames(coefs2), rownames(coefs3)))
varstoplot <- varstoplot[which(!grepl('Intercept', varstoplot) | grepl(':', varstoplot))] # vars to plot

rows1_1 <- which(rownames(coefs1) %in% varstoplot) # rows in coefs
rows1_2 <- which(rownames(coefs2) %in% varstoplot)
rows1_3 <- which(rownames(coefs3) %in% varstoplot)
xlims <- range(c(coefs1[rows1_1,1] - 1.96*coefs1[rows1_1,2], coefs1[rows1_1,1] + 1.96*coefs1[rows1_1,2], 
                  coefs2[rows1_2,1] - 1.96*coefs2[rows1_2,2], coefs2[rows1_2,1] + 1.96*coefs2[rows1_2,2], 
                  coefs3[rows1_3,1] - 1.96*coefs3[rows1_3,2], coefs3[rows1_3,1] + 1.96*coefs3[rows1_3,2]))

cols <- brewer.pal(3, 'Dark2') # for Jtu, Jbeta and Horn models
pchs <- c(16, 16, 16)
offs <- c(0.1, 0, -0.1) # offset vertically for each model

par(las = 1, mai = c(0.5, 4, 0.1, 0.1))

plot(0,0, col = 'white', xlim = xlims, ylim = c(1,length(varstoplot)), yaxt='n', xlab = '', ylab ='')
axis(2, at = length(varstoplot):1, labels = varstoplot, cex.axis = 0.7)
abline(v = 0, col = 'grey', lty = 2)
abline(h = 1:length(varstoplot), col = 'grey', lty = 3)
for(i in 1:length(varstoplot)){
  if(varstoplot[i] %in% rownames(coefs1)){
    x = coefs1[rownames(coefs1) == varstoplot[i], 1]
    se = coefs1[rownames(coefs1) == varstoplot[i], 2]
    points(x, length(varstoplot) + 1 - i + offs[1], pch = pchs[1], col = cols[1])
    lines(x = c(x-1.96*se, x+1.96*se), y = c(length(varstoplot) + 1 - i + offs[1], length(varstoplot) + 1 - i + offs[1]), col = cols[1])
  }
  if(varstoplot[i] %in% rownames(coefs2)){
    x = coefs2[rownames(coefs2) == varstoplot[i], 1]
    se = coefs2[rownames(coefs2) == varstoplot[i], 2]
    points(x, length(varstoplot) + 1 - i + offs[2], pch = pchs[2], col = cols[2])
    lines(x = c(x-1.96*se, x+1.96*se), y = c(length(varstoplot) + 1 - i + offs[2], length(varstoplot) + 1 - i + offs[2]), col = cols[2])
  }
  if(varstoplot[i] %in% rownames(coefs3)){
    x = coefs3[rownames(coefs3) == varstoplot[i], 1]
    se = coefs3[rownames(coefs3) == varstoplot[i], 2]
    points(x, length(varstoplot) + 1 - i + offs[3], pch = pchs[3], col = cols[3])
    lines(x = c(x-1.96*se, x+1.96*se), y = c(length(varstoplot) + 1 - i + offs[3], length(varstoplot) + 1 - i + offs[3]), col = cols[3])
  }
}
legend('topleft', col = cols, pch = 16, lwd = 1, legend = c('Jtu', 'Jbeta', 'Horn'), cex = 0.5)
```


## Full models
Try static covariates plus interactions of abs temperature trend with each covariate:

- realm
- speed
- mass
- average metabolic temperature
- consumer fraction
- environmental temperature
- seasonality
- microclimates
- thermal bias
- NPP
- vegetation
- duration
- human footprint

Except for thermal bias: interact with temperature trend (not abs)

### Bowler vs Venter/Halpern human impact
Bowler has lower AIC.
```{r LME Jacard turnover temperature full rem0}
# using Bowler for human impact
i1 <- trends[, complete.cases(Jtutrendrem0, REALM, tempave_metab.sc, seas.sc, microclim.sc, 
                             tempchange_abs.sc, mass.sc, speed.sc, 
                             consumerfrac.sc, nspp.sc, thermal_bias.sc, npp.sc, 
                             veg.sc, duration.sc, human_bowler.sc, human_footprint.sc)]

randef <- list(STUDY_ID = ~ tempchange_abs.sc, rarefyID = ~1)
varef <- varPower(-0.5, ~nyrBT)

if(file.exists('temp/modTfullbowlerrem0.rds')){
  modTfullbowlerrem0 <- readRDS('temp/modTfullbowlerrem0.rds')
} else {

modTfullbowlerrem0 <- lme(Jtutrendrem0 ~ tempchange_abs.sc*REALM +
                     tempchange_abs.sc*tsign + 
                     tempchange_abs.sc*tempave_metab.sc + 
                     tempchange_abs.sc*seas.sc + 
                     tempchange_abs.sc*microclim.sc + 
                     tempchange_abs.sc*mass.sc + 
                     tempchange_abs.sc*speed.sc + 
                     tempchange_abs.sc*consumerfrac.sc +
                     tempchange_abs.sc*nspp.sc +
                     tempchange_abs.sc*thermal_bias.sc:tsign +
                     tempchange_abs.sc*npp.sc +
                     tempchange_abs.sc*veg.sc +
                     tempchange_abs.sc*duration.sc +
                     tempchange_abs.sc*human_bowler.sc:REALM2,
                   random = randef, weights = varef, data = trends[i1,], method = 'REML')
  saveRDS(modTfullbowlerrem0, file = 'temp/modTfullbowlerrem0.rds')
}

# using Venter/Halpern for human impact
if(file.exists('temp/modTfullfootprintrem0.rds')){
  modTfullfootprintrem0 <- readRDS('temp/modTfullfootprintrem0.rds')
} else {
modTfullfootprintrem0 <- lme(Jtutrendrem0 ~ tempchange_abs.sc*REALM + 
                     tempchange_abs.sc*tsign + 
                     tempchange_abs.sc*tempave_metab.sc + 
                     tempchange_abs.sc*seas.sc + 
                     tempchange_abs.sc*microclim.sc + 
                     tempchange_abs.sc*mass.sc + 
                     tempchange_abs.sc*speed.sc + 
                     tempchange_abs.sc*consumerfrac.sc +
                     tempchange_abs.sc*nspp.sc +
                     tempchange_abs.sc*thermal_bias.sc:tsign +
                     tempchange_abs.sc*npp.sc +
                     tempchange_abs.sc*veg.sc +
                     tempchange_abs.sc*duration.sc +
                     tempchange_abs.sc*human_footprint.sc:REALM2,
                   random = randef, weights = varef, data = trends[i1,], method = 'REML',
                   control = lmeControl(maxIter = 100, msMaxIter = 100, niterEM = 50, msMaxEval = 500))
  saveRDS(modTfullfootprintrem0, file = 'temp/modTfullfootprintrem0.rds')

}
AIC(modTfullbowlerrem0, modTfullfootprintrem0)

```

### Fit/load full models
```{r full models, fig.width=10, fig.height=8}
randef <- list(STUDY_ID = ~ tempchange_abs.sc, rarefyID = ~1)
varef <- varPower(-0.5, ~nyrBT)

terms <- c('tempchange_abs.sc*REALM', 
           'tempchange_abs.sc*tsign',
           'tempchange_abs.sc*tempave_metab.sc',
           'tempchange_abs.sc*seas.sc',
           'tempchange_abs.sc*microclim.sc',
           'tempchange_abs.sc*mass.sc',
           'tempchange_abs.sc*speed.sc', 
           'tempchange_abs.sc*consumerfrac.sc',
           'tempchange_abs.sc*nspp.sc',
           'tempchange_abs.sc*thermal_bias.sc:tsign',
           'tempchange_abs.sc*npp.sc',
           'tempchange_abs.sc*veg.sc',
           'tempchange_abs.sc*duration.sc',
           'tempchange_abs.sc*human_bowler.sc:REALM2')

completerows <- trends[, complete.cases(REALM, tempave_metab.sc, 
                                seas.sc, microclim.sc, 
                                tempchange_abs.sc, mass.sc, speed.sc, 
                                consumerfrac.sc, nspp.sc, thermal_bias.sc, npp.sc, 
                                veg.sc, duration.sc, human_bowler.sc)]


# rem0
if(file.exists('temp/modTfullJturem0.rds')){
  modTfullJturem0 <- readRDS('temp/modTfullJturem0.rds')
} else {
  i <- trends[, complete.cases(Jtutrendrem0)] & completerows
  thisformula <- as.formula(paste0('Jtutrendrem0 ~ ', paste(terms, collapse = ' + ')))
  modTfullJturem0 <- eval(bquote(lme(.(thisformula),
                         random = randef, weights = varef, data = trends[i,], 
                         method = 'REML')))
  saveRDS(modTfullJturem0, file = 'temp/modTfullJturem0.rds')
}

if(file.exists('temp/modTfullJbetarem0.rds')){
  modTfullJbetarem0 <- readRDS('temp/modTfullJbetarem0.rds')
} else {
  i <- trends[, complete.cases(Jbetatrendrem0)] & completerows
  thisformula <- as.formula(paste0('Jbetatrendrem0 ~ ', paste(terms, collapse = ' + ')))
  modTfullJbetarem0 <- eval(bquote(lme(.(thisformula),
                           random = randef, weights = varef, data = trends[i,], 
                           method = 'REML')))
  saveRDS(modTfullJbetarem0, file = 'temp/modTfullJbetarem0.rds')
}

if(file.exists('temp/modTfullHornrem0.rds')){
  modTfullHornrem0 <- readRDS('temp/modTfullHornrem0.rds')
} else {
  i <- trends[, complete.cases(Horntrendrem0)] & completerows
  thisformula <- as.formula(paste0('Horntrendrem0 ~ ', paste(terms, collapse = ' + ')))
  modTfullHornrem0 <- eval(bquote(lme(.(thisformula),
                      random = randef, weights = varef, data = trends[i,], 
                      method = 'REML')))
  saveRDS(modTfullHornrem0, file = 'temp/modTfullHornrem0.rds')
}

```

#### Summary
```{r summary  full}
summary(modTfullJturem0)
summary(modTfullJbetarem0)
summary(modTfullHornrem0)

rsquared(modTfullJturem0)
rsquared(modTfullJbetarem0)
rsquared(modTfullHornrem0)

```

### Plots from the full models
#### Plot the coefficients
```{r plot fullTmods, fig.height=8, fig.width=8}

coefs1 <- summary(modTfullJturem0)$tTable
coefs2 <- summary(modTfullJbetarem0)$tTable
coefs3 <- summary(modTfullHornrem0)$tTable

varstoplot <- unique(c(rownames(coefs1), rownames(coefs2), rownames(coefs3)))
varstoplot <- varstoplot[which(!grepl('Intercept', varstoplot) | grepl(':', varstoplot))] # vars to plot

rows1_1 <- which(rownames(coefs1) %in% varstoplot) # rows in coefs
rows1_2 <- which(rownames(coefs2) %in% varstoplot)
rows1_3 <- which(rownames(coefs3) %in% varstoplot)
xlims <- range(c(coefs1[rows1_1,1] - coefs1[rows1_1,2], coefs1[rows1_1,1] + coefs1[rows1_1,2], 
                  coefs2[rows1_2,1] - coefs2[rows1_2,2], coefs2[rows1_2,1] + coefs2[rows1_2,2], 
                  coefs3[rows1_3,1] - coefs3[rows1_3,2], coefs3[rows1_3,1] + coefs3[rows1_3,2]))


cols <- brewer.pal(3, 'Dark2') # for Jtu, Jbeta and Horn models
pchs <- c(16, 16, 16)
offs <- c(0.1, 0, -0.1) # offset vertically for each model


par(las = 1, mai = c(0.5, 4, 0.1, 0.1))

plot(0,0, col = 'white', xlim = xlims, ylim = c(1,length(varstoplot)), yaxt='n', xlab = '', ylab ='')
axis(2, at = length(varstoplot):1, labels = varstoplot, cex.axis = 0.7)
abline(v = 0, col = 'grey', lty = 2)
abline(h = 1:length(varstoplot), col = 'grey', lty = 3)
for(i in 1:length(varstoplot)){
  if(varstoplot[i] %in% rownames(coefs1)){
    x = coefs1[rownames(coefs1) == varstoplot[i], 1]
    se = coefs1[rownames(coefs1) == varstoplot[i], 2]
    points(x, length(varstoplot) + 1 - i + offs[1], pch = pchs[1], col = cols[1])
    lines(x = c(x-se, x+se), y = c(length(varstoplot) + 1 - i + offs[1], length(varstoplot) + 1 - i + offs[1]), col = cols[1])
  }
  if(varstoplot[i] %in% rownames(coefs2)){
    x = coefs2[rownames(coefs2) == varstoplot[i], 1]
    se = coefs2[rownames(coefs2) == varstoplot[i], 2]
    points(x, length(varstoplot) + 1 - i + offs[2], pch = pchs[2], col = cols[2])
    lines(x = c(x-se, x+se), y = c(length(varstoplot) + 1 - i + offs[2], length(varstoplot) + 1 - i + offs[2]), col = cols[2])
  }
  if(varstoplot[i] %in% rownames(coefs3)){
    x = coefs3[rownames(coefs3) == varstoplot[i], 1]
    se = coefs3[rownames(coefs3) == varstoplot[i], 2]
    points(x, length(varstoplot) + 1 - i + offs[3], pch = pchs[3], col = cols[3])
    lines(x = c(x-se, x+se), y = c(length(varstoplot) + 1 - i + offs[3], length(varstoplot) + 1 - i + offs[3]), col = cols[3])
  }
}
legend('topleft', col = cols, pch = 16, lwd = 1, legend = c('Jtu', 'Jbeta', 'Horn'), cex = 0.5)
```
#### Set up function to plot the main effects
<details>
<summary>Click to unfold</summary>

```{r function to plot main effects}
# mods should be a list of 3 full models
# returns a list with 2 components: the plots and the dataframe
plotmaineffects <- function(mods){
  # set up the variables to plot
  # if variable is logged before scaling (see 'center and scale' above), then need to mark it here and express the limits on a log10 scale (even though log transforming is log)
  vars <- data.frame(vars = c('tempchange_abs', 'tempave_metab', 'seas', 'microclim', 'mass', 'speed', 
                              'consumerfrac', 'nspp', 'thermal_bias', 'npp', 'veg', 'duration', 
                              'human_bowler', 'human_bowler'),
                     min =      c(0,  0,   0.1, -2,  0,   0,   0,   0.3, -10, 1.9, 0,   0.5, 0,   0), 
                     max =      c(0.2,  30,  16,  0.8, 8,   2,   1,   2.6, 10,  3.7, 0.3, 2,   1,   1),
                     log =      c(F,  F,   F,   T,   T,   T,   F,   T,   F,   T,   T,   T,   T,   T),
                     len =      c(100,  100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100),
                     discrete = c(F,  F,   F,   F,   F,   F,   F,   F,   F,   F,   F,   F,   F,   F),
                     plus =     c(0,  0,   0,   0,   0,   1,   0,   0,   0,   0,   1,   0,   1,   1), # what to add before log-scaling
                     REALM = c(rep('Terrestrial', 13), 'Marine'),
                     REALM2 = c(rep('TerrFresh', 13), 'Marine'),
                     stringsAsFactors = FALSE)
  baseall <- trends[, .(type = 'all', 
                        tempchange = -0.0001,
                        tempchange_abs.sc = 0.0001,
                        tempave_metab.sc = mean(tempave_metab.sc, na.rm=TRUE), 
                        seas.sc = mean(seas.sc, na.rm=TRUE), 
                        microclim.sc = mean(microclim.sc, na.rm=TRUE), 
                        speed.sc = mean(speed.sc, na.rm=TRUE), 
                        mass.sc = mean(mass.sc, na.rm=TRUE), 
                        nspp.sc = 0, 
                        thermal_bias.sc = mean(thermal_bias.sc, na.rm=TRUE), 
                        npp.sc = mean(npp.sc, na.rm=TRUE), 
                        human_bowler.sc = mean(human_bowler.sc, na.rm=TRUE), 
                        veg.sc = mean(veg.sc, na.rm=TRUE), 
                        consumerfrac.sc = mean(consumerfrac.sc, na.rm=TRUE))]
  baseterr <- trends[REALM == 'Terrestrial', 
                     .(type = 'Terrestrial', 
                       tempchange = -0.0001,
                       tempchange_abs.sc = 0.0001,
                       tempave_metab.sc = mean(tempave_metab.sc, na.rm=TRUE), 
                       seas.sc = mean(seas.sc, na.rm=TRUE), 
                       microclim.sc = mean(microclim.sc, na.rm=TRUE), 
                       speed.sc = mean(speed.sc, na.rm=TRUE), 
                       mass.sc = mean(mass.sc, na.rm=TRUE), 
                       nspp.sc = 0, 
                       thermal_bias.sc = 0, 
                       npp.sc = mean(npp.sc, na.rm=TRUE), 
                       human_bowler.sc = mean(human_bowler.sc, na.rm=TRUE), 
                       veg.sc = mean(veg.sc, na.rm=TRUE), 
                       consumerfrac.sc = mean(consumerfrac.sc, na.rm=TRUE))]
  basemar <- trends[REALM == 'Marine', 
                    .(type = 'Marine',
                      tempchange = -0.0001,
                      tempchange_abs.sc = 0.0001,
                      tempave_metab.sc = mean(tempave_metab.sc, na.rm=TRUE), 
                      seas.sc = mean(seas.sc, na.rm=TRUE), 
                      microclim.sc = mean(microclim.sc, na.rm=TRUE), 
                      speed.sc = mean(speed.sc, na.rm=TRUE), 
                      mass.sc = mean(mass.sc, na.rm=TRUE), 
                      nspp.sc = 0, 
                      thermal_bias.sc = 0, 
                      npp.sc = mean(npp.sc, na.rm=TRUE), 
                      human_bowler.sc = mean(human_bowler.sc, na.rm=TRUE), 
                      veg.sc = mean(veg.sc, na.rm=TRUE), 
                      consumerfrac.sc = mean(consumerfrac.sc, na.rm=TRUE))]
  basetab <- rbind(baseall, baseterr, basemar)
  basetab[, ':='(duration.sc = 0, nyrBT = 20, STUDY_ID = 127L, rarefyID = '127_514668')]
  
  # make the data frames for each interaction to plot                
  for(j in 1:nrow(vars)){
    # set up the main effects
    if(vars$log[j]){
      thisdat <- data.frame(new = 10^seq(vars$min[j], vars$max[j], length.out = vars$len[j]),
                            var = vars$vars[j], stringsAsFactors = FALSE)
    } 
    if(!vars$log[j]){
      thisdat <- data.frame(new = seq(vars$min[j], vars$max[j], length.out = vars$len[j]),
                            var = vars$vars[j], stringsAsFactors = FALSE)
    }
    names(thisdat) <- c(vars$vars[j], 'var')
    
    # scale the variable
    cent <- attr(trends[[paste0(vars$vars[j], '.sc')]], 'scaled:center')
    scl <- attr(trends[[paste0(vars$vars[j], '.sc')]], 'scaled:scale')
    if(is.null(cent)) cent <- 0
    if(!is.null(cent) & !is.null(scl)){
      if(vars$log[j]) thisdat[[paste0(vars$var[j], '.sc')]] <- (log(thisdat[[vars$vars[j]]] + vars$plus[j]) - cent)/scl
      if(!vars$log[j]) thisdat[[paste0(vars$var[j], '.sc')]] <- (thisdat[[vars$var[j]]] - cent)/scl
    }
    
    # merge with the rest of the columns
    # use realm-specific averages for human impacts
    if(vars$vars[j] != 'tsign') colnamestouse <- setdiff(colnames(basetab), paste0(vars$vars[j], '.sc'))
    if(vars$vars[j] == 'tsign') colnamestouse <- setdiff(colnames(basetab), vars$var[j])
    if(vars$vars[j] != 'human_bowler'){
      thisdat <- cbind(thisdat, basetab[type == 'all', ..colnamestouse])
    }
    if(vars$vars[j] == 'human_bowler' & vars$REALM[j] == 'Terrestrial'){
      thisdat <- cbind(thisdat, basetab[type == 'Terrestrial', ..colnamestouse])
    }
    if(vars$vars[j] == 'human_bowler' & vars$REALM[j] == 'Marine'){
      thisdat <- cbind(thisdat, basetab[type == 'Marine', ..colnamestouse])
    }
    
    # add realm
    thisdat$REALM <- vars$REALM[j]
    thisdat$REALM2 <- vars$REALM2[j]
    
    # merge with the previous iterations
    if(j == 1) newdat <- thisdat
    if(j > 1){
      colstoadd <- setdiff(colnames(thisdat), colnames(newdat))
      for(toadd in colstoadd){
        newdat[[toadd]] <- NA
      }
      
      colstoadd2 <- setdiff(colnames(newdat), colnames(thisdat))
      for(toadd in colstoadd2){
        thisdat[[toadd]] <- NA
      }
      
      newdat <- rbind(newdat, thisdat)
    } 
  }
  
  # character so that new levels can be added
  newdat$REALM <- as.character(newdat$REALM)
  newdat$REALM2 <- as.character(newdat$REALM2)
  
  # add extra rows so that all factor levels are represented (for predict.lme to work)
  newdat <- rbind(newdat[1:6, ], newdat)
  newdat$REALM[1:6] <- c('Marine', 'Marine', 'Freshwater', 'Freshwater', 'Terrestrial', 'Terrestrial')
  newdat$REALM2[1:6] <- c('Marine', 'Marine', 'TerrFresh', 'TerrFresh', 'TerrFresh', 'TerrFresh')
  newdat$tempchange_abs.sc[1:6] <- rep(0.0001, 6)
  newdat$tempchange[1:6] <- rep(c(0.0001, -0.0001), 3)
  newdat$var[1:6] <- 'test'
  
  # trim to at least some temperature change (so that tsign is -1 or 1)
  newdat <- newdat[newdat$tempchange_abs.sc != 0,]
  
  # set up tsign
  newdat$tsign <- factor(sign(newdat$tempchange))
  
  
  # make predictions
  newdat$predsJtu <- predict(object = mods[[1]], newdata = newdat, level = 0)
  newdat$predsJbeta <- predict(object = mods[[2]], newdata = newdat, level = 0)
  newdat$predsHorn <- predict(object = mods[[3]], newdata = newdat, level = 0)
  
  #compute standard error for predictions
  # from https://stackoverflow.com/questions/14358811/extract-prediction-band-from-lme-fit
  DesignmatJtu <- model.matrix(eval(eval(modTfullJturem0$call$fixed)[-2]), newdat)
  DesignmatJbeta <- model.matrix(eval(eval(modTfullJbetarem0$call$fixed)[-2]), newdat)
  DesignmatHorn <- model.matrix(eval(eval(modTfullHornrem0$call$fixed)[-2]), newdat)
  
  predvarJtu <- diag(DesignmatJtu %*% modTfullJturem0$varFix %*% t(DesignmatJtu))
  predvarJbeta <- diag(DesignmatJbeta %*% modTfullJbetarem0$varFix %*% t(DesignmatJbeta))
  predvarHorn <- diag(DesignmatHorn %*% modTfullHornrem0$varFix %*% t(DesignmatHorn))
  
  newdat$SE_Jtu <- sqrt(predvarJtu) 
  newdat$SE_Jbeta <- sqrt(predvarJbeta) 
  newdat$SE_Horn <- sqrt(predvarHorn) 
  
  # prep the plots
  varplots <- vector('list', nrow(vars))
  for(j in 1:length(varplots)){
    subs <- newdat$var == vars$vars[j] # which rows of newdat
    xvar <- vars$vars[j]
    title <- vars$vars[j]
    if(vars$vars[j] %in% c('human_bowler')){
      subs <- newdat$var == vars$vars[j] & newdat$REALM2 == vars$REALM2[j]
      title <- paste0('human:', vars$REALM2[j])
    } 
    
    se <- 1
    thisplot <- ggplot(newdat[subs, ], 
                       aes_string(x = xvar, y = 'predsJtu')) +
      geom_line() +
      geom_ribbon(aes(ymin = predsJtu - se*SE_Jtu, ymax = predsJtu + se*SE_Jtu), alpha = 0.5, fill = "grey") +
      geom_line(aes(y = predsJbeta), color = 'red') +
      geom_ribbon(aes(ymin = predsJbeta - se*SE_Jbeta, ymax = predsJbeta + se*SE_Jbeta), alpha = 0.5, fill = "red") +
      geom_line(aes(y = predsHorn), color = 'blue') +
      geom_ribbon(aes(ymin = predsHorn - se*SE_Horn, ymax = predsHorn + se*SE_Horn), alpha = 0.5, fill = "blue") +
      #coord_cartesian(ylim = c(0, 0.4)) +
      theme(plot.margin = unit(c(0.5,0,0.5,0), 'cm')) +
      labs(title = title) 
    varplots[[j]] <- thisplot
    if(vars$log[j] & !vars$discrete[j]){
      varplots[[j]] <- thisplot + scale_x_log10()
    }
  }
  out <- list(varplots = varplots, newdat = newdat)
}
```

</details>

#### Plot the main effects (rem0)
```{r main effect plots rem0, fig.width=12, fig.height=12}

#uses function from previous section
out <- plotmaineffects(mods = list(modTfullJturem0, modTfullJbetarem0, modTfullHornrem0))

grid.arrange(grobs = out$varplots, ncol = 3)

# write out the interactions
write.csv(out$newdat, file = 'output/maineffectsrem0.csv')

```
Grey: Jaccard turnover
Red: Jaccard total
Blue: Horn
Plots are for Terrestrial, except the marine plot.


#### Set up function to plot the interactions
<details>
<summary>Click to unfold</summary>

```{r interactions plot function}
# mod should be a full model
# returns a list with 2 components: the plots and the dataframe
plotinteractions <- function(mod, ylims = c(-0.05, 0.1)){
  # set up the interactions to plot
  # if variable is logged before scaling (see 'center and scale' above), then need to mark it here and express the limits on a log10 scale (even though log transforming is log)
  ints <- data.frame(vars = c('tsign', 'tempave_metab', 'seas', 'microclim', 'mass', 'speed', 
                              'consumerfrac', 'nspp', 'thermal_bias', 'npp', 'veg', 'duration', 
                              'human_bowler', 'human_bowler'),
                     min =      c(1,  0,   0.1, -2,  0,   0,   0,   0.3, -10, 1.9, 0,   0.5, 0,   0), 
                     max =      c(2,  30,  16,  0.8, 8,   2,   1,   2.6, 10,  3.7, 0.3, 2,   1,   1),
                     log =      c(F,  F,   F,   T,   T,   T,   F,   T,   F,   T,   T,   T,   T,   T),
                     len =      c(2,  100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100),
                     discrete = c(T,  F,   F,   F,   F,   F,   F,   F,   F,   F,   F,   F,   F,   F),
                     plus =     c(0,  0,   0,   0,   0,   1,   0,   0,   0,   0,   1,   0,   1,   1), # what to add before log-scaling
                     REALM = c(rep('Terrestrial', 12), 'Terrestrial', 'Marine'),
                     REALM2 = c(rep('TerrFresh', 13), 'Marine'),
                     stringsAsFactors = FALSE)
  baseall <- trends[, .(type = 'all', tempave_metab.sc = mean(tempave_metab.sc, na.rm=TRUE), 
                        seas.sc = mean(seas.sc, na.rm=TRUE), 
                        microclim.sc = mean(microclim.sc, na.rm=TRUE), 
                        speed.sc = mean(speed.sc, na.rm=TRUE), 
                        mass.sc = mean(mass.sc, na.rm=TRUE), 
                        nspp.sc = 0, 
                        thermal_bias.sc = mean(thermal_bias.sc, na.rm=TRUE), 
                        npp.sc = mean(npp.sc, na.rm=TRUE), 
                        human_bowler.sc = mean(human_bowler.sc, na.rm=TRUE), 
                        veg.sc = mean(veg.sc, na.rm=TRUE), 
                        consumerfrac.sc = mean(consumerfrac.sc, na.rm=TRUE))]
  baseterr <- trends[REALM == 'Terrestrial', 
                     .(type = 'Terrestrial', 
                       tempave_metab.sc = mean(tempave_metab.sc, na.rm=TRUE), 
                       seas.sc = mean(seas.sc, na.rm=TRUE), 
                       microclim.sc = mean(microclim.sc, na.rm=TRUE), 
                       speed.sc = mean(speed.sc, na.rm=TRUE), 
                       mass.sc = mean(mass.sc, na.rm=TRUE), 
                       nspp.sc = 0, 
                       thermal_bias.sc = 0, 
                       npp.sc = mean(npp.sc, na.rm=TRUE), 
                       human_bowler.sc = mean(human_bowler.sc, na.rm=TRUE), 
                       veg.sc = mean(veg.sc, na.rm=TRUE), 
                       consumerfrac.sc = mean(consumerfrac.sc, na.rm=TRUE))]
  basemar <- trends[REALM == 'Marine', 
                    .(type = 'Marine',
                      tempave_metab.sc = mean(tempave_metab.sc, na.rm=TRUE), 
                      seas.sc = mean(seas.sc, na.rm=TRUE), 
                      microclim.sc = mean(microclim.sc, na.rm=TRUE), 
                      speed.sc = mean(speed.sc, na.rm=TRUE), 
                      mass.sc = mean(mass.sc, na.rm=TRUE), 
                      nspp.sc = 0, 
                      thermal_bias.sc = 0, 
                      npp.sc = mean(npp.sc, na.rm=TRUE), 
                      human_bowler.sc = mean(human_bowler.sc, na.rm=TRUE), 
                      veg.sc = mean(veg.sc, na.rm=TRUE), 
                      consumerfrac.sc = mean(consumerfrac.sc, na.rm=TRUE))]
  basetab <- rbind(baseall, baseterr, basemar)
  basetab[, ':='(duration.sc = 0, nyrBT = 20, STUDY_ID = 127L, rarefyID = '127_514668')]
  
  # make the data frames for each interaction to plot                
  for(j in 1:nrow(ints)){
    # set up a grid of temperature trends and the interacting variable
    if(ints$log[j]) intvars <- list(tempchange = seq(-0.2, 0.2, length.out = 100), 
                                    new = 10^seq(ints$min[j], ints$max[j], length.out = ints$len[j]),
                                    var = ints$vars[j])
    if(!ints$log[j]) intvars <- list(tempchange = seq(-0.2, 0.2, length.out = 100), 
                                     new = seq(ints$min[j], ints$max[j], length.out = ints$len[j]),
                                     var = ints$vars[j])
    names(intvars) <- c('tempchange', ints$vars[j], 'var')
    thisdat <- expand.grid(intvars)
    
    # scale the interacting variable
    cent <- attr(trends[[paste0(ints$var[j], '.sc')]], 'scaled:center')
    scl <- attr(trends[[paste0(ints$var[j], '.sc')]], 'scaled:scale')
    if(!is.null(cent) & !is.null(scl)){
      if(ints$log[j]) thisdat[[paste0(ints$var[j], '.sc')]] <- (log(thisdat[[ints$vars[j]]] + ints$plus[j]) - cent)/scl
      if(!ints$log[j]) thisdat[[paste0(ints$var[j], '.sc')]] <- (thisdat[[ints$var[j]]] - cent)/scl
    }
    
    # merge with the rest of the columns
    # use realm-specific averages for human impacts
    if(ints$vars[j] != 'tsign') colnamestouse <- setdiff(colnames(basetab), paste0(ints$var[j], '.sc'))
    if(ints$vars[j] == 'tsign') colnamestouse <- setdiff(colnames(basetab), ints$var[j])
    if(ints$vars[j] != 'human_bowler'){
      thisdat <- cbind(thisdat, basetab[type == 'all', ..colnamestouse])
    }
    if(ints$vars[j] == 'human_bowler' & ints$REALM[j] == 'Terrestrial'){
      thisdat <- cbind(thisdat, basetab[type == 'Terrestrial', ..colnamestouse])
    }
    if(ints$vars[j] == 'human_bowler' & ints$REALM[j] == 'Marine'){
      thisdat <- cbind(thisdat, basetab[type == 'Marine', ..colnamestouse])
    }
    
    # add realm
    thisdat$REALM <- ints$REALM[j]
    thisdat$REALM2 <- ints$REALM2[j]
    
    # merge with the previous iterations
    if(j == 1) newdat <- thisdat
    if(j > 1){
      colstoadd <- setdiff(colnames(thisdat), colnames(newdat))
      for(toadd in colstoadd){
        newdat[[toadd]] <- NA
      }
      
      colstoadd2 <- setdiff(colnames(newdat), colnames(thisdat))
      for(toadd in colstoadd2){
        thisdat[[toadd]] <- NA
      }
      
      newdat <- rbind(newdat, thisdat)
    } 
  }
  
  # character so that new levels can be added
  newdat$REALM <- as.character(newdat$REALM)
  newdat$REALM2 <- as.character(newdat$REALM2)
  
  # add extra rows so that all factor levels are represented (for predict.lme to work)
  newdat <- rbind(newdat[1:6, ], newdat)
  newdat$REALM[1:6] <- c('Marine', 'Marine', 'Freshwater', 'Freshwater', 'Terrestrial', 'Terrestrial')
  newdat$REALM2[1:6] <- c('Marine', 'Marine', 'TerrFresh', 'TerrFresh', 'TerrFresh', 'TerrFresh')
  newdat$tempchange[1:6] <- c(-0.2, 0.2, -0.2, 0.2, -0.2, 0.2)
  
  # trim to at least some temperature change (so that tsign is -1 or 1)
  newdat <- newdat[newdat$tempchange != 0,]
  
  # scale the temperature vars
  newdat$tempchange.sc <- newdat$tempchange/attr(trends$tempchange.sc, 'scaled:scale') 
  newdat$tempchange_abs <- abs(newdat$tempchange)
  newdat$tempchange_abs.sc <- (newdat$tempchange_abs)/attr(trends$tempchange_abs.sc, 'scaled:scale')
  newdat$tsign <- factor(sign(newdat$tempchange))
  
  # make predictions
  newdat$preds <- predict(object = mod, newdata = newdat, level = 0)
  
  #remove the extra rows
  newdat <- newdat[5:nrow(newdat), ]
  
  # prep the plots
  intplots <- vector('list', nrow(ints))
  for(j in 1:length(intplots)){
    subs <- newdat$var == ints$vars[j] & newdat$tempchange > 0 # select warming side
    xvar <- 'tempchange_abs'
    title <- ints$vars[j]
    if(ints$vars[j] %in% c('tsign')){
      subs <- newdat$var == ints$vars[j]
    } 
    if(ints$vars[j] %in% c('thermal_bias')){
      subs <- newdat$var == ints$vars[j]
      xvar <- 'tempchange'
    } 
    if(ints$vars[j] %in% c('human_bowler')){
      subs <- newdat$var == ints$vars[j] & newdat$tempchange > 0 & newdat$REALM2 == ints$REALM2[j]
      title <- paste0('human:', ints$REALM2[j])
    } 
    
    thisplot <- ggplot(newdat[subs, ], 
                       aes_string(x = xvar, y = 'preds', 
                                  group = ints$vars[j], 
                                  color = ints$vars[j])) +
      geom_line() +
      coord_cartesian(ylim = ylims) +
      #theme(plot.margin = unit(c(0.5,0,0.5,0), 'cm')) +
      labs(title = title)
    if(ints$log[j] & !ints$discrete[j]){
      intplots[[j]] <- thisplot + scale_color_distiller(palette = "YlGnBu", trans = 'log')
    }
    if(!ints$log[j] & !ints$discrete[j]){
      intplots[[j]] <- thisplot + scale_color_distiller(palette = "YlGnBu", trans = 'identity')
    }
    if(ints$discrete[j]){
      intplots[[j]] <- thisplot + scale_color_brewer(palette = "Dark2")
    }
  }
  out <- list(intplots = intplots, newdat = newdat)
  return(out)
}
```


#### Plot interactions (Jaccard turnover rem0)
```{r interaction plots modTfullJturem0, fig.height = 13, fig.width = 9}

out <- plotinteractions(modTfullJturem0, ylims = c(-0.03, 0.03))

grid.arrange(grobs = out$intplots, ncol = 3)

# write out the interactions
write.csv(out$newdat, file = 'temp/interactionsJturem0.csv')

```

#### Plot interactions (Horn rem0)
```{r interaction plots modTfullHornrem0, fig.height = 13, fig.width = 9}

out <- plotinteractions(modTfullHornrem0, ylims = c(-0.02, 0.07))

grid.arrange(grobs = out$intplots, ncol = 3)

# write out the interactions
write.csv(out$newdat, file = 'temp/interactionsHornrem0.csv')

```


#### Plot residuals against each predictor (Jaccard turnover)
```{r resids modTfull1, fig.height = 10, fig.width=10}
resids <- resid(modTfullJturem0)
preds <- getData(modTfullJturem0)
col = '#00000033'
cex = 0.5
par(mfrow = c(5,4))
boxplot(resids ~ preds$REALM, cex = cex, col = col)
plot(preds$tempchange_abs.sc, resids, cex = cex, col = col)
plot(preds$tsign, resids, cex = cex, col = col)
plot(preds$tempave.sc, resids, cex = cex, col = col)
plot(preds$tempave_metab.sc, resids, cex = cex, col = col)
plot(preds$seas.sc, resids, cex = cex, col = col)
plot(preds$microclim.sc, resids, cex = cex, col = col)
plot(preds$mass.sc, resids, cex = cex, col = col)
plot(preds$speed.sc, resids, cex = cex, col = col)
plot(preds$lifespan.sc, resids, cex = cex, col = col)
plot(preds$consumerfrac.sc, resids, cex = cex, col = col)
plot(preds$endothermfrac.sc, resids, cex = cex, col = col)
plot(preds$nspp.sc, resids, cex = cex, col = col)
plot(preds$thermal_bias.sc, resids, cex = cex, col = col)
plot(preds$npp.sc, resids, cex = cex, col = col)
plot(preds$veg.sc, resids, cex = cex, col = col)
plot(preds$human_bowler.sc, resids, cex = cex, col = col)
```

### Remove each term from the full model
```{r term deletion from modTfull}
AICnas <- function(x){
  if(class(x) == 'NULL'){
    return(NA)
  } else {
    return(AIC(x))
  }
}

# set up the response variables to run
torun = data.frame(var = c('Jtutrendrem0', 'Jbetatrendrem0', 'Horntrendrem0'), 
                   modvar = c('Jtutrendrem0', 'Jbetatrendrem0', 'Horntrendrem0'),
                   run = TRUE, aics = NA)

# check if any already exist. If so, don't re-run that model.
if(file.exists('output/aics_from_full.csv')){
  aicsfromfull <- read.csv('output/aics_from_full.csv')
  
  for(i in 1:nrow(torun)){
    nm <- paste0('dAIC_', torun$var[i])
    if(nm %in% colnames(aicsfromfull)){ # check for column name
      if(!is.na(aicsfromfull[[nm]][1])){ # check that full model is not NA
        torun$run[i] <- FALSE
      }
    }
  }
}

randef <- list(STUDY_ID = ~ tempchange_abs.sc, rarefyID = ~1)
varef <- varPower(-0.5, ~nyrBT)

terms <- c('tempchange_abs.sc*REALM', 
           'tempchange_abs.sc*tsign',
           'tempchange_abs.sc*tempave_metab.sc',
           'tempchange_abs.sc*seas.sc',
           'tempchange_abs.sc*microclim.sc',
           'tempchange_abs.sc*mass.sc',
           'tempchange_abs.sc*speed.sc', 
           'tempchange_abs.sc*consumerfrac.sc',
           'tempchange_abs.sc*nspp.sc',
           'tempchange_abs.sc*thermal_bias.sc:tsign',
           'tempchange_abs.sc*npp.sc',
           'tempchange_abs.sc*veg.sc',
           'tempchange_abs.sc*duration.sc',
           'tempchange_abs.sc*human_bowler.sc:REALM2')

completerows <- trends[, complete.cases(REALM, tempave_metab.sc, 
                                seas.sc, microclim.sc, 
                                tempchange_abs.sc, mass.sc, speed.sc, 
                                consumerfrac.sc, nspp.sc, thermal_bias.sc, npp.sc, 
                                veg.sc, duration.sc, human_bowler.sc)]

if(any(torun$run)){
  for(k in which(torun$run)){

    i <- !is.na(trends[[as.character(torun$var[k])]]) & completerows
    
    modTdrops <- vector('list', length(terms)+2)
    names(modTdrops) <- c('full', '-tempchange_abs.sc', paste0('-', terms))
    
    # fit full model with ML for model comparison
    modTdrops[[1]] <- lme(formula(paste0(torun$modvar[k], ' ~ ', paste(terms, collapse = ' + '))),
                          random = randef, weights = varef, data = trends[i,], method = 'ML',
                          control = lmeControl(maxIter = 100, msMaxIter = 100, niterEM = 50, msMaxEval = 500, opt = 'optim'))
    
    # w/out tempchange
    modTdrops[[2]] <- lme(formula(paste0(torun$modvar[k], ' ~ ', paste(gsub('tempchange_abs.sc\\*', '', terms), 
                                                                       collapse = ' + '))),
                          random = list(STUDY_ID = ~ 1, rarefyID = ~1), weights = varef, data = trends[i,], method = 'ML',
                          control = lmeControl(maxIter = 100, msMaxIter = 100, niterEM = 50, msMaxEval = 500, opt = 'optim'))
    
    for(j in 1:length(terms)){
      print(j)
      tryCatch({
        modTdrops[[j+2]] <- lme(formula(paste0(torun$modvar[k], ' ~ ', paste(terms[-j], collapse = ' + '))),
                                random = randef, weights = varef, data = trends[i,], method = 'ML')
        
      }, error = function(e){
        print('going to optim (Jtu)')
        tryCatch({
          modTdrops[[j+2]] <- lme(formula(paste0(torun$modvar[k], ' ~ ', paste(terms[-j], collapse = ' + '))),
                                  random = randef, weights = varef, data = trends[i,], method = 'ML',
                                  control = lmeControl(opt = 'optim'))
          
        }, error = function(e){
          print('going to more iters (Jtu)') 
          tryCatch({
            modTdrops[[j+2]] <- lme(formula(paste0(torun$modvar[k], ' ~ ', paste(terms[-j], collapse = ' + '))),
                                    random = randef, weights = varef, data = trends[i,], method = 'ML',
                                    control = lmeControl(maxIter = 100, msMaxIter = 100, niterEM = 50, msMaxEval = 500))
            
          }, error= function(e){
            print('giving up on this one')
            modTdrops[[j+2]] <- NA
          })
        })
      })
    }
    
    torun$aics[k] <- list(sapply(modTdrops, AICnas))
  }
}



# if there was anything new
if(any(torun$run)){
  if(!exists('aicsfromfull')){
    aicsfromfull <- data.frame(mod = names(torun$aics[which(torun$run)[1]][[1]]))
  }
  
  # subtract full from each model AIC. Negative means term removal is supported. Positive means full is the better model.
  for(j in which(torun$run)){
    nm <- paste0('dAIC_', torun$var[j])
    aics <- torun$aics[j][[1]]
    aicsfromfull[[nm]] <- aics - aics[1]
  }

  
  # write out
  write.csv(aicsfromfull, file = 'output/aics_from_full.csv', row.names = FALSE)
}

aicsfromfull
```

#### Plot deltaAICs for all models
```{r plot dAICs, message = FALSE, warning = FALSE}
# transform for a plot
aicsfromfulllong <- reshape(aicsfromfull, direction = 'long',
                            varying = c('dAIC_Jtutrendrem0', 'dAIC_Jbetatrendrem0', 'dAIC_Horntrendrem0'),
                            v.names = 'dAIC',
                            idvar = 'mod',
                            timevar = 'type',
                            times = c('Jtutrendrem0', 'Jbetatrendrem0', 'Horntrendrem0'))
aicsfromfulllong$response <- gsub('trendrem0', '', aicsfromfulllong$type)
aicsfromfulllong$fit <- gsub('Jtu|Jbeta|Horn', '', aicsfromfulllong$type)

# plot
ggplot(aicsfromfulllong, aes(y=dAIC, x = mod, shape = response, color = fit, group = fit)) +
  geom_point(position = position_dodge(width = 0.5)) +
  scale_y_continuous(trans = signedsqrttrans) +
  coord_flip()
```

Clear that removing temperature trend makes the model quite a bit worse.



## Simplify the full models
This takes a couple days on a laptop to run if temp/ files not available.
Not run when knitting
```{r simplify the full models, eval = FALSE}
randef <- list(STUDY_ID = ~ tempchange_abs.sc, rarefyID = ~1)
varef <- varPower(-0.5, ~nyrBT)

terms <- ' ~ tempchange_abs.sc*REALM + tempchange_abs.sc*tsign + tempchange_abs.sc*tempave_metab.sc + tempchange_abs.sc*seas.sc + tempchange_abs.sc*microclim.sc + tempchange_abs.sc*mass.sc + tempchange_abs.sc*speed.sc + tempchange_abs.sc*consumerfrac.sc + tempchange_abs.sc*nspp.sc + tempchange_abs.sc*thermal_bias.sc:tsign + tempchange_abs.sc*npp.sc + tempchange_abs.sc*veg.sc + tempchange_abs.sc*duration.sc + tempchange_abs.sc*human_bowler.sc:REALM2'

completerows <- trends[, complete.cases(REALM, tempave_metab.sc, 
                                        seas.sc, microclim.sc, 
                                        tempchange_abs.sc, mass.sc, speed.sc, 
                                        consumerfrac.sc, nspp.sc, thermal_bias.sc, npp.sc, 
                                        veg.sc, duration.sc, human_bowler.sc)]

# rem0
if(file.exists('temp/modTsimpJturem0.rds')){
  modTsimpJturem0 <- readRDS('temp/modTsimpJturem0.rds')
} else {
  i <- !is.na(trends$Jtutrendrem0) & completerows
  
  modTfullJturem0ML <- lme(formula(paste0('Jtutrendrem0', terms)),
                           random = randef, weights = varef, data = trends[i,], method = 'ML',
                           control = lmeControl(maxIter = 100, msMaxIter = 100, niterEM = 50, msMaxEval = 500, opt = 'optim'))
  modTsimpJturem0 <- stepAIC(modTfullJturem0ML, direction = 'backward')
  saveRDS(modTsimpJturem0, file = 'temp/modTsimpJturem0.rds')
}

if(file.exists('temp/modTsimpJbetarem0.rds')){
  modTsimpJbetarem0 <- readRDS('temp/modTsimpJbetarem0.rds')
} else {
  i <- !is.na(trends$Jbetatrendrem0) & completerows
  modTfullJbetarem0ML <- lme(formula(paste0('Jbetatrendrem0', terms)),
                       random = randef, weights = varef, data = trends[i,], method = 'ML',
                       control = lmeControl(maxIter = 100, msMaxIter = 100, niterEM = 50, msMaxEval = 500, opt = 'optim'))
  modTsimpJbetarem0 <- stepAIC(modTfullJbetarem0ML, direction = 'backward')
  saveRDS(modTsimpJbetarem0, file = 'temp/modTsimpJbetarem0.rds')
}

if(file.exists('temp/modTsimpHornrem0.rds')){
  modTsimpHornrem0 <- readRDS('temp/modTsimpHornrem0.rds')
} else {
  i <- !is.na(trends$Horntrendrem0) & completerows
  modTfullHornrem0ML <- lme(formula(paste0('Horntrendrem0', terms)),
                            random = randef, weights = varef, data = trends[i,], method = 'ML',
                            control = lmeControl(maxIter = 100, msMaxIter = 100, niterEM = 50, msMaxEval = 500, opt = 'optim'))
  modTsimpHornrem0 <- stepAIC(modTfullHornrem0ML, direction = 'backward')
  saveRDS(modTsimpHornrem0, file = 'temp/modTsimpHornrem0.rds')
}


summary(modTsimpJturem0)
summary(modTsimpJbetarem0)
summary(modTsimpHornrem0)


```


## Make realm-specific models
```{r LME Horn models by realm, fig.width=10, fig.height=8}
i1 <- trends[, REALM == 'Terrestrial' & complete.cases(Horntrendrem0, tempave_metab.sc, seas.sc, microclim.sc, 
                             tempchange_abs.sc, mass.sc, speed.sc, 
                             consumerfrac.sc, nspp.sc, thermal_bias.sc, npp.sc, 
                             veg.sc, duration.sc, human_bowler.sc)]
i2 <- trends[, REALM == 'Freshwater' & complete.cases(Horntrendrem0, tempave_metab.sc, seas.sc, microclim.sc, 
                             tempchange_abs.sc, mass.sc, speed.sc, 
                             nspp.sc, thermal_bias.sc, npp.sc, 
                             veg.sc, duration.sc, human_bowler.sc)] # no consumerfrac
i3 <- trends[, REALM == 'Marine' & complete.cases(Horntrendrem0, tempave_metab.sc, seas.sc, microclim.sc, 
                             tempchange_abs.sc, mass.sc, speed.sc, 
                             consumerfrac.sc, nspp.sc, thermal_bias.sc, npp.sc, 
                             duration.sc, human_bowler.sc)] # no veg

print(paste('Terrestrial', sum(i1)))
print(paste('Freshwater', sum(i2)))
print(paste('Marine', sum(i3)))

randef <- list(STUDY_ID = ~ tempchange_abs.sc, rarefyID = ~1)
varef <- varPower(-0.5, ~nyrBT)

# land
if(file.exists('temp/modTfullHornTerr.rds')){
  modTfullHornTerr <- readRDS('temp/modTfullHornTerr.rds')
} else {
  modTfullHornTerr <- lme(Horntrendrem0 ~ 
                         tempchange_abs.sc*tsign +
                         tempchange_abs.sc*tempave_metab.sc + 
                         tempchange_abs.sc*seas.sc + 
                         tempchange_abs.sc*microclim.sc + 
                         tempchange_abs.sc*mass.sc + 
                         tempchange_abs.sc*speed.sc + 
                         tempchange_abs.sc*consumerfrac.sc +
                         tempchange_abs.sc*nspp.sc +
                         tempchange_abs.sc*thermal_bias.sc:tsign +
                         tempchange_abs.sc*npp.sc +
                         tempchange_abs.sc*veg.sc +
                         tempchange_abs.sc*duration.sc +
                         tempchange_abs.sc*human_bowler.sc,
                       random = randef, weights = varef, data = trends[i1,], method = 'REML',
                       control = lmeControl(maxIter = 100, msMaxIter = 100, niterEM = 50, msMaxEval = 500))
  saveRDS(modTfullHornTerr, file = 'temp/modTfullHornTerr.rds')
}

# freshwater
if(file.exists('temp/modTfullHornFresh.rds')){
  modTfullHornFresh <- readRDS('temp/modTfullHornFresh.rds')
} else {
  modTfullHornFresh <- lme(Horntrendrem0 ~ 
                         tempchange_abs.sc*tsign +
                         tempchange_abs.sc*tempave_metab.sc + 
                         tempchange_abs.sc*seas.sc + 
                         tempchange_abs.sc*microclim.sc + 
                         tempchange_abs.sc*mass.sc + 
                         tempchange_abs.sc*speed.sc + 
                         tempchange_abs.sc*nspp.sc +
                         tempchange_abs.sc*thermal_bias.sc:tsign +
                         tempchange_abs.sc*npp.sc +
                         tempchange_abs.sc*veg.sc +
                         tempchange_abs.sc*duration.sc +
                         tempchange_abs.sc*human_bowler.sc,
                       random = randef, weights = varef, data = trends[i2,], method = 'REML',
                       control = lmeControl(maxIter = 100, msMaxIter = 100, niterEM = 50, msMaxEval = 500))
  saveRDS(modTfullHornFresh, file = 'temp/modTfullHornFresh.rds')
}

# marine
if(file.exists('temp/modTfullHornMar.rds')){
  modTfullHornMar <- readRDS('temp/modTfullHornMar.rds')
} else {
  modTfullHornMar <- lme(Horntrendrem0 ~ 
                         tempchange_abs.sc*tsign +
                         tempchange_abs.sc*tempave_metab.sc + 
                         tempchange_abs.sc*seas.sc + 
                         tempchange_abs.sc*microclim.sc + 
                         tempchange_abs.sc*mass.sc + 
                         tempchange_abs.sc*speed.sc + 
                         tempchange_abs.sc*consumerfrac.sc +
                         tempchange_abs.sc*nspp.sc +
                         tempchange_abs.sc*thermal_bias.sc:tsign +
                         tempchange_abs.sc*npp.sc +
                         tempchange_abs.sc*duration.sc +
                         tempchange_abs.sc*human_bowler.sc,
                       random = randef, weights = varef, data = trends[i3,], method = 'REML',
                       control = lmeControl(maxIter = 100, msMaxIter = 100, niterEM = 50, msMaxEval = 500))
  saveRDS(modTfullHornMar, file = 'temp/modTfullHornMar.rds')
}

summary(modTfullHornTerr)
summary(modTfullHornFresh)
summary(modTfullHornMar)
```

### Plot the realm-specific coefficients
Also uses the full models across all realms
```{r plot realm mods, fig.height=12, fig.width=9}

coefs1 <- summary(modTfullHornrem0)$tTable
coefs2 <- summary(modTfullHornTerr)$tTable
coefs3 <- summary(modTfullHornFresh)$tTable
coefs4 <- summary(modTfullHornMar)$tTable

varstoplot <- unique(c(rownames(coefs1), rownames(coefs2), rownames(coefs3), rownames(coefs4)))
varstoplot <- varstoplot[which(!grepl('Intercept', varstoplot) | grepl(':', varstoplot))] # vars to plot

rows1_1 <- which(rownames(coefs1) %in% varstoplot) # rows in coefs
rows1_2 <- which(rownames(coefs2) %in% varstoplot)
rows1_3 <- which(rownames(coefs3) %in% varstoplot)
rows1_4 <- which(rownames(coefs4) %in% varstoplot)
xlims <- range(c(coefs1[rows1_1,1] - coefs1[rows1_1,2], coefs1[rows1_1,1] + coefs1[rows1_1,2], 
                 coefs2[rows1_2,1] - coefs2[rows1_2,2], coefs2[rows1_2,1] + coefs2[rows1_2,2], 
                 coefs3[rows1_3,1] - coefs3[rows1_3,2], coefs3[rows1_3,1] + coefs3[rows1_3,2],
                 coefs4[rows1_4,1] - coefs4[rows1_4,2], coefs4[rows1_4,1] + coefs4[rows1_4,2]))


cols <- brewer.pal(4, 'Dark2') # for full, terr, fresh, mar
pchs <- c(1, 16, 16, 16)
offs <- c(0.1, 0, -0.1, -0.2) # offset vertically for each model


par(las = 1, mai = c(0.5, 4, 0.1, 0.1))

plot(0,0, col = 'white', xlim = xlims, ylim = c(1,length(varstoplot)), yaxt='n', xlab = '', ylab ='')
axis(2, at = length(varstoplot):1, labels = varstoplot, cex.axis = 0.7)
abline(v = 0, col = 'grey', lty = 2)
abline(h = 1:length(varstoplot), col = 'grey', lty = 3)
for(i in 1:length(varstoplot)){
  if(varstoplot[i] %in% rownames(coefs1)){
    x = coefs1[rownames(coefs1) == varstoplot[i], 1]
    se = coefs1[rownames(coefs1) == varstoplot[i], 2]
    points(x, length(varstoplot) + 1 - i + offs[1], pch = pchs[1], col = cols[1])
    lines(x = c(x-se, x+se), y = c(length(varstoplot) + 1 - i + offs[1], length(varstoplot) + 1 - i + offs[1]), col = cols[1])
  }
  if(varstoplot[i] %in% rownames(coefs2)){
    x = coefs2[rownames(coefs2) == varstoplot[i], 1]
    se = coefs2[rownames(coefs2) == varstoplot[i], 2]
    points(x, length(varstoplot) + 1 - i + offs[2], pch = pchs[2], col = cols[2])
    lines(x = c(x-se, x+se), y = c(length(varstoplot) + 1 - i + offs[2], length(varstoplot) + 1 - i + offs[2]), col = cols[2])
  }
  if(varstoplot[i] %in% rownames(coefs3)){
    x = coefs3[rownames(coefs3) == varstoplot[i], 1]
    se = coefs3[rownames(coefs3) == varstoplot[i], 2]
    points(x, length(varstoplot) + 1 - i + offs[3], pch = pchs[3], col = cols[3])
    lines(x = c(x-se, x+se), y = c(length(varstoplot) + 1 - i + offs[3], length(varstoplot) + 1 - i + offs[3]), col = cols[3])
  }
  if(varstoplot[i] %in% rownames(coefs4)){
    x = coefs4[rownames(coefs4) == varstoplot[i], 1]
    se = coefs4[rownames(coefs4) == varstoplot[i], 2]
    points(x, length(varstoplot) + 1 - i + offs[4], pch = pchs[4], col = cols[4])
    lines(x = c(x-se, x+se), y = c(length(varstoplot) + 1 - i + offs[4], length(varstoplot) + 1 - i + offs[4]), col = cols[4])
  }
}
legend('bottomleft', col = cols, pch = pchs, lwd = 1, legend = c('All', 'Terestrial', 'Freshwater', 'Marine'))
```

[End text in hopes this helps the last figure show up when knitted]