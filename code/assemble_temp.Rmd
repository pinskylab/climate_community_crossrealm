---
title: "Assemble temperature dataset"
output: html_notebook
---
```{r setup}
require(data.table)
require(ncdf4)
require(ggplot2)

knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file()) # tell RStudio to use project root directory as the root for this notebook. Needed since we are storing code in a separate directory.
```

### Read in BioTime and temperature data
Using average daily temperature by month from CRU TS
Using average temperature by month from ERSST. NOAA_ERSST_V5 data provided by the NOAA/OAR/ESRL PSD, Boulder, Colorado, USA, from their Web site at https://www.esrl.noaa.gov/psd/
```{r}
# biotime
load('data/biotime_blowes/bt.Rdata')
bt <- data.table(bt_malin); rm(bt_malin)

# CRU TS mean temp by year
n = nc_open('dataDL/cruts/cru_ts4.03.1901.2018.tmp.dat.nc') # Open the netCDF file. Won't work on .gz for some reason
# print(n) # get information about the file format
tmp = ncvar_get(n, 'tmp') # dim order: 720 lon x 360 lat x 1416 time (observations are month, time measured in days since Jan 1, 1900). 0 lon is at date line.
dim(tmp)
dates <- format(as.Date(as.numeric(ncvar_get(n, 'time')), origin=as.Date('1900-01-01')), format = '%Y%m')
dimnames(tmp) <- list(lon_cruts = ncvar_get(n, 'lon'), lat_cruts = ncvar_get(n, 'lat'), time = dates)
nc_close(n)

# ERSST temp by month
n = nc_open('dataDL/ersst/sst.mnmean.nc') # Open the netCDF file
# print(n) # get information about the file format
sst = ncvar_get(n, 'sst') # dim order: 180 lon x 89 lat x 1994 time (observations are month, time measured in days since Jan 1, 1800). 0 lon is at greenwhich mean.
dim(sst)
dates <- format(as.Date(as.numeric(ncvar_get(n, 'time')), origin = as.Date('1800-01-01')), format = '%Y%m')
dimnames(sst) <- list(lon_ersst = ncvar_get(n, 'lon'), lat_ersst = ncvar_get(n, 'lat'), time = dates)
nc_close(n)

```

Check the temperature data read in correctly
```{r}
# CTU TS
head(dimnames(tmp)[[3]]) # 190101: good
tail(dimnames(tmp)[[3]]) # should be Dec. 2018: good

# ERSST
head(dimnames(sst)[[3]]) # should be Jan. 1854: good
tail(dimnames(sst)[[3]]) # should be Feb. 2020: good

```

Average temperature by year
```{r}
# CRU TS
tmpmelt <- as.data.table(tmp, value.name='tmp') # reshape to long format
tmpmelt[, YEAR := as.numeric(substr(time, 1,4))] # extract year
tmpyr <- tmpmelt[, .(tmp = mean(tmp, na.rm=TRUE)), by = .(lat_cruts = as.numeric(lat_cruts), lon_cruts = as.numeric(lon_cruts), YEAR)]

# ERSST
sstmelt <- as.data.table(sst, value.name = 'sst')
sstmelt[, YEAR := as.numeric(substr(time, 1,4))]
sstyr <- sstmelt[, .(sst = mean(sst, na.rm=TRUE)), by = .(lat_ersst = as.numeric(lat_ersst), lon_ersst = as.numeric(lon_ersst), YEAR)]

```

Plot CRU TS to make sure it worked
```{r}
ggplot(tmpyr[YEAR == 1901,], aes(lon_cruts, lat_cruts, color = tmp)) + geom_point(size = 0.1)
```
Plot ERSST to make sure it worked
```{r}
ggplot(sstyr[YEAR == 1901,], aes(lon_ersst, lat_ersst, color = sst)) + geom_point(size = 1) # plot to make sure it worked
```

Calculate seasonality by year (SD)
```{r}
# CRU TS
tmpmelt[, mo := as.numeric(substr(time, 5,6))] # extract month
tmpmo <- tmpmelt[, .(tmp = mean(tmp, na.rm = TRUE)), by = .(lat_cruts = as.numeric(lat_cruts), lon_cruts = as.numeric(lon_cruts), mo)] # average by month
tmpseas <- tmpmo[, .(seas_cruts = sd(tmp, na.rm = TRUE)), by = .(lat_cruts, lon_cruts)]

# ERSST
sstmelt[, mo := as.numeric(substr(time, 5,6))] # extract month
sstmo <- sstmelt[, .(sst = mean(sst, na.rm = TRUE)), by = .(lat_ersst = as.numeric(lat_ersst), lon_ersst = as.numeric(lon_ersst), mo)] # average by month
sstmo[lon_ersst > 180, lon_ersst := lon_ersst - 360] # convert to -180 to 180
sstseas <- sstmo[, .(seas_ersst = sd(sst, na.rm = TRUE)), by = .(lat_ersst, lon_ersst)]

```

Plot CRU TS to make sure seasonality worked
```{r}
ggplot(tmpseas, aes(lon_cruts, lat_cruts, color = seas_cruts)) + geom_point(size = 0.1) # plot to make sure it worked
```
Plot ERSST to make sure seasonality worked
```{r}
ggplot(sstseas, aes(lon_ersst, lat_ersst, color = seas_ersst)) + geom_point(size = 1) # plot to make sure it worked
```
### Merge temperature with biotime by year/lat/lon
```{r}
# CRU TS
bt[, lat_cruts := floor(rarefyID_y*2)/2 + 0.25] # find nearest CRU TS lat and lon grid values (0.5)
bt[, lon_cruts := floor(rarefyID_x*2)/2 + 0.25]
bttmp <- merge(bt, tmpyr, by = c('lat_cruts', 'lon_cruts', 'YEAR'), all.x = TRUE) # CRU TS

# ERSST
bt[, lat_ersst := floor((rarefyID_y - 1)*0.5 + 1)/0.5] # find nearest ERSST lat and lon grid values (2).
bt[, lon_ersst := floor((rarefyID_x + 1)*0.5 + 1)/0.5]
sstyr[lon_ersst > 180, lon_ersst := lon_ersst - 360] # convert to -180 to 180
btsst <- merge(bt, sstyr, by = c('lat_ersst', 'lon_ersst', 'YEAR'), all.x = TRUE) # ERSST

```

Check for missing CRU TS data in terrestrial, freshwater and marine. na is # missing values. n is # values with  data. Mostly missing in marine, as expected. Study 293 and 216 start before 1900.
```{r}
bttmp[REALM == 'Terrestrial', .(na = sum(is.na(tmp)), n = sum(!is.na(tmp))), by = .(STUDY_ID, rarefyID)][na > 0,]
bttmp[REALM == 'Freshwater', .(na = sum(is.na(tmp)), n = sum(!is.na(tmp))), by = .(STUDY_ID, rarefyID)][na > 0,]
bttmp[REALM == 'Marine', .(na = sum(is.na(tmp)), n = sum(!is.na(tmp))), by = .(STUDY_ID, rarefyID)][na > 0, .N]

ggplot(bttmp[REALM %in% c('Terrestrial', 'Freshwater'), ], aes(rarefyID_x, rarefyID_y, color = is.na(tmp))) +
    geom_point(size = 0.2)

```

Check for missing ERSST data in terrestrial, freshwater and marine. na is # missing values. n is # values with  data. Mostly missing in marine, as expected. Study 293 and 216 start before 1900.
```{r}
btsst[REALM == 'Terrestrial', .(na = sum(is.na(sst)), n = sum(!is.na(sst))), by = .(STUDY_ID, rarefyID)][na > 0, .N]
btsst[REALM == 'Freshwater', .(na = sum(is.na(sst)), n = sum(!is.na(sst))), by = .(STUDY_ID, rarefyID)][na > 0, .N]
btsst[REALM == 'Marine', .(na = sum(is.na(sst)), n = sum(!is.na(sst))), by = .(STUDY_ID, rarefyID, lat_ersst, lon_ersst)][na > 0, ]
btsst[REALM == 'Marine' & is.na(sst), ][, .(na = sum(is.na(sst))), by = .(lat_ersst, lon_ersst)]

ggplot(btsst[REALM == 'Marine', ], aes(rarefyID_x, rarefyID_y, color = is.na(sst))) +
    geom_point(size = 0.2)
```

### Write out temperature values that match BioTime by year/lat/lon
Only write years/lats/lons with temperature
```{r}
# CRU TS
outtmp <- bttmp[!is.na(tmp), .(rarefyID, YEAR, tmp)]
write.csv(outtmp, file = gzfile('output/cruts_tmp_byyear.csv.gz'))

# ERSST
outsst <- btsst[!is.na(sst), .(rarefyID, YEAR, sst)]
write.csv(outsst, file = gzfile('output/ersst_byyear.csv.gz'))

```

### Write out temperature trends calculated from values that match BioTime by year/lat/lon
Calculate trend only over those years that match sampled years in BioTime
```{r}
# CRU TS
out2tmp <- bttmp[!is.na(tmp), .(tmptrendbyyr = coef(lm(tmp ~ YEAR))[2], YEAR_min = min(YEAR), YEAR_max = max(YEAR)), 
          by = .(rarefyID)]
write.csv(out2tmp, file = gzfile('output/cruts_tmptrend_byyear.csv.gz'))

# ERSST
out2sst <- btsst[!is.na(sst), .(ssttrendbyyr = coef(lm(sst ~ YEAR))[2], YEAR_min = min(YEAR), YEAR_max = max(YEAR)), 
          by = .(rarefyID)]
write.csv(out2sst, file = gzfile('output/ersst_ssttrend_byyear.csv.gz'))

```

### Calculate and write out temperature trends for all years from first to last in BioTime
As opposed to previous block, don't skip years not sampled in BioTime
```{r write temp trend all years}
# CRU TS
btallyrstmp <- bttmp[!is.na(tmp), .(YEAR = seq(min(YEAR), max(YEAR), by = 1)), by = .(rarefyID, lat_cruts, lon_cruts)] # make a data.table of all years from first to last for each BioTime dataset with tmp data
btallyrstmp <- merge(btallyrstmp, tmpyr, by = c('lat_cruts', 'lon_cruts', 'YEAR'), all.x = TRUE) # merge the data.table with tmp values
out3tmp <- btallyrstmp[, .(tmptrendallyr = coef(lm(tmp ~ YEAR))[2], YEAR_min = min(YEAR), YEAR_max = max(YEAR)), 
          by = .(rarefyID)] # calculate trends
write.csv(out3tmp, file = gzfile('output/cruts_tmptrend_allyear.csv.gz')) # write out

# ERSST
btallyrssst <- btsst[!is.na(sst), .(YEAR = seq(min(YEAR), max(YEAR), by = 1)), by = .(rarefyID, lat_ersst, lon_ersst)]
btallyrssst <- merge(btallyrssst, sstyr, by = c('lat_ersst', 'lon_ersst', 'YEAR'), all.x = TRUE)
out3sst <- btallyrssst[, .(ssttrendallyr = coef(lm(sst ~ YEAR))[2], YEAR_min = min(YEAR), YEAR_max = max(YEAR)), 
          by = .(rarefyID)] # calculate trends
write.csv(out3sst, file = gzfile('output/ersst_ssttrend_allyear.csv.gz'))

```

### Calculate and write out average temperature for all years from first to last in BioTime
Need to have already run the previous block
```{r write temp ave all years}
# CRU TS
out4tmp <- btallyrstmp[, .(tmpaveallyr = mean(tmp, na.rm = TRUE), YEAR_min = min(YEAR), YEAR_max = max(YEAR)), 
          by = .(rarefyID)] # calculate ave
write.csv(out4tmp, file = gzfile('output/cruts_tmpave_allyear.csv.gz')) # write out

# ERSST
out4sst <- btallyrssst[, .(sstaveallyr = mean(sst, na.rm = TRUE), YEAR_min = min(YEAR), YEAR_max = max(YEAR)), 
          by = .(rarefyID)]
write.csv(out4sst, file = gzfile('output/ersst_sstave_allyear.csv.gz'))

```

### Write out seasonality values
```{r}
# CRU TS
btseastmp <- merge(bt[!duplicated(rarefyID), .(rarefyID, lat_cruts, lon_cruts)], tmpseas, by = c('lat_cruts', 'lon_cruts'), all.x = TRUE) # merge bt with seasonality values
write.csv(btseastmp, file = gzfile('output/cruts_seas.csv.gz')) # write out

# ERSST
btseassst <- merge(bt[!duplicated(rarefyID), .(rarefyID, lat_ersst, lon_ersst)], sstseas, by = c('lat_ersst', 'lon_ersst'), all.x = TRUE)
write.csv(btseassst, file = gzfile('output/ersst_seas.csv.gz')) # write out

```